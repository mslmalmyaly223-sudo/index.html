<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>سوق الطلاب</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary-color:#4a6bff;--secondary-color:#f8f9fa;--accent-color:#ff6b6b;
      --text-color:#222;--light-text:#6c757d;--border-color:#dee2e6;
      --success-color:#28a745;--warning-color:#ffc107;--danger-color:#dc3545;
      --sky:#e9f0ff;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal','Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    html,body{height:100%}
    body{background:#f5f5f5;color:var(--text-color);overscroll-behavior-y:contain;-webkit-text-size-adjust:100%;touch-action:manipulation}
    .container{max-width:100%;min-height:100vh;background:#fff;padding-bottom:70px}

    /* ===== Splash ===== */
    .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:
      radial-gradient(60% 90% at 20% 10%, rgba(16,209,255,.20), transparent 60%),
      radial-gradient(70% 80% at 90% 90%, rgba(106,17,203,.18), transparent 60%),
      linear-gradient(135deg,#0d0f1a 0%, #0f1330 100%);z-index:1200;overflow:hidden;transition:opacity .6s ease}
    .splash.fade-out{opacity:0;pointer-events:none}
    .runner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:.08em;filter:drop-shadow(0 10px 28px rgba(0,0,0,.45));pointer-events:none;}
    .runner span{font-weight:900;font-size:clamp(40px,9vw,74px);color:#e6ebff;display:inline-block;opacity:0; transform:translateX(6vw) scale(.96);animation:runCentered .8s cubic-bezier(.2,.8,.2,1) forwards;will-change:transform,opacity}
    .runner span:nth-child(1){animation-delay:.00s}.runner span:nth-child(2){animation-delay:.05s}.runner span:nth-child(3){animation-delay:.10s}
    .runner span:nth-child(4){animation-delay:.15s}.runner span:nth-child(5){animation-delay:.20s}.runner span:nth-child(6){animation-delay:.25s}
    .runner span:nth-child(7){animation-delay:.30s}.runner span:nth-child(8){animation-delay:.35s}.runner span:nth-child(9){animation-delay:.40s}
    .runner span:nth-child(10){animation-delay:.45s}
    @keyframes runCentered{0%{opacity:0; transform:translateX(6vw) scale(.96)}18%{opacity:1}55%{transform:translateX(-6vw) scale(1.02)}100%{opacity:0; transform:translateX(-6vw) scale(.98)}}
    .final-logo{position:relative;z-index:2;opacity:0;font-weight:900;font-size:clamp(42px,9.5vw,72px);color:#eef2ff;text-shadow:0 14px 40px rgba(16,209,255,.22),0 4px 10px rgba(0,0,0,.5);white-space:nowrap;line-height:1;direction:rtl;unicode-bidi:plaintext;animation:logoMerge .55s cubic-bezier(.2,.9,.1,1) var(--merge-delay,1.35s) forwards}
    @keyframes logoMerge{0%{opacity:0;transform:translateY(18px) scale(.94)}100%{opacity:1;transform:translateY(0) scale(1)}}

    /* Auth */
    .auth-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:20px;background:linear-gradient(135deg,#4a6bff,#6a11cb)}
    .auth-box{background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;width:100%;max-width:420px;text-align:center}
    .auth-tabs{display:flex;margin-bottom:20px;border-bottom:1px solid var(--border-color)}
    .auth-tab{flex:1;padding:10px;cursor:pointer;font-weight:500;color:var(--light-text);transition:.3s}
    .auth-tab.active{color:var(--primary-color);border-bottom:2px solid var(--primary-color)}
    .auth-form{display:none}.auth-form.active{display:block}
    .form-group{margin-bottom:15px;text-align:right}
    .form-group label{display:block;margin-bottom:5px;font-weight:500}
    .form-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;transition:.3s}
    .form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,107,255,.2)}
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}

    /* اختيار الصورة */
    .choose-avatar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .choose-avatar label{display:flex;align-items:center;gap:8px;background:#f2f4ff;border:1px solid #dfe4ff;padding:10px 12px;border-radius:12px;cursor:pointer}
    .choose-avatar input{display:none}
    .choose-avatar input:checked + span{outline:3px solid #3a5bef;border-radius:10px}
    .choose-avatar .emo{font-size:28px;line-height:1}

    /* Buttons */
    .btn{display:inline-block;padding:10px 14px;background:var(--primary-color);color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;width:auto}
    .btn:hover{transform:translateY(-1px)}
    .btn[disabled]{opacity:.65;cursor:not-allowed;transform:none}
    .btn-block{width:100%}
    .btn-secondary{background:var(--secondary-color);color:var(--text-color)}
    .btn-danger{background:var(--danger-color)}
    .btn-success{background:var(--success-color)}
    .btn-warning{background:var(--warning-color);color:#111}
    .btn-xs{padding:6px 8px;font-size:12px;border-radius:8px}

    /* Header */
    .header{position:sticky;top:0;background:#fff;padding:12px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);z-index:100}
    .brand{display:flex;align-items:center;gap:8px}
    .section-switch{display:inline-flex;background:#f2f4ff;border:1px solid #dfe4ff;border-radius:999px;overflow:hidden;margin-inline-start:10px}
    .section-pill{padding:6px 10px;font-size:12px;font-weight:800;color:#3a5bef;cursor:pointer;border:none;background:transparent}
    .section-pill.active{background:#3a5bef;color:#fff}
    .icon-btn{position:relative;background:transparent;border:none;cursor:pointer;font-size:20px}
    .icon-btn .dot{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:#ff3b3b;border-radius:50%;display:none}
    .icon-btn.has-unseen .dot{display:block}

    .filter-container{padding:15px;background:#fff;border-bottom:1px solid var(--border-color); display:flex; gap:10px;}
    .filter-select{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:5px}
    .posts-container{padding:15px 15px 90px}
    .pull-indicator{position:relative;height:0;overflow:visible}
    .pull-indicator .bubble{position:absolute;top:-28px;left:50%;transform:translateX(-50%);background:#e9f0ff;border:1px solid #d0dcff;border-radius:999px;padding:4px 10px;font-size:12px;color:#3a5bef;display:none}

    .post{background:#fff;border-radius:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);padding:15px;margin-bottom:15px;border:1px solid var(--border-color);position:relative}
    .post.pinned{box-shadow:0 4px 14px rgba(74,107,255,.25)}
    .post .pin-ribbon{position:absolute;top:-8px;right:-8px;background:#4a6bff;color:#fff;font-weight:800;padding:4px 8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:11px}
    .post.sold{opacity:.85;position:relative}
    .post.sold::after{content:"تم بيعه";position:absolute;top:10px;left:10px;background:var(--success-color);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
    .post-header{display:grid;grid-template-columns:1fr auto;grid-row-gap:6px;align-items:center;margin-bottom:10px}
    .post-username{display:flex;align-items:center;gap:10px;font-weight:900;color:#111;font-size:17px}
    .badge-verified{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:999px;background:linear-gradient(135deg,#f7d774,#e7b10a,#ffdf85,#e7b10a);color:#5a4600;font-size:12px;font-weight:900;border:1px solid rgba(128,96,0,.35);box-shadow:0 2px 10px rgba(231,177,10,.35), inset 0 0 10px rgba(255,255,255,.35)}
    .badge-verified i{font-size:14px;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15))}
    .post-title{font-weight:800;font-size:15px;color:var(--primary-color)}
    .post-price{justify-self:end;font-weight:900;color:var(--success-color)}
    .post-description{margin:10px 0 15px;line-height:1.8;color:#222;white-space:pre-wrap}
    .post-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .owner-tools{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;border-bottom:1px dashed #eee;padding-bottom:8px}

    /* Companies */
    .company{background:#fff;border-radius:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);padding:15px;margin-bottom:12px;border:1px solid var(--border-color)}
    .company .name{font-weight:900;color:#111;font-size:16px}
    .company .phone{color:#0c7a43;font-weight:800;margin-top:6px}
    .company .route{color:#555;margin-top:6px;font-size:13px}
    .company .desc{color:#333;margin-top:6px}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;overflow-y:auto}
    .modal-content{background:#fff;margin:20px auto;padding:20px;border-radius:12px;width:90%;max-width:520px;animation:modalOpen .25s}
    @keyframes modalOpen{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}
    .modal-header h2{font-size:18px;margin:0}
    .close-modal{background:none;border:none;font-size:24px;cursor:pointer;color:var(--light-text)}
    .select-group{margin-bottom:15px}
    .select-group label{display:block;margin-bottom:5px;font-weight:500}
    .select-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;background:#fff}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}

    /* Profile */
    .profile-shell{padding:16px}
    .profile-card{background:var(--sky);border:1px solid #d0dcff;border-radius:16px;padding:16px;display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .avatar{width:72px;height:72px;border-radius:50%;display:grid;place-items:center;background:#d7e4ff;color:#2740b9;font-size:40px;cursor:pointer;border:2px solid #c9d7ff;overflow:hidden}
    .profile-meta{display:flex;flex-direction:column;gap:4px}
    .profile-name-row{display:flex;align-items:center;gap:8px;font-weight:900;font-size:18px;color:#0f235f}
    .profile-count{font-size:13px;color:#2b3f8c;font-weight:700}
    .profile-email{font-size:12px;color:#3c4c7f;word-break:break-all}
    .profile-uid-input {font-size:12px;padding:6px 8px}

    .profile-actions-card{margin-top:20px;background:#fff;border:1px solid var(--border-color);border-radius:14px;padding:10px}
    .profile-menu{padding:5px}
    .menu-item{display:flex;align-items:center;gap:10px;padding:14px;margin-bottom:10px;background:var(--secondary-color);border-radius:12px;cursor:pointer;transition:.2s}
    .menu-item:hover{transform:translateY(-2px)}
    .muted{color:#777;font-size:13px}

    /* ===== Broadcast popup ===== */
    #broadcast-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:210}
    #broadcast-overlay.show{display:block}
    #broadcast-banner{
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.98);
      width:min(92%, 380px); max-height:70vh; overflow:auto; z-index:220;
      background:#e9f0ff; border:1px solid #d0dcff; border-radius:16px; padding:16px 46px 16px 16px;
      box-shadow:0 20px 40px rgba(0,0,0,.28); opacity:0;
    }
    #broadcast-banner.show{
      display:block; opacity:1; transform:translate(-50%,-50%) scale(1);
      animation:bannerIn .32s cubic-bezier(.2,.8,.2,1) forwards;
    }
    @keyframes bannerIn{to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    #broadcast-banner .x{position:absolute;top:10px;right:12px;background:#0000;border:none;font-size:22px;cursor:pointer;color:#2643b8}

    .bottom-nav{position:fixed;bottom:0;left:0;width:100%;background:#fff;display:flex;justify-content:space-around;padding:12px 0;border-top:1px solid var(--border-color);z-index:120}
    .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--light-text);font-size:12px;cursor:pointer}
    .nav-item.active{color:var(--primary-color)}

    .notification{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:var(--success-color);color:#fff;padding:16px 22px;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:300;display:none;font-size:14px;text-align:center;min-width:240px;max-width:85%;
    }

    /* ===== Challenge Page ===== */
    .challenge-shell{padding:16px;}
    .challenge-tab-nav {display:flex; background:#f2f4ff; border:1px solid #dfe4ff; border-radius:999px; overflow:hidden; margin-bottom: 20px;}
    .challenge-tab-pill {flex:1; padding:10px; font-size:13px; font-weight:800; color:#3a5bef; cursor:pointer; border:none; background:transparent; text-align:center;}
    .challenge-tab-pill.active {background:#3a5bef; color:#fff;}
    .challenge-tab-content {display:none;}
    .challenge-tab-content.active {display:block;}

    .rank-list{display:grid;gap:10px;margin-top:10px}
    .rank-card{background:#fff;border:2px solid var(--border-color);border-radius:16px;padding:12px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .rank-left{display:flex;align-items:center;gap:10px}
    .rank-badge{width:36px;height:36px;border-radius:999px;display:grid;place-items:center;font-weight:900}
    .rank-name{font-weight:900;color:#0f235f}
    .rank-points{font-weight:800;color:#2740b9}
    .rank-1{border-color:#d4af37;box-shadow:0 0 0 3px rgba(212,175,55,.35),0 6px 18px rgba(212,175,55,.25)}
    .rank-1 .rank-badge{background:linear-gradient(135deg,#ffe27a,#f6c33b);color:#5a4600;border:2px solid #d4af37}
    .rank-2{border-color:#c0c0c0;box-shadow:0 0 0 3px rgba(192,192,192,.35),0 6px 18px rgba(192,192,192,.25)}
    .rank-2 .rank-badge{background:linear-gradient(135deg,#f2f2f2,#bfbfbf);color:#333;border:2px solid #c0c0c0}
    .rank-3{border-color:#cd7f32;box-shadow:0 0 0 3px rgba(205,127,50,.35),0 6px 18px rgba(205,127,50,.25)}
    .rank-3 .rank-badge{background:linear-gradient(135deg,#f2b182,#c97a3e);color:#3b240f;border:2px solid #cd7f32}

    .timer-card{background:var(--sky);border:1px solid #d0dcff;border-radius:16px;padding:20px;margin-top:24px;min-width:min(92%,520px);text-align:center}
    .timer-title{font-weight:900;color:#0f235f}
    .timer-display{font-weight:900;font-size:clamp(28px,7vw,48px);margin-top:8px;color:#1b2f7a}
    .timer-actions{display:flex;gap:10px;justify-content:center;margin-top:14px}
    .hint{margin-top:8px;color:#3c4c7f;font-size:12px}
    .points-display{font-weight:800;color:#0f235f;margin:12px 0;}
    .boost-card{margin-top:20px; background:#fff; border:1px solid var(--border-color); border-radius:14px; padding:15px; text-align:center;}
    .boost-card .btn {background: #ff8c00; color:#fff;}
    
    .qna-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .qna-header { display: flex; justify-content: space-between; align-items: center; }
    .qna-prize { font-weight: 900; color: var(--success-color); font-size: 16px; }
    .qna-creator { font-weight: 700; color: #555; }
    .qna-actions { margin-top: 10px; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>

  <!-- Splash -->
  <div id="splash" class="splash" aria-label="سوق الطلاب">
    <div class="runner" dir="rtl" aria-hidden="true">
      <span>س</span><span>و</span><span>ق</span><span>&nbsp;</span><span>ا</span><span>ل</span><span>ط</span><span>ل</span><span>ا</span><span>ب</span>
    </div>
    <div class="final-logo" id="final-logo" dir="rtl">سوق الطلاب</div>
  </div>

  <!-- Auth -->
  <div id="auth-page" class="auth-container page" style="display:none">
    <div class="auth-box">
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">تسجيل الدخول</div>
        <div class="auth-tab" onclick="switchAuthTab('register')">إنشاء حساب</div>
      </div>

      <form id="login-form" class="auth-form active" onsubmit="event.preventDefault(); login();">
        <div class="form-group"><label for="login-email">البريد الإلكتروني</label><input type="email" id="login-email" class="form-control" required></div>
        <div class="form-group"><label for="login-password">كلمة المرور</label><input type="password" id="login-password" class="form-control" required></div>
        <button type="submit" class="btn btn-block">تسجيل الدخول</button>
      </form>

      <form id="register-form" class="auth-form" onsubmit="event.preventDefault(); register();">
        <div class="form-group"><label for="register-name">الاسم الكامل</label><input type="text" id="register-name" class="form-control" required></div>
        <div class="form-group"><label for="register-email">البريد الإلكتروني</label><input type="email" id="register-email" class="form-control" required></div>
        <div class="form-group"><label for="register-password">كلمة المرور</label><input type="password" id="register-password" class="form-control" required></div>
        <div class="form-group">
          <label>اختر الصورة</label>
          <div class="choose-avatar">
            <label><input type="radio" name="register-avatar" value="male" checked><span class="emo">👨🏻‍💼</span> ولد</label>
            <label><input type="radio" name="register-avatar" value="female"><span class="emo">👩🏻‍💼</span> بنت</label>
          </div>
        </div>
        <button type="button" id="register-submit" class="btn btn-block" onclick="register()">إنشاء حساب</button>
      </form>
    </div>
  </div>

  <!-- Main -->
  <div id="main-page" class="container page" style="display:none">
    <div class="header">
      <div class="brand">
        <button id="create-btn" class="btn" onclick="onCreateButton()"><i class="fas fa-plus"></i> <span id="create-btn-label">إنشاء منشور</span></button>
        <div class="section-switch" role="tablist" aria-label="الأقسام">
          <button id="pill-posts" class="section-pill active" onclick="switchSection('posts')" role="tab" aria-selected="true">المنشورات</button>
          <button id="pill-companies" class="section-pill" onclick="switchSection('companies')" role="tab" aria-selected="false">شركات التوصيل</button>
        </div>
      </div>
    </div>

    <div id="filter-container" class="filter-container">
      <select id="filter-stage" class="filter-select" onchange="renderPosts()">
        <option value="">كل المراحل</option>
        <option value="sades-elmi">السادس العلمي</option>
        <option value="sades-adabi">السادس الادبي</option>
        <option value="khames">الخامس علمي/ادبي</option>
        <option value="rabea">الرابع علمي/ادبي</option>
        <option value="thaleth-mut">الثالث متوسط</option>
        <option value="thani-mut">الثاني متوسط</option>
        <option value="awal-mut">الاول متوسط</option>
        <option value="sades-ibtidai">السادس الابتدائي</option>
      </select>
      <select id="filter-material" class="filter-select" onchange="renderPosts()">
        <option value="">كل المواد</option>
        <option value="اسلامية">اسلامية</option><option value="عربي">عربي</option><option value="انكليزي">انكليزي</option>
        <option value="رياضيات">رياضيات</option><option value="احياء">احياء</option><option value="كيمياء">كيمياء</option>
        <option value="فيزياء">فيزياء</option><option value="اقتصاد">اقتصاد</option><option value="أدب ونصوص">أدب ونصوص</option>
        <option value="قواعد">قواعد</option>
      </select>
    </div>

    <div id="broadcast-overlay"></div>
    <div id="broadcast-banner">
      <button class="x" onclick="dismissBroadcast()">×</button>
      <div style="font-weight:900;color:#0f235f" id="broadcast-title-display"></div>
      <div id="broadcast-text-display" style="margin-top:4px;color:#0f235f"></div>
    </div>

    <div class="pull-indicator"><div id="pull-bubble" class="bubble">اسحب للتحديث…</div></div>
    <div class="posts-container" id="posts-container"></div>
    <div class="posts-container" id="companies-container" style="display:none"></div>
  </div>

  <!-- Profile -->
  <div id="profile-page" class="container page" style="display:none">
    <div class="profile-shell">
      <div class="profile-card">
        <div id="avatar" class="avatar" title="تغيير الصورة" onclick="openAvatarModal"></div>
        <div class="profile-meta">
          <div class="profile-name-row">
            <span id="profile-name"></span>
            <span id="profile-verified"></span>
            <i class="fas fa-pencil-alt" style="color:var(--primary-color);cursor:pointer" onclick="editProfileName()"></i>
          </div>
          <div id="profile-count" class="profile-count"></div>
          <div id="profile-email" class="profile-email"></div>
          <div class="row" style="align-items: center; gap: 8px; margin-top:4px;">
            <input id="profile-uid-input" class="form-control profile-uid-input" readonly />
            <button class="btn btn-xs" onclick="copyUidToClipboard()"><i class="fas fa-copy"></i> نسخ</button>
          </div>
        </div>
      </div>
      <div class="profile-actions-card">
        <div class="profile-menu">
          <div class="menu-item" onclick="showUserPosts()"><i class="fas fa-book"></i><span>منشوراتي</span></div>
          <div class="menu-item" onclick="showInbox()"><i class="fas fa-inbox"></i><span>البريد الوارد</span></div>
          <div class="menu-item" onclick="openTelegram('MSLM_ALMYALY')"><i class="fas fa-thumbtack"></i><span>تثبيت المنشور بـ 1$</span></div>
          <div class="menu-item" onclick="claimReward()"><i class="fas fa-gift"></i><span>مكافأة يومية (20 نقطة)</span></div>
          <div class="menu-item" onclick="openUserStats()"><i class="fas fa-chart-pie"></i><span>إحصائيات المستخدمين</span></div>
          <div class="menu-item owner-only" style="display:none" onclick="openBroadcastModal()"><i class="fas fa-bullhorn"></i><span>إشعار عام</span></div>
          <div class="menu-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- User posts -->
  <div id="user-posts-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">منشوراتي</span></div>
    <div class="posts-container" id="user-posts-container"></div>
  </div>

  <!-- Inbox -->
  <div id="inbox-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">البريد الوارد</span></div>
    <div class="posts-container" id="inbox-container"></div>
  </div>

  <!-- Details -->
  <div id="details-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromDetails()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">تفاصيل المنشور</span></div>
    <div class="posts-container" id="details-container"></div>
  </div>

  <!-- Comments -->
  <div id="comments-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromComments()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">التعليقات</span></div>
    <div class="posts-container">
      <div id="comments-list-page"></div>
      <div class="row" style="margin-top:10px;">
        <input type="text" id="comment-text-page" class="form-control grow" placeholder="أضف تعليقًا...">
        <button id="send-comment-btn" class="btn" onclick="addCommentFromPage()">إرسال</button>
      </div>
    </div>
  </div>
  
  <!-- Reward -->
  <div id="reward-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i> رجوع</button>
      <span style="font-weight:900">مكافأة يومية</span>
    </div>
    <div class="profile-shell" style="text-align: center;">
      <div class="post">
        <h2>خطوتان للحصول على 20 نقطة!</h2>
        <p class="muted" style="margin: 10px 0;">يمكنك الحصول على المكافأة مرة كل 24 ساعة.</p>
        <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
          <a href="https://t.me/IbnalKufa" target="_blank" class="btn btn-block" style="background-color: #0088cc;">
            <i class="fab fa-telegram"></i> الخطوة 1: اشترك في القناة
          </a>
          <button class="btn btn-block btn-success" onclick="verifyRewardSubscription()">
            <i class="fas fa-check"></i> الخطوة 2: التحقق والحصول على النقاط
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Challenge -->
  <div id="challenge-page" class="container page" style="display:none">
    <div class="header">
      <span style="font-weight:900">تحدي دراسي</span>
      <div class="owner-only" style="display: none;">
        <button class="btn btn-xs btn-success" onclick="openAddPointsModal()"><i class="fa-solid fa-plus"></i> إضافة نقاط</button>
      </div>
    </div>
    <div class="challenge-shell">
      <div class="challenge-tab-nav">
        <button class="challenge-tab-pill active" data-tab="timer" onclick="switchChallengeTab(this)">تحدي المؤقت</button>
        <button class="challenge-tab-pill" data-tab="qna" onclick="switchChallengeTab(this)">تحدي الأسئلة</button>
        <button class="challenge-tab-pill" data-tab="leaderboard" onclick="switchChallengeTab(this)">التصنيف العالمي</button>
      </div>

      <div id="challenge-tab-timer" class="challenge-tab-content active">
        <div class="timer-card">
          <div class="timer-title">عدّاد دراستك</div>
          <div id="timer-display" class="timer-display">00:00:00</div>
          <div class="points-display">
            رصيدك: <b id="current-points-display">0</b> نقطة
          </div>
          <div class="timer-actions">
            <button id="timer-start-btn" class="btn" onclick="startStudyTimer()"><i class="fa-solid fa-play"></i> بدء</button>
            <button id="timer-stop-btn" class="btn btn-warning" onclick="stopStudyTimer()" disabled><i class="fa-solid fa-stop"></i> إيقاف</button>
          </div>
          <div id="timer-hint" class="hint">يبدأ العداد من الصفر ويحوّل الوقت إلى نقاط عند الإيقاف (1 نقطة لكل 3 دقائق).</div>
        </div>
        <div class="boost-card">
          <div class="timer-title">تسريع المؤقت</div>
          <div class="hint">ضاعف سرعة عداد الوقت (2x) لمدة ساعة كاملة.</div>
          <button class="btn" style="margin-top: 10px;" onclick="buyBoost()">شراء مقابل 75 نقطة</button>
          <div id="boost-status" class="hint" style="margin-top: 10px; font-weight: 700;"></div>
        </div>
      </div>

      <div id="challenge-tab-qna" class="challenge-tab-content">
        <button class="btn btn-block" onclick="openCreateQnaModal()"><i class="fa-solid fa-plus"></i> إنشاء سؤال جديد</button>
        <div id="qna-list-container" class="posts-container">
          <div class="post"><p>جاري تحميل الأسئلة...</p></div>
        </div>
      </div>

      <div id="challenge-tab-leaderboard" class="challenge-tab-content">
        <div class="post-title" style="font-size:16px;color:#0f235f;font-weight:900">التصنيف العالمي (أعلى 50)</div>
        <div id="challenge-leaderboard" class="rank-list">
          <div class="post"><p>جاري تحميل التصنيف...</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom nav -->
  <div id="bottom-nav" class="bottom-nav">
    <div class="nav-item active" data-page="main" onclick="showMainPage()"><i class="fas fa-home"></i><span>الرئيسية</span></div>
    <div class="nav-item" data-page="challenge" onclick="showChallengePage()"><i class="fas fa-fire"></i><span>تحدي دراسي</span></div>
    <div class="nav-item" data-page="profile" onclick="showProfilePage()"><i class="fas fa-user"></i><span>حسابي</span></div>
  </div>

  <div id="notification" class="notification"></div>

  <!-- Post modals -->
  <div id="create-post-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>إنشاء منشور جديد</h2><button class="close-modal" onclick="closeCreatePostModal()">&times;</button></div>
      <div class="select-group">
        <label for="post-stage">المرحلة الدراسية</label>
        <select id="post-stage" class="select-control">
          <option value="sades-elmi">السادس العلمي</option>
          <option value="sades-adabi">السادس الادبي</option>
          <option value="khames">الخامس علمي/ادبي</option>
          <option value="rabea">الرابع علمي/ادبي</option>
          <option value="thaleth-mut">الثالث متوسط</option>
          <option value="thani-mut">الثاني متوسط</option>
          <option value="awal-mut">الاول متوسط</option>
          <option value="sades-ibtidai">السادس الابتدائي</option>
        </select>
      </div>
      <div class="form-group"><label for="post-price">السعر (دينار عراقي)</label><input type="number" id="post-price" class="form-control" placeholder="اتركه 0 ليكون مجانًا" required></div>
      <div class="select-group">
        <label for="post-material">المادة</label>
        <select id="post-material" class="select-control">
          <option value="اسلامية">اسلامية</option><option value="عربي">عربي</option><option value="انكليزي">انكليزي</option>
          <option value="رياضيات">رياضيات</option><option value="احياء">احياء</option><option value="كيمياء">كيمياء</option>
          <option value="فيزياء">فيزياء</option><option value="اقتصاد">اقتصاد</option><option value="أدب ونصوص">أدب ونصوص</option>
          <option value="قواعد">قواعد</option>
        </select>
      </div>
      <div class="form-group"><label for="post-description">الوصف</label><textarea id="post-description" class="form-control" rows="4" placeholder="اذكر اسم الأستاذ، الفصل، أو أي تفاصيل أخرى..." required></textarea></div>
      <div class="select-group">
        <label for="contact-method">طريقة التواصل</label>
        <select id="contact-method" class="select-control" onchange="changeContactMethod()">
          <option value="whatsapp">واتساب</option><option value="telegram">تلكرام</option><option value="comments">تعليقات</option>
        </select>
      </div>
      <div class="form-group" id="whatsapp-field"><label for="whatsapp-number">رقم الواتساب</label><input type="text" id="whatsapp-number" class="form-control" placeholder="07xxxxxxxx"></div>
      <div class="form-group" id="telegram-field" style="display:none"><label for="telegram-username">معرف التلكرام</label><input type="text" id="telegram-username" class="form-control" placeholder="username"></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeCreatePostModal()">إلغاء</button><button id="post-submit-btn" class="btn" onclick="createPost()">نشر</button></div>
    </div>
  </div>

  <div id="edit-post-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>تعديل المنشور</h2><button class="close-modal" onclick="closeEditPostModal()">&times;</button></div>
      <input type="hidden" id="edit-post-id">
      <div class="select-group">
        <label for="edit-post-stage">المرحلة الدراسية</label>
        <select id="edit-post-stage" class="select-control">
          <option value="sades-elmi">السادس العلمي</option>
          <option value="sades-adabi">السادس الادبي</option>
          <option value="khames">الخامس علمي/ادبي</option>
          <option value="rabea">الرابع علمي/ادبي</option>
          <option value="thaleth-mut">الثالث متوسط</option>
          <option value="thani-mut">الثاني متوسط</option>
          <option value="awal-mut">الاول متوسط</option>
          <option value="sades-ibtidai">السادس الابتدائي</option>
        </select>
      </div>
      <div class="form-group"><label for="edit-post-price">السعر (دينار عراقي)</label><input type="number" id="edit-post-price" class="form-control" required></div>
      <div class="select-group">
        <label for="edit-post-material">المادة</label>
        <select id="edit-post-material" class="select-control">
          <option value="اسلامية">اسلامية</option><option value="عربي">عربي</option><option value="انكليزي">انكليزي</option>
          <option value="رياضيات">رياضيات</option><option value="احياء">احياء</option><option value="كيمياء">كيمياء</option>
          <option value="فيزياء">فيزياء</option><option value="اقتصاد">اقتصاد</option><option value="أدب ونصوص">أدب ونصوص</option>
          <option value="قواعد">قواعد</option>
        </select>
      </div>
      <div class="form-group"><label for="edit-post-description">الوصف</label><textarea id="edit-post-description" class="form-control" rows="4" required></textarea></div>
      <div class="select-group">
        <label for="edit-contact-method">طريقة التواصل</label>
        <select id="edit-contact-method" class="select-control" onchange="changeContactMethod('edit')">
          <option value="whatsapp">واتساب</option><option value="telegram">تلكرام</option><option value="comments">تعليقات</option>
        </select>
      </div>
      <div class="form-group" id="edit-whatsapp-field"><label for="edit-whatsapp-number">رقم الواتساب</label><input type="text" id="edit-whatsapp-number" class="form-control"></div>
      <div class="form-group" id="edit-telegram-field" style="display:none"><label for="edit-telegram-username">معرف التلكرام</label><input type="text" id="edit-telegram-username" class="form-control"></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeEditPostModal()">إلغاء</button><button id="post-edit-submit-btn" class="btn" onclick="savePostEdits()">حفظ التعديلات</button></div>
    </div>
  </div>

  <!-- Companies -->
  <div id="create-company-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>إضافة شركة توصيل</h2><button class="close-modal" onclick="closeCreateCompanyModal()">&times;</button></div>
      <div class="form-group"><label for="company-name">اسم الشركة</label><input type="text" id="company-name" class="form-control" required></div>
      <div class="select-group">
        <label for="company-from">من محافظة</label>
        <select id="company-from" class="select-control"></select>
        <div class="muted">المحافظة التي <b>تستلم منها</b> الشركة الطلب.</div>
      </div>
      <div class="select-group">
        <label for="company-to">إلى محافظة</label>
        <select id="company-to" class="select-control"></select>
        <div class="muted">المحافظات التي <b>تُوصل إليها</b> الشركة (اختر "كل المحافظات" إن كانت عامة).</div>
      </div>
      <div class="form-group"><label for="company-phone">رقم الهاتف</label><input type="text" id="company-phone" class="form-control" placeholder="07xxxxxxxxxx" required></div>
      <div class="form-group"><label for="company-desc">وصف (اختياري)</label><textarea id="company-desc" class="form-control" rows="3" placeholder="ملاحظات أو أسعار تقريبية..."></textarea></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeCreateCompanyModal()">إلغاء</button><button id="company-submit-btn" class="btn" onclick="createCompany()">إضافة</button></div>
    </div>
  </div>
  
  <div id="edit-company-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>تعديل بيانات الشركة</h2><button class="close-modal" onclick="closeEditCompanyModal()">&times;</button></div>
      <input type="hidden" id="edit-company-id">
      <div class="form-group"><label for="edit-company-name">اسم الشركة</label><input type="text" id="edit-company-name" class="form-control" required></div>
      <div class="select-group">
        <label for="edit-company-from">من محافظة</label>
        <select id="edit-company-from" class="select-control"></select>
      </div>
      <div class="select-group">
        <label for="edit-company-to">إلى محافظة</label>
        <select id="edit-company-to" class="select-control"></select>
      </div>
      <div class="form-group"><label for="edit-company-phone">رقم الهاتف</label><input type="text" id="edit-company-phone" class="form-control" required></div>
      <div class="form-group"><label for="edit-company-desc">وصف (اختياري)</label><textarea id="edit-company-desc" class="form-control" rows="3"></textarea></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditCompanyModal()">إلغاء</button>
        <button class="btn" onclick="saveCompanyEdits()">حفظ التعديلات</button>
      </div>
    </div>
  </div>

  <!-- Avatar / Edit name / Stats / Broadcast / QnA / Owner points -->
  <div id="avatar-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>اختيار صورة</h2><button class="close-modal" onclick="closeAvatarModal()">&times;</button></div>
      <div class="row" style="justify-content:center;margin-top:10px;">
        <div class="avatar" onclick="setAvatar('female')" title="بنت" style="background:#ffd7ea;border-color:#ffc2e1"><div style="width:100%;height:100%;font-size:40px;line-height:72px">👩🏻‍💼</div></div>
        <div class="avatar" onclick="setAvatar('male')" title="ولد" style="background:#d7e4ff;border-color:#c9d7ff"><div style="width:100%;height:100%;font-size:40px;line-height:72px">👨🏻‍💼</div></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeAvatarModal()">إغلاق</button></div>
    </div>
  </div>

  <div id="edit-name-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>تعديل الاسم</h2><button class="close-modal" onclick="closeEditNameModal()">&times;</button></div>
      <div class="form-group"><label for="new-name">الاسم الجديد</label><input type="text" id="new-name" class="form-control" required></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeEditNameModal()">إلغاء</button><button class="btn" onclick="saveProfileName()">حفظ</button></div>
    </div>
  </div>

  <div id="stats-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>لوحة الإحصائيات</h2><button class="close-modal" onclick="closeStatsModal()">&times;</button></div>
      <div id="stats-cards" class="row" style="gap:12px;flex-wrap:wrap">
        <div class="post" style="flex:1;min-width:160px"><div class="post-title">النشطون الآن</div><div id="stat-active-now" style="font-size:26px;font-weight:900;margin-top:6px">—</div></div>
        <div class="post" style="flex:1;min-width:160px"><div class="post-title">النشطون اليوم</div><div id="stat-active-today" style="font-size:26px;font-weight:900;margin-top:6px">—</div></div>
        <div class="post" style="flex:1;min-width:160px"><div class="post-title">إجمالي المستخدمين</div><div id="stat-users" style="font-size:26px;font-weight:900;margin-top:6px">—</div></div>
        <div class="post" style="flex:1;min-width:160px"><div class="post-title">إجمالي المنشورات</div><div id="stat-posts" style="font-size:26px;font-weight:900;margin-top:6px">—</div></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeStatsModal()">إغلاق</button></div>
    </div>
  </div>

  <div id="broadcast-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>إرسال إشعار عام</h2><button class="close-modal" onclick="closeBroadcastModal()">&times;</button></div>
      <div class="form-group"><label for="broadcast-title-modal">عنوان الإشعار</label><input id="broadcast-title-modal" class="form-control" placeholder="مثال: الأسعار"></div>
      <div class="form-group"><label for="broadcast-text-modal">نص الإشعار</label><textarea id="broadcast-text-modal" class="form-control" rows="3" placeholder="اكتب الرسالة التي ستظهر للجميع"></textarea></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeBroadcastModal()">إلغاء</button><button class="btn" onclick="sendBroadcast()">نشر</button></div>
    </div>
  </div>

  <div id="create-qna-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>إنشاء سؤال جديد</h2><button class="close-modal" onclick="closeCreateQnaModal()">&times;</button></div>
      <div class="form-group"><label for="qna-question">نص السؤال</label><textarea id="qna-question" class="form-control" rows="3" required></textarea></div>
      <div class="select-group">
        <label for="qna-material">المادة</label>
        <select id="qna-material" class="select-control">
          <option value="اسلامية">اسلامية</option><option value="عربي">عربي</option><option value="انكليزي">انكليزي</option>
          <option value="رياضيات">رياضيات</option><option value="احياء">احياء</option><option value="كيمياء">كيمياء</option>
          <option value="فيزياء">فيزياء</option><option value="اقتصاد">اقتصاد</option><option value="أدب ونصوص">أدب ونصوص</option>
          <option value="قواعد">قواعد</option>
        </select>
      </div>

      <div class="form-group">
        <label>الخيارات (اختر الدائرة أمام الإجابة الصحيحة)</label>

        <div class="row" style="gap:8px; align-items:center; margin-bottom:8px;">
          <input type="radio" name="qna-correct" value="0" checked style="width:auto;">
          <input type="text" id="qna-option-1" class="form-control" placeholder="الخيار 1" required>
        </div>
        <div class="row" style="gap:8px; align-items:center; margin-bottom:8px;">
          <input type="radio" name="qna-correct" value="1" style="width:auto;">
          <input type="text" id="qna-option-2" class="form-control" placeholder="الخيار 2" required>
        </div>
        <div class="row" style="gap:8px; align-items:center;">
          <input type="radio" name="qna-correct" value="2" style="width:auto;">
          <input type="text" id="qna-option-3" class="form-control" placeholder="الخيار 3" required>
        </div>
      </div>

      <div class="form-group"><label for="qna-prize">جائزة السؤال (بالنقاط)</label><input type="number" id="qna-prize" class="form-control" placeholder="مثال: 10" required></div>
      <div class="muted">سيتم خصم قيمة الجائزة من رصيدك الحالي عند إنشاء السؤال.</div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeCreateQnaModal()">إلغاء</button><button class="btn" onclick="createQnaChallenge()">إنشاء</button></div>
    </div>
  </div>

  <div id="answer-qna-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>أجب عن السؤال</h2><button class="close-modal" onclick="closeAnswerQnaModal()">&times;</button></div>
      <div class="post-description" id="answer-qna-text" style="font-weight:700; font-size: 18px; text-align:center; margin-bottom: 20px;"></div>
      <div id="answer-qna-options" style="display: flex; flex-direction: column; gap: 10px;"></div>
      <div class="muted" style="margin-top:20px; text-align:center;">اختر الإجابة الصحيحة لربح النقاط.</div>
    </div>
  </div>

  <div id="add-points-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>إضافة نقاط لمستخدم</h2><button class="close-modal" onclick="closeAddPointsModal()">&times;</button></div>
      <div class="form-group"><label for="add-points-uid">UID المستخدم</label><input type="text" id="add-points-uid" class="form-control" placeholder="أدخل معرّف المستخدم الكامل"></div>
      <div class="form-group"><label for="add-points-amount">عدد النقاط</label><input type="number" id="add-points-amount" class="form-control" placeholder="مثال: 100"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddPointsModal()">إلغاء</button>
        <button class="btn" onclick="ownerAddPoints()">إرسال النقاط</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey:"AIzaSyBkoSz3ZUy4qKBTeLx42Oo-TlTtvFtF2vY",
      authDomain:"we-kill-the-sixth.firebaseapp.com",
      databaseURL:"https://we-kill-the-sixth-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"we-kill-the-sixth",
      storageBucket:"we-kill-the-sixth.appspot.com",
      messagingSenderId:"862363949793",
      appId:"1:862363949793:web:e0dc01a4eb139da43f75a0",
      measurementId:"G-CT6WFGXRHH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const APP_OWNER_EMAIL = "mslmalmyaly223@gmail.com";
    let pendingChosenAvatar = null;
    let lastBroadcast = null;
    let isFirstLoginSession = false;

    // ===== Splash timings =====
    (function(){
      const lastDelay = 0.45, runDur=0.8, mergeDelay = lastDelay + runDur + .10;
      document.getElementById('final-logo').style.setProperty('--merge-delay', mergeDelay+'s');
      setTimeout(()=>{ document.querySelector('.runner')?.remove(); }, (mergeDelay+0.4)*1000);
      const splash=document.getElementById('splash');
      function skip(){ splash.classList.add('fade-out'); setTimeout(()=>splash.remove(),600); }
      splash.addEventListener('click', skip);
      splash.addEventListener('touchstart', skip, {passive:true});
    })();

    // ===== Helpers =====
    function showNotification(msg,type="success"){
      const n=document.getElementById("notification");
      n.textContent=msg; n.style.display="block";
      const colors={error:'var(--danger-color)',warning:'var(--warning-color)',info:'var(--primary-color)',success:'var(--success-color)'};
      n.style.backgroundColor = colors[type]||colors.success;
      clearTimeout(n._t);
      n._t=setTimeout(()=>{ n.style.display="none"; },2500);
    }
    function escapeHTML(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    function validateEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase()); }
    function formatWhatsApp(v){ 
      let num = (v||"").toString().replace(/[^\d]/g, "");
      if (num.startsWith('07') && num.length === 11) { return '964' + num.substring(1); }
      if (num.startsWith('96407') && num.length === 14) { return '964' + num.substring(4); }
      return num;
    }
    function sanitizeTelegram(v){ return (v||"").toString().replace(/^@+/,"").trim(); }
    function openTelegram(username){ username=sanitizeTelegram(username); if(!username) return; window.location.href = "https://t.me/" + username; }
    const GOVERNORATES = ["بغداد","نينوى","البصرة","أربيل","النجف","كربلاء","ذي قار","السليمانية","ديالى","الأنبار","بابل","كركوك","واسط","المثنى","القادسية","ميسان","صلاح الدين","دهوك","كل المحافظات"];
    function renderAvatar(kind){
      const el = document.getElementById("avatar");
      const bg = kind==="female" ? "#ffd7ea" : "#d7e4ff";
      const emoji = kind==="female" ? "👩🏻‍💼" : "👨🏻‍💼";
      el.style.background = bg;
      el.innerHTML = `<div style="font-size:40px;line-height:72px">${emoji}</div>`;
    }
    function handleAuthError(error){
      const code = (error && error.code) || '';
      const msg  = (error && error.message) ? String(error.message) : '';
      let friendly = 'خطأ مصادقة.';
      if (code === 'auth/user-not-found' || code === 'auth/wrong-password' || msg.includes('INVALID_LOGIN_CREDENTIALS')) {
        friendly = 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
      } else if (code === 'auth/invalid-email') {
        friendly = 'صيغة البريد الإلكتروني غير صحيحة.';
      } else if (code === 'auth/network-request-failed') {
        friendly = 'تحقّق من اتصال الإنترنت.';
      } else if (code === 'auth/too-many-requests') {
        friendly = 'محاولات كثيرة. حاول لاحقًا.';
      } else if (code === 'auth/email-already-in-use') {
        friendly = 'هذا البريد مسجّل مسبقًا.';
      } else if (code === 'auth/operation-not-allowed') {
        friendly = 'فعّل تسجيل البريد/كلمة المرور من Firebase > Authentication.';
      }
      showNotification(friendly,'error');
      console.error('Auth error:', error);
    }

    // ===== Pages & UI =====
    const pages = {
      auth: document.getElementById("auth-page"), main: document.getElementById("main-page"),
      profile: document.getElementById("profile-page"), userPosts: document.getElementById("user-posts-page"),
      inbox: document.getElementById("inbox-page"), details: document.getElementById("details-page"),
      comments: document.getElementById("comments-page"), challenge: document.getElementById("challenge-page"),
      reward: document.getElementById("reward-page"),
    };
    const postsContainer = document.getElementById("posts-container");
    const companiesContainer = document.getElementById("companies-container");
    const userPostsContainer = document.getElementById("user-posts-container");
    const detailsContainer = document.getElementById("details-container");
    const commentsList = document.getElementById("comments-list-page");
    const inboxContainer = document.getElementById("inbox-container");
    const createBtn = document.getElementById("create-btn");
    const createBtnLabel = document.getElementById("create-btn-label");
    const filterBox = document.getElementById("filter-container");
    const pillPosts = document.getElementById("pill-posts");
    const pillCompanies = document.getElementById("pill-companies");

    let currentUser = null; 
    let posts = []; 
    let companies = [];
    let currentDetailsPostId = null; 
    let currentCommentsPostId = null;
    const userMetaCache = {}; 
    let activeSection = "posts";

    // ===== Challenge state =====
    let studyInterval = null; 
    let boostInterval = null;
    let heartbeatInterval = null;
    let lastHeartbeatSentAt = 0;
    let studyState = { 
      running: false, totalSeconds: 0, startAtMs: null, 
      totalPoints: 0, currentPoints: 0, boostUntil: null
    };
    let leaderboardUnsub = null; 
    let qnaUnsub = null; 
    let studyBusy = false;

    // ===== Auth =====
    auth.onAuthStateChanged(async (user) => {
      if(!user){
        updateUIForLoggedOutUser();
        setTimeout(()=>{ document.getElementById('splash')?.classList.add('fade-out'); setTimeout(()=>document.getElementById('splash')?.remove(),700); }, 900);
        return;
      }
      try{
        let doc = await db.collection("users").doc(user.uid).get();
        if(!doc.exists){
          isFirstLoginSession = true;
          await db.collection("users").doc(user.uid).set({
            name: user.email.split("@")[0], email: user.email, avatar: pendingChosenAvatar || "male",
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), isVerified:false, isOwner:false,
            blockedFromPosting:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp(), lastPromoAt: null
          },{merge:true});
          doc = await db.collection("users").doc(user.uid).get();
        }else{
          isFirstLoginSession = false;
          db.collection("users").doc(user.uid).set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() },{merge:true});
        }
        currentUser = { uid:user.uid, ...doc.data() };
      }catch(e){
        console.error("user load error:", e);
        currentUser = { uid:user.uid, name:user.email.split("@")[0], email:user.email, avatar: pendingChosenAvatar || "male", isVerified:false, blockedFromPosting:false, isOwner:false };
      }
      updateUIForLoggedInUser();
      await Promise.all([loadPostsFromFirestore(), loadCompanies(), fetchLatestBroadcast()]);
      await initChallengeAfterLogin();
      setTimeout(()=>{ document.getElementById('splash')?.classList.add('fade-out'); setTimeout(()=>document.getElementById('splash')?.remove(),700); }, 200);
      pendingChosenAvatar = null;
    });

    function isOwner(){ return currentUser && (currentUser.email===APP_OWNER_EMAIL || currentUser.isOwner===true); }

    function register(){
      const name=document.getElementById("register-name").value.trim();
      const email=document.getElementById("register-email").value.trim();
      const password=document.getElementById("register-password").value;
      const picked=(document.querySelector('input[name="register-avatar"]:checked')?.value)||"male";
      pendingChosenAvatar = picked;
      if(!name||!email||!password) return showNotification("يرجى ملء جميع الحقول","error");
      if(!validateEmail(email)) return showNotification("البريد الإلكتروني غير صالح","error");
      auth.createUserWithEmailAndPassword(email,password)
        .then(cred=>{
          return db.collection("users").doc(cred.user.uid).set({
            name,email,avatar:picked, createdAt:firebase.firestore.FieldValue.serverTimestamp(),
            isVerified:false,isOwner:false,blockedFromPosting:false,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp(), lastPromoAt: null
          },{merge:true});
        })
        .then(()=>{ showNotification("تم إنشاء الحساب. سجّل الدخول الآن.","success"); switchAuthTab('login'); })
        .catch(handleAuthError);
    }

    function login(){
      const email=document.getElementById("login-email").value.trim();
      const password=document.getElementById("login-password").value;
      if(!email||!password) return showNotification("يرجى ملء جميع الحقول","error");
      const btn = document.querySelector('#login-form button[type="submit"]');
      if (btn) { btn.disabled = true; btn.textContent = "جاري تسجيل الدخول…"; }
      auth.signInWithEmailAndPassword(email,password)
        .catch(handleAuthError)
        .finally(()=>{ if (btn) { btn.disabled = false; btn.textContent = "تسجيل الدخول"; } });
    }
    function logout(){ auth.signOut(); }

    // ===== Navigation =====
    function showPage(key){
      Object.values(pages).forEach(p=>p.style.display="none");
      pages[key].style.display = (key==="auth")?"flex":"block";
      updateBottomNav(key);
      if (key === "auth") { const sp = document.getElementById('splash'); if (sp) sp.remove(); }
    }
    function updateBottomNav(activePageKey) {
      document.querySelectorAll("#bottom-nav .nav-item").forEach(item => {
        item.classList.toggle("active", item.dataset.page === activePageKey);
      });
    }
    function showMainPage(){ showPage("main"); }
    function showProfilePage(){ showPage("profile"); }
    function showChallengePage(){ showPage("challenge"); }
    function backToProfile(){ showPage("profile"); }
    function backToMainFromDetails(){ showPage("main"); }
    function backToMainFromComments(){ showPage("main"); }

    function updateUIForLoggedInUser(){
      showPage("main");
      document.getElementById("profile-name").textContent = currentUser.name || "";
      document.getElementById("profile-email").textContent = currentUser.email || "";
      document.getElementById("profile-uid-input").value = currentUser.uid || "";
      renderAvatar(currentUser.avatar==="female"?"female":"male");
      const pv=document.getElementById("profile-verified");
      pv.innerHTML = currentUser.isVerified? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : '';
      document.querySelectorAll(".owner-only").forEach(el=> el.style.display = isOwner()? "flex":"none");
      updateCreateButton();
      updatePostCountInProfile();
    }
    function updateUIForLoggedOutUser(){
      showPage("auth"); 
      postsContainer.innerHTML=""; 
      companiesContainer.innerHTML=""; 
      posts=[]; companies=[]; currentUser=null;
      document.getElementById("broadcast-banner").classList.remove('show');
      document.getElementById("broadcast-overlay").classList.remove('show');
      stopLeaderboardListener(); stopQnaListener(); stopStudyInterval(); stopBoostInterval(); stopHeartbeatInterval();
    }
    function switchAuthTab(tab){
      document.querySelectorAll(".auth-tab, .auth-form").forEach(el=>el.classList.remove("active"));
      if(tab==="login"){ document.querySelector(".auth-tab:nth-child(1)").classList.add("active"); document.getElementById("login-form").classList.add("active"); }
      else{ document.querySelector(".auth-tab:nth-child(2)").classList.add("active"); document.getElementById("register-form").classList.add("active"); }
    }

    // ===== Sections =====
    function switchSection(section){
      activeSection = section;
      pillPosts.classList.toggle("active", section === "posts");
      pillCompanies.classList.toggle("active", section !== "posts");
      postsContainer.style.display = section === "posts" ? "block" : "none";
      companiesContainer.style.display = section !== "posts" ? "block" : "none";
      filterBox.style.display = section === "posts" ? "flex" : "none";
      updateCreateButton();
    }
    function updateCreateButton(){
      createBtnLabel.textContent = activeSection === "posts" ? "إنشاء منشور" : "إضافة شركة";
      const showForPosts = activeSection === "posts" && currentUser;
      const showForCompanies = activeSection !== "posts" && isOwner();
      createBtn.style.display = (showForPosts || showForCompanies) ? "inline-flex" : "none";
    }
    function onCreateButton(){ if(activeSection==="posts") openCreatePostModal(); else openCreateCompanyModal(); }

    // ===== Posts =====
    async function loadPostsFromFirestore(){
      try{
        const snap = await db.collection("posts").orderBy("createdAt", "desc").get();
        posts = snap.docs.map(d=>{
          const data=d.data(); const createdAt=data.createdAt?.toDate?data.createdAt.toDate():new Date(0);
          return { id:d.id, isPinned: !!data.isPinned, ...data, createdAt };
        });
        renderPosts();
        updatePostCountInProfile();
      }catch(e){ console.error(e); showNotification("خطأ في تحميل البيانات: "+(e.message||e),"error"); }
    }
    async function getUserMeta(uid){
      if(userMetaCache[uid]) return userMetaCache[uid];
      try{
        const u = await db.collection("users").doc(uid).get();
        const meta = { isVerified: !!u.data()?.isVerified, blockedFromPosting: !!u.data()?.blockedFromPosting };
        userMetaCache[uid]=meta; return meta;
      }catch{ return { isVerified:false, blockedFromPosting:false }; }
    }
    async function renderPosts(){
      postsContainer.innerHTML="";
      const filterMaterial = document.getElementById('filter-material').value;
      const filterStage = document.getElementById('filter-stage').value;
      const sorted=[...posts].sort((a,b)=>{
        if(a.isPinned && !b.isPinned) return -1; if(!a.isPinned && b.isPinned) return 1;
        return (b.createdAt?.getTime?.()||0)-(a.createdAt?.getTime?.()||0);
      });
      const filtered = sorted.filter(p => {
        const isVisible = p.status !== 'sold';
        const materialMatch = !filterMaterial || p.material === filterMaterial;
        const stageMatch = !filterStage || p.stage === filterStage;
        return isVisible && materialMatch && stageMatch;
      });
      if(filtered.length===0){ postsContainer.innerHTML='<div class="post"><p>لا توجد منشورات تطابق الفلتر</p></div>'; return; }
      const uids = [...new Set(filtered.map(p => p.userId).filter(Boolean))];
      await Promise.all(uids.map(async uid => { if(!userMetaCache[uid]) userMetaCache[uid] = await getUserMeta(uid); }));
      const frag = document.createDocumentFragment();
      for(const post of filtered){
        const meta = userMetaCache[post.userId] || {isVerified:false, blockedFromPosting:false};
        const card = document.createElement("div");
        card.className = `post ${post.isPinned?'pinned':''}`;
        card.innerHTML = generatePostHTML(post, meta, 'list');
        frag.appendChild(card);
      }
      postsContainer.appendChild(frag);
    }
    function generatePostHTML(post, meta, context = 'list') {
      const badge = meta.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : '';
      const pinRibbon = post.isPinned ? '<div class="pin-ribbon"><i class="fa-solid fa-thumbtack"></i> مثبت</div>' : '';
      let ownerTools = '';
      if (isOwner()) {
        const pinTxt = post.isPinned ? 'إلغاء التثبيت' : 'تثبيت';
        const verTxt = meta.isVerified ? 'إلغاء التوثيق' : 'توثيق';
        const banTxt = meta.blockedFromPosting ? 'إلغاء حظر النشر' : 'حظر النشر';
        ownerTools = `<div class="owner-tools">
            <button class="btn btn-xs" onclick="ownerTogglePin('${post.id}', ${post.isPinned ? 'true' : 'false'})"><i class="fa-solid fa-thumbtack"></i> ${pinTxt}</button>
            <button class="btn btn-xs" onclick="ownerToggleVerify('${post.userId}')"><i class="fa-solid fa-crown"></i> ${verTxt}</button>
            <button class="btn btn-xs" onclick="ownerToggleUserBanById('${post.userId}')"><i class="fa-solid fa-ban"></i> ${banTxt}</button>
            <button class="btn btn-danger btn-xs" onclick="ownerDeletePost('${post.id}')"><i class="fa-solid fa-trash"></i> حذف</button>
        </div>`;
      }
      const priceValue = Number(post.price);
      const priceLabel = (!isNaN(priceValue) && priceValue === 0) ? 'مجاناً' : `${priceValue.toLocaleString('ar-IQ')} د.ع`;
      const stageLabel = post.stage ? ({ "sades-elmi": "السادس العلمي", "sades-adabi": "السادس الادبي", "khames": "الخامس", "rabea": "الرابع", "thaleth-mut": "الثالث متوسط", "thani-mut": "الثاني متوسط", "awal-mut": "الاول متوسط", "sades-ibtidai": "السادس الابتدائي" })[post.stage] || "" : "";
      const userName = escapeHTML(post.userName||'مستخدم');
      const material = escapeHTML(post.material||'');
      const description = escapeHTML(post.description||'');
      let contactBtn="";
      if (post.contactMethod === "whatsapp" && post.whatsapp) { contactBtn = `<a class="btn" href="https://wa.me/${post.whatsapp}" target="_blank" rel="noopener">تواصل (واتساب)</a>`; } 
      else if (post.contactMethod === "telegram" && post.telegram) { contactBtn = `<button class="btn" onclick="openTelegram('${post.telegram}')">تواصل (تلكرام)</button>`; } 
      else if (post.contactMethod === "comments") { contactBtn = `<button class="btn" onclick="openCommentsPage('${post.id}')">تواصل (تعليقات)</button>`; }
      let actionButtons = '';
      if (context === 'list') { actionButtons = `<button class="btn btn-secondary" onclick="openDetailsPage('${post.id}')">تفاصيل المنشور</button>${contactBtn}`; } 
      else if (context === 'details') { 
        const reportedPosts = JSON.parse(localStorage.getItem('reportedPosts') || '[]');
        const isReported = reportedPosts.includes(post.id);
        const reportButton = isReported
            ? '<button class="btn btn-secondary" disabled><i class="fas fa-check"></i> تم الإبلاغ</button>'
            : `<button class="btn btn-secondary" onclick="reportPost('${post.id}')"><i class="fas fa-flag"></i> إبلاغ</button>`;
        actionButtons = `${reportButton}${contactBtn}`;
      } 
      else if (context === 'user-posts') {
        actionButtons = `
          <button class="btn btn-secondary" onclick="openDetailsPage('${post.id}')">تفاصيل</button> ${contactBtn}
          <button class="btn btn-secondary" onclick="openEditPostModal('${post.id}')"><i class="fas fa-edit"></i> تعديل</button>
          <button class="btn" onclick="repost('${post.id}')"><i class="fas fa-rotate-right"></i> إعادة نشر</button>
          <button class="btn btn-warning" onclick="markSold('${post.id}', ${post.status === 'sold' ? 'true' : 'false'})">${post.status === 'sold' ? 'إلغاء تم بيعه' : 'تم بيعه'}</button>
          <button class="btn btn-danger" onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i> حذف</button>`;
      }
      return `${pinRibbon}${ownerTools}<div class="post-header"><div class="post-username"><span>${userName}</span> ${badge}</div><div class="post-price">${priceLabel}</div><div class="post-title">${stageLabel?`${stageLabel} - `:''}${material}</div></div><div class="post-description">${description}</div><div class="post-actions">${actionButtons}</div>`;
    }
    let createPostBusy = false;
    function openCreatePostModal(){ document.getElementById("create-post-modal").style.display="block"; }
    function closeCreatePostModal(){ document.getElementById("create-post-modal").style.display="none"; }
    function changeContactMethod(prefix = ''){
      const methodEl = document.getElementById(`${prefix ? 'edit-' : ''}contact-method`);
      const w_field = document.getElementById(`${prefix ? 'edit-' : ''}whatsapp-field`);
      const t_field = document.getElementById(`${prefix ? 'edit-' : ''}telegram-field`);
      const method = methodEl ? methodEl.value : '';
      if(w_field) w_field.style.display = method==="whatsapp"?"block":"none"; 
      if(t_field) t_field.style.display = method==="telegram"?"block":"none";
    }
    async function createPost(){
      if(createPostBusy) return; if(!currentUser) return showNotification("يرجى تسجيل الدخول أولاً","error");
      try { 
        const udoc = await db.collection("users").doc(currentUser.uid).get(); 
        if(udoc.exists && udoc.data()?.blockedFromPosting){ return showNotification("تم حظرك من النشر","error"); } 
      } catch(e){ console.warn("check block failed", e); }
      const stage = document.getElementById("post-stage").value.trim(); 
      const price = document.getElementById("post-price").value.trim();
      const material = document.getElementById("post-material").value; 
      const description = document.getElementById("post-description").value.trim();
      const contactMethod = document.getElementById("contact-method").value; 
      const whatsapp = formatWhatsApp(document.getElementById("whatsapp-number").value);
      const telegram = sanitizeTelegram(document.getElementById("telegram-username").value); 
      if(!description) return showNotification("يرجى ملء الوصف","error");
      if (contactMethod==="whatsapp" && whatsapp.length !== 12) return showNotification("رقم واتساب غير صالح","error");
      if (contactMethod==="telegram" && !telegram) return showNotification("معرّف تلكرام غير صالح","error");
      createPostBusy = true; 
      const btn = document.getElementById("post-submit-btn"); btn.disabled = true;
      const newPost = { 
        userId:currentUser.uid, userName:currentUser.name, userEmail:currentUser.email||"", 
        stage, material, price: Number(price) || 0, description, contactMethod, 
        whatsapp: contactMethod==="whatsapp"?whatsapp:"", 
        telegram: contactMethod==="telegram"?telegram:"", 
        status:"active", isPinned:false, createdAt:firebase.firestore.FieldValue.serverTimestamp() 
      };
      try{ 
        await db.collection("posts").add(newPost); 
        closeCreatePostModal(); 
        await loadPostsFromFirestore(); 
        showNotification("تم نشر المنشور بنجاح","success");
      } catch(err){ showNotification("حدث خطأ أثناء النشر: "+(err.message||err),"error"); } 
      finally{ createPostBusy = false; btn.disabled = false; }
    }
    function openEditPostModal(postId) {
      const post = posts.find(p => p.id === postId); 
      if (!post) return showNotification("لم يتم العثور على المنشور", "error");
      document.getElementById('edit-post-id').value = postId; 
      document.getElementById('edit-post-stage').value = post.stage || 'sades-elmi';
      document.getElementById('edit-post-price').value = post.price || 0; 
      document.getElementById('edit-post-material').value = post.material || 'اسلامية';
      document.getElementById('edit-post-description').value = post.description || ''; 
      document.getElementById('edit-contact-method').value = post.contactMethod || 'whatsapp';
      document.getElementById('edit-whatsapp-number').value = post.whatsapp || ''; 
      document.getElementById('edit-telegram-username').value = post.telegram || '';
      changeContactMethod('edit'); 
      document.getElementById('edit-post-modal').style.display = 'block';
    }
    function closeEditPostModal() { document.getElementById('edit-post-modal').style.display = 'none'; }
    async function savePostEdits() {
      const postId = document.getElementById('edit-post-id').value; if (!postId) return;
      const updatedData = {
        stage: document.getElementById('edit-post-stage').value.trim(), 
        price: Number(document.getElementById('edit-post-price').value.trim()) || 0,
        material: document.getElementById('edit-post-material').value, 
        description: document.getElementById('edit-post-description').value.trim(),
        contactMethod: document.getElementById('edit-contact-method').value, 
        whatsapp: formatWhatsApp(document.getElementById('edit-whatsapp-number').value),
        telegram: sanitizeTelegram(document.getElementById('edit-telegram-username').value),
      };
      if (!updatedData.description) return showNotification("الوصف مطلوب", "error");
      if (updatedData.contactMethod==="whatsapp" && updatedData.whatsapp.length !== 12) return showNotification("رقم واتساب غير صالح","error");
      if (updatedData.contactMethod==="telegram" && !updatedData.telegram) return showNotification("معرّف تلكرام غير صالح","error");
      const btn = document.getElementById('post-edit-submit-btn'); btn.disabled = true;
      try {
        await db.collection('posts').doc(postId).update(updatedData); 
        showNotification('تم حفظ التعديلات', 'success');
        closeEditPostModal(); 
        await loadPostsFromFirestore();
        if (pages.userPosts.style.display === 'block') { showUserPosts(); }
      } catch (e) { showNotification('فشل حفظ التعديلات: ' + e.message, 'error'); } 
      finally { btn.disabled = false; }
    }
    async function showUserPosts(){
      if(!currentUser) return showNotification("يرجى تسجيل الدخول","warning"); 
      showPage("userPosts"); userPostsContainer.innerHTML="";
      const mine = posts.filter(p=>p.userId===currentUser.uid).sort((a,b)=> (b.createdAt?.getTime?.()||0)-(a.createdAt?.getTime?.()||0));
      if(mine.length===0){ userPostsContainer.innerHTML='<div class="post"><p>لا توجد منشورات لك</p></div>'; return; }
      for(const post of mine){
        const meta = await getUserMeta(post.userId); const div=document.createElement("div");
        div.className=`post ${post.status==='sold'?'sold':''} ${post.isPinned?'pinned':''}`;
        div.innerHTML = generatePostHTML(post, meta, 'user-posts'); userPostsContainer.appendChild(div);
      }
    }
    function updatePostCountInProfile(){ if(!currentUser) return; const count = posts.filter(p=>p.userId===currentUser?.uid).length; const el=document.getElementById("profile-count"); if(el) el.textContent = `عدد منشوراتك: ${count}`; }
    async function repost(postId){ const doc = await db.collection("posts").doc(postId).get(); if(!doc.exists || doc.data().userId !== currentUser.uid) return; await db.collection("posts").doc(postId).update({ createdAt:firebase.firestore.FieldValue.serverTimestamp(), status:'active' }); showNotification("تم إعادة النشر وتحديث التاريخ","success"); await loadPostsFromFirestore(); showUserPosts(); }
    async function markSold(postId,isSold){ const doc = await db.collection("posts").doc(postId).get(); if(!doc.exists || doc.data().userId !== currentUser.uid) return; await db.collection("posts").doc(postId).update({ status: isSold? 'active':'sold' }); showNotification(isSold?"تم إلغاء حالة البيع":"تم تحديد: تم بيعه","success"); await loadPostsFromFirestore(); showUserPosts(); }
    function deletePost(postId){ if(!currentUser || !confirm("هل أنت متأكد من حذف هذا المنشور؟")) return; db.collection("posts").doc(postId).get().then(doc=>{ if(!doc.exists || doc.data().userId !== currentUser.uid) return; return db.collection("posts").doc(postId).delete(); }).then(()=>{ showNotification("تم الحذف","success"); loadPostsFromFirestore(); showUserPosts(); }).catch(err=> showNotification("خطأ أثناء الحذف: "+(err.message||err),"error")); }
    function openDetailsPage(postId){ currentDetailsPostId = postId; showPage("details"); renderDetails(postId); }
    async function renderDetails(postId){
      detailsContainer.innerHTML = "<div class='post'><p>جاري التحميل...</p></div>";
      const post = posts.find(p=>p.id===postId); if(!post){ detailsContainer.innerHTML="<div class='post'><p>تعذر تحميل التفاصيل</p></div>"; return; }
      const meta = await getUserMeta(post.userId); const card = document.createElement("div");
      card.className = `post ${post.isPinned?'pinned':''}`; card.innerHTML = generatePostHTML(post, meta, 'details');
      detailsContainer.innerHTML = ''; detailsContainer.appendChild(card);
    }
    
    // ===== Comments =====
    async function openCommentsPage(postId) { if (!currentUser) return; currentCommentsPostId = postId; showPage("comments"); await renderComments(postId); }
    async function renderComments(postId) {
      const commentsListContainer = document.getElementById("comments-list-page");
      commentsListContainer.innerHTML = '<div class="post"><p>جاري تحميل التعليقات...</p></div>';
      try {
        const snap = await db.collection("posts").doc(postId).collection("comments").orderBy("createdAt", "asc").get();
        if (snap.empty) { commentsListContainer.innerHTML = '<div class="post"><p>لا توجد تعليقات بعد.</p></div>'; return; }
        commentsListContainer.innerHTML = snap.docs.map(doc => { const c = doc.data(); const d = c.createdAt?.toDate?c.createdAt.toDate().toLocaleString('ar-IQ'):''; return `<div class="post" style="margin-bottom:8px; padding:10px;"><div style="font-weight:bold;">${escapeHTML(c.userName||'مستخدم')}</div><p style="margin-top:5px;">${escapeHTML(c.text||'')}</p><small style="color:#777;">${d}</small></div>`; }).join('');
      } catch (e) { commentsListContainer.innerHTML = '<div class="post"><p>خطأ في تحميل التعليقات.</p></div>'; }
    }
    async function addCommentFromPage() {
      if (!currentUser || !currentCommentsPostId) return;
      const textInput = document.getElementById("comment-text-page"); const text = textInput.value.trim(); if (!text) return;
      const btn = document.getElementById('send-comment-btn'); btn.disabled = true;
      try {
        await db.collection("posts").doc(currentCommentsPostId).collection("comments").add({ text, userId: currentUser.uid, userName: currentUser.name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        textInput.value = ''; await renderComments(currentCommentsPostId);
      } catch (e) { showNotification('فشل إرسال التعليق', 'error'); } finally { btn.disabled = false; }
    }

    // ===== Challenge / Study Timer =====
    function switchChallengeTab(tabElement) {
      const tabName = tabElement.dataset.tab;
      document.querySelectorAll('.challenge-tab-pill, .challenge-tab-content').forEach(el => el.classList.remove('active'));
      tabElement.classList.add('active'); document.getElementById(`challenge-tab-${tabName}`).classList.add('active');
      if (tabName === 'leaderboard' && !leaderboardUnsub) startLeaderboardListener();
      if (tabName === 'qna' && !qnaUnsub) startQnaListener();
    }
    async function initChallengeAfterLogin(){ await loadStudyState(); switchChallengeTab(document.querySelector('.challenge-tab-pill[data-tab="timer"]')); }

    function startLeaderboardListener(){
      stopLeaderboardListener(); const lb = document.getElementById("challenge-leaderboard"); lb.innerHTML = "<div class='post'><p>جاري تحميل التصنيف...</p></div>";
      leaderboardUnsub = db.collection("study").orderBy("totalPoints","desc").limit(50)
        .onSnapshot( snap => { renderLeaderboard(snap.docs.map(d => ({ uid:d.id, ...d.data() }))); }, err => { lb.innerHTML = "<div class='post'><p>تعذّر تحميل التصنيف</p></div>"; });
    }
    function stopLeaderboardListener(){ if (leaderboardUnsub){ try{ leaderboardUnsub(); }catch{} leaderboardUnsub=null; } }
    function renderLeaderboard(items){
      const lb = document.getElementById("challenge-leaderboard"); if(!lb) return;
      if(!items || items.length===0){ lb.innerHTML = "<div class='post'><p>لا يوجد متنافسون بعد</p></div>"; return; }
      lb.innerHTML = items.map((it, idx) => {
        const points = it.totalPoints || 0; const cls = idx===0?'rank-1':(idx===1?'rank-2':(idx===2?'rank-3':''));
        const ownerDeleteBtn = isOwner() ? `<button class="btn btn-xs btn-danger" style="margin-right: auto;" onclick="ownerRemoveFromLeaderboard('${it.uid}', '${escapeHTML(it.name||'مستخدم')}')"><i class="fa-solid fa-trash"></i></button>` : '';
        return `<div class="rank-card ${cls}"><div class="rank-left"><div class="rank-badge">${idx+1}</div><div class="rank-name">${escapeHTML(it.name||'مستخدم')}</div></div>${ownerDeleteBtn}<div class="rank-points">${points.toLocaleString('ar-IQ')} نقطة</div></div>`;
      }).join("");
    }
    async function ownerRemoveFromLeaderboard(uid, name) {
      if (!isOwner()) return showNotification("غير مصرح لك", "error");
      if (!confirm(`هل أنت متأكد من حذف المستخدم "${name}" من التصنيف؟ سيتم حذف جميع نقاطه وسجله في التحدي.`)) return;
      try { await db.collection('study').doc(uid).delete(); showNotification(`تم حذف "${name}" من التصنيف بنجاح.`, 'success');
      } catch (e) { showNotification("فشل الحذف: " + e.message, "error"); }
    }

    async function loadStudyState(){
      if(!currentUser) return;
      try{
        const ref = db.collection("study").doc(currentUser.uid);
        const sdoc = await ref.get();
        if(sdoc.exists){
          const s = sdoc.data();
          const lastPing = s.lastPingAt?.toDate ? s.lastPingAt.toDate() : null;
          const runStart = s.startAt?.toDate ? s.startAt.toDate() : null;
          const now = new Date();
          if (s.running && lastPing && (now - lastPing) > 3*3600*1000 && runStart) {
            const elapsedSeconds = Math.max(0, Math.floor((lastPing - runStart) / 1000));
            const boosted = (s.boostUntil?.toDate && s.boostUntil.toDate() > runStart)
              ? Math.max(0, Math.floor((Math.min(lastPing, s.boostUntil.toDate()) - runStart) / 1000))
              : 0;
            const effectiveSeconds = elapsedSeconds + boosted;
            const pointsEarned = Math.floor(effectiveSeconds / 180);
            await ref.set({
              running:false, startAt:null,
              totalPoints: firebase.firestore.FieldValue.increment(pointsEarned),
              currentPoints: firebase.firestore.FieldValue.increment(pointsEarned)
            }, {merge:true});
            s.running = false;
          }

          studyState = { 
            totalSeconds: 0, 
            totalPoints: Number(s.totalPoints||0), 
            currentPoints: Number(s.currentPoints||0), 
            running: !!s.running, 
            startAtMs: s.startAt?.toDate?s.startAt.toDate().getTime():null, 
            boostUntil: s.boostUntil?.toDate?s.boostUntil.toDate():null, 
          };
          if (studyState.running && !studyState.startAtMs) { studyState.running = false; }
        } else { 
          studyState = { running:false, totalSeconds:0, totalPoints:0, currentPoints:0, startAtMs:null, boostUntil:null }; 
        }
        renderTimerUI(); 
        if (studyState.running) { startStudyInterval(); startHeartbeatInterval(); }
        if (studyState.boostUntil && studyState.boostUntil > new Date()) startBoostInterval();
      }catch(e){ console.error("loadStudyState error:", e); }
    }
    function renderTimerUI(){
      const disp = document.getElementById("timer-display"); 
      const startBtn = document.getElementById("timer-start-btn");
      const stopBtn = document.getElementById("timer-stop-btn"); 
      const pointsDisp = document.getElementById("current-points-display");
      const isBoostActive = studyState.boostUntil && studyState.boostUntil > new Date();
      const boostIndicator = isBoostActive ? ' <span style="color: #ff8c00; font-size: 16px;">(2x)</span>' : '';
      let totalSecondsToDisplay = 0;
      if (studyState.running && studyState.startAtMs) {
        const elapsedMs = Date.now() - studyState.startAtMs;
        const effectiveElapsedMs = isBoostActive ? elapsedMs * 2 : elapsedMs;
        const currentSessionSeconds = Math.floor(effectiveElapsedMs / 1000);
        totalSecondsToDisplay += currentSessionSeconds;
      }
      if(disp) disp.innerHTML = `${formatDuration(totalSecondsToDisplay)}${boostIndicator}`;
      if(startBtn) startBtn.disabled = !!studyState.running;
      if(stopBtn) stopBtn.disabled = !studyState.running; 
      if(pointsDisp) pointsDisp.textContent = studyState.currentPoints.toLocaleString('ar-IQ');
    }
    function startStudyInterval() { stopStudyInterval(); studyInterval = setInterval(renderTimerUI, 1000); }
    function stopStudyInterval(){ if(studyInterval){ clearInterval(studyInterval); studyInterval=null; } }
    function startHeartbeatInterval(){
      stopHeartbeatInterval();
      lastHeartbeatSentAt = 0;
      heartbeatInterval = setInterval(async ()=>{
        if (!studyState.running || !currentUser) return;
        const now = Date.now();
        if (now - lastHeartbeatSentAt < 60000) return;
        lastHeartbeatSentAt = now;
        try{
          await Promise.all([
            db.collection('study').doc(currentUser.uid).set({ lastPingAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true}),
            db.collection('users').doc(currentUser.uid).set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true})
          ]);
        }catch(e){}
      }, 5000);
    }
    function stopHeartbeatInterval(){ if (heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval=null; } }

    async function startStudyTimer(){
      if(studyBusy || !currentUser) return; studyBusy = true;
      try{
        const ref = db.collection("study").doc(currentUser.uid);
        await ref.set({ 
          name: currentUser.name || currentUser.email || 'مستخدم',
          running: true, 
          startAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastPingAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        const again = await ref.get();
        if (again.exists) { 
          const s = again.data(); 
          studyState.running = true; 
          studyState.startAtMs = s.startAt?.toDate?s.startAt.toDate().getTime():Date.now(); 
        } else {
          studyState.running = true; studyState.startAtMs = Date.now();
        }
        startStudyInterval(); startHeartbeatInterval(); renderTimerUI(); showNotification("بدأ التحدي. بالتوفيق!","success");
      }catch(e){ showNotification("تعذّر بدء العداد","error"); } finally{ studyBusy = false; }
    }
    async function stopStudyTimer(){
      if(studyBusy || !currentUser || !studyState.running) return; studyBusy = true; stopStudyInterval(); stopHeartbeatInterval();
      try {
        const ref = db.collection("study").doc(currentUser.uid);
        await db.runTransaction(async (tx) => {
          const sdoc = await tx.get(ref); if (!sdoc.exists || !sdoc.data().running) { return; }
          const s = sdoc.data(); 
          let stopAt = new Date();
          const lastPing = s.lastPingAt?.toDate ? s.lastPingAt.toDate() : null;
          if (lastPing && (new Date() - lastPing) > 3*3600*1000) stopAt = lastPing;
          let elapsedSeconds = 0; 
          if (s.startAt?.toDate) { elapsedSeconds = Math.max(0, Math.floor((stopAt.getTime() - s.startAt.toDate().getTime()) / 1000)); }
          let effectiveSeconds = elapsedSeconds;
          if (s.boostUntil?.toDate && s.boostUntil.toDate() > s.startAt.toDate()) {
            const boostStart = s.startAt.toDate(); 
            const boostEnd = s.boostUntil.toDate(); 
            const boostedDuration = Math.max(0, (Math.min(stopAt, boostEnd) - boostStart) / 1000); 
            effectiveSeconds += boostedDuration;
          }
          const pointsEarned = Math.floor(effectiveSeconds / 180);
          tx.update(ref, { 
            running: false, startAt: null, 
            totalPoints: firebase.firestore.FieldValue.increment(pointsEarned), 
            currentPoints: firebase.firestore.FieldValue.increment(pointsEarned)
          });
          studyState.currentPoints += pointsEarned;
          studyState.totalPoints += pointsEarned;
        });
        studyState.running = false; studyState.startAtMs = null; 
        renderTimerUI(); 
        showNotification("تم إيقاف العداد وتحويل الوقت إلى نقاط", "success");
      } catch (e) { showNotification("تعذر إيقاف العداد، حاول مرة أخرى", "error"); if (studyState.running) startStudyInterval(); } 
      finally { studyBusy = false; }
    }
    async function buyBoost() {
      if (!currentUser || studyState.currentPoints < 75 || !confirm("هل تريد شراء تسريع 2x لمدة ساعة مقابل 75 نقطة؟")) return;
      try {
        const ref = db.collection("study").doc(currentUser.uid);
        await db.runTransaction(async (tx) => {
          const doc = await tx.get(ref); const currentPoints = doc.exists?(doc.data().currentPoints || 0):0;
          if (currentPoints < 75) throw new Error("نقاط غير كافية");
          const now = new Date(); const currentBoostUntil = doc.exists && doc.data().boostUntil?.toDate()?doc.data().boostUntil.toDate():now;
          const newBoostTimestamp = Math.max(now.getTime(), currentBoostUntil.getTime()) + 60 * 60 * 1000;
          const newBoostUntil = new Date(newBoostTimestamp);
          tx.set(ref, { name: currentUser.name || currentUser.email || 'مستخدم', currentPoints: currentPoints - 75, boostUntil: newBoostUntil }, { merge: true });
          studyState.currentPoints -= 75; studyState.boostUntil = newBoostUntil;
        });
        showNotification("تم تفعيل التسريع بنجاح!", "success"); startBoostInterval(); renderTimerUI();
      } catch (e) { showNotification("فشلت عملية الشراء: " + e.message, "error"); }
    }
    function startBoostInterval() { stopBoostInterval(); updateBoostStatus(); boostInterval = setInterval(updateBoostStatus, 1000); }
    function stopBoostInterval() { if(boostInterval) clearInterval(boostInterval); boostInterval = null; }
    function updateBoostStatus() {
      const statusEl = document.getElementById('boost-status'); if (!statusEl || !studyState.boostUntil) { if(statusEl) statusEl.textContent = ''; stopBoostInterval(); return; }
      const timeLeftMs = studyState.boostUntil.getTime() - Date.now(); if (timeLeftMs <= 0) { statusEl.textContent = ''; studyState.boostUntil = null; stopBoostInterval(); renderTimerUI(); return; }
      const m = Math.floor(timeLeftMs / 60000); const s = Math.floor((timeLeftMs % 60000) / 1000);
      statusEl.textContent = `التسريع مفعل! الوقت المتبقي: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    function formatDuration(sec){ sec=Math.max(0,Math.floor(Number(sec)||0)); const h=Math.floor(sec/3600); sec-=h*3600; const m=Math.floor(sec/60); const s=sec-m*60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

    // --- Q&A Challenge ---
    function openCreateQnaModal() { document.getElementById('create-qna-modal').style.display = 'block'; }
    function closeCreateQnaModal() { document.getElementById('create-qna-modal').style.display = 'none'; }
    function openAnswerQnaModal() { document.getElementById('answer-qna-modal').style.display = 'block'; }
    function closeAnswerQnaModal() { document.getElementById('answer-qna-modal').style.display = 'none'; }

    async function createQnaChallenge() {
      if (!currentUser) return;
      const question = document.getElementById('qna-question').value.trim();
      const prize = parseInt(document.getElementById('qna-prize').value, 10);
      const material = document.getElementById('qna-material').value;
      const options = [
        document.getElementById('qna-option-1').value.trim(),
        document.getElementById('qna-option-2').value.trim(),
        document.getElementById('qna-option-3').value.trim(),
      ];
      const correctIndex = parseInt(document.querySelector('input[name="qna-correct"]:checked').value, 10);
      if (!question || !material || options.some(o => !o) || !Number.isFinite(prize) || prize <= 0) {
        return showNotification('يرجى ملء جميع الحقول بجائزة صالحة', 'error');
      }
      if (prize > studyState.currentPoints) {
        return showNotification('رصيدك غير كافٍ', 'error');
      }
      const btn = document.querySelector('#create-qna-modal .btn:last-child'); btn.disabled = true;
      try {
        const ref = db.collection("study").doc(currentUser.uid);
        await db.runTransaction(async (tx) => {
          const sdoc = await tx.get(ref); 
          if (!sdoc.exists || (sdoc.data().currentPoints || 0) < prize) throw new Error("نقاط غير كافية");
          tx.update(ref, { currentPoints: firebase.firestore.FieldValue.increment(-prize), name: currentUser.name || currentUser.email || 'مستخدم' });
          const challengeRef = db.collection('qna_challenges').doc();
          tx.set(challengeRef, { 
            creatorUid: currentUser.uid, 
            creatorName: currentUser.name || 'مستخدم', 
            question, material, options, correctIndex, prize, 
            status: 'open', createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
          });
        });
        showNotification('تم إنشاء السؤال بنجاح', 'success'); 
        closeCreateQnaModal(); 
        studyState.currentPoints -= prize; 
        renderTimerUI();
      } catch (e) { showNotification('فشل إنشاء السؤال: ' + e.message, 'error'); } 
      finally { btn.disabled = false; }
    }

    function startQnaListener() {
      stopQnaListener(); 
      const container = document.getElementById('qna-list-container'); 
      container.innerHTML = "<div class='post'><p>جاري التحميل...</p></div>";
      qnaUnsub = db.collection('qna_challenges').where('status', '==', 'open')
        .onSnapshot( snap => { 
          const challenges = snap.docs.map(d => ({ id: d.id, ...d.data() })); 
          challenges.sort((a,b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0)); 
          renderQnaList(challenges); 
        }, err => { container.innerHTML = "<p>خطأ في التحميل</p>"; } );
    }
    function stopQnaListener() { if (qnaUnsub) { qnaUnsub(); qnaUnsub = null; } }
    function renderQnaList(challenges) {
      const container = document.getElementById('qna-list-container');
      if (challenges.length === 0) { container.innerHTML = "<div class='post'><p>لا توجد أسئلة متاحة حالياً</p></div>"; return; }
      container.innerHTML = challenges.map(c => {
        let actionButtons = '';
        if (c.creatorUid !== currentUser.uid) { actionButtons = `<div class="qna-actions"><button class="btn btn-success" onclick="acceptQnaChallenge('${c.id}')">أجب عن السؤال</button></div>`; } 
        else { actionButtons = '<div class="muted" style="margin-top:8px;">هذا سؤالك.</div>'; }
        if (isOwner() || c.creatorUid === currentUser.uid) { actionButtons += `<div class="qna-actions" style="margin-top: 5px;"><button class="btn btn-danger btn-xs" onclick="deleteQnaChallenge('${c.id}')"><i class="fas fa-trash"></i> حذف السؤال</button></div>`; }
        return `<div class="qna-card">
          <div class="qna-header"><div class="qna-creator">سؤال من: ${escapeHTML(c.creatorName||'مستخدم')}</div><div class="qna-prize">${c.prize} نقطة <i class="fa-solid fa-star" style="color:#ffc107;"></i></div></div>
          <div class="muted" style="margin-top:4px;font-weight:700;">المادة: <span style="color:var(--primary-color);">${escapeHTML(c.material||'غير محدد')}</span></div>
          ${actionButtons}</div>`;
      }).join('');
    }
    async function deleteQnaChallenge(challengeId) {
      if (!currentUser || !confirm("هل أنت متأكد من حذف هذا السؤال؟")) return;
      try { await db.collection('qna_challenges').doc(challengeId).delete(); showNotification("تم حذف السؤال بنجاح", "success");
      } catch (e) { showNotification("فشل حذف السؤال: " + e.message, "error"); }
    }
    async function acceptQnaChallenge(challengeId) {
      if (!currentUser) return; 
      const challengeDoc = await db.collection('qna_challenges').doc(challengeId).get();
      if (!challengeDoc.exists) return showNotification("السؤال لم يعد متاحاً", "error");
      const challenge = { id: challengeDoc.id, ...challengeDoc.data() };
      if (challenge.creatorUid === currentUser.uid) { return showNotification("لا يمكنك الإجابة على سؤالك", "warning"); }

      document.getElementById('answer-qna-text').textContent = challenge.question;
      const optionsContainer = document.getElementById('answer-qna-options');

      const shuffled = challenge.options.map((text, idx) => ({ text, idx })).sort(() => Math.random() - 0.5);
      optionsContainer.innerHTML = shuffled.map(opt =>
        `<button class="btn btn-block btn-secondary" onclick="submitQnaAnswer('${challenge.id}', ${opt.idx})">${escapeHTML(opt.text)}</button>`
      ).join('');
      openAnswerQnaModal();
    }

    // *** تم استبدال منطق الإجابة: لا نلمس أرصدة الآخرين من المتصفح.
    async function submitQnaAnswer(challengeId, chosenIndex) {
      if (!currentUser) return; 
      closeAnswerQnaModal();
      const challengeRef = db.collection('qna_challenges').doc(challengeId);
      let isCorrectLocal = false;
      try {
        await db.runTransaction(async (tx) => {
          const snap = await tx.get(challengeRef);
          if (!snap.exists) throw new Error('السؤال غير موجود');
          const ch = snap.data();
          if (ch.status !== 'open') throw new Error('تمت الإجابة على هذا السؤال مسبقًا');
          if (ch.creatorUid === currentUser.uid) throw new Error('لا يمكنك الإجابة على سؤالك');

          const correctIndex = Number(ch.correctIndex || 0);
          isCorrectLocal = (Number(chosenIndex) === correctIndex);

          tx.update(challengeRef, {
            status: 'answered',
            answeredBy: { uid: currentUser.uid, name: currentUser.name || 'مستخدم' },
            isCorrect: isCorrectLocal,
            answeredAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });

        if (isCorrectLocal) {
          showNotification('إجابة صحيحة! سيتم تحديث رصيدك خلال لحظات.', 'success');
        } else {
          showNotification('إجابة خاطئة! سيتم خصم/تحويل النقاط خلال لحظات.', 'error');
        }
        setTimeout(loadStudyState, 1500);
      } catch (e) {
        showNotification('حدث خطأ: ' + (e.message || e), 'error');
      }
    }

    // --- Owner Tools ---
    function openAddPointsModal() { document.getElementById('add-points-modal').style.display = 'block'; }
    function closeAddPointsModal() { document.getElementById('add-points-modal').style.display = 'none'; }
    async function ownerAddPoints() {
      if (!isOwner()) return; 
      const uid = document.getElementById('add-points-uid').value.trim();
      const amount = parseInt(document.getElementById('add-points-amount').value, 10);
      if (!uid || !amount || amount <= 0) return showNotification("يرجى إدخال UID وكمية صالحة", "error");
      const btn = document.querySelector('#add-points-modal .btn:last-child'); btn.disabled = true;
      try {
        const userDoc = await db.collection('users').doc(uid).get(); if (!userDoc.exists) { throw new Error("المستخدم غير موجود."); }
        const userName = userDoc.data().name || 'مستخدم'; const ref = db.collection('study').doc(uid);
        await ref.set({ uid, name: userName, totalPoints: firebase.firestore.FieldValue.increment(amount), currentPoints: firebase.firestore.FieldValue.increment(amount) }, { merge: true });
        showNotification(`تمت إضافة ${amount} نقطة للمستخدم ${userName}`, 'success'); closeAddPointsModal();
        document.getElementById('add-points-uid').value = ''; document.getElementById('add-points-amount').value = '';
      } catch (e) { showNotification("فشل إضافة النقاط: " + e.message, "error"); } finally { btn.disabled = false; }
    }

    // ===== Clipboard UID =====
    function copyUidToClipboard() {
      if (!currentUser || !currentUser.uid) return;
      const uid = currentUser.uid;
      const input = document.getElementById('profile-uid-input');
      if (input) { input.focus(); input.select(); }
      const fallback = () => {
        const ta = document.createElement('textarea');
        ta.value = uid;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        let ok = false;
        try { ok = document.execCommand('copy'); } catch {}
        document.body.removeChild(ta);
        return ok;
      };
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(uid)
          .then(()=> showNotification('تم نسخ الـID بنجاح!', 'success'))
          .catch(()=> { if (fallback()) showNotification('تم نسخ الـID!', 'success'); else showNotification('فشل النسخ. انسخ يدويًا من الحقل.', 'error'); });
      } else {
        if (fallback()) showNotification('تم نسخ الـID!', 'success');
        else showNotification('فشل النسخ. انسخ يدويًا من الحقل.', 'error');
      }
    }

    // ===== Inbox & Reports =====
    async function showInbox() {
      showPage("inbox"); 
      const container = document.getElementById("inbox-container");
      container.innerHTML = '<div class="post"><p>جاري تحميل البيانات...</p></div>';
      try{
        if (isOwner()) { await renderOwnerInbox(); } else { await renderUserInbox(); }
      }catch(e){
        container.innerHTML = '<div class="post"><p>خطأ في تحميل البيانات.</p></div>';
        console.error(e);
      }
    }
    async function renderOwnerInbox() {
      const container = document.getElementById("inbox-container");
      try {
        // بدون orderBy لتجنّب فهرس مركّب؛ سنرتّب محليًا
        const snap = await db.collection('reports').where('status', '==', 'pending').get();
        if (snap.empty) { container.innerHTML = '<div class="post" style="text-align:center;"><p>لا توجد بلاغات جديدة للمراجعة.</p></div>'; return; }
        const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        items.sort((a,b) => (b.createdAt?.toMillis?.()||0) - (a.createdAt?.toMillis?.()||0));
        let html = '<h2>البلاغات الجديدة</h2>';
        for (const report of items) {
          html += `<div class="post">
            <p><b>سبب البلاغ:</b> ${escapeHTML(report.reason||'')}</p>
            <p class="muted" style="margin: 8px 0; border-left: 3px solid #eee; padding-left: 8px;"><b>اقتباس:</b> "${escapeHTML(report.postDescriptionSnippet||'')}..."</p>
            <p><small><b>المبلغ:</b> ${escapeHTML(report.reporterName||'')}</small></p>
            <div class="post-actions" style="margin-top: 15px;">
              <button class="btn btn-secondary btn-xs" onclick="openDetailsPage('${report.postId}')">عرض المنشور</button>
              <button class="btn btn-warning btn-xs" onclick="resolveReport('${report.id}', 'ban_post_owner', '${report.postOwnerUid}')">حظر صاحب المنشور</button>
              <button class="btn btn-warning btn-xs" onclick="resolveReport('${report.id}', 'ban_reporter', '${report.reporterUid}')">حظر المُبلّغ</button>
              <button class="btn btn-success btn-xs" onclick="resolveReport('${report.id}', 'reject_report', null)">رفض البلاغ</button>
            </div></div>`;
        }
        container.innerHTML = html;
      } catch (e) { 
        container.innerHTML = '<div class="post"><p>خطأ في تحميل البلاغات.</p></div>'; 
        console.error(e); 
      }
    }
    async function renderUserInbox() {
      const container = document.getElementById("inbox-container");
      try {
        const snap = await db.collection('reports').where('reporterUid', '==', currentUser.uid).get();
        if (snap.empty) { container.innerHTML = '<div class="post" style="text-align:center;"><p>ليس لديك أي بلاغات مرسلة.</p></div>'; return; }
        const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        items.sort((a,b) => (b.createdAt?.toMillis?.()||0) - (a.createdAt?.toMillis?.()||0));
        let html = '<h2>حالة بلاغاتك</h2>';
        for (const report of items) {
          html += `<div class="post">
            <p><b>سبب البلاغ:</b> ${escapeHTML(report.reason||'')}</p>
            <p class="muted" style="margin: 8px 0; border-left: 3px solid #eee; padding-left: 8px;"><b>عن منشور:</b> "${escapeHTML(report.postDescriptionSnippet||'')}..."</p>
            <p><b>الحالة:</b> ${escapeHTML(formatReportStatus(report.status))}</p></div>`;
        }
        container.innerHTML = html;
      } catch (e) { container.innerHTML = '<div class="post"><p>خطأ في تحميل بلاغاتك.</p></div>'; console.error(e); }
    }
    async function resolveReport(reportId, action, targetUid) {
      if (!isOwner()) return;
      const confirmMessages = { 'ban_post_owner': 'هل أنت متأكد من حظر صاحب المنشور؟', 'ban_reporter': 'هل أنت متأكد من حظر المُبلّغ؟', 'reject_report': 'هل أنت متأكد من رفض هذا البلاغ؟' };
      if (!confirm(confirmMessages[action])) return;
      try {
        let newStatus = '';
        if (action === 'ban_post_owner') { await db.collection('users').doc(targetUid).update({ blockedFromPosting: true }); newStatus = 'تم الحل (تم حظر صاحب المنشور)'; } 
        else if (action === 'ban_reporter') { await db.collection('users').doc(targetUid).update({ blockedFromPosting: true }); newStatus = 'تم الحل (بلاغ كاذب)'; } 
        else if (action === 'reject_report') { newStatus = 'تم الرفض'; }
        await db.collection('reports').doc(reportId).update({ status: newStatus });
        showNotification("تم اتخاذ الإجراء بنجاح", "success"); await renderOwnerInbox();
      } catch (e) { showNotification("فشل اتخاذ الإجراء: " + e.message, "error"); }
    }
    function formatReportStatus(status) {
      if (status === 'pending') return 'قيد المراجعة';
      return status || '';
    }
    async function reportPost(postId) {
      if (!currentUser) return showNotification("يرجى تسجيل الدخول أولاً", "warning");
      const reportedPosts = JSON.parse(localStorage.getItem('reportedPosts') || '[]');
      if (reportedPosts.includes(postId)) { return showNotification("لقد أبلغت عن هذا المنشور مسبقاً", "info"); }
      const reason = prompt("يرجى ذكر سبب الإبلاغ عن هذا المنشور:", "");
      if (!reason || reason.trim().length < 5) { return showNotification("يجب ذكر سبب واضح للإبلاغ", "error"); }
      const btn = document.querySelector(`.btn[onclick="reportPost('${postId}')"]`); if(btn) btn.disabled = true;
      try {
        const postDoc = await db.collection('posts').doc(postId).get(); if (!postDoc.exists) throw new Error("المنشور غير موجود.");
        const postData = postDoc.data();
        await db.collection('reports').add({ postId, postDescriptionSnippet: (postData.description||'').substring(0, 100), postOwnerUid: postData.userId, reason, reporterUid: currentUser.uid, reporterName: currentUser.name, status: 'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        showNotification("تم إرسال بلاغك بنجاح.", "success");
        reportedPosts.push(postId); localStorage.setItem('reportedPosts', JSON.stringify(reportedPosts));
        if(pages.details.style.display === 'block') { renderDetails(postId); } else { renderPosts(); }
      } catch (e) { showNotification("فشل إرسال البلاغ: " + e.message, "error"); } finally { if(btn) btn.disabled = false; }
    }

    // ===== Company Functions =====
    function populateGovernorateSelects(selectId) { 
      const select = document.getElementById(selectId); 
      if (!select.dataset.populated) { 
        select.innerHTML = GOVERNORATES.map(g => `<option value="${g}">${g}</option>`).join(''); 
        select.dataset.populated = "true"; 
      } 
    }
    function openCreateCompanyModal() { if (!isOwner()) return; populateGovernorateSelects('company-from'); populateGovernorateSelects('company-to'); document.getElementById('create-company-modal').style.display = 'block'; }
    function closeCreateCompanyModal() { document.getElementById('create-company-modal').style.display = 'none'; }
    async function createCompany() {
      if (!isOwner()) return; 
      const data = { 
        name: document.getElementById('company-name').value.trim(), 
        from: document.getElementById('company-from').value, 
        to: document.getElementById('company-to').value, 
        phone: document.getElementById('company-phone').value.trim(), 
        desc: document.getElementById('company-desc').value.trim(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      if (!data.name || !data.phone || !data.from || !data.to) { return showNotification("يرجى ملء جميع الحقول المطلوبة", "error"); }
      const btn = document.getElementById('company-submit-btn'); btn.disabled = true;
      try { await db.collection('companies').add(data); showNotification("تمت إضافة الشركة بنجاح", "success"); closeCreateCompanyModal(); await loadCompanies(); } 
      catch (e) { showNotification("فشل إضافة الشركة: " + e.message, "error"); } 
      finally { btn.disabled = false; }
    }
    function openEditCompanyModal(companyId) { 
      const company = companies.find(c => c.id === companyId); if (!company) return; 
      populateGovernorateSelects('edit-company-from'); populateGovernorateSelects('edit-company-to'); 
      document.getElementById('edit-company-from').value = company.from; 
      document.getElementById('edit-company-to').value = company.to; 
      document.getElementById('edit-company-id').value = company.id; 
      document.getElementById('edit-company-name').value = company.name; 
      document.getElementById('edit-company-phone').value = company.phone; 
      document.getElementById('edit-company-desc').value = company.desc || ''; 
      document.getElementById('edit-company-modal').style.display = 'block'; 
    }
    function closeEditCompanyModal() { document.getElementById('edit-company-modal').style.display = 'none'; }
    async function saveCompanyEdits() {
      const companyId = document.getElementById('edit-company-id').value; 
      const updatedData = { 
        name: document.getElementById('edit-company-name').value.trim(), 
        from: document.getElementById('edit-company-from').value, 
        to: document.getElementById('edit-company-to').value, 
        phone: document.getElementById('edit-company-phone').value.trim(), 
        desc: document.getElementById('edit-company-desc').value.trim(), 
      };
      if (!updatedData.name || !updatedData.phone) { return showNotification("اسم الشركة ورقم الهاتف حقول مطلوبة", "error"); }
      try { await db.collection('companies').doc(companyId).update(updatedData); showNotification("تم حفظ التعديلات بنجاح", "success"); closeEditCompanyModal(); await loadCompanies(); } 
      catch (e) { showNotification("فشل حفظ التعديلات", "error"); }
    }
    async function deleteCompany(companyId){
      if (!isOwner()) return;
      if (!confirm("حذف هذه الشركة؟")) return;
      try{ await db.collection('companies').doc(companyId).delete(); showNotification("تم حذف الشركة","success"); await loadCompanies(); }
      catch(e){ showNotification("فشل الحذف: "+e.message,"error"); }
    }
    async function loadCompanies(){
      try{
        const snap = await db.collection('companies').orderBy('createdAt','desc').get();
        companies = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        renderCompanies();
      }catch(e){ companiesContainer.innerHTML = '<div class="post"><p>خطأ في تحميل شركات التوصيل</p></div>'; }
    }
    function renderCompanies(){
      companiesContainer.innerHTML = '';
      if (!companies || companies.length===0){ companiesContainer.innerHTML = '<div class="post"><p>لا توجد شركات مسجلة.</p></div>'; return; }
      for(const c of companies){
        const div = document.createElement('div');
        div.className = 'company';
        div.innerHTML = `
          <div class="name">${c.name}</div>
          <div class="route">من: <b>${c.from}</b> &nbsp;|&nbsp; إلى: <b>${c.to}</b></div>
          <div class="phone"><i class="fa fa-phone"></i> ${c.phone}</div>
          ${c.desc? `<div class="desc">${c.desc}</div>` : ''}
          ${isOwner()? `<div class="post-actions" style="margin-top:10px;">
            <button class="btn btn-secondary btn-xs" onclick="openEditCompanyModal('${c.id}')"><i class="fa fa-edit"></i> تعديل</button>
            <button class="btn btn-danger btn-xs" onclick="deleteCompany('${c.id}')"><i class="fa fa-trash"></i> حذف</button>
          </div>`:``}
        `;
        companiesContainer.appendChild(div);
      }
    }

    // ===== Reward =====
    function claimReward() { showPage('reward'); }
    async function verifyRewardSubscription() {
      if (!currentUser) return; 
      const btn = document.querySelector('#reward-page .btn-success'); 
      btn.disabled = true;
      try {
        const uref = db.collection("users").doc(currentUser.uid); 
        const udoc = await uref.get(); 
        const now = Date.now();
        const lastClaim = udoc.data()?.lastPromoAt?.toDate()?.getTime();
        if (lastClaim && (now - lastClaim < 24 * 60 * 60 * 1000)) { showNotification("لقد حصلت على المكافأة بالفعل. تعال غداً!", "warning"); return; }
        const studyRef = db.collection("study").doc(currentUser.uid);
        await db.runTransaction(async (tx) => { 
          tx.set(studyRef, { name: currentUser.name || currentUser.email || 'مستخدم', currentPoints: firebase.firestore.FieldValue.increment(20), totalPoints: firebase.firestore.FieldValue.increment(20) }, { merge: true }); 
          tx.update(uref, { lastPromoAt: firebase.firestore.FieldValue.serverTimestamp() }); 
        });
        await loadStudyState(); showNotification("تهانينا! تمت إضافة 20 نقطة إلى حسابك!", "success"); backToProfile();
      } catch (e) { showNotification("حدث خطأ: " + e.message, "error"); } finally { btn.disabled = false; }
    }

    // ===== Profile edit / avatar =====
    function editProfileName() { if (!currentUser) return; document.getElementById('new-name').value = currentUser.name; document.getElementById('edit-name-modal').style.display = 'block'; }
    async function saveProfileName() {
      if (!currentUser) return; 
      const newName = document.getElementById('new-name').value.trim();
      if (newName.length < 3) { return showNotification("يجب أن يكون الاسم 3 أحرف على الأقل", "error"); }
      const btn = document.querySelector('#edit-name-modal .btn:last-child'); btn.disabled = true;
      try { 
        await db.collection('users').doc(currentUser.uid).update({ name: newName }); 
        currentUser.name = newName;
        document.getElementById('profile-name').textContent = newName; 
        showNotification("تم تحديث الاسم بنجاح", "success"); 
        closeEditNameModal();
      } catch (e) { showNotification("فشل تحديث الاسم: " + e.message, "error"); } finally { btn.disabled = false; }
    }
    function openAvatarModal(){ document.getElementById('avatar-modal').style.display='block'; }
    async function setAvatar(kind){
      if (!currentUser) return;
      try{
        await db.collection('users').doc(currentUser.uid).update({ avatar: kind });
        currentUser.avatar = kind; renderAvatar(kind);
        showNotification('تم تحديث الصورة','success'); closeAvatarModal();
      }catch(e){ showNotification('فشل التحديث','error'); }
    }
    function closeAvatarModal(){ document.getElementById('avatar-modal').style.display='none'; }
    function closeEditNameModal(){ document.getElementById('edit-name-modal').style.display = 'none'; }

    // ===== Stats & Broadcast =====
    async function openUserStats() {
      document.getElementById('stats-modal').style.display = 'block';
      document.getElementById('stat-users').textContent = '...'; document.getElementById('stat-posts').textContent = '...';
      document.getElementById('stat-active-today').textContent = '...'; document.getElementById('stat-active-now').textContent = '...';
      try {
        const usersPromise = db.collection('users').get(); const postsPromise = db.collection('posts').get();
        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        const activeTodayPromise = db.collection('users').where('lastSeen', '>=', oneDayAgo).get();
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
        const activeNowPromise = db.collection('users').where('lastSeen', '>=', fiveMinutesAgo).get();
        const [usersSnap, postsSnap, activeTodaySnap, activeNowSnap] = await Promise.all([ usersPromise, postsPromise, activeTodayPromise, activeNowPromise ]);
        document.getElementById('stat-users').textContent = usersSnap.size;
        document.getElementById('stat-posts').textContent = postsSnap.size;
        document.getElementById('stat-active-today').textContent = activeTodaySnap.size;
        document.getElementById('stat-active-now').textContent = activeNowSnap.size;
      } catch (e) { showNotification('فشل في جلب الإحصائيات', 'error'); console.error("Stats error:", e); }
    }
    function closeStatsModal(){ document.getElementById('stats-modal').style.display = 'none'; }
    function openBroadcastModal() { if (!isOwner()) return; document.getElementById('broadcast-modal').style.display = 'block'; }
    async function sendBroadcast() {
      if (!isOwner()) return; 
      const title = document.getElementById('broadcast-title-modal').value.trim();
      const text = document.getElementById('broadcast-text-modal').value.trim(); if (!text) return showNotification("نص الإشعار مطلوب", "error");
      try { await db.collection('broadcasts').add({ title, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); showNotification("تم إرسال الإشعار بنجاح", "success"); closeBroadcastModal(); await fetchLatestBroadcast(); } 
      catch (e) { showNotification("فشل إرسال الإشعار: " + e.message, "error"); }
    }
    async function fetchLatestBroadcast() {
      if (isFirstLoginSession) return;
      try {
        const snap = await db.collection('broadcasts').orderBy('createdAt', 'desc').limit(1).get(); if (snap.empty) return;
        const broadcastId = snap.docs[0].id;
        const seenBroadcasts = JSON.parse(localStorage.getItem('seenBroadcasts') || '[]'); if (seenBroadcasts.includes(broadcastId)) return;
        const broadcast = snap.docs[0].data();
        document.getElementById('broadcast-title-display').textContent = broadcast.title; document.getElementById('broadcast-text-display').textContent = broadcast.text;
        document.getElementById('broadcast-banner').classList.add('show'); document.getElementById('broadcast-overlay').classList.add('show');
        lastBroadcast = broadcastId;
      } catch (e) { console.error("Error fetching broadcast:", e); }
    }
    function dismissBroadcast() {
      document.getElementById('broadcast-banner').classList.remove('show'); document.getElementById('broadcast-overlay').classList.remove('show');
      if (lastBroadcast) { const seenBroadcasts = JSON.parse(localStorage.getItem('seenBroadcasts') || '[]'); if (!seenBroadcasts.includes(lastBroadcast)) { seenBroadcasts.push(lastBroadcast); localStorage.setItem('seenBroadcasts', JSON.stringify(seenBroadcasts)); } }
    }
    function closeBroadcastModal(){ document.getElementById('broadcast-modal').style.display = 'none'; }

    // ===== Owner toggles =====
    async function ownerTogglePin(postId, isPinned) { if (!isOwner()) return; try { await db.collection('posts').doc(postId).update({ isPinned: !isPinned }); showNotification(isPinned ? 'تم إلغاء تثبيت المنشور' : 'تم تثبيت المنشور', 'success'); await loadPostsFromFirestore(); } catch (e) { showNotification('فشل تغيير حالة التثبيت: ' + e.message, 'error'); } }
    async function ownerToggleVerify(userId) { if (!isOwner()) return; try { const userRef = db.collection('users').doc(userId); const userDoc = await userRef.get(); if(!userDoc.exists) throw new Error("User not found"); const isVerified = userDoc.data()?.isVerified || false; await userRef.update({ isVerified: !isVerified }); showNotification(isVerified ? 'تم إلغاء توثيق المستخدم' : 'تم توثيق المستخدم', 'success'); delete userMetaCache[userId]; await renderPosts(); } catch (e) { showNotification('فشل تغيير حالة التوثيق: ' + e.message, 'error'); } }
    async function ownerToggleUserBanById(userId) { if (!isOwner()) return; try { const userRef = db.collection('users').doc(userId); const userDoc = await userRef.get(); if(!userDoc.exists) throw new Error("User not found"); const isBanned = userDoc.data()?.blockedFromPosting || false; await userRef.update({ blockedFromPosting: !isBanned }); showNotification(isBanned ? 'تم إلغاء حظر المستخدم' : 'تم حظر المستخدم من النشر', 'success'); delete userMetaCache[userId]; await renderPosts(); } catch (e) { showNotification('فشل تغيير حالة الحظر: ' + e.message, 'error'); } }
    async function ownerDeletePost(postId) { if (!isOwner() || !confirm("هل أنت متأكد من حذف هذا المنشور بشكل نهائي؟")) return; try { await db.collection('posts').doc(postId).delete(); showNotification('تم حذف المنشور بنجاح', 'success'); await loadPostsFromFirestore(); } catch (e) { showNotification('فشل حذف المنشور: ' + e.message, 'error'); } }

    // ===== Pull to refresh =====
    (function initPullToRefresh(){
      const bubble = document.getElementById("pull-bubble"); let startY = 0, pulling = false, threshold = 80;
      window.addEventListener("touchstart", (e)=>{ if(pages.main.style.display!=="block" || window.pageYOffset > 0) return; startY = e.touches[0].clientY; pulling = true; }, {passive:true});
      window.addEventListener("touchmove", (e)=>{ if(!pulling) return; const dy = e.touches[0].clientY - startY; if(dy > 6 && window.pageYOffset <= 0){ e.preventDefault(); bubble.style.display="inline-block"; bubble.textContent = dy > threshold ? "أفلت للتحديث…" : "اسحب للتحديث…"; }else{ bubble.style.display = "none"; } }, {passive:false});
      window.addEventListener("touchend", async ()=>{ if(!pulling) return; pulling = false; if(bubble.style.display === "inline-block" && bubble.textContent.includes("أفلت")){ bubble.textContent = "جاري التحديث…"; try{ await Promise.all([loadPostsFromFirestore(), loadCompanies(), fetchLatestBroadcast()]); } finally{ setTimeout(()=> bubble.style.display="none", 500); } }else{ bubble.style.display = "none"; } });
    })();

    // ===== Service Worker


    // ===== Stats =====
    async function openUserStats() {
      document.getElementById('stats-modal').style.display = 'block';
      document.getElementById('stat-users').textContent = '...'; document.getElementById('stat-posts').textContent = '...';
      document.getElementById('stat-active-today').textContent = '...'; document.getElementById('stat-active-now').textContent = '...';
      try {
        const usersPromise = db.collection('users').get(); const postsPromise = db.collection('posts').get();
        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        const activeTodayPromise = db.collection('users').where('lastSeen', '>=', oneDayAgo).get();
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
        const activeNowPromise = db.collection('users').where('lastSeen', '>=', fiveMinutesAgo).get();
        const [usersSnap, postsSnap, activeTodaySnap, activeNowSnap] = await Promise.all([ usersPromise, postsPromise, activeTodayPromise, activeNowPromise ]);
        document.getElementById('stat-users').textContent = usersSnap.size;
        document.getElementById('stat-posts').textContent = postsSnap.size;
        document.getElementById('stat-active-today').textContent = activeTodaySnap.size;
        document.getElementById('stat-active-now').textContent = activeNowSnap.size;
      } catch (e) { showNotification('فشل في جلب الإحصائيات', 'error'); console.error("Stats error:", e); }
    }
    function closeStatsModal(){ document.getElementById('stats-modal').style.display = 'none'; }

    // ===== Pull to refresh =====
    (function initPullToRefresh(){
      const bubble = document.getElementById("pull-bubble"); let startY = 0, pulling = false, threshold = 80;
      window.addEventListener("touchstart", (e)=>{ if(pages.main.style.display!=="block" || window.pageYOffset > 0) return; startY = e.touches[0].clientY; pulling = true; }, {passive:true});
      window.addEventListener("touchmove", (e)=>{ if(!pulling) return; const dy = e.touches[0].clientY - startY; if(dy > 6 && window.pageYOffset <= 0){ e.preventDefault(); bubble.style.display="inline-block"; bubble.textContent = dy > threshold ? "أفلت للتحديث…" : "اسحب للتحديث…"; }else{ bubble.style.display = "none"; } }, {passive:false});
      window.addEventListener("touchend", async ()=>{ if(!pulling) return; pulling = false; if(bubble.style.display === "inline-block" && bubble.textContent.includes("أفلت")){ bubble.textContent = "جاري التحديث…"; try{ await Promise.all([loadPostsFromFirestore(), loadCompanies(), fetchLatestBroadcast()]); } finally{ setTimeout(()=> bubble.style.display="none", 500); } }else{ bubble.style.display = "none"; } });
    })();

  </script>

  <script>
    // Service Worker (اختياري)
    (function(){
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js').catch(err => console.log('SW reg failed:', err));
        });
      }
    })();
  </script>
</body>
</html>
