<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>ÿ≥ŸàŸÇ ÿßŸÑÿ∑ŸÑÿßÿ®</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary-color:#4a6bff;--secondary-color:#f8f9fa;--accent-color:#ff6b6b;
      --text-color:#222;--light-text:#6c757d;--border-color:#dee2e6;
      --success-color:#28a745;--warning-color:#ffc107;--danger-color:#dc3545;
      --sky:#e9f0ff;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal','Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    html,body{height:100%}
    body{background:#f5f5f5;color:var(--text-color);overscroll-behavior-y:contain;-webkit-text-size-adjust:100%;touch-action:manipulation}
    .container{max-width:100%;min-height:100vh;background:#fff;padding-bottom:70px}

/* ===== ÿ£ŸÜŸÖŸäÿ¥ŸÜ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ£ŸàŸÑŸâ ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ===== */
.splash {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: radial-gradient(60% 90% at 20% 10%, rgba(16,209,255,.20), transparent 60%),
              radial-gradient(70% 80% at 90% 90%, rgba(106,17,203,.18), transparent 60%),
              linear-gradient(135deg,#0d0f1a 0%, #0f1330 100%);
  z-index: 9999;
  overflow: hidden;
  transition: opacity .6s ease;
}

.splash.fade-out {
  opacity: 0;
  pointer-events: none;
}

.runner {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: .08em;
  filter: drop-shadow(0 10px 28px rgba(0,0,0,.45));
  pointer-events: none;
}

.runner span {
  font-weight: 900;
  font-size: clamp(40px, 9vw, 74px);
  color: #e6ebff;
  display: inline-block;
  opacity: 0;
  transform: translateX(6vw) scale(.96);
  animation: runCentered .8s cubic-bezier(.2,.8,.2,1) forwards;
  will-change: transform, opacity;
}

.runner span:nth-child(1){ animation-delay:.00s }
.runner span:nth-child(2){ animation-delay:.05s }
.runner span:nth-child(3){ animation-delay:.10s }
.runner span:nth-child(4){ animation-delay:.15s }
.runner span:nth-child(5){ animation-delay:.20s }
.runner span:nth-child(6){ animation-delay:.25s }
.runner span:nth-child(7){ animation-delay:.30s }
.runner span:nth-child(8){ animation-delay:.35s }
.runner span:nth-child(9){ animation-delay:.40s }
.runner span:nth-child(10){ animation-delay:.45s }

@keyframes runCentered {
  0% { opacity: 0; transform: translateX(6vw) scale(.96) }
  18% { opacity: 1 }
  55% { transform: translateX(-6vw) scale(1.02) }
  100% { opacity: 0; transform: translateX(-6vw) scale(.98) }
}

.final-logo {
  position: relative;
  z-index: 2;
  opacity: 0;
  font-weight: 900;
  font-size: clamp(42px, 9.5vw, 72px);
  color: #eef2ff;
  text-shadow: 0 14px 40px rgba(16,209,255,.22), 0 4px 10px rgba(0,0,0,.5);
  white-space: nowrap;
  line-height: 1;
  direction: rtl;
  unicode-bidi: plaintext;
  animation: logoMerge .55s cubic-bezier(.2,.9,.1,1) var(--merge-delay,1.35s) forwards;
}

@keyframes logoMerge {
  0% { opacity: 0; transform: translateY(18px) scale(.94) }
  100% { opacity: 1; transform: translateY(0) scale(1) }
}

/* üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ŸÜÿµ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ */
.loading-text {
  position: absolute;
  bottom: 30%;
  color: #a0b4ff;
  font-size: 14px;
  font-weight: 500;
  text-align: center;
  opacity: 0;
  animation: loadingPulse 2s infinite;
  direction: rtl;
}

@keyframes loadingPulse {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; }
}

.loading-text.show {
  display: block;
  animation: fadeInUp 0.5s ease forwards;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

    /* ===== Splash ===== */
    .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:
      radial-gradient(60% 90% at 20% 10%, rgba(16,209,255,.20), transparent 60%),
      radial-gradient(70% 80% at 90% 90%, rgba(106,17,203,.18), transparent 60%),
      linear-gradient(135deg,#0d0f1a 0%, #0f1330 100%);z-index:1200;overflow:hidden;transition:opacity .6s ease}
    .splash.fade-out{opacity:0;pointer-events:none}
    .runner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:.08em;filter:drop-shadow(0 10px 28px rgba(0,0,0,.45));pointer-events:none;}
    .runner span{font-weight:900;font-size:clamp(40px,9vw,74px);color:#e6ebff;display:inline-block;opacity:0; transform:translateX(6vw) scale(.96);animation:runCentered .8s cubic-bezier(.2,.8,.2,1) forwards;will-change:transform,opacity}
    .runner span:nth-child(1){animation-delay:.00s}.runner span:nth-child(2){animation-delay:.05s}.runner span:nth-child(3){animation-delay:.10s}
    .runner span:nth-child(4){animation-delay:.15s}.runner span:nth-child(5){animation-delay:.20s}.runner span:nth-child(6){animation-delay:.25s}
    .runner span:nth-child(7){animation-delay:.30s}.runner span:nth-child(8){animation-delay:.35s}.runner span:nth-child(9){animation-delay:.40s}
    .runner span:nth-child(10){animation-delay:.45s}
    @keyframes runCentered{0%{opacity:0; transform:translateX(6vw) scale(.96)}18%{opacity:1}55%{transform:translateX(-6vw) scale(1.02)}100%{opacity:0; transform:translateX(-6vw) scale(.98)}}
    .final-logo{position:relative;z-index:2;opacity:0;font-weight:900;font-size:clamp(42px,9.5vw,72px);color:#eef2ff;text-shadow:0 14px 40px rgba(16,209,255,.22),0 4px 10px rgba(0,0,0,.5);white-space:nowrap;line-height:1;direction:rtl;unicode-bidi:plaintext;animation:logoMerge .55s cubic-bezier(.2,.9,.1,1) var(--merge-delay,1.35s) forwards}
    @keyframes logoMerge{0%{opacity:0;transform:translateY(18px) scale(.94)}100%{opacity:1;transform:translateY(0) scale(1)}}

    /* Auth */
    .auth-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:20px;background:linear-gradient(135deg,#4a6bff,#6a11cb)}
    .auth-box{background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;width:100%;max-width:420px;text-align:center}
    .auth-tabs{display:flex;margin-bottom:20px;border-bottom:1px solid var(--border-color)}
    .auth-tab{flex:1;padding:10px;cursor:pointer;font-weight:500;color:var(--light-text);transition:.3s}
    .auth-tab.active{color:var(--primary-color);border-bottom:2px solid var(--primary-color)}
    .auth-form{display:none}.auth-form.active{display:block}
    .form-group{margin-bottom:15px;text-align:right}
    .form-group label{display:block;margin-bottom:5px;font-weight:500}
    .form-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;transition:.3s}
    .form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,107,255,.2)}
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}

/* ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿµŸàÿ±ÿ© */
.choose-avatar {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.choose-avatar label {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 12px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.choose-avatar label:has(input:checked) {
    border: 3px solid #3a5bef !important;
    background: rgba(58, 91, 239, 0.15);
    box-shadow: 0 0 15px rgba(58, 91, 239, 0.3);
    transform: scale(1.05);
}

.choose-avatar label:has(input:checked) .emo {
    background: rgba(58, 91, 239, 0.1);
    border-radius: 8px;
    padding: 4px;
}

.choose-avatar .emo {
    font-size: 28px;
    line-height: 1;
}

.choose-avatar input[type="radio"] {
    display: none;
}

/* ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÅŸàŸÇ ŸÉŸÑÿ¥Ÿä */
#broadcast-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 1000; /* ÿ≤ŸàÿØ ÿßŸÑŸÄ z-index */
  display: none;
}

#broadcast-banner {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  width: min(92%, 380px);
  max-height: 70vh;
  overflow: auto;
  z-index: 1010; /* ÿ≤ŸàÿØ ÿßŸÑŸÄ z-index */
  background: #e9f0ff;
  border: 1px solid #d0dcff;
  border-radius: 16px;
  padding: 16px 46px 16px 16px;
  box-shadow: 0 20px 40px rgba(0,0,0,.28);
  display: none;
}

    /* Buttons */
    .btn{display:inline-block;padding:10px 14px;background:var(--primary-color);color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;width:auto}
    .btn:hover{transform:translateY(-1px)}
    .btn[disabled]{opacity:.65;cursor:not-allowed;transform:none}
    .btn-block{width:100%}
    .btn-secondary{background:var(--secondary-color);color:var(--text-color)}
    .btn-danger{background:var(--danger-color);color:#fff}
    .btn-success{background:var(--success-color)}
    .btn-warning{background:var(--warning-color);color:#111}
    .btn-xs{padding:6px 8px;font-size:12px;border-radius:8px}

    /* Header */
    .header{position:sticky;top:0;background:#fff;padding:12px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);z-index:100}
    .brand{display:flex;align-items:center;gap:8px}
    .section-switch{display:inline-flex;background:#f2f4ff;border:1px solid #dfe4ff;border-radius:999px;overflow:hidden;margin-inline-start:10px}
    .section-pill{padding:6px 10px;font-size:12px;font-weight:800;color:#3a5bef;cursor:pointer;border:none;background:transparent}
    .section-pill.active{background:#3a5bef;color:#fff}
    .icon-btn{position:relative;background:transparent;border:none;cursor:pointer;font-size:20px}
    .icon-btn .dot{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:#ff3b3b;border-radius:50%;display:none}
    .icon-btn.has-unseen .dot{display:block}

    .filter-container{padding:15px;background:#fff;border-bottom:1px solid var(--border-color); display:flex; gap:10px;}
    .filter-select{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:5px}
    .posts-container{padding:15px 15px 90px}
    .pull-indicator{position:relative;height:0;overflow:visible}
    .pull-indicator .bubble{position:absolute;top:-28px;left:50%;transform:translateX(-50%);background:#e9f0ff;border:1px solid #d0dcff;border-radius:999px;padding:4px 10px;font-size:12px;color:#3a5bef;display:none}

    .post{background:#fff;border-radius:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);padding:15px;margin-bottom:15px;border:1px solid var(--border-color);position:relative}
    .post.pinned{box-shadow:0 4px 14px rgba(74,107,255,.25)}
    .post .pin-ribbon{position:absolute;top:-8px;right:-8px;background:#4a6bff;color:#fff;font-weight:800;padding:4px 8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:11px}
    .post.sold{opacity:.85;position:relative}
    .post.deleted{opacity:.5;position:relative}
    .post.sold::after{content:"ÿ™ŸÖ ÿ®ŸäÿπŸá";position:absolute;top:10px;left:10px;background:var(--success-color);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
    .post-header{display:grid;grid-template-columns:1fr auto;grid-row-gap:6px;align-items:center;margin-bottom:10px}
    .post-username{display:flex;align-items:center;gap:10px;font-weight:900;color:#111;font-size:17px}
    .badge-verified{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:999px;background:linear-gradient(135deg,#f7d774,#e7b10a,#ffdf85,#e7b10a);color:#5a4600;font-size:12px;font-weight:900;border:1px solid rgba(128,96,0,.35);box-shadow:0 2px 10px rgba(231,177,10,.35), inset 0 0 10px rgba(255,255,255,.35)}
    .badge-verified i{font-size:14px;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15))}
    .post-title{font-weight:800;font-size:15px;color:var(--primary-color)}
    .post-price{justify-self:end;font-weight:900;color:#28a745}
    .post-description{margin:10px 0 15px;line-height:1.8;color:#222;white-space:pre-wrap}
    .post-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .owner-tools{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;border-bottom:1px dashed #eee;padding-bottom:8px}

    /* Companies */
    .company{background:#fff;border-radius:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);padding:15px;margin-bottom:12px;border:1px solid var(--border-color)}
    .company .name{font-weight:900;color:#111;font-size:16px}
    .company .phone{color:#0c7a43;font-weight:800;margin-top:6px}
    .company .route{color:#555;margin-top:6px;font-size:13px}
    .company .desc{color:#333;margin-top:6px}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;overflow-y:auto}
    .modal-content{background:#fff;margin:20px auto;padding:20px;border-radius:12px;width:90%;max-width:520px;animation:modalOpen .25s}
    @keyframes modalOpen{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}
    .modal-header h2{font-size:18px;margin:0}
    .close-modal{background:none;border:none;font-size:24px;cursor:pointer;color:var(--light-text)}
    .select-group{margin-bottom:15px}
    .select-group label{display:block;margin-bottom:5px;font-weight:500}
    .select-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;background:#fff}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}

    /* Profile */
    .profile-shell{padding:16px}
    .profile-card{background:var(--sky);border:1px solid #d0dcff;border-radius:16px;padding:16px;display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .avatar{width:72px;height:72px;border-radius:50%;display:grid;place-items:center;background:#d7e4ff;color:#2740b9;font-size:40px;cursor:pointer;border:2px solid #c9d7ff;overflow:hidden}
    .profile-meta{display:flex;flex-direction:column;gap:4px}
    .profile-name-row{display:flex;align-items:center;gap:8px;font-weight:900;font-size:18px;color:#0f235f}
    .profile-count{font-size:13px;color:#2b3f8c;font-weight:700}
    .profile-email{font-size:12px;color:#3c4c7f;word-break:break-all}
    .profile-uid-input {font-size:12px;padding:6px 8px}

    .profile-actions-card{margin-top:20px;background:#fff;border:1px solid var(--border-color);border-radius:14px;padding:10px}
    .profile-menu{padding:5px}
    .menu-item{display:flex;align-items:center;gap:10px;padding:14px;margin-bottom:10px;background:var(--secondary-color);border-radius:12px;cursor:pointer;transition:.2s}
    .menu-item:hover{transform:translateY(-2px)}
    .muted{color:#777;font-size:13px}

    /* ===== Broadcast popup ===== */
    #broadcast-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:210}
    #broadcast-overlay.show{display:block}
    #broadcast-banner{
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.98);
      width:min(92%, 380px); max-height:70vh; overflow:auto; z-index:220;
      background:#e9f0ff; border:1px solid #d0dcff; border-radius:16px; padding:16px 46px 16px 16px;
      box-shadow:0 20px 40px rgba(0,0,0,.28); opacity:0;
    }
    #broadcast-banner.show{
      display:block; opacity:1; transform:translate(-50%,-50%) scale(1);
      animation:bannerIn .32s cubic-bezier(.2,.8,.2,1) forwards;
    }
    @keyframes bannerIn{to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    #broadcast-banner .x{position:absolute;top:10px;right:12px;background:#0000;border:none;font-size:22px;cursor:pointer;color:#2643b8}

    .bottom-nav{position:fixed;bottom:0;left:0;width:100%;background:#fff;display:flex;justify-content:space-around;padding:12px 0;border-top:1px solid var(--border-color);z-index:120}
    .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--light-text);font-size:12px;cursor:pointer;position:relative}
    .nav-item.active{color:var(--primary-color)}

    .notification{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:var(--success-color);color:#fff;padding:16px 22px;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:300;display:none;font-size:14px;text-align:center;min-width:240px;max-width:85%;
    }

    /* ===== Challenge Page ===== */
    .challenge-shell{padding:16px;}
    .challenge-tab-nav {display:flex; background:#f2f4ff; border:1px solid #dfe4ff; border-radius:999px; overflow:hidden; margin-bottom: 20px;}
    .challenge-tab-pill {flex:1; padding:10px; font-size:13px; font-weight:800; color:#3a5bef; cursor:pointer; border:none; background:transparent; text-align:center;}
    .challenge-tab-pill.active {background:#3a5bef; color:#fff;}
    .challenge-tab-content {display:none;}
    .challenge-tab-content.active {display:block;}

    .rank-list{display:grid;gap:10px;margin-top:10px}
    .rank-card{background:#fff;border:2px solid var(--border-color);border-radius:16px;padding:12px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .rank-left{display:flex;align-items:center;gap:10px}
    .rank-badge{width:36px;height:36px;border-radius:999px;display:grid;place-items:center;font-weight:900}
    .rank-name{font-weight:900;color:#0f235f}
    .rank-points{font-weight:800;color:#2740b9}

    .timer-card{background:var(--sky);border:1px solid #d0dcff;border-radius:16px;padding:20px;margin-top:24px;min-width:min(92%,520px);text-align:center}
    .timer-title{font-weight:900;color:#0f235f}
    .timer-display{font-weight:900;font-size:clamp(28px,7vw,48px);margin-top:8px;color:#1b2f7a}
    .timer-actions{display:flex;gap:10px;justify-content:center;margin-top:14px}
    .hint{margin-top:8px;color:#3c4c7f;font-size:12px}
    .points-display{font-weight:800;color:#0f235f;margin:12px 0;}
    .boost-card{margin-top:20px; background:#fff; border:1px solid var(--border-color); border-radius:14px; padding:15px; text-align:center;}
    .boost-card .btn {background: #ff8c00; color:#fff;}

    .qna-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .qna-header { display:flex; justify-content: space-between; align-items: center; }
    .qna-prize { font-weight: 900; color: var(--success-color); font-size: 16px; }
    .qna-creator { font-weight: 700; color: #555; }
    .qna-actions { margin-top: 10px; }

    /* ===== "ÿ•ÿ∑ÿßÿ±ÿßÿ™" ÿ£ŸàŸÑ 5 ŸÅŸä ÿßŸÑÿ™ÿµŸÜŸäŸÅ ===== */
    .rank-1{border-color:#d4af37;box-shadow:0 0 0 3px rgba(212,175,55,.35),0 10px 24px rgba(212,175,55,.25)}
    .rank-1 .rank-badge{background:linear-gradient(135deg,#ffe27a,#f6c33b);color:#5a4600;border:2px solid #d4af37}
    .rank-2{border-color:#c0c0c0;box-shadow:0 0 0 3px rgba(192,192,192,.35),0 10px 24px rgba(192,192,192,.25)}
    .rank-2 .rank-badge{background:linear-gradient(135deg,#f0f0f0,#c0c0c0);color:#333;border:2px solid #c0c0c0}
    .rank-3{border-color:#cd7f32;box-shadow:0 0 0 3px rgba(205,127,50,.35),0 10px 24px rgba(205,127,50,.25)}
    .rank-3 .rank-badge{background:linear-gradient(135deg,#e6b17e,#cd7f32);color:#5a3f1e;border:2px solid #cd7f32}
    .rank-4{border-color:#7aa2ff;box-shadow:0 0 0 3px rgba(122,162,255,.35),0 10px 24px rgba(122,162,255,.25)}
    .rank-4 .rank-badge{background:linear-gradient(135deg,#b3e5fc,#81d4fa);color:#06334a;border:2px solid #66c3eb}
    .rank-5{border-color:#a17aff;box-shadow:0 0 0 3px rgba(161,122,255,.35),0 10px 24px rgba(161,122,255,.25)}
    .rank-5 .rank-badge{background:linear-gradient(135deg,#d1c4e9,#b39ddb);color:#382a4e;border:2px solid #9575cd}


    /* ÿ≤ÿ± ÿßŸÑŸÖÿ∑ÿßŸÑÿ®ÿ© ÿßŸÑŸäŸàŸÖŸäÿ© ÿØÿßÿÆŸÑ ÿßŸÑŸÖÿ§ŸÇÿ™ (ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸàÿ≠ŸäÿØ ÿßŸÑŸÖŸÅÿπŸëŸéŸÑ) */
    .daily-claim{display:inline-flex;align-items:center;justify-content:center;width:120px;height:56px;border-radius:12px;font-weight:900;border:2px dashed #ff8c00;background:#fff7e6;cursor:pointer}
    .daily-claim[disabled]{opacity:.6;cursor:not-allowed;border-style:solid}
    .daily-claim small{display:block;font-weight:700;color:#a85}

    /* ŸÖÿ±ÿ®ÿπÿßÿ™ ÿµŸÅÿ≠ÿßÿ™ "ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥/ÿ¥ÿ±ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ" */
    .square-card{background:#fff;border:1px solid var(--border-color);border-radius:14px;padding:14px;margin-bottom:12px}
    .square-card h3{margin-bottom:6px;font-weight:900;color:#0f235f}
    .journey-button{background:#fff;border:1px solid var(--border-color);border-radius:14px;padding:14px;margin-bottom:12px;cursor:pointer;transition:.2s}
    .journey-button:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.1)}
    
    /* ÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ¨ÿØŸäÿØÿ© */
    .gift-section { margin-bottom: 20px; }
    .gift-item { background: #fff7e6; border: 1px solid #ffd8a8; border-radius: 12px; padding: 12px; margin-bottom: 10px; }
    .gift-item h4 { margin: 0 0 8px 0; color: #e67700; }
    .gift-actions { display: flex; gap: 8px; margin-top: 10px; }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .stat-card { background: #f8f9fa; border-radius: 12px; padding: 12px; text-align: center; }
    .stat-number { font-size: 24px; font-weight: 900; color: var(--primary-color); }
    .stat-label { font-size: 12px; color: var(--light-text); }
    .report-reason { margin-top: 10px; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; width: 100%; }
    .daily-reward { margin-top: 20px; padding: 15px; background: #fff; border: 1px solid var(--border-color); border-radius: 14px; }
    
    /* ÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÑŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™ */
    .purchased-gifts-btn { 
      background: #fff7e6; 
      border: 1px solid #ffd8a8; 
      border-radius: 12px; 
      padding: 10px; 
      margin-bottom: 10px; 
      cursor: pointer; 
      text-align: center;
      font-weight: 700;
      color: #e67700;
    }
    .gift-section-sm { 
      margin-bottom: 15px; 
      padding: 12px; 
      background: #fff7e6; 
      border: 1px solid #ffd8a8; 
      border-radius: 12px; 
    }

    /* ===== ŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅ + ÿßŸÑÿπÿØ ÿßŸÑÿ™ŸÜÿßÿ≤ŸÑŸä ===== */
    .lb-tools{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0;}
    .countdown{font-weight:900;color:#0f235f;font-size:14px;display:flex;align-items:center;gap:6px}
    .cd-box{background:#f2f4ff;border:1px solid #dfe4ff;border-radius:10px;padding:6px 10px;min-width:58px;text-align:center}
    .cd-num{font-size:16px;font-weight:900;display:block}
    .cd-lbl{font-size:11px;color:#3a5bef;display:block}
    .lb-note{margin-top:10px;font-size:12px;color:#b33;background:#fff3cd;border:1px solid #ffeeba;border-radius:10px;padding:10px;font-weight:800}

    /* ŸÅŸÇÿßÿπÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ */
/* ÿ∫Ÿäÿ± ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ: */
.nav-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #dc3545;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 11px;
  font-weight: bold;
  display: none; /* ÿ™ÿ∫ŸäŸäÿ± ŸÖŸÜ flex ÿ•ŸÑŸâ none */
  align-items: center;
  justify-content: center;
  border: 2px solid #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  animation: pulse 2s infinite;
}

.menu-item {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.menu-item .nav-badge {
  position: static;
  margin-right: auto;
  margin-left: 8px;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
   
   /* ===== ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿ≤ÿ± ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸàÿßŸÑŸÇÿßÿ¶ŸÖÿ© ===== */
.more-actions-container {
  position: relative;
  margin: 15px 0;
}

.more-actions-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #4a6bff, #6a11cb);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: 0 4px 15px rgba(74, 107, 255, 0.3);
}

.more-actions-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(74, 107, 255, 0.4);
}

.more-actions-btn i {
  transition: transform 0.3s ease;
}

.more-actions-btn.active i {
  transform: rotate(180deg);
}

.more-actions-grid {
  display: none;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 15px;
  animation: fadeIn 0.3s ease;
}

.more-actions-grid.show {
  display: grid;
}

.action-card {
  background: #fff;
  border: 2px solid #e9f0ff;
  border-radius: 14px;
  padding: 16px 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-height: 100px;
}

.action-card:hover {
  transform: translateY(-3px);
  border-color: #4a6bff;
  box-shadow: 0 8px 20px rgba(74, 107, 255, 0.15);
}

.action-card i {
  font-size: 24px;
  color: #4a6bff;
  margin-bottom: 5px;
}

.action-card .action-title {
  font-weight: 800;
  font-size: 14px;
  color: #2c3e50;
  line-height: 1.3;
}

.action-card.management { background: #fff7e6; border-color: #ffd8a8; }
.action-card.management i { color: #e67700; }

.action-card.points { background: #e9f7ef; border-color: #a3e4c1; }
.action-card.points i { color: #27ae60; }

.action-card.schedule { background: #e9f0ff; border-color: #a4b8ff; }
.action-card.schedule i { color: #3498db; }

.action-card.broadcast { background: #ffeaea; border-color: #ffb8b8; }
.action-card.broadcast i { color: #e74c3c; }

.action-card.report { background: #f0e9ff; border-color: #c9b8ff; }
.action-card.report i { color: #9b59b6; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ÿ™ÿµŸÖŸäŸÖ ŸÖÿ™ÿ¨ÿßŸàÿ® */
@media (max-width: 480px) {
  .more-actions-grid {
    grid-template-columns: 1fr;
  }
  
  .action-card {
    min-height: 90px;
    padding: 14px 10px;
  }
}

/* ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿ≤ÿ± ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ® */
.menu-item[onclick="openDeleteAccountModal()"] {
    border-top: 1px solid var(--border-color) !important;
    padding-top: 15px !important;
    margin-top: 15px !important;
}

.menu-item[onclick="openDeleteAccountModal()"]:hover {
    background: #fee !important;
    transform: translateY(-2px);
}

#delete-account-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background: #dc3545 !important;
}

#confirm-delete-checkbox {
    accent-color: #e74c3c;
}

#confirm-delete-checkbox:checked {
    background: #e74c3c;
}

/* ===== ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ¨ÿØŸäÿØ ŸÖÿπ ÿßŸÑÿµŸàÿ± - ŸÖÿπÿØŸÑ ===== */
.rank-card-new {
    background: #fff;
    border-radius: 14px;
    padding: 14px 16px; /* ÿ≤ÿØÿ™ ÿßŸÑpadding ÿ£ŸÉÿ´ÿ± */
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 14px; /* ÿ≤ÿØÿ™ ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ÿßŸÑÿπŸÜÿßÿµÿ± ÿ£ŸÉÿ´ÿ± */
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
    position: relative;
    overflow: hidden;
    min-height: 65px; /* ÿ≤ÿØÿ™ ÿßŸÑÿ∑ŸàŸÑ ÿ£ŸÉÿ´ÿ± */
    max-height: 65px;
}

.rank-card-new:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-color: #4a6bff;
}

/* ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿØÿßÿ¶ÿ±ÿ© ÿßŸÑÿ≠ŸÖÿ±ÿßÿ° ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© ÿπŸÑŸâ ÿßŸÑŸäŸÖŸäŸÜ */
.rank-number-new {
    display: none;
}

.rank-avatar-container {
    position: relative;
    width: 50px; /* ŸÉÿ®ÿ±ÿ™ ÿßŸÑÿµŸàÿ±ÿ© ŸÉÿ´Ÿäÿ± */
    height: 50px;
    flex-shrink: 0;
}

.rank-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e9ecef; /* ŸÉÿ®ÿ±ÿ™ ÿßŸÑborder */
    background: #f8f9fa;
}

/* ÿßŸÑÿØÿßÿ¶ÿ±ÿ© ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© ŸÅŸàŸÇ ÿßŸÑÿµŸàÿ±ÿ© */
.rank-number-overlay {
    position: absolute;
    top: 0px;
    right: 0px;
    width: 22px; /* ŸÉÿ®ÿ±ÿ™ ÿßŸÑÿØÿßÿ¶ÿ±ÿ© ŸÉÿ´Ÿäÿ± */
    height: 22px;
    border-radius: 50%;
    display: flex !important;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 11px; /* ŸÉÿ®ÿ±ÿ™ ÿßŸÑÿÆÿ∑ ŸÉÿ´Ÿäÿ± */
    color: white;
    border: 1.5px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    z-index: 3;
    background: linear-gradient(135deg, #4a6bff, #6a11cb);
}

.rank-user-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 5px; /* ÿ≤ÿØÿ™ ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ÿßŸÑÿßÿ≥ŸÖ ŸàÿßŸÑŸÜŸÇÿßÿ∑ ÿ£ŸÉÿ´ÿ± */
}

.rank-user-name {
    font-weight: 900;
    font-size: 15px; /* ŸÉÿ®ÿ±ÿ™ ÿÆÿ∑ ÿßŸÑÿßÿ≥ŸÖ ÿ£ŸÉÿ´ÿ± */
    color: #0f235f;
    display: flex;
    align-items: center;
    gap: 8px;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.verified-badge-new {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 8px;
    background: linear-gradient(135deg, #4a6bff, #6a11cb);
    color: white;
    font-size: 10px; /* ŸÉÿ®ÿ±ÿ™ ÿÆÿ∑ ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ ÿ£ŸÉÿ´ÿ± */
    font-weight: 800;
    border: 1px solid rgba(255,255,255,0.3);
    line-height: 1;
    flex-shrink: 0;
}

.rank-user-points {
    font-weight: 800;
    font-size: 13px; /* ŸÉÿ®ÿ±ÿ™ ÿÆÿ∑ ÿßŸÑŸÜŸÇÿßÿ∑ ÿ£ŸÉÿ´ÿ± */
    color: #28a745;
    line-height: 1.3;
}

.rank-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
}

/* ÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿØŸàÿßÿ¶ÿ± ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© ŸÑŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑÿ£ŸàŸÑŸâ */
.rank-card-new.rank-1-new .rank-number-overlay {
    background: linear-gradient(135deg, #ff4757, #ff3838);
}

.rank-card-new.rank-2-new .rank-number-overlay {
    background: linear-gradient(135deg, #ffa502, #e67e22);
}

.rank-card-new.rank-3-new .rank-number-overlay {
    background: linear-gradient(135deg, #3742fa, #2f3542);
}

.rank-card-new.rank-4-new .rank-number-overlay {
    background: linear-gradient(135deg, #2ed573, #1dd1a1);
}

.rank-card-new.rank-5-new .rank-number-overlay {
    background: linear-gradient(135deg, #a4b0be, #747d8c);
}

.rank-card-new.rank-1-new {
    border-color: #ff4757;
    background: linear-gradient(135deg, #fff, #ffe6e6);
}

.rank-card-new.rank-2-new {
    border-color: #ffa502;
    background: linear-gradient(135deg, #fff, #fff9e6);
}

.rank-card-new.rank-3-new {
    border-color: #3742fa;
    background: linear-gradient(135deg, #fff, #e6f7ff);
}

.rank-card-new.rank-4-new {
    border-color: #2ed573;
    background: linear-gradient(135deg, #fff, #e6fff3);
}

.rank-card-new.rank-5-new {
    border-color: #a4b0be;
    background: linear-gradient(135deg, #fff, #f8f9fa);
}

.rank-card-new.rank-normal-new {
    border-color: #e9f0ff;
}

/* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿ™ÿµŸÜŸäŸÅ ŸÉŸÉŸÑ */
#challenge-leaderboard {
    max-height: 500px;
    overflow-y: auto;
}

#challenge-leaderboard::-webkit-scrollbar {
    width: 4px;
}

#challenge-leaderboard::-webkit-scrollbar-thumb {
    background: #4a6bff;
    border-radius: 2px;
}

/* ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿµŸÖŸäŸÖ ÿ≤ÿ± ÿßŸÑÿπÿ¨ŸÑÿ© */
#spin-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #dc3545 !important;
    border: 3px solid #fff;
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    color: #fff;
    cursor: pointer;
    box-shadow: 0 0 25px rgba(220, 53, 69, 0.5);
    font-size: 18px;
    transition: all 0.3s ease;
}

#spin-button:hover {
    background: #c82333 !important;
    transform: translate(-50%, -50%) scale(1.05);
    box-shadow: 0 0 35px rgba(220, 53, 69, 0.7);
}

#spin-button:disabled {
    background: #6c757d !important;
    cursor: not-allowed;
    transform: translate(-50%, -50%) scale(1);
    box-shadow: 0 0 15px rgba(108, 117, 125, 0.5);
}

/* ÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ≥ŸáŸÖ */
.wheel-arrow {
    position: absolute;
    top: -15px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 40px;
    color: #ff4757;
    text-shadow: 0 3px 15px rgba(0, 0, 0, 0.5);
    z-index: 10;
    filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.3));
}

/* ÿ™ÿ≠ÿ≥ŸäŸÜ ŸÖÿ∏Ÿáÿ± ÿßŸÑÿπÿ¨ŸÑÿ© */
#wheel-canvas {
    border-radius: 50%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    transition: transform 0.1s ease;
}

/* ÿ•ÿÆŸÅÿßÿ° ŸÇÿ≥ŸÖ ÿßŸÑŸÜÿ≥ÿ® */
.wheel-probabilities {
    display: none !important;
}

  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>

  <!-- Splash -->
<div id="splash" class="splash" aria-label="ÿ≥ŸàŸÇ ÿßŸÑÿ∑ŸÑÿßÿ®">
  <div class="runner" dir="rtl" aria-hidden="true">
    <span>ÿ≥</span><span>Ÿà</span><span>ŸÇ</span><span>&nbsp;</span><span>ÿß</span><span>ŸÑ</span><span>ÿ∑</span><span>ŸÑ</span><span>ÿß</span><span>ÿ®</span>
  </div>
  <div class="final-logo" id="final-logo" dir="rtl">ÿ≥ŸàŸÇ ÿßŸÑÿ∑ŸÑÿßÿ®</div>
  
  <!-- üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ŸÜÿµ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ™ÿ≠ÿ™ ÿßŸÑÿ£ŸÜŸÖŸäÿ¥ŸÜ -->
  <div id="loading-text" class="loading-text" style="display: none;">
    ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...
  </div>
</div>

  <!-- Auth -->
  <div id="auth-page" class="auth-container page" style="display:none">
    <div class="auth-box">
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</div>
        <div class="auth-tab" onclick="switchAuthTab('register')">ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®</div>
      </div>

      <form id="login-form" class="auth-form active" onsubmit="event.preventDefault(); login();">
        <div class="form-group"><label for="login-email">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label><input type="email" id="login-email" class="form-control" required></div>
        <div class="form-group"><label for="login-password">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label><input type="password" id="login-password" class="form-control" required></div>
        <div class="form-group" style="text-align:center; margin-top:10px;">
          <a href="#" onclick="openForgotPasswordModal()" style="color:var(--primary-color); text-decoration:none; font-size:14px;">
            ŸÜÿ≥Ÿäÿ™ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±ÿü
          </a>
        </div>
        <button type="submit" class="btn btn-block">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
      </form>

      <form id="register-form" class="auth-form" onsubmit="event.preventDefault(); register();">
        <div class="form-group"><label for="register-name">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</label><input type="text" id="register-name" class="form-control" required></div>
        <div class="form-group"><label for="register-email">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label><input type="email" id="register-email" class="form-control" required></div>
        <div class="form-group"><label for="register-password">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label><input type="password" id="register-password" class="form-control" required></div>

<!-- ŸÅŸä ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ÿπÿØ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿµŸàÿ±ÿ© -->
<div class="form-group">
  <label for="register-referral">ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
  <input type="text" id="register-referral" class="form-control" placeholder="ÿ£ÿØÿÆŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ŸÑÿ±ÿ®ÿ≠ 75 ŸÜŸÇÿ∑ÿ© ŸÖÿ¨ÿßŸÜŸäÿ©">
  <div class="hint" style="text-align: center; color: #28a745; font-size: 12px; margin-top: 5px;">
    üéÅ ÿ≥ÿ™ÿ≠ÿµŸÑ ÿπŸÑŸâ 75 ŸÜŸÇÿ∑ÿ© ŸÖÿ¨ÿßŸÜŸäÿ© ÿπŸÜÿØ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ±ŸÖÿ≤ ÿ•ÿ≠ÿßŸÑÿ© ÿµÿ≠Ÿäÿ≠
  </div>
</div>
        <div class="form-group">
          <label>ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸàÿ±ÿ©</label>
          <div class="choose-avatar">
            <label><input type="radio" name="register-avatar" value="male" checked><span class="emo">üë®üèª‚Äçüíº</span> ŸàŸÑÿØ</label>
            <label><input type="radio" name="register-avatar" value="female"><span class="emo">üë©üèª‚Äçüíº</span> ÿ®ŸÜÿ™</label>
          </div>
        </div>
        <button type="button" id="register-submit" class="btn btn-block" onclick="register()">ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®</button>
      </form>
    </div>
  </div>

  <!-- Main (ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™) -->
  <div id="main-page" class="container page" style="display:none">
    <div class="header">
      <div class="brand">
        <button id="create-btn" class="btn" onclick="onCreateButton()"><i class="fas fa-plus"></i> <span id="create-btn-label">ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÜÿ¥Ÿàÿ±</span></button>
        <div class="section-switch" role="tablist" aria-label="ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ">
          <button id="pill-posts" class="section-pill active" onclick="switchSection('posts')" role="tab" aria-selected="true">ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™</button>
          <button id="pill-companies" class="section-pill" onclick="switchSection('companies')" role="tab" aria-selected="false">ÿ¥ÿ±ŸÉÿßÿ™ ÿßŸÑÿ™ŸàÿµŸäŸÑ</button>
        </div>
      </div>
    </div>

    <div id="filter-container" class="filter-container">
      <select id="filter-stage" class="filter-select" onchange="renderPosts()">
        <option value="">ŸÉŸÑ ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ</option>
        <option value="sades-elmi">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿπŸÑŸÖŸä</option>
        <option value="sades-adabi">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿßÿØÿ®Ÿä</option>
        <option value="khames">ÿßŸÑÿÆÿßŸÖÿ≥ ÿπŸÑŸÖŸä/ÿßÿØÿ®Ÿä</option>
        <option value="rabea">ÿßŸÑÿ±ÿßÿ®ÿπ ÿπŸÑŸÖŸä/ÿßÿØÿ®Ÿä</option>
        <option value="thaleth-mut">ÿßŸÑÿ´ÿßŸÑÿ´ ŸÖÿ™Ÿàÿ≥ÿ∑</option>
        <option value="thani-mut">ÿßŸÑÿ´ÿßŸÜŸä ŸÖÿ™Ÿàÿ≥ÿ∑</option>
        <option value="awal-mut">ÿßŸÑÿßŸàŸÑ ŸÖÿ™Ÿàÿ≥ÿ∑</option>
        <option value="sades-ibtidai">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä</option>
      </select>
      <select id="filter-material" class="filter-select" onchange="renderPosts()">
        <option value="">ŸÉŸÑ ÿßŸÑŸÖŸàÿßÿØ</option>
        <option value="ÿßÿ≥ŸÑÿßŸÖŸäÿ©">ÿßÿ≥ŸÑÿßŸÖŸäÿ©</option><option value="ÿπÿ±ÿ®Ÿä">ÿπÿ±ÿ®Ÿä</option><option value="ÿßŸÜŸÉŸÑŸäÿ≤Ÿä">ÿßŸÜŸÉŸÑŸäÿ≤Ÿä</option>
        <option value="ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™">ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™</option><option value="ÿßÿ≠Ÿäÿßÿ°">ÿßÿ≠Ÿäÿßÿ°</option><option value="ŸÉŸäŸÖŸäÿßÿ°">ŸÉŸäŸÖŸäÿßÿ°</option>
        <option value="ŸÅŸäÿ≤Ÿäÿßÿ°">ŸÅŸäÿ≤Ÿäÿßÿ°</option><option value="ÿßŸÇÿ™ÿµÿßÿØ">ÿßŸÇÿ™ÿµÿßÿØ</option><option value="ÿ£ÿØÿ® ŸàŸÜÿµŸàÿµ">ÿ£ÿØÿ® ŸàŸÜÿµŸàÿµ</option>
        <option value="ŸÇŸàÿßÿπÿØ">ŸÇŸàÿßÿπÿØ</option>
      </select>
    </div>

    <div class="pull-indicator"><div id="pull-bubble" class="bubble">ÿßÿ≥ÿ≠ÿ® ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´‚Ä¶</div></div>
    <div class="posts-container" id="posts-container"></div>
    <div class="posts-container" id="companies-container" style="display:none"></div>
  </div>

<div class="pull-indicator">
  <div id="pull-bubble" class="bubble" style="display: none">
    <i class="fas fa-sync-alt fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´...
  </div>
</div>

  <!-- Profile -->
  <div id="profile-page" class="container page" style="display:none">
    <div class="profile-shell">
      <div class="profile-card">
    <div class="avatar-container">
        <div id="avatar" class="avatar" title="ÿßŸÜŸÇÿ± ŸÑÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©" onclick="openAvatarModal()">
            <div style="width:100%;height:100%;font-size:40px;line-height:72px">üë®üèª‚Äçüíº</div>
        </div>
        <div class="avatar-upload-btn" onclick="openImageUploadModal()" title="ÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿ¥ÿÆÿµŸäÿ©">
            <i class="fas fa-camera"></i>
        </div>
    </div>
    <!-- Modal ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ© -->
<div id="image-upload-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿ¥ÿÆÿµŸäÿ©</h2>
            <button class="close-modal" onclick="closeImageUploadModal()">&times;</button>
        </div>
        <div class="select-group">
            <label>ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ©</label>
            <input type="file" id="avatar-upload-input" accept="image/*" class="form-control">
            <div class="hint" style="text-align: center; margin-top: 10px;">
                <small>ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑÿ£ŸÇÿµŸâ: 2MB | ÿßŸÑÿµŸäÿ∫ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ©: JPG, PNG, GIF</small>
            </div>
        </div>
        <div id="avatar-preview" style="text-align: center; margin: 15px 0; display: none;">
            <img id="avatar-preview-img" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #4a6bff;">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeImageUploadModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
            <button id="upload-avatar-btn" class="btn btn-success" onclick="uploadAvatar()" disabled>ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©</button>
        </div>
    </div>
</div>
        <div class="profile-meta">
          <div class="profile-name-row">
            <span id="profile-name"></span>
            <span id="profile-verified"></span>
            <i class="fas fa-pencil-alt" style="color:var(--primary-color);cursor:pointer" onclick="editProfileName()"></i>
          </div>
          <div id="profile-count" class="profile-count"></div>
          <div id="profile-email" class="profile-email"></div>
          <div class="row" style="align-items: center; gap: 8px; margin-top:4px;">
            <input id="profile-uid-input" class="form-control profile-uid-input" readonly />
            <button class="btn btn-xs" onclick="copyUidToClipboard()"><i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ</button>
          </div>
        </div>
      </div>
      <div class="profile-actions-card">
<div class="profile-menu">
<div class="menu-item" onclick="showUserPosts()">
  <i class="fas fa-book"></i>
  <span>ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™Ÿä</span>
</div>

  <div class="menu-item" onclick="showInbox();">
    <i class="fas fa-inbox"></i>
    <span>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ</span>
    <div id="inbox-badge" class="nav-badge" style="display: none">0</div>
  </div>
  
  <!-- ŸÅŸä ÿµŸÅÿ≠ÿ© profile-page ÿ™ÿ≠ÿ™ ÿπŸÜÿµÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ -->
<div class="menu-item" onclick="showReferralSystem()">
  <i class="fas fa-user-plus"></i>
  <span>ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©</span>
</div>

  <div class="menu-item" onclick="openUserStats()">
    <i class="fas fa-chart-pie"></i>
    <span>ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</span>
  </div>
  
          <div class="menu-item" onclick="openAppExplanation()"><i class="fas fa-info-circle"></i><span>ÿ¥ÿ±ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</span></div>
          <div class="menu-item" onclick="openTelegram('MSLM_ALMYALY')"><i class="fas fa-thumbtack"></i><span>ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ± ÿ®ŸÄ 1$</span></div>
<!-- ÿ≤ÿ± ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± -->
<div class="menu-item owner-only" style="display:none" onclick="openMoreActionsPage()">
    <i class="fas fa-th-list"></i>
    <span>ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±</span>
</div>
          <div class="menu-item" onclick="logout()" style="color: var(--danger-color);"><i class="fas fa-sign-out-alt"></i><span>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span></div>
        </div>
      </div>
    </div>
  </div>

<!-- Modal ÿπÿ¨ŸÑÿ© ÿßŸÑÿ≠ÿ∏ -->
<div id="wheel-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÿπÿ¨ŸÑÿ© ÿßŸÑÿ≠ÿ∏ üé°</h2>
      <button class="close-modal" onclick="closeWheelModal()">&times;</button>
    </div>
    <div style="text-align:center; padding:20px">
      <!-- ÿßŸÑÿ≥ŸáŸÖ - ÿ£ÿ∂ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ -->
<!-- ÿßŸÑÿ≥ŸáŸÖ Ÿäÿ∂ŸÑ ŸÅŸä ÿßŸÑÿ£ÿπŸÑŸâ ÿπŸÑÿ¥ÿßŸÜ Ÿäÿ®ÿßŸÜ ÿ£Ÿä ÿ¨ÿßÿ¶ÿ≤ÿ© ŸÉÿ≥ÿ®Ÿáÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
<div style="position:relative; margin:0 auto; width:300px;">
    </div>
    
    <div id="wheel-container" style="position:relative; width:300px; height:300px; margin:40px auto 0 auto">
        <canvas id="wheel-canvas" width="300" height="300"></canvas>
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); 
                   background: #dc3545 !important; 
                   border:3px solid #fff; 
                   border-radius:50%; 
                   width:80px; height:80px; 
                   display:flex; align-items:center; justify-content:center;
                   font-weight:900; color:#fff; cursor:pointer; 
                   box-shadow:0 0 25px rgba(220,53,69,0.5); font-size:18px;"
             onclick="spinWheel()" id="spin-button">
            ÿßÿ®ÿØÿ°
        </div>
    </div>
</div>
      
      <div id="wheel-result" style="margin-top:20px; font-weight:900; font-size:18px; display:none">
        <!-- ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
      </div>
      
      <div class="hint" style="margin-top:15px">
        üéÅ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤: 10, 25, 50, 75, 100, 150, 200, 250 ŸÜŸÇÿ∑ÿ©<br>
        ‚è∞ ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ≥ÿ≠ÿ® ŸÖÿ±ÿ© ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™
      </div>
    </div>
  </div>
</div>

  <!-- User posts -->
<div id="user-posts-page" class="container page" style="display:none">
  <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™Ÿä</span></div>
  <div class="posts-container" id="user-posts-container"></div>
</div>

<!-- Inbox -->
<div id="inbox-page" class="container page" style="display:none">
  <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ</span></div>
  <div class="posts-container" id="inbox-container"></div>
</div>

<!-- Details -->
<div id="details-page" class="container page" style="display:none">
  <div class="header"><button class="btn btn-secondary" onclick="backToMainFromDetails()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±</span></div>
  <div class="posts-container" id="details-container"></div>
</div>

<!-- Comments -->
<div id="comments-page" class="container page" style="display:none">
  <div class="header"><button class="btn btn-secondary" onclick="backToMainFromComments()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™</span></div>
  <div class="posts-container">
    <div id="comments-list-page"></div>
    <div class="row" style="margin-top:10px;">
      <input type="text" id="comment-text-page" class="form-control grow" placeholder="ÿ£ÿ∂ŸÅ ÿ™ÿπŸÑŸäŸÇŸãÿß...">
      <button id="send-comment-btn" class="btn" onclick="addCommentFromPage()">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
    </div>
  </div>
</div>

<!-- Challenge (ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©) -->
<div id="challenge-page" class="container page" style="display:none">
  <div class="header">
    <span style="font-weight:900">ÿ™ÿ≠ÿØŸä ÿØÿ±ÿßÿ≥Ÿä</span>
  </div>
  <div class="challenge-shell">
    <div class="challenge-tab-nav">
      <button class="challenge-tab-pill active" data-tab="timer" onclick="switchChallengeTab(this)">ÿ™ÿ≠ÿØŸä ÿßŸÑŸÖÿ§ŸÇÿ™</button>
      <button class="challenge-tab-pill" data-tab="leaderboard" onclick="switchChallengeTab(this)">ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿπÿßŸÑŸÖŸä</button>
      <button class="challenge-tab-pill" data-tab="journey" onclick="switchChallengeTab(this)">ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥</button>
    </div>

    <div id="challenge-tab-timer" class="challenge-tab-content active">
      <!-- ŸÇÿ≥ŸÖ ÿßŸÑŸáÿØÿßŸäÿß ÿ£ÿπŸÑŸâ ÿßŸÑŸÖÿ§ŸÇÿ™ -->
      <div class="gift-section-sm">
        <div style="font-weight:900;color:#0f235f;margin-bottom:8px">ÿßÿ¥ÿ™ÿ±Ÿä ŸÖÿ±ÿ¥ÿ≠ÿßÿ™ ÿßŸÑŸÖŸàÿßÿØ ÿ®ÿßŸÑŸÜŸÇÿßÿ∑ Ÿàÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖŸÉÿßŸÅÿ¢ÿ™</div>
        <button class="btn btn-success btn-block" onclick="openGiftsModal()"><i class="fas fa-gift"></i> ÿπÿ±ÿ∂ ÿßŸÑŸáÿØÿßŸäÿß ŸàÿßŸÑÿ¥ÿ±ÿßÿ°</button>
        <div id="purchased-gifts-btn" class="purchased-gifts-btn" onclick="showPurchasedGifts()" style="display:none; margin-top:10px">
          <i class="fas fa-box-open"></i> ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™ ÿßŸÑÿ™Ÿä ÿßÿ¥ÿ™ÿ±Ÿäÿ™Ÿáÿß
        </div>
      </div>

      <div class="timer-card">
        <div class="timer-title">ÿπÿØŸëÿßÿØ ÿØÿ±ÿßÿ≥ÿ™ŸÉ</div>
        <div id="timer-display" class="timer-display">00:00:00</div>
        <div class="points-display">
          ÿ±ÿµŸäÿØŸÉ: <b id="current-points-display">0</b> ŸÜŸÇÿ∑ÿ©
        </div>
        <div class="timer-actions">
          <button id="timer-start-btn" class="btn" onclick="startStudyTimer()"><i class="fa-solid fa-play"></i> ÿ®ÿØÿ°</button>
          <button id="timer-stop-btn" class="btn btn-warning" onclick="stopStudyTimer()" disabled><i class="fa-solid fa-stop"></i> ÿ•ŸäŸÇÿßŸÅ</button>
        </div>
        <div id="timer-hint" class="hint">1 ŸÜŸÇÿ∑ÿ© ŸÑŸÉŸÑ ÿØŸÇŸäŸÇÿ™ŸäŸÜ. ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ŸäŸèÿ∂ÿßÿπŸÅ ÿßŸÑÿØŸÇŸäŸÇÿ© ÿØÿßÿÆŸÑ ŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ.</div>
      </div>

      <!-- ÿ®ÿØŸÑ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸä ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ§ŸÇÿ™ -->
<div class="daily-reward">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
    <div style="font-weight:800;color:#0f235f">ÿπÿ¨ŸÑÿ© ÿßŸÑÿ≠ÿ∏ üé°</div>
    <button id="wheel-spin-btn" class="btn btn-success" onclick="openWheelModal()">
      <i class="fas fa-gift"></i> ÿ≥ÿ≠ÿ® ÿπÿ¨ŸÑÿ© ÿßŸÑÿ≠ÿ∏
    </button>
  </div>
  <div id="wheel-remaining" class="hint" style="margin-top:10px"></div>
</div>

      <div class="boost-card">
        <div class="timer-title">ŸÖÿ∂ÿßÿπŸÅÿ© ÿßŸÑŸÜŸÇÿßÿ∑ 2√ó </div>
        <div class="hint">ÿßÿÆÿ™ÿ± ÿ≠ÿ≤ŸÖÿ© ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ© ŸÑŸÉ:</div>
        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
          <button class="btn" onclick="buyBoost(1)">1 ÿ≥ÿßÿπÿ© (25 ŸÜŸÇÿ∑ÿ©)</button>
          <button class="btn" onclick="buyBoost(2)">2 ÿ≥ÿßÿπÿßÿ™ (50 ŸÜŸÇÿ∑ÿ©)</button>
          <button class="btn" onclick="buyBoost(3)">3 ÿ≥ÿßÿπÿßÿ™ (75 ŸÜŸÇÿ∑ÿ©)</button>
          <button class="btn" onclick="buyBoost(5)">5 ÿ≥ÿßÿπÿßÿ™ (100 ŸÜŸÇÿ∑ÿ©)</button>
        </div>
        <div id="boost-status" class="hint" style="margin-top: 10px; font-weight: 700;"></div>
      </div>
    </div>

    <div id="challenge-tab-leaderboard" class="challenge-tab-content">
      <div class="post-title" style="font-size:16px;color:#0f235f;font-weight:900">ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿπÿßŸÑŸÖŸä (ÿ£ÿπŸÑŸâ 50)</div>

      <!-- ÿ¥ÿ±Ÿäÿ∑ ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅ: ÿ≤ÿ± ŸÖŸÉÿßŸÅÿ¢ÿ™ + ÿπÿØ ÿ™ŸÜÿßÿ≤ŸÑŸä ÿ£ÿ≥ÿ®ŸàÿπŸä -->
      <div class="lb-tools">
        <button class="btn" id="lb-rewards-btn" onclick="openLbRewardsModal()"><i class="fa-solid fa-trophy"></i> ŸÖŸÉÿßŸÅÿ¶ÿßÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅ</button>
        <div class="countdown" id="leaderboard-countdown" aria-label="ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿµŸÜŸäŸÅ">
          <span class="cd-box"><span class="cd-num" id="cd-days">00</span><span class="cd-lbl">ÿ£ŸäÿßŸÖ</span></span>
          <span class="cd-box"><span class="cd-num" id="cd-hours">00</span><span class="cd-lbl">ÿ≥ÿßÿπÿßÿ™</span></span>
          <span class="cd-box"><span class="cd-num" id="cd-mins">00</span><span class="cd-lbl">ÿØŸÇÿßÿ¶ŸÇ</span></span>
          <span class="cd-box"><span class="cd-num" id="cd-secs">00</span><span class="cd-lbl">ÿ´ŸàÿßŸÜŸä</span></span>
        </div>
      </div>

      <div id="challenge-leaderboard" class="rank-list">
        <div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿµŸÜŸäŸÅ...</p></div>
      </div>
    </div>

    <div id="challenge-tab-journey" class="challenge-tab-content">
      <!-- ÿ≤ÿ± ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ÿ™ŸàŸâ (ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑) -->
      <button class="btn btn-block owner-only" id="add-journey-btn" style="display:none" onclick="addJourneyContent()">
        <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ÿ™ŸàŸâ
      </button>

      <div id="journey-container" class="journey-container">
        <div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿ≠ÿ™ŸàŸâ ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥...</p></div>
      </div>
    </div>
</div>
</div>

<!-- üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©: Modal ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ -->
<div id="user-management-modal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>üõ†Ô∏è ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h2>
            <button class="close-modal" onclick="closeUserManagementModal()">&times;</button>
        </div>
        
        <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ®ÿ≠ÿ´ -->
        <div class="select-group">
            <label>ÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</label>
            <div class="row">
                <input type="text" id="user-search-input" class="form-control grow" 
                       placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖÿå ÿßŸÑÿ®ÿ±ŸäÿØÿå ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿÆÿ™ÿµÿ±...">
                <button class="btn" onclick="searchUsers()">
                    <i class="fas fa-search"></i> ÿ®ÿ≠ÿ´
                </button>
            </div>
        </div>

        <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© -->
        <div class="stats-grid" style="margin: 15px 0;">
            <div class="stat-card">
                <div class="stat-number" id="total-users-count">0</div>
                <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="banned-users-count">0</div>
                <div class="stat-label">ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±ŸäŸÜ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="verified-users-count">0</div>
                <div class="stat-label">ÿßŸÑŸÖŸàÿ´ŸëŸÇŸäŸÜ</div>
            </div>
        </div>

        <!-- ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ -->
        <div style="max-height: 500px; overflow-y: auto;">
            <div id="users-list-container">
                <div class="post"><p>ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ®ÿ≠ÿ´ ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ...</p></div>
            </div>
        </div>
    </div>
</div>

    <div id="broadcast-overlay"></div>
    <div id="broadcast-banner">
      <button class="x" onclick="dismissBroadcast()">√ó</button>
      <div style="font-weight:900;color:#0f235f" id="broadcast-title-display"></div>
      <div id="broadcast-text-display" style="margin-top:4px;color:#0f235f"></div>
    </div>
    
<!-- Bottom nav -->
<div id="bottom-nav" class="bottom-nav">
  <div class="nav-item" data-page="challenge" onclick="showChallengePage()">
    <i class="fas fa-fire"></i>
    <span>ÿ™ÿ≠ÿØŸä ÿØÿ±ÿßÿ≥Ÿä</span>
    <!-- ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅŸÇÿßÿπÿ© ŸáŸÜÿß ŸÉŸÖÿß ÿ∑ŸÑÿ®ÿ™ -->
  </div>
<div class="nav-item active" data-page="main" onclick="showMainPage();">
  <i class="fas fa-home"></i>
  <span>ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™</span>
  <div id="posts-badge" class="nav-badge" style="display: none">0</div>
</div>
  <div class="nav-item" data-page="profile" onclick="showProfilePage()">
    <i class="fas fa-user"></i>
    <span>ÿ≠ÿ≥ÿßÿ®Ÿä</span>
    <!-- ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ -->
    <div class="nav-badge" style="display: none"></div>
  </div>
</div>

<div id="notification" class="notification"></div>

<!-- Modals: ÿßŸÑŸáÿØÿßŸäÿß / ÿ¥ÿ±ÿßÿ° ŸáÿØŸäÿ© / ÿ¥ÿ±ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ -->
<div id="gifts-modal" class="modal"><div class="modal-content">
  <div class="modal-header"><h2>ŸáÿØÿßŸäÿß ŸàŸÖÿ±ÿ¥ÿ≠ÿßÿ™ ÿßŸÑŸÖŸàÿßÿØ</h2><button class="close-modal" onclick="closeGiftsModal()">&times;</button></div>
  <div id="gifts-list" style="max-height: 400px; overflow-y: auto;">
    <div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸáÿØÿßŸäÿß...</p></div>
  </div>
</div></div>

<div id="purchased-gifts-modal" class="modal"><div class="modal-content">
  <div class="modal-header"><h2>ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™ ÿßŸÑÿ™Ÿä ÿßÿ¥ÿ™ÿ±Ÿäÿ™Ÿáÿß</h2><button class="close-modal" onclick="closePurchasedGiftsModal()">&times;</button></div>
  <div id="purchased-gifts-list" style="max-height: 400px; overflow-y: auto;">
    <div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™...</p></div>
  </div>
</div></div>

<div id="buy-gift-modal" class="modal"><div class="modal-content">
  <div class="modal-header"><h2 id="buy-gift-title">ÿ¥ÿ±ÿßÿ° ŸáÿØŸäÿ©</h2><button class="close-modal" onclick="closeBuyGiftModal()">&times;</button></div>
  <div class="post">
    <p id="buy-gift-description"></p>
    <p class="muted">ÿßŸÑÿ≥ÿπÿ±: <span id="buy-gift-price"></span> ŸÜŸÇÿ∑ÿ©</p>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeBuyGiftModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
      <button class="btn btn-success" onclick="purchaseGift()">ÿ¥ÿ±ÿßÿ°</button>
    </div>
  </div>
</div></div>

<div id="app-explanation-modal" class="modal"><div class="modal-content">
  <div class="modal-header"><h2>ÿ¥ÿ±ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</h2><button class="close-modal" onclick="closeAppExplanationModal()">&times;</button></div>
  <div id="app-explanation-content" style="max-height: 400px; overflow-y: auto;">
    <div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ¥ÿ±ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ...</p></div>
  </div>
</div></div>

<!-- ÿµŸÅÿ≠ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© -->
<div id="referral-page" class="container page" style="display:none">
  <div class="header">
    <button class="btn btn-secondary" onclick="showProfilePage()">
      <i class="fas fa-arrow-right"></i>
    </button>
    <span style="font-weight:900">ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©</span>
  </div>
  <div class="profile-shell">
    <div class="profile-actions-card">
      <!-- ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© -->
      <div class="post" style="text-align: center; margin-bottom: 20px;">
        <h3>üéÅ ŸÉŸàÿØ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ</h3>
        <div class="row" style="align-items: center; justify-content: center; gap: 10px; margin: 15px 0;">
          <input id="referral-code-input" class="form-control" style="text-align: center; font-weight: bold; font-size: 18px;" readonly />
          <button class="btn btn-success" onclick="copyReferralCode()">
            <i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ
          </button>
        </div>
      </div>

      <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© -->
      <div class="stats-grid" style="margin: 20px 0;">
        <div class="stat-card">
          <div class="stat-number" id="referral-count">0</div>
          <div class="stat-label">ÿπÿØÿØ ÿßŸÑŸÖŸèÿ≠ÿßŸÑŸêŸäŸÜ</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="referral-points">0</div>
          <div class="stat-label">ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑŸÖŸÉÿ™ÿ≥ÿ®ÿ©</div>
        </div>
      </div>

      <!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ -->
      <div class="post" style="background: #fff3cd; border: 1px solid #ffeaa7;">
        <h4>üìã ÿ™ŸÅÿßÿµŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©:</h4>
        <ul style="text-align: right; line-height: 1.8; margin: 10px 0;">
          <li>üéØ <strong>ÿ£ŸÜÿ™ ÿ™ÿ±ÿ®ÿ≠ 150 ŸÜŸÇÿ∑ÿ©</strong> ŸÑŸÉŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ ŸäÿØÿÆŸÑ ÿ®ÿ±ŸÖÿ≤ŸÉ</li>
          <li>üéÅ <strong>ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ¨ÿØŸäÿØ Ÿäÿ±ÿ®ÿ≠ 75 ŸÜŸÇÿ∑ÿ©</strong> ŸÖÿ¨ÿßŸÜÿßŸã</li>
          <li>üö´ <strong>ÿ™ÿ≠ÿ∞Ÿäÿ±:</strong> ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ŸàŸáŸÖŸäÿ© ÿ™ÿ§ÿØŸä ÿ•ŸÑŸâ ÿ≠ÿ∏ÿ± ÿØÿßÿ¶ŸÖ</li>
          <li>‚úÖ <strong>ŸäÿØÿπŸÖ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™</strong> ÿßŸÑŸÇÿØŸäŸÖÿ© ŸàÿßŸÑÿ¨ÿØŸäÿØÿ©</li>
        </ul>
      </div>

      <!-- ŸÉŸäŸÅŸäÿ© ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ -->
      <div class="post">
        <h4>üìù ŸÉŸäŸÅŸäÿ© ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ:</h4>
        <p style="text-align: center; font-weight: bold; color: #4a6bff;">
          ÿ¥ÿßÿ±ŸÉ ÿ±ŸÖÿ≤ŸÉ: <span id="referral-share-code" style="color: #dc3545;"></span>
        </p>
        <p style="text-align: center;">ÿßÿ∑ŸÑÿ® ŸÖŸÜ ÿ£ÿµÿØŸÇÿßÿ¶ŸÉ ÿ•ÿØÿÆÿßŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÖÿ≤ ÿπŸÜÿØ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ¨ÿØŸäÿØ</p>
      </div>
    </div>
  </div>
</div>

<!-- ŸÖŸàÿØÿßŸÑÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸäÿ¥ÿ™ÿ∫ŸÑ ŸÉŸÑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± -->
<div id="create-post-modal" class="modal"><div class="modal-content">
  <div class="modal-header"><h2>ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÜÿ¥Ÿàÿ±</h2><button class="close-modal" onclick="closeCreatePostModal()">&times;</button></div>
  <div class="select-group"><label>ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©</label>
    <select id="post-stage" class="select-control">
      <option value="sades-elmi">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿπŸÑŸÖŸä</option>
      <option value="sades-adabi">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿßÿØÿ®Ÿä</option>
      <option value="khames">ÿßŸÑÿÆÿßŸÖÿ≥</option>
      <option value="rabea">ÿßŸÑÿ±ÿßÿ®ÿπ</option>
      <option value="thaleth-mut">ÿßŸÑÿ´ÿßŸÑÿ´ ŸÖÿ™Ÿàÿ≥ÿ∑</option>
      <option value="thani-mut">ÿßŸÑÿ´ÿßŸÜŸä ŸÖÿ™Ÿàÿ≥ÿ∑</option>
      <option value="awal-mut">ÿßŸÑÿßŸàŸÑ ŸÖÿ™Ÿàÿ≥ÿ∑</option>
      <option value="sades-ibtidai">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä</option>
    </select>
  </div>
  <div class="select-group"><label>ÿßŸÑŸÖÿßÿØÿ©</label>
    <select id="post-material" class="select-control">
      <option>ÿßÿ≥ŸÑÿßŸÖŸäÿ©</option><option>ÿπÿ±ÿ®Ÿä</option><option>ÿßŸÜŸÉŸÑŸäÿ≤Ÿä</option>
      <option>ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™</option><option>ÿßÿ≠Ÿäÿßÿ°</option><option>ŸÉŸäŸÖŸäÿßÿ°</option>
      <option>ŸÅŸäÿ≤Ÿäÿßÿ°</option><option>ÿßŸÇÿ™ÿµÿßÿØ</option><option>ÿ£ÿØÿ® ŸàŸÜÿµŸàÿµ</option><option>ŸÇŸàÿßÿπÿØ</option>
    </select>
  </div>
  <div class="select-group"><label>ÿßŸÑÿ≥ÿπÿ±</label><input id="post-price" class="select-control" type="number" value="0"></div>
  <div class="select-group"><label>ÿßŸÑŸàÿµŸÅ</label><textarea id="post-description" class="select-control" rows="4"></textarea></div>
  <div class="select-group"><label>ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ</label>
    <select id="contact-method" class="select-control" onchange="changeContactMethod()">
      <option value="whatsapp">Ÿàÿßÿ™ÿ≥ÿßÿ®</option>
      <option value="telegram">ÿ™ŸÑŸÉÿ±ÿßŸÖ</option>
      <option value="comments">ÿ™ÿπŸÑŸäŸÇÿßÿ™</option>
    </select>
  </div>
  <div id="whatsapp-field" class="select-group"><label>ÿ±ŸÇŸÖ Ÿàÿßÿ™ÿ≥ÿßÿ®</label><input id="whatsapp-number" class="select-control" placeholder="9647xxxxxxxxx"></div>
  <div id="telegram-field" class="select-group" style="display:none"><label>ŸÖÿπÿ±ŸëŸÅ ÿ™ŸÑŸÉÿ±ÿßŸÖ</label><input id="telegram-username" class="select-control" placeholder="username ÿ®ÿØŸàŸÜ @"></div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeCreatePostModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
    <button id="post-submit-btn" class="btn" onclick="createPost()">ŸÜÿ¥ÿ±</button>
  </div>
</div></div>

<div id="edit-post-modal" class="modal"><div class="modal-content">
  <div class="modal-header"><h2>ÿ™ÿπÿØŸäŸÑ ŸÖŸÜÿ¥Ÿàÿ±</h2><button class="close-modal" onclick="closeEditPostModal()">&times;</button></div>
  <input type="hidden" id="edit-post-id"/>
  <div class="select-group"><label>ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©</label>
    <select id="edit-post-stage" class="select-control">
      <option value="sades-elmi">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿπŸÑŸÖŸä</option>
      <option value="sades-adabi">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿßÿØÿ®Ÿä</option>
      <option value="khames">ÿßŸÑÿÆÿßŸÖÿ≥</option>
      <option value="rabea">ÿßŸÑÿ±ÿßÿ®ÿπ</option>
      <option value="thaleth-mut">ÿßŸÑÿ´ÿßŸÑÿ´ ŸÖÿ™Ÿàÿ≥ÿ∑</option>
      <option value="thani-mut">ÿßŸÑÿ´ÿßŸÜŸä ŸÖÿ™Ÿàÿ≥ÿ∑</option>
      <option value="awal-mut">ÿßŸÑÿßŸàŸÑ ŸÖÿ™Ÿàÿ≥ÿ∑</option>
      <option value="sades-ibtidai">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä</option>
    </select>
  </div>
  <div class="select-group"><label>ÿßŸÑÿ≥ÿπÿ±</label><input id="edit-post-price" class="select-control" type="number"></div>
  <div class="select-group"><label>ÿßŸÑŸÖÿßÿØÿ©</label>
    <select id="edit-post-material" class="select-control">
      <option>ÿßÿ≥ŸÑÿßŸÖŸäÿ©</option><option>ÿπÿ±ÿ®Ÿä</option><option>ÿßŸÜŸÉŸÑŸäÿ≤Ÿä</option>
      <option>ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™</option><option>ÿßÿ≠Ÿäÿßÿ°</option><option>ŸÉŸäŸÖŸäÿßÿ°</option>
      <option>ŸÅŸäÿ≤Ÿäÿßÿ°</option><option>ÿßŸÇÿ™ÿµÿßÿØ</option><option>ÿ£ÿØÿ® ŸàŸÜÿµŸàÿµ</option><option>ŸÇŸàÿßÿπÿØ</option>
    </select>
  </div>
  <div class="select-group"><label>ÿßŸÑŸàÿµŸÅ</label><textarea id="edit-post-description" class="select-control" rows="4"></textarea></div>
  <div class="select-group"><label>ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ</label>
    <select id="edit-contact-method" class="select-control" onchange="changeContactMethod('edit')">
      <option value="whatsapp">Ÿàÿßÿ™ÿ≥ÿßÿ®</option>
      <option value="telegram">ÿ™ŸÑŸÉÿ±ÿßŸÖ</option>
      <option value="comments">ÿ™ÿπŸÑŸäŸÇÿßÿ™</option>
    </select>
  </div>
  <div id="edit-whatsapp-field" class="select-group"><label>ÿ±ŸÇŸÖ Ÿàÿßÿ™ÿ≥ÿßÿ®</label><input id="edit-whatsapp-number" class="select-control"></div>
  <div id="edit-telegram-field" class="select-group" style="display:none"><label>ŸÖÿπÿ±ŸëŸÅ ÿ™ŸÑŸÉÿ±ÿßŸÖ</label><input id="edit-telegram-username" class="select-control"></div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeEditPostModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
    <button id="post-edit-submit-btn" class="btn" onclick="savePostEdits()">ÿ≠ŸÅÿ∏</button>
  </div>
</div></div>

<div id="create-company-modal" class="modal"><div class="modal-content">
  <div class="modal-header"><h2>ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ÿ±ŸÉÿ© ÿ™ŸàÿµŸäŸÑ</h2><button class="close-modal" onclick="closeCreateCompanyModal()">&times;</button></div>
  <div class="select-group"><label>ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ©</label><input id="company-name" class="select-control"></div>
  <div class="select-group"><label>ŸÖŸÜ</label><select id="company-from" class="select-control"></select></div>
  <div class="select-group"><label>ÿ•ŸÑŸâ</label><select id="company-to" class="select-control"></select></div>
  <div class="select-group"><label>ÿßŸÑŸáÿßÿ™ŸÅ</label><input id="company-phone" class="select-control"></div>
  <div class="select-group"><label>ŸàÿµŸÅ</label><textarea id="company-desc" class="select-control" rows="3"></textarea></div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeCreateCompanyModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
    <button id="company-submit-btn" class="btn btn-success" onclick="createCompany()">ÿ•ÿ∂ÿßŸÅÿ©</button>
  </div>
</div></div>

<div id="avatar-modal" class="modal"><div class="modal-content">
  <div class="modal-header">
    <h2>ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©</h2><button class="close-modal" onclick="closeAvatarModal()">&times;</button></div>
  <div class="choose-avatar">
    <button class="btn" onclick="setAvatar('male')">üë®üèª‚Äçüíº ŸàŸÑÿØ</button>
    <button class="btn" onclick="setAvatar('female')">üë©üèª‚Äçüíº ÿ®ŸÜÿ™</button>
  </div>
</div></div>

<div id="add-points-modal" class="modal"><div class="modal-content">
  <div class="modal-header"><h2>ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÇÿßÿ∑</h2><button class="close-modal" onclick="closeModal()">&times;</button></div>
  <div class="select-group"><label>UID/ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿÆÿ™ÿµÿ±</label><input id="addpoints-uid" class="select-control" placeholder="ÿ£ÿØÿÆŸÑ UID ÿßŸÑŸÉÿßŸÖŸÑ ÿ£Ÿà ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿÆÿ™ÿµÿ± (ŸÖÿ´ÿßŸÑ: ABC12DE)"></div>
  <div class="select-group"><label>ÿπÿØÿØ ÿßŸÑŸÜŸÇÿßÿ∑</label><input id="addpoints-num" type="number" class="select-control" value="50"></div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
    <button class="btn btn-success" onclick="(function(){ const uid=document.getElementById('addpoints-uid').value.trim(); const n=parseInt(document.getElementById('addpoints-num').value||'0',10); if(uid && n){ addPointsDirectly(uid,n);} })()">ÿ•ÿ∂ÿßŸÅÿ©</button>
  </div>
</div></div>

<div id="broadcast-modal" class="modal"><div class="modal-content">
  <div class="modal-header"><h2>ÿ•ÿ¥ÿπÿßÿ± ÿπÿßŸÖ</h2><button class="close-modal" onclick="closeModal()">&times;</button></div>
  <div class="select-group"><label>ÿßŸÑÿπŸÜŸàÿßŸÜ</label><input id="bcast-title" class="select-control"></div>
  <div class="select-group"><label>ÿßŸÑŸÜÿµ</label><textarea id="bcast-text" class="select-control" rows="4"></textarea></div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
    <button class="btn btn-success" onclick="sendBroadcast()">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
  </div>
</div></div>

<!-- Modal ŸÜÿ≥Ÿäÿ™ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± - ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸÖÿ®ÿ≥ÿ∑ -->
<div id="forgot-password-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</h2>
      <button class="close-modal" onclick="closeForgotPasswordModal()">&times;</button>
    </div>
    <div class="select-group">
      <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
      <input type="email" id="forgot-email" class="select-control" placeholder="ÿ£ÿØÿÆŸÑ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿßŸÑŸÖÿ≥ÿ¨ŸÑ">
    </div>
    <div style="background:#fff3cd; padding:10px; border-radius:8px; text-align:center;">
üí° <strong>ÿ™ŸÜÿ®ŸäŸá:</strong> 
ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÖŸÉŸÜ ÿ™ŸàÿµŸÑ <strong>"ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ±ÿ∫Ÿàÿ® ŸÅŸäŸáÿß"</strong>
</div>
    <div class="hint" style="text-align: center; color: var(--light-text); font-size: 12px; margin: 10px 0;">
      ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ•ŸÑŸâ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeForgotPasswordModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
      <button id="forgot-submit-btn" class="btn btn-success" onclick="handleForgotPassword()">ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©</button>
    </div>
  </div>
</div>

<!-- ÿµŸÅÿ≠ÿßÿ™ ŸÖÿ≥ÿ™ŸÇŸÑŸëÿ© -->
<div id="journey-item-page" class="container page" style="display:none">
  <div class="header"><button class="btn btn-secondary" onclick="showChallengePage()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥</span></div>
  <div class="posts-container" id="journey-item-container"></div>
</div>

<div id="app-explanation-page" class="container page" style="display:none">
  <div class="header"><button class="btn btn-secondary" onclick="showProfilePage()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">ÿ¥ÿ±ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</span></div>
  <div class="posts-container" id="app-explanation-list"></div>
</div>

<div id="user-stats-page" class="container page" style="display:none">
  <div class="header"><button class="btn btn-secondary" onclick="showProfilePage()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</span></div>
  <div class="posts-container" id="user-stats-container"></div>
</div>

<!-- ÿµŸÅÿ≠ÿ© ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± -->
<div id="more-actions-page" class="container page" style="display:none">
  <div class="header">
<button class="btn btn-secondary" onclick="showPage('profile')">
    <span style="font-weight:900">ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±</span>
  </div>
  
  <div class="profile-shell">
    <div class="profile-actions-card">
      <div class="profile-menu">
        <!-- ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ -->
        <div class="menu-item" onclick="openUserManagement()">
          <i class="fas fa-users-cog"></i>
          <span>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</span>
        </div>
        
        <!-- ŸÉÿ¥ŸÅ ÿßŸÑŸÜŸÇÿßÿ∑ -->
        <div class="menu-item" onclick="openPointsReport()">
          <i class="fas fa-file-invoice"></i>
          <span>ŸÉÿ¥ŸÅ ÿßŸÑŸÜŸÇÿßÿ∑</span>
        </div>
        
        <!-- ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÇÿßÿ∑ -->
        <div class="menu-item" onclick="openAddPointsModal()">
          <i class="fas fa-plus"></i>
          <span>ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÇÿßÿ∑</span>
        </div>
        
        <!-- ŸÖŸàÿπÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿµŸÜŸäŸÅ -->
        <div class="menu-item" onclick="openLbScheduleModal()">
          <i class="fa-solid fa-clock"></i>
          <span>ŸÖŸàÿπÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿµŸÜŸäŸÅ</span>
        </div>
        
        <!-- ÿ•ÿ¥ÿπÿßÿ± ÿπÿßŸÖ -->
        <div class="menu-item" onclick="openBroadcastModal()">
          <i class="fas fa-bullhorn"></i>
          <span>ÿ•ÿ¥ÿπÿßÿ± ÿπÿßŸÖ</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: ŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅ -->
<div id="lb-rewards-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ŸÖŸÉÿßŸÅÿ¶ÿßÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅ</h2>
      <button class="close-modal" onclick="closeLbRewardsModal()">&times;</button>
    </div>
    <div class="post">
      <ul style="line-height:2">
        <li><b>ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ£ŸàŸÑ:</b> 2000 ŸÜŸÇÿ∑ÿ©</li>
        <li><b>ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ´ÿßŸÜŸä:</b> 1500 ŸÜŸÇÿ∑ÿ©</li>
        <li><b>ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ´ÿßŸÑÿ´:</b> 1000 ŸÜŸÇÿ∑ÿ©</li>
        <li><b>ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ±ÿßÿ®ÿπ:</b> 500 ŸÜŸÇÿ∑ÿ©</li>
        <li><b>ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿÆÿßŸÖÿ≥:</b> 300 ŸÜŸÇÿ∑ÿ©</li>
      </ul>
      <div class="lb-note">
        ‚úÖ <b>ÿ™ŸÜÿ®ŸäŸá ŸÖŸáŸÖ:</b> ŸÑÿß ÿ™Ÿèÿµÿ±ŸÅ ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™ ÿ•ŸÑÿß ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÜŸÇÿßÿ∑ŸÉ <u>200 ŸÜŸÇÿ∑ÿ© ŸÅÿ£ŸÉÿ´ÿ±</u> ÿπŸÜÿØ ŸÜŸáÿßŸäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπÿå ÿ≠ÿ™Ÿâ ŸÑŸà ŸÉŸÜÿ™ ÿ∂ŸÖŸÜ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑÿÆŸÖÿ≥ÿ© ÿßŸÑÿ£ŸàŸÑŸâ.
      </div>
    </div>
  </div>
</div>

<!-- Modal: ŸÖŸàÿπÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿµŸÜŸäŸÅ (ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿßŸÑÿ™ÿ£ÿ¨ŸäŸÑ) -->
<div id="lb-schedule-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ŸÖŸàÿπÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿµŸÜŸäŸÅ</h2>
      <button class="close-modal" onclick="closeLbScheduleModal()">&times;</button>
    </div>
    <div class="select-group">
      <label>ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´</label>
      <select id="lb-schedule-day" class="select-control">
        <option value="0">ÿßŸÑÿ£ÿ≠ÿØ</option>
        <option value="1">ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ</option>
        <option value="2">ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°</option>
        <option value="3">ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°</option>
        <option value="4">ÿßŸÑÿÆŸÖŸäÿ≥</option>
        <option value="5">ÿßŸÑÿ¨ŸÖÿπÿ©</option>
        <option value="6">ÿßŸÑÿ≥ÿ®ÿ™</option>
      </select>
    </div>
    <div class="select-group">
      <label>ŸàŸÇÿ™ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´</label>
      <input id="lb-schedule-time" class="select-control" type="time" value="00:00">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeLbScheduleModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
      <button class="btn btn-success" onclick="ownerSetLbSchedule()"><i class="fa-solid fa-calendar-alt"></i> ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàÿπÿØ</button>
    </div>
  </div>
</div>

<!-- Modal ŸÉÿ¥ŸÅ ÿßŸÑŸÜŸÇÿßÿ∑ -->
<div id="points-report-modal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2>ŸÉÿ¥ŸÅ ÿßŸÑŸÜŸÇÿßÿ∑ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</h2>
      <button class="close-modal" onclick="closePointsReportModal()">&times;</button>
    </div>
    
    <!-- ÿÆÿßŸÜÿ© ÿßŸÑÿ®ÿ≠ÿ´ -->
    <div class="select-group">
      <label>ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ÿ®ÿ±ŸäÿØ ÿ£Ÿà ŸÖÿπÿ±ŸÅ)</label>
      <div class="row">
        <input type="text" id="points-search-input" class="form-control grow" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ£Ÿà ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿÆÿ™ÿµÿ±">
        <button class="btn" onclick="searchUserPoints()"><i class="fas fa-search"></i> ÿ®ÿ≠ÿ´</button>
      </div>
    </div>

    <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
    <div id="points-user-info" style="display: none; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
      <div style="font-weight: bold;" id="points-user-name"></div>
      <div style="color: #666; font-size: 14px;" id="points-user-email"></div>
      <div style="color: #666; font-size: 14px;" id="points-user-shortuid"></div>
    </div>

    <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÜŸÇÿßÿ∑ -->
    <div id="points-stats" style="display: none; margin: 15px 0;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="total-points">0</div>
          <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸÇÿßÿ∑</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="current-points">0</div>
          <div class="stat-label">ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="wallet-points">0</div>
          <div class="stat-label">ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©</div>
        </div>
      </div>
    </div>

    <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜŸÇÿßÿ∑ -->
    <div style="max-height: 500px; overflow-y: auto;">
      <div id="points-report-container">
        <div class="post"><p>ÿßŸÉÿ™ÿ® ÿ®ÿ±ŸäÿØ ÿ£Ÿà ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ´ŸÖ ÿßÿ∂ÿ∫ÿ∑ ÿ®ÿ≠ÿ´</p></div>
      </div>
    </div>
  </div>
</div>
<script>
/* =========================
   Firebase & Globals
========================= */
const firebaseConfig = {
  apiKey:"AIzaSyBkoSz3ZUy4qKBTeLx42Oo-TlTtvFtF2vY",
  authDomain:"we-kill-the-sixth.firebaseapp.com",
  databaseURL:"https://we-kill-the-sixth-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"we-kill-the-sixth",
  storageBucket:"we-kill-the-sixth.appspot.com",
  messagingSenderId:"862363949793",
  appId:"1:862363949793:web:e0dc01a4eb139da43f75a0",
  measurementId:"G-CT6WFGXRHH"
};

// üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ÿ™ŸáŸäÿ¶ÿ© Firebase ŸÅŸàÿ±ÿßŸã
try {
  firebase.initializeApp(firebaseConfig);
  console.log("‚úÖ Firebase initialized immediately");
} catch (error) {
  console.log("Firebase already initialized");
}

const db = firebase.firestore();
const auth = firebase.auth();

// üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≥ÿ®ŸÇÿßŸã
let appInitialized = false;
let cachedUserData = null;

/* ===== Telegram ===== */
const TELEGRAM_BOT_TOKEN = "8167852054:AAHt587_tOX_XASuNlskt3odkfJHNesiDxc";
const TELEGRAM_OWNER_ID   = "7782429739";
const APP_OWNER_EMAIL     = "mslmalmyaly223@gmail.com";

/* ===== State ===== */
let pendingChosenAvatar = null;
let lastBroadcast = null;
let isFirstLoginSession = false;

let currentUser = null;
let posts = [];
let companies = [];
let activeSection = "posts";
let currentDetailsPostId = null;
let currentCommentsPostId = null;
const userMetaCache = {};

// ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅ
let leaderboardSettings = { 
  nextReset: null,
  scheduleDay: 0,
  scheduleTime: "00:00"
};

/* ===== ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿßŸÑÿ¨ÿØŸäÿØ ===== */
let referralListener = null;

let _ownerUidCache = null;
// ÿ£ÿ∂ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÅŸä ŸÇÿ≥ŸÖ State
let leaderboardUnsub = null;
let journeyUnsub = null;
window._leaderboardInit = false;
window._journeyInit = false;
// ÿÆÿ∑ÿ£: ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸÅÿ©
window._leaderboardInit = false; // Ÿäÿ¨ÿ® ÿ™ÿπÿ±ŸäŸÅŸáÿß ŸÅŸä ÿßŸÑÿ£ÿπŸÑŸâ
window._journeyInit = false;
/* ===== ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸàÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ===== */
let unreadNotifications = {
    inbox: 0,
    newPosts: 0,
    weeklyRewards: 0,
    reports: 0,
    purchases: 0
};

let notificationsListener = null;
let postsListener = null;
let lastSeenPostsTime = null;

/* ===== ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÅŸÇÿßÿπÿßÿ™ ŸÅŸä ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ŸÜŸÇŸÑ ===== */
let unreadPostsCount = 0;
let hasUnreadInbox = false;

/* =========================
   Utilities & UI helpers
========================= */
function showNotification(msg,type="success"){
  const n=document.getElementById("notification");
  n.textContent=msg; n.style.display="block";
  const colors={error:'var(--danger-color)',warning:'var(--warning-color)',info:'var(--primary-color)',success:'var(--success-color)'};
  n.style.backgroundColor = colors[type]||colors.success;
  clearTimeout(n._t);
  n._t=setTimeout(()=>{ n.style.display="none"; },2600);
}
function escapeHTML(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
function validateEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase()); }
function formatWhatsApp(v){ 
  let num = (v||"").toString().replace(/[^\d]/g, "");
  if (num.startsWith('07') && num.length === 11) { return '964' + num.substring(1); }
  if (num.startsWith('96407') && num.length === 14) { return '964' + num.substring(4); }
  return num;
}
function sanitizeTelegram(v){ return (v||"").toString().replace(/^@+/,"").trim(); }
function openTelegram(username){ username=sanitizeTelegram(username); if(!username) return; window.location.href = "https://t.me/" + username; }
function copyUidToClipboard(){
  const el=document.getElementById('profile-uid-input');
  if(!el) return; el.select(); el.setSelectionRange(0,99999);
  document.execCommand('copy'); showNotification('ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ','success');
}
function isOwner(){ return currentUser && (currentUser.email===APP_OWNER_EMAIL || currentUser.isOwner===true); }
function renderAvatar(kind){
  const el = document.getElementById("avatar");
  const bg = kind==="female" ? "#ffd7ea" : "#d7e4ff";
  const emoji = kind==="female" ? "üë©üèª‚Äçüíº" : "üë®üèª‚Äçüíº";
  el.style.background = bg;
  el.innerHTML = `<div style="font-size:40px;line-height:72px">${emoji}</div>`;
}

// ÿ™ŸàŸÑŸäÿØ ŸÖÿπÿ±ŸÅ ŸÖÿÆÿ™ÿµÿ±
function generateShortUid(uid) {
  if (!uid) return '';
  let hash = 0;
  for (let i = 0; i < uid.length; i++) {
    hash = ((hash << 5) - hash) + uid.charCodeAt(i);
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36).substring(0, 7).toUpperCase();
}

async function getOwnerUid(){
  if(_ownerUidCache) return _ownerUidCache;
  try{
    const q = await db.collection('users').where('email','==', APP_OWNER_EMAIL).limit(1).get();
    if(!q.empty){ _ownerUidCache = q.docs[0].id; return _ownerUidCache; }
  }catch(e){}
  return null;
}

/* Telegram notify */
async function sendTelegramNotification(message, chatId = TELEGRAM_OWNER_ID) {
  try {
    if (!TELEGRAM_BOT_TOKEN) return false;
    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    const MAX = 3900;
    const chunks = [];
    for (let i = 0; i < message.length; i += MAX) {
      chunks.push(message.slice(i, i + MAX));
    }
    for (const chunk of chunks) {
      const res = await fetch(url, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ chat_id: chatId, text: chunk, parse_mode: 'HTML' })
      });
      const data = await res.json();
      if (!data.ok) return false;
    }
    return true;
  } catch { return false; }
}

/* ===== ÿØŸàÿßŸÑ ÿ™ÿ™ÿ®ÿπ ŸàŸÇÿ™ ÿßŸÑŸÖÿ¥ÿßŸáÿØÿ© ===== */
function getLastSeenTime() {
    const lastSeen = localStorage.getItem('lastSeenTime');
    return lastSeen ? new Date(parseInt(lastSeen)) : new Date(0);
}

function updateLastSeenTime() {
    localStorage.setItem('lastSeenTime', Date.now().toString());
}

function getLastSeenPostsTime() {
    const lastSeen = localStorage.getItem('lastSeenPostsTime');
    return lastSeen ? new Date(parseInt(lastSeen)) : new Date(0);
}

function updateLastSeenPostsTime() {
    localStorage.setItem('lastSeenPostsTime', Date.now().toString());
}

/* ===== ÿØŸàÿßŸÑ ÿ™ÿ™ÿ®ÿπ ŸàŸÇÿ™ ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ===== */
function getLastSeenPostsTime() {
    const lastSeen = localStorage.getItem('lastSeenPostsTime');
    const time = lastSeen ? new Date(parseInt(lastSeen)) : new Date(0);
    console.log('‚è∞ ŸàŸÇÿ™ ÿ¢ÿÆÿ± ŸÖÿ¥ÿßŸáÿØÿ© ŸÑŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™:', time);
    return time;
}

function updateLastSeenPostsTime() {
    const now = Date.now();
    localStorage.setItem('lastSeenPostsTime', now.toString());
    unreadPostsCount = 0;
    updateNavBadges();
    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿßŸÑŸÖÿ¥ÿßŸáÿØÿ©:', new Date(now));
}

// ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿßŸÑŸÖÿ¥ÿßŸáÿØÿ© ÿπŸÜÿØ ÿØÿÆŸàŸÑ ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™
function showMainPage() {
    showPage("main");
    updateLastSeenPostsTime();
}

/* ===== ŸÜÿ∏ÿßŸÖ ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ===== */
function startNotificationsListener() {
    if (!currentUser) return;
    
    // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÇÿØŸäŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
    if (notificationsListener) {
        notificationsListener();
    }
    
    // ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ
    notificationsListener = db.collection('inbox')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'unread')
        .onSnapshot(async (snapshot) => {
            let totalUnread = 0;
            
            snapshot.forEach(doc => {
                totalUnread++;
            });
            
            unreadNotifications.inbox = totalUnread;
            updateAllBadges();
        }, (error) => {
            console.error('Notifications listener error:', error);
        });
    
    // ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© (ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿπÿßÿØŸä)
    if (!isOwner()) {
        startPostsListener();
    }
    
    // ŸÑŸÑŸÖÿßŸÑŸÉ: ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ ŸàÿßŸÑÿ®ŸÑÿßÿ∫ÿßÿ™
    if (isOwner()) {
        startOwnerListeners();
    }
}

/* ===== ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ===== */
function startPostsListener() {
    console.log('üöÄ ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±...');
    
    // ÿ£ŸàŸÇŸÅ ÿ£Ÿä ŸÖÿ≥ÿ™ŸÖÿπ ŸÇÿØŸäŸÖ
    if (postsListener) {
        postsListener();
        postsListener = null;
    }
    
    const lastSeenTime = getLastSeenPostsTime();
    console.log('üîç ÿ£ÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿ®ÿπÿØ:', lastSeenTime.toLocaleString('ar-IQ'));
    
    // ŸÖÿ≥ÿ™ŸÖÿπ ŸÖÿ®ÿßÿ¥ÿ± ŸÑŸÉŸÑ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
    postsListener = db.collection('posts')
        .where('createdAt', '>=', lastSeenTime)
        .where('status', 'in', ['active', 'sold'])
        .onSnapshot((snapshot) => {
            const newPosts = snapshot.docs.filter(doc => {
                const postTime = doc.data().createdAt?.toDate?.();
                return postTime && postTime > lastSeenTime;
            });
            
            const newCount = newPosts.length;
            
            if (newCount > 0) {
                console.log('üéØ ÿßŸÉÿ™ÿ¥ŸÅÿ™', newCount, 'ŸÖŸÜÿ¥Ÿàÿ± ÿ¨ÿØŸäÿØ:', 
                    newPosts.map(p => ({
                        ŸÖÿßÿØÿ©: p.data().material,
                        ŸÖÿ≥ÿ™ÿÆÿØŸÖ: p.data().userName,
                        ŸàŸÇÿ™: p.data().createdAt?.toDate?.().toLocaleTimeString('ar-IQ')
                    }))
                );
                
                unreadPostsCount = newCount;
                updateNavBadges();
                
                // ÿ•ÿ¥ÿπÿßÿ± ŸÅŸàÿ±Ÿä ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                if (newCount > 0 && !isOwner()) {
                    console.log('üì¢ ÿ•ÿ¥ÿπÿßÿ±: ŸáŸÜÿßŸÉ ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿ¨ÿØŸäÿØÿ©!');
                }
            }
        }, (error) => {
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ:', error);
        });
}

// ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
function startPostsListener() {
    if (postsListener) {
        postsListener();
    }
    
    const lastSeenTime = getLastSeenPostsTime();
    
    postsListener = db.collection('posts')
        .where('createdAt', '>', lastSeenTime)
        .onSnapshot((snapshot) => {
            unreadNotifications.newPosts = snapshot.size;
            updateAllBadges();
        }, (error) => {
            console.error('Posts listener error:', error);
        });
}

// ŸÖÿ≥ÿ™ŸÖÿπÿßÿ™ ÿÆÿßÿµÿ© ÿ®ÿßŸÑŸÖÿßŸÑŸÉ
function startOwnerListeners() {
    // ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
    db.collection('purchases')
        .where('createdAt', '>', getLastSeenTime())
        .onSnapshot((snapshot) => {
            unreadNotifications.purchases = snapshot.size;
            updateAllBadges();
        });

    // ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿ®ŸÑÿßÿ∫ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
    db.collection('inbox')
        .where('type', '==', 'admin_report')
        .where('status', '==', 'unread')
        .where('createdAt', '>', getLastSeenTime())
        .onSnapshot((snapshot) => {
            unreadNotifications.reports = snapshot.size;
            updateAllBadges();
        });
}

// ÿ•ŸäŸÇÿßŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπŸäŸÜ
function stopAllListeners() {
    if (notificationsListener) {
        notificationsListener();
        notificationsListener = null;
    }
    if (postsListener) {
        postsListener();
        postsListener = null;
    }
}

/* ===== ÿØŸàÿßŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ===== */
function updateAllBadges() {
    updateNavBadges();
    updateInboxBadge();
    updateProfileBadge();
    updatePostsBadge();
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑÿ™ŸÜŸÇŸÑ ÿßŸÑÿ≥ŸÅŸÑŸäÿ©
function updateNavBadges() {
    // ÿπŸÑÿßŸÖÿ© ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™
    const postsBadge = document.getElementById('posts-badge');
    if (postsBadge) {
        if (unreadNotifications.newPosts > 0) {
            postsBadge.style.display = 'flex';
            postsBadge.textContent = unreadNotifications.newPosts > 9 ? '9+' : unreadNotifications.newPosts.toString();
        } else {
            postsBadge.style.display = 'none';
        }
    }
    
    // ÿπŸÑÿßŸÖÿ© ŸÇÿ≥ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸä
    const challengeBadge = document.getElementById('challenge-badge');
    if (challengeBadge) {
        const total = unreadNotifications.weeklyRewards;
        if (total > 0) {
            challengeBadge.style.display = 'flex';
            challengeBadge.textContent = total > 9 ? '9+' : total.toString();
        } else {
            challengeBadge.style.display = 'none';
        }
    }
    
    // ÿπŸÑÿßŸÖÿ© ŸÇÿ≥ŸÖ ÿßŸÑÿ≠ÿ≥ÿßÿ® (ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä)
    const profileNavBadge = document.querySelector('.nav-item[data-page="profile"] .nav-badge');
    if (profileNavBadge) {
        const totalProfile = unreadNotifications.inbox + unreadNotifications.weeklyRewards;
        if (totalProfile > 0) {
            profileNavBadge.style.display = 'flex';
            profileNavBadge.textContent = totalProfile > 9 ? '9+' : totalProfile.toString();
        } else {
            profileNavBadge.style.display = 'none';
        }
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿØÿ± ŸÅŸä ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®
function updateInboxBadge() {
    const inboxBadge = document.getElementById('inbox-badge');
    if (inboxBadge) {
        if (unreadNotifications.inbox > 0) {
            inboxBadge.style.display = 'flex';
            inboxBadge.textContent = unreadNotifications.inbox > 9 ? '9+' : unreadNotifications.inbox.toString();
        } else {
            inboxBadge.style.display = 'none';
        }
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÑÿßŸÖÿ© ŸÇÿ≥ŸÖ ÿßŸÑÿ≠ÿ≥ÿßÿ®
function updateProfileBadge() {
    const profileBadge = document.getElementById('profile-badge');
    if (profileBadge) {
        const total = unreadNotifications.inbox + unreadNotifications.weeklyRewards;
        if (total > 0) {
            profileBadge.style.display = 'flex';
            profileBadge.textContent = total > 9 ? '9+' : total.toString();
        } else {
            profileBadge.style.display = 'none';
        }
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÑÿßŸÖÿ© ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ŸÅŸä ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®
function updatePostsBadge() {
    const postsMenuBadge = document.getElementById('posts-menu-badge');
    if (postsMenuBadge) {
        if (unreadNotifications.newPosts > 0) {
            postsMenuBadge.style.display = 'flex';
            postsMenuBadge.textContent = unreadNotifications.newPosts > 9 ? '9+' : unreadNotifications.newPosts.toString();
        } else {
            postsMenuBadge.style.display = 'none';
        }
    }
}

/* ===== ÿØŸàÿßŸÑ Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ŸÉŸÖŸÇÿ±Ÿàÿ° ===== */
// Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÉŸÖŸÇÿ±Ÿàÿ°ÿ©
async function markAllNotificationsAsRead() {
    if (!currentUser) return;
    
    try {
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ
        const inboxSnapshot = await db.collection('inbox')
            .where('userId', '==', currentUser.uid)
            .where('status', '==', 'unread')
            .get();
        
        const batch = db.batch();
        inboxSnapshot.forEach(doc => {
            batch.update(doc.ref, { status: 'read' });
        });
        
        await batch.commit();
        
        // ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿßŸÑŸÖÿ¥ÿßŸáÿØÿ©
        updateLastSeenTime();
        updateLastSeenPostsTime();
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿπÿØÿßÿØ
        unreadNotifications.inbox = 0;
        unreadNotifications.newPosts = 0;
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        updateAllBadges();
        
        showNotification('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÉŸÖŸÇÿ±Ÿàÿ°ÿ©', 'success');
        
    } catch (error) {
        console.error('Error marking notifications as read:', error);
    }
}

// Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ŸÉŸÖÿ¥ÿßŸáÿØÿ©
function markPostsAsSeen() {
    updateLastSeenPostsTime();
    unreadNotifications.newPosts = 0;
    updateAllBadges();
}

// Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ÿπŸÑŸâ ÿ•ÿ¥ÿπÿßÿ± ŸÖÿπŸäŸÜ ŸÉŸÖŸÇÿ±Ÿàÿ°
async function markNotificationAsRead(notificationId) {
    try {
        await db.collection('inbox').doc(notificationId).update({
            status: 'read',
            readAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿØÿßÿØ
        if (unreadNotifications.inbox > 0) {
            unreadNotifications.inbox--;
        }
        
        updateAllBadges();
        
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}
/* ===== ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑŸÜŸÇÿßÿ∑ ===== */
async function logPointsTransaction(userId, points, type, description) {
    try {
        await db.collection('points_transactions').add({
            userId: userId,
            points: points,
            type: type, // 'admin_add', 'daily_reward', 'boost_purchase', 'gift_purchase', 'weekly_reward'
            description: description,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            processed: true
        });
        console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© ÿßŸÑŸÜŸÇÿßÿ∑: ${type} - ${points} ŸÜŸÇÿ∑ÿ©`);
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© ÿßŸÑŸÜŸÇÿßÿ∑:', error);
        // ŸÑÿß ŸÜÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ≠ÿ™Ÿâ ŸÑÿß ŸÜÿ≤ÿπÿ¨Ÿá
    }
}
/* ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿπÿßŸÖ */
async function sendBroadcastToAllUsers(message) {
  try {
    const usersSnapshot = await db.collection('users').get();
    const promises = [];
    usersSnapshot.forEach(doc => {
      const user = doc.data();
      if (user.telegramId) {
        promises.push(sendTelegramNotification(message, user.telegramId));
      }
    });
    await Promise.all(promises);
    return true;
  } catch (error) {
    console.error('Error sending broadcast:', error);
    return false;
  }
}

/* =========================
   Splash timing - Ÿäÿ∂ŸÑ Ÿäÿ∏Ÿáÿ± ŸÑÿ≠ÿØ ŸÖÿß Ÿäÿ™ÿ≠ŸÖŸÑ ŸÉŸÑ ÿ¥Ÿä
========================= */
(function(){
  const lastDelay = 0.45, runDur = 0.8, mergeDelay = lastDelay + runDur + .10;
  document.getElementById('final-logo').style.setProperty('--merge-delay', mergeDelay+'s');
  
  // üî• ÿßŸÑÿ™ÿ∫ŸäŸäÿ±: ŸÖÿß ŸÜÿÆÿ™ŸÅŸä ÿßŸÑÿ£ŸÜŸÖŸäÿ¥ŸÜ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
  setTimeout(() => { 
    document.querySelector('.runner')?.remove(); 
    
    // üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿµ "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ" ÿ®ÿπÿØ ÿßŸÑÿ£ŸÜŸÖŸäÿ¥ŸÜ
    setTimeout(() => {
      const loadingText = document.getElementById('loading-text');
      if (loadingText) {
        loadingText.style.display = 'block';
        loadingText.classList.add('show');
        console.log("üìù Showing loading text");
      }
    }, 300);
    
  }, (mergeDelay + 0.4) * 1000);
  
  // üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ŸÖŸÜÿπ ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿ¥ÿßÿ¥ÿ©
  const splash = document.getElementById('splash');
  function skip(){ 
    // ŸÑÿß ÿ™ŸÅÿπŸÑ ÿ¥Ÿäÿ¶ÿßŸã - ŸÖŸÜÿπ ÿßŸÑÿ™ÿÆÿ∑Ÿä
  }
  splash.addEventListener('click', skip);
  splash.addEventListener('touchstart', skip, {passive:true});
})();

// üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ÿØÿßŸÑÿ© ŸÑÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
function hideSplashAfterLoad() {
  const splash = document.getElementById('splash');
  if (splash) {
    splash.classList.add('fade-out');
    setTimeout(() => {
      splash.remove();
      console.log("‚úÖ Splash hidden after complete load");
    }, 600);
  }
}

// üî• ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸÖÿ≠ÿ≥ŸÜ: ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÖÿµÿßÿØŸÇÿ© ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿØÿ±Ÿäÿ¨Ÿä
auth.onAuthStateChanged(async (user) => {
  console.log("üöÄ Auth state detected");
  
  if(!user){
    // ÿ•ÿ∞ÿß ŸÖÿß ŸÉÿßŸÜ ŸÅŸäŸá ŸÖÿ≥ÿ™ÿÆÿØŸÖÿå ŸÜÿÆŸÅŸä ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸàŸÜÿ∏Ÿáÿ± ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
    hideSplashAfterLoad();
    updateUIForLoggedOutUser();
    stopAllListeners();
    return;
  }
  
  try {
    // üî• ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿµ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
    updateLoadingText("ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...");
    
    // üî• ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
    let userData = await loadUserDataFast(user.uid);
    
    if (!userData) {
      updateLoadingText("ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®...");
      // ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ
      isFirstLoginSession = true;
      const shortUid = generateShortUid(user.uid);
      userData = {
        name: user.displayName || user.email.split("@")[0], 
        email: user.email, 
        avatar: pendingChosenAvatar || "male",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
        isVerified: false, 
        isOwner: false, 
        blockedFromPosting: false, 
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(), 
        lastPromoAt: null,
        shortUid: shortUid
      };
      
      await db.collection("users").doc(user.uid).set(userData, {merge:true});
    }
    
    currentUser = { uid: user.uid, ...userData };
    
    // üî• ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿµ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
    updateLoadingText("ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸä...");
    
    // üî• ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
    updateUIForLoggedInUserFast();
    
    // üî• ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿπ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿµ
    await loadAllDataWithProgress();
    
    // üî• ÿ£ÿÆŸäÿ±ÿßŸã: ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿ®ÿπÿØ ÿßŸÉÿ™ŸÖÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
    hideSplashAfterLoad();
    
    pendingChosenAvatar = null;
    
  } catch(e) {
    console.error("User load error:", e);
    // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸàŸÜÿÆŸÅŸä ÿßŸÑÿ¥ÿßÿ¥ÿ©
    currentUser = { 
      uid: user.uid, 
      name: user.email.split("@")[0], 
      email: user.email, 
      avatar: pendingChosenAvatar || "male"
    };
    updateUIForLoggedInUserFast();
    hideSplashAfterLoad();
  }
});

// üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÜÿµ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
function updateLoadingText(text) {
  const loadingText = document.getElementById('loading-text');
  if (loadingText) {
    loadingText.textContent = text;
    console.log("üìù Loading:", text);
  }
}

// üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿπ ÿßŸÑÿ™ŸÇÿØŸÖ
async function loadAllDataWithProgress() {
  try {
    updateLoadingText("ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜŸÇÿßÿ∑...");
    await loadStudyState();
    
    updateLoadingText("ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™...");
    await loadPostsFromFirestore();
    
    updateLoadingText("ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™...");
    await Promise.all([
      loadCompanies(),
      fetchLatestBroadcast(),
      loadLeaderboardSettings()
    ]);
    
    updateLoadingText("ÿ¨ÿßÿ±Ÿä ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ...");
    
    // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ£ŸÜÿ∏ŸÖÿ©
    setTimeout(() => {
      startInboxBadgeListener();
      startPostsListener();
      updateNavBadges();
      console.log('üöÄ All systems activated');
    }, 500);
    
    updateLoadingText("ÿ¨ÿßŸáÿ≤!");
    
  } catch (error) {
    console.error("Data loading error:", error);
    updateLoadingText("ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπ ÿ®ÿπÿ∂ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°");
  }
}

// üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ÿØÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ±Ÿäÿπÿ© ŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
async function loadUserDataFast(uid) {
  try {
    const doc = await db.collection("users").doc(uid).get();
    if (doc.exists) {
      const data = doc.data();
      
      // ÿ™ÿ≠ÿØŸäÿ´ lastSeen ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ©
      setTimeout(() => {
        db.collection("users").doc(uid).update({ 
          lastSeen: firebase.firestore.FieldValue.serverTimestamp() 
        });
      }, 2000);
      
      return data;
    }
    return null;
  } catch (error) {
    console.error("Fast user load error:", error);
    return null;
  }
}

// üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ±Ÿäÿπ ŸÑŸÑŸàÿßÿ¨Ÿáÿ©
function updateUIForLoggedInUserFast() {
  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ŸÅŸÇÿ∑
  if (document.getElementById("profile-name")) {
    document.getElementById("profile-name").textContent = currentUser.name || "";
  }
  
  const shortUid = currentUser.shortUid || generateShortUid(currentUser.uid);
  if (document.getElementById("profile-uid-input")) {
    document.getElementById("profile-uid-input").value = shortUid || "";
  }
  
  renderAvatar(currentUser.avatar === "female" ? "female" : "male");
  
  document.querySelectorAll(".owner-only").forEach(el => {
    el.style.display = isOwner() ? "flex" : "none";
  });
}

/* =========================
   ŸÜÿ∏ÿßŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± - ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸÖÿ≠ÿ≥ŸÜ
========================= */
let passwordResetConfirmation = null;

function openForgotPasswordModal(){
  document.getElementById('forgot-password-modal').style.display = 'block';
  // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ
  document.getElementById('reset-code-section').style.display = 'none';
  document.getElementById('new-password-section').style.display = 'none';
  document.getElementById('forgot-submit-btn').textContent = 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©';
  document.getElementById('forgot-submit-btn').className = 'btn btn-success';
  document.getElementById('forgot-email').value = '';
  document.getElementById('reset-code').value = '';
  document.getElementById('new-password').value = '';
  passwordResetConfirmation = null;
}

async function handleForgotPassword(){
  const email = document.getElementById('forgot-email').value.trim();
  const btn = document.getElementById('forgot-submit-btn');
  
  if(!email) {
    return showNotification('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä', 'error');
  }
  
  if(!validateEmail(email)) {
    return showNotification('ÿµŸäÿ∫ÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©', 'error');
  }
  
  btn.disabled = true;
  btn.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...';
  
  try {
    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Firebase ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
    await auth.sendPasswordResetEmail(email);
    
    showNotification('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ•ŸÑŸâ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä', 'success');
    console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ•ŸÑŸâ:', email);
    
    // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿ®ÿπÿØ 3 ÿ´ŸàÿßŸÜŸä
    setTimeout(() => {
      closeForgotPasswordModal();
    }, 3000);
    
  } catch(error) {
    console.error('Password reset error:', error);
    
    let errorMessage = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©';
    switch(error.code) {
      case 'auth/user-not-found':
        errorMessage = 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ';
        break;
      case 'auth/invalid-email':
        errorMessage = 'ÿµŸäÿ∫ÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©';
        break;
      case 'auth/too-many-requests':
        errorMessage = 'ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ŸÉÿ´Ÿäÿ±ÿ©. ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã';
        break;
      case 'auth/operation-not-allowed':
        errorMessage = 'ÿπŸÖŸÑŸäÿ© ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©';
        break;
      case 'auth/network-request-failed':
        errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ¥ÿ®ŸÉÿ©. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑŸÉ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™';
        break;
      default:
        errorMessage = error.message || errorMessage;
    }
    
    showNotification(errorMessage, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©';
  }
}

// ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
function closeForgotPasswordModal(){
  document.getElementById('forgot-password-modal').style.display = 'none';
  passwordResetConfirmation = null;
}

/* =========================
   Auth
========================= */
function handleAuthError(error){
  const code = (error && error.code) || '';
  const msg  = (error && error.message) ? String(error.message) : '';
  let friendly = 'ÿÆÿ∑ÿ£ ŸÖÿµÿßÿØŸÇÿ©.';
  if (code === 'auth/user-not-found' || code === 'auth/wrong-password' || msg.includes('INVALID_LOGIN_CREDENTIALS')) {
    friendly = 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.';
  } else if (code === 'auth/invalid-email') {
    friendly = 'ÿµŸäÿ∫ÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.';
  } else if (code === 'auth/network-request-failed') {
    friendly = 'ÿ™ÿ≠ŸÇŸëŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.';
  } else if (code === 'auth/too-many-requests') {
    friendly = 'ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ŸÉÿ´Ÿäÿ±ÿ©. ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇŸãÿß.';
  } else if (code === 'auth/email-already-in-use') {
    friendly = 'Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸäÿØ ŸÖÿ≥ÿ¨ŸëŸÑ ŸÖÿ≥ÿ®ŸÇŸãÿß.';
  } else if (code === 'auth/operation-not-allowed') {
    friendly = 'ŸÅÿπŸëŸÑ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑŸÖÿµÿßÿØŸÇÿ© ŸÖŸÜ Firebase > Authentication.';
  }
  showNotification(friendly,'error');
  console.error('Auth error:', error);
}

// ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿØÿßŸÑÿ© register ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ®Ÿáÿ∞Ÿá ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÖÿ®ÿ≥ÿ∑ÿ©
async function register(){
    const name = document.getElementById("register-name").value.trim();
    const email = document.getElementById("register-email").value.trim().toLowerCase();
    const password = document.getElementById("register-password").value;
    const picked = (document.querySelector('input[name="register-avatar"]:checked')?.value) || "male";
    const referralCode = document.getElementById("register-referral")?.value.trim() || '';
    
    pendingChosenAvatar = picked;
    
    if(!name || !email || !password) return showNotification("Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ","error");
    if(!validateEmail(email)) return showNotification("ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠","error");
    
    // ÿ™ÿπÿ∑ŸäŸÑ ÿ≤ÿ± ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
    const registerBtn = document.getElementById("register-submit");
    const originalText = registerBtn.textContent;
    registerBtn.disabled = true;
    registerBtn.textContent = "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ...";
    
    try {
        // 1. üîç ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÄ IP
        const userIP = await getUserIP();
        
        // 2. üö´ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖŸÜÿπ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©
        const ipCheck = await preventMultipleAccounts(userIP, email);
        if (!ipCheck.allowed) {
            // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÖŸÜÿπ ÿ®ÿ¥ŸÉŸÑ Ÿàÿßÿ∂ÿ≠
            showNotification("üö´ ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ", "error");
            
            // ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ŸÅŸä alert ŸÖŸÜŸÅÿµŸÑ
            setTimeout(() => {
                alert(ipCheck.message);
            }, 1000);
            
            return;
        }
        
        // 3. üîç ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±
        const isBanned = await checkIfEmailBanned(email);
        if (isBanned) {
            showNotification("üö´ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÖÿ≠ÿ∏Ÿàÿ±", "error");
            return;
        }
        
        // 4. ‚úÖ ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπÿßÿØŸä
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        const shortUid = generateShortUid(cred.user.uid);
        
        // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿπ ÿßŸÑŸÄ IP
        await db.collection("users").doc(cred.user.uid).set({
            name, 
            email, 
            avatar: picked, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            isVerified: false, 
            isOwner: false, 
            blockedFromPosting: false,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp(), 
            lastPromoAt: null,
            shortUid: shortUid,
            registrationIP: userIP, // ‚úÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÄ IP
            ipRegisteredAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // 5. üéÅ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
        if (referralCode) {
            try {
                const referralResult = await processSuccessfulReferral(cred.user.uid, name, referralCode);
                if (referralResult.success) {
                    showNotification("üéâ ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠! ÿ±ÿ®ÿ≠ÿ™ 75 ŸÜŸÇÿ∑ÿ©", "success");
                }
            } catch (referralError) {
                console.error('Error in referral:', referralError);
            }
        }
        
        showNotification("‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠! ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿ¢ŸÜ.", "success"); 
        switchAuthTab('login'); 
        
    } catch (error) {
        console.error('Registration error:', error);
        handleAuthError(error);
    } finally {
        // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿ≤ÿ± ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
        registerBtn.disabled = false;
        registerBtn.textContent = originalText;
    }
}

function login(){
  const email=document.getElementById("login-email").value.trim();
  const password=document.getElementById("login-password").value;
  if(!email||!password) return showNotification("Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ","error");
  const btn = document.querySelector('#login-form button[type="submit"]');
  if (btn) { btn.disabled = true; btn.textContent = "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ‚Ä¶"; }
  
  // üî• ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ± ŸÇÿ®ŸÑ ÿßŸÑŸÖÿµÿßÿØŸÇÿ©
  checkIfEmailBanned(email).then(isBanned => {
      if (isBanned) {
          showNotification("üö´ Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿ≠ÿ∏Ÿàÿ± ŸàŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ", "error");
          if (btn) { btn.disabled = false; btn.textContent = "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ"; }
          return;
      }
      
      // ŸÖÿ™ÿßÿ®ÿπÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿπÿßÿØŸä
      auth.signInWithEmailAndPassword(email,password)
        .catch(handleAuthError)
        .finally(()=>{ if (btn) { btn.disabled = false; btn.textContent = "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ"; } });
  });
}
function logout(){ auth.signOut(); }

auth.onAuthStateChanged(async (user) => {
  if(!user){
    updateUIForLoggedOutUser();
    stopAllListeners();
    return;
  }
  try{
    let doc = await db.collection("users").doc(user.uid).get();
    if(!doc.exists){
      isFirstLoginSession = true;
      const shortUid = generateShortUid(user.uid);
      await db.collection("users").doc(user.uid).set({
        name: user.displayName || user.email.split("@")[0], 
        email: user.email, 
        avatar: pendingChosenAvatar || "male",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
        isVerified:false, isOwner:false, blockedFromPosting:false, 
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(), 
        lastPromoAt: null,
        shortUid: shortUid
      },{merge:true});
      doc = await db.collection("users").doc(user.uid).get();
    }else{
      isFirstLoginSession = false;
      if (!doc.data().shortUid) {
        const shortUid = generateShortUid(user.uid);
        await db.collection("users").doc(user.uid).update({
          shortUid: shortUid,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await db.collection("users").doc(user.uid).update({ 
          lastSeen: firebase.firestore.FieldValue.serverTimestamp() 
        });
      }
    }
    currentUser = { uid:user.uid, ...doc.data() };
  }catch(e){
    console.error("user load error:", e);
    currentUser = { uid:user.uid, name:user.email.split("@")[0], email:user.email, avatar: pendingChosenAvatar || "male", isVerified:false, blockedFromPosting:false, isOwner:false };
  }
  updateUIForLoggedInUser();
  await Promise.all([loadPostsFromFirestore(), loadCompanies(), fetchLatestBroadcast()]);
  await loadStudyState();
  await loadLeaderboardSettings();
  
  // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ÿ®ÿØÿ° ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑŸÅŸÇÿßÿπÿßÿ™ ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ (ŸÖÿπ ÿ™ÿ£ÿÆŸäÿ± ÿ®ÿ≥Ÿäÿ∑)
  setTimeout(() => {
    startInboxBadgeListener();
    startPostsListener();
    updateNavBadges();
    console.log('üöÄ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÅŸÇÿßÿπÿßÿ™ ŸàÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
  }, 1000);
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ±Ÿä ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ©
  setInterval(updateNavBadges, 30000);

  setTimeout(()=>{ 
    document.getElementById('splash')?.classList.add('fade-out'); 
    setTimeout(()=> document.getElementById('splash')?.remove(), 700); 
  }, 200);
  
  pendingChosenAvatar = null;
});

/* =========================
   Pages & Navigation
========================= */
const pages = {
  auth: document.getElementById("auth-page"), 
  main: document.getElementById("main-page"),
  profile: document.getElementById("profile-page"), 
  userPosts: document.getElementById("user-posts-page"),
  inbox: document.getElementById("inbox-page"), 
  details: document.getElementById("details-page"),
  comments: document.getElementById("comments-page"), 
  challenge: document.getElementById("challenge-page"),
  journeyItem: document.getElementById("journey-item-page"),
  appExplainPage: document.getElementById("app-explanation-page"),
  userStats: document.getElementById("user-stats-page"),
  moreActions: document.getElementById("more-actions-page"),
  referral: document.getElementById("referral-page"), // ‚úÖ ÿ£ÿ∂ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ±
};
const postsContainer = document.getElementById("posts-container");
const companiesContainer = document.getElementById("companies-container");
const userPostsContainer = document.getElementById("user-posts-container");
const detailsContainer = document.getElementById("details-container");
const commentsList = document.getElementById("comments-list-page");
const inboxContainer = document.getElementById("inbox-container");
const createBtn = document.getElementById("create-btn");
const createBtnLabel = document.getElementById("create-btn-label");
const filterBox = document.getElementById("filter-container");
const pillPosts = document.getElementById("pill-posts");
const pillCompanies = document.getElementById("pill-companies");

// ÿ∫Ÿäÿ± ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ®Ÿáÿ∞Ÿá:
function showPage(key){
  Object.values(pages).forEach(p=>p && (p.style.display="none"));
  if(!pages[key]) return;
  pages[key].style.display = (key==="auth")?"flex":"block";
  updateBottomNav(key);
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸÅÿ≠ÿ© - ÿ£ÿ∂ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ±
  updateAllBadges();
}
function updateBottomNav(activePageKey) {
  document.querySelectorAll("#bottom-nav .nav-item").forEach(item => {
    item.classList.toggle("active", item.dataset.page === activePageKey);
  });
}
function showMainPage(){ 
    showPage("main"); 
    // ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿßŸÑŸÖÿ¥ÿßŸáÿØÿ© ÿπŸÜÿØ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™
    updateLastSeenPostsTime();
}
function showProfilePage(){ showPage("profile"); }
function showChallengePage(){ showPage("challenge"); }
function backToProfile(){ showPage("profile"); }
function backToMainFromDetails(){ showPage("main"); }
function backToMainFromComments(){ showPage("main"); }

function switchAuthTab(tab){
  document.querySelectorAll(".auth-tab, .auth-form").forEach(el=>el.classList.remove("active"));
  if(tab==="login"){ document.querySelector(".auth-tab:nth-child(1)").classList.add("active"); document.getElementById("login-form").classList.add("active"); }
  else{ document.querySelector(".auth-tab:nth-child(2)").classList.add("active"); document.getElementById("register-form").classList.add("active"); }
}

function updateUIForLoggedInUser(){
  // üî• ÿßŸÑÿ™ÿ∫ŸäŸäÿ±: ÿ™Ÿàÿ¨ŸäŸá ŸÖÿ®ÿßÿ¥ÿ± ŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸä
  showPage("challenge");
  
  document.getElementById("profile-name").textContent = currentUser.name || "";
  document.getElementById("profile-email").textContent = currentUser.email || "";
  const shortUid = currentUser.shortUid || generateShortUid(currentUser.uid);
  document.getElementById("profile-uid-input").value = shortUid || "";
  
  // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ©
  updateAvatarDisplay(); // ÿ£ÿ∂ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ±
  
  const pv=document.getElementById("profile-verified");
  pv.innerHTML = currentUser.isVerified? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> ŸÖŸàÿ´ŸëŸÇ</span>` : '';
  document.querySelectorAll(".owner-only").forEach(el=> el.style.display = isOwner()? "flex":"none");

  const addJourneyBtn = document.getElementById('add-journey-btn');
  if (addJourneyBtn) addJourneyBtn.style.display = isOwner()? 'block' : 'none';

  updateCreateButton();
  updatePostCountInProfile();
  
  // üî• ÿ•ÿ∂ÿßŸÅÿ©: ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅŸÇÿßÿπÿßÿ™ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
  updateNavBadges();
}

function updateUIForLoggedOutUser(){
  showPage("auth"); 
  postsContainer.innerHTML=""; 
  companiesContainer.innerHTML=""; 
  posts=[]; companies=[]; currentUser=null;
  document.getElementById("broadcast-banner").classList.remove('show');
  document.getElementById("broadcast-overlay").classList.remove('show');
}

/* =========================
   Sections switch
========================= */
function switchSection(section){
  activeSection = section;
  pillPosts.classList.toggle("active", section === "posts");
  pillCompanies.classList.toggle("active", section !== "posts");
  postsContainer.style.display = section === "posts" ? "block" : "none";
  companiesContainer.style.display = section !== "posts" ? "block" : "none";
  filterBox.style.display = section === "posts" ? "flex" : "none";
  updateCreateButton();
}
function updateCreateButton(){
  createBtnLabel.textContent = activeSection === "posts" ? "ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÜÿ¥Ÿàÿ±" : "ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ÿ±ŸÉÿ©";
  const showForPosts = activeSection === "posts" && currentUser;
  const showForCompanies = activeSection !== "posts" && isOwner();
  createBtn.style.display = (showForPosts || showForCompanies) ? "inline-flex" : "none";
}
function onCreateButton(){ if(activeSection==="posts") openCreatePostModal(); else openCreateCompanyModal(); }

/* =========================
   Posts CRUD
========================= */
async function loadPostsFromFirestore(){
  try{
    const snap = await db.collection("posts").orderBy("createdAt","desc").get();
    posts = snap.docs.map(d=>{
      const data=d.data(); const createdAt=data.createdAt?.toDate?data.createdAt.toDate():new Date(0);
      return { id:d.id, isPinned: !!data.isPinned, ...data, createdAt };
    });
    renderPosts();
    updatePostCountInProfile();
  }catch(e){ console.error(e); showNotification("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™","error"); }
}
async function getUserMeta(uid){
  if(userMetaCache[uid]) return userMetaCache[uid];
  try{
    const u = await db.collection("users").doc(uid).get();
    const meta = { isVerified: !!u.data()?.isVerified, blockedFromPosting: !!u.data()?.blockedFromPosting };
    userMetaCache[uid]=meta; return meta;
  }catch{ return { isVerified:false, blockedFromPosting:false }; }
}
function priceLabelFromNumber(price){
  const priceValue = Number(price);
  if (!isNaN(priceValue) && priceValue === 0) return 'ŸÖÿ¨ÿßŸÜÿßŸã';
  try { return `${priceValue.toLocaleString('ar-IQ')} ÿØ.ÿπ`; } catch { return `${priceValue} ÿØ.ÿπ`; }
}
function stageLabel(stage){
  const map = { "sades-elmi":"ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿπŸÑŸÖŸä","sades-adabi":"ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿßÿØÿ®Ÿä","khames":"ÿßŸÑÿÆÿßŸÖÿ≥","rabea":"ÿßŸÑÿ±ÿßÿ®ÿπ","thaleth-mut":"ÿßŸÑÿ´ÿßŸÑÿ´ ŸÖÿ™Ÿàÿ≥ÿ∑","thani-mut":"ÿßŸÑÿ´ÿßŸÜŸä ŸÖÿ™Ÿàÿ≥ÿ∑","awal-mut":"ÿßŸÑÿßŸàŸÑ ŸÖÿ™Ÿàÿ≥ÿ∑","sades-ibtidai":"ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä" };
  return map[stage]||"";
}
function generatePostHTML(post, meta, context = 'list') {
  const badge = meta.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> ŸÖŸàÿ´ŸëŸÇ</span>` : '';
  const pinRibbon = post.isPinned ? '<div class="pin-ribbon"><i class="fa-solid fa-thumbtack"></i> ŸÖÿ´ÿ®ÿ™</div>' : '';
  let ownerTools = '';
  if (isOwner()) {
    const pinTxt = post.isPinned ? 'ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™' : 'ÿ™ÿ´ÿ®Ÿäÿ™';
    const verTxt = meta.isVerified ? 'ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ' : 'ÿ™Ÿàÿ´ŸäŸÇ';
    const banTxt = meta.blockedFromPosting ? 'ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∏ÿ± ÿßŸÑŸÜÿ¥ÿ±' : 'ÿ≠ÿ∏ÿ± ÿßŸÑŸÜÿ¥ÿ±';
    ownerTools = `<div class="owner-tools">
        <button class="btn btn-xs" onclick="ownerTogglePin('${post.id}', ${post.isPinned ? 'true' : 'false'})"><i class="fa-solid fa-thumbtack"></i> ${pinTxt}</button>
        <button class="btn btn-xs" onclick="ownerToggleVerify('${post.userId}')"><i class="fa-solid fa-crown"></i> ${verTxt}</button>
        <button class="btn btn-xs" onclick="ownerToggleUserBanById('${post.userId}')"><i class="fa-solid fa-ban"></i> ${banTxt}</button>
        <button class="btn btn-danger btn-xs" onclick="ownerDeletePost('${post.id}')"><i class="fa-solid fa-trash"></i> ÿ≠ÿ∞ŸÅ</button>
    </div>`;
  }
  const priceLbl = priceLabelFromNumber(post.price);
  const stageLbl = stageLabel(post.stage);
  const userName = escapeHTML(post.userName||'ŸÖÿ≥ÿ™ÿÆÿØŸÖ');
  const material = escapeHTML(post.material||'');
  const description = escapeHTML(post.description||'');
  let contactBtn="";
  if (post.contactMethod === "whatsapp" && post.whatsapp) { contactBtn = `<a class="btn" href="https://wa.me/${post.whatsapp}" target="_blank" rel="noopener">ÿ™ŸàÿßÿµŸÑ (Ÿàÿßÿ™ÿ≥ÿßÿ®)</a>`; } 
  else if (post.contactMethod === "telegram" && post.telegram) { contactBtn = `<button class="btn" onclick="openTelegram('${post.telegram}')">ÿ™ŸàÿßÿµŸÑ (ÿ™ŸÑŸÉÿ±ÿßŸÖ)</button>`; } 
  else if (post.contactMethod === "comments") { contactBtn = `<button class="btn" onclick="openCommentsPage('${post.id}')">ÿ™ŸàÿßÿµŸÑ (ÿ™ÿπŸÑŸäŸÇÿßÿ™)</button>`; }
  let actionButtons = '';
  if (context === 'list') { actionButtons = `<button class="btn btn-secondary" onclick="openDetailsPage('${post.id}')">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±</button>${contactBtn}`; } 
  else if (context === 'details') { 
    const reportedPosts = JSON.parse(localStorage.getItem('reportedPosts') || '[]');
    const isReported = reportedPosts.includes(post.id);
    const reportButton = isReported
        ? '<button class="btn btn-secondary" disabled><i class="fas fa-check"></i> ÿ™ŸÖ ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫</button>'
        : `<button class="btn btn-secondary" onclick="reportPost('${post.id}')"><i class="fas fa-flag"></i> ÿ•ÿ®ŸÑÿßÿ∫</button>`;
    actionButtons = `${reportButton}${contactBtn}`;
  } 
  else if (context === 'user-posts') {
    actionButtons = `
      <button class="btn btn-secondary" onclick="openDetailsPage('${post.id}')">ÿ™ŸÅÿßÿµŸäŸÑ</button> ${contactBtn}
      <button class="btn btn-secondary" onclick="openEditPostModal('${post.id}')"><i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ</button>
      <button class="btn" onclick="repost('${post.id}')"><i class="fas fa-rotate-right"></i> ÿ•ÿπÿßÿØÿ© ŸÜÿ¥ÿ±</button>
      <button class="btn btn-warning" onclick="markSold('${post.id}', ${post.status === 'sold' ? 'true' : 'false'})">${post.status === 'sold' ? 'ÿ•ŸÑÿ∫ÿßÿ° ÿ™ŸÖ ÿ®ŸäÿπŸá' : 'ÿ™ŸÖ ÿ®ŸäÿπŸá'}</button>
      <button class="btn btn-danger" onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ</button>`;
  }
  return `${pinRibbon}${ownerTools}
    <div class="post-header">
      <div class="post-username"><span>${userName}</span> ${badge}</div>
      <div class="post-price">${priceLbl}</div>
      <div class="post-title">${stageLbl?`${stageLbl} - `:''}${material}</div>
    </div>
    <div class="post-description">${description}</div>
    <div class="post-actions">${actionButtons}</div>`;
}
async function renderPosts(){
  postsContainer.innerHTML="";
  const filterMaterial = document.getElementById('filter-material').value;
  const filterStage = document.getElementById('filter-stage').value;
  const sorted=[...posts].sort((a,b)=>{
    if(a.isPinned && !b.isPinned) return -1; if(!a.isPinned && b.isPinned) return 1;
    return (b.createdAt?.getTime?.()||0)-(a.createdAt?.getTime?.()||0);
  });
  const filtered = sorted.filter(p => {
    const isVisible = p.status !== 'sold' && p.status !== 'deleted';
    const materialMatch = !filterMaterial || p.material === filterMaterial;
    const stageMatch = !filterStage || p.stage === filterStage;
    return isVisible && materialMatch && stageMatch;
  });
  if(filtered.length===0){ postsContainer.innerHTML='<div class="post"><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿ™ÿ∑ÿßÿ®ŸÇ ÿßŸÑŸÅŸÑÿ™ÿ±</p></div>'; return; }
  const uids = [...new Set(filtered.map(p => p.userId).filter(Boolean))];
  await Promise.all(uids.map(async uid => { if(!userMetaCache[uid]) userMetaCache[uid] = await getUserMeta(uid); }));
  const frag = document.createDocumentFragment();
  for(const post of filtered){
    const meta = userMetaCache[post.userId] || {isVerified:false, blockedFromPosting:false};
    const card = document.createElement("div");
    card.className = `post ${post.isPinned?'pinned':''}`;
    card.innerHTML = generatePostHTML(post, meta, 'list');
    frag.appendChild(card);
  }
  postsContainer.appendChild(frag);
}
function openCreatePostModal(){ document.getElementById("create-post-modal").style.display="block"; }
function closeCreatePostModal(){ document.getElementById("create-post-modal").style.display="none"; }
function changeContactMethod(prefix = ''){
  const methodEl = document.getElementById(`${prefix ? 'edit-' : ''}contact-method`);
  const w_field = document.getElementById(`${prefix ? 'edit-' : ''}whatsapp-field`);
  const t_field = document.getElementById(`${prefix ? 'edit-' : ''}telegram-field`);
  const method = methodEl ? methodEl.value : '';
  if(w_field) w_field.style.display = method==="whatsapp"?"block":"none"; 
  if(t_field) t_field.style.display = method==="telegram"?"block":"none";
}
let createPostBusy = false;
async function createPost(){
  if(createPostBusy) return; if(!currentUser) return showNotification("Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã","error");
  try { 
    const udoc = await db.collection("users").doc(currentUser.uid).get(); 
    if(udoc.exists && udoc.data()?.blockedFromPosting){ return showNotification("ÿ™ŸÖ ÿ≠ÿ∏ÿ±ŸÉ ŸÖŸÜ ÿßŸÑŸÜÿ¥ÿ±","error"); } 
  } catch(e){ console.warn("check block failed", e); }
  const stage = document.getElementById("post-stage").value.trim(); 
  const price = document.getElementById("post-price").value.trim();
  const material = document.getElementById("post-material").value; 
  const description = document.getElementById("post-description").value.trim();
  const contactMethod = document.getElementById("contact-method").value; 
  const whatsapp = formatWhatsApp(document.getElementById("whatsapp-number").value);
  const telegram = sanitizeTelegram(document.getElementById("telegram-username").value); 
  if(!description) return showNotification("Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿßŸÑŸàÿµŸÅ","error");
  if (contactMethod==="whatsapp" && whatsapp.length !== 12) return showNotification("ÿ±ŸÇŸÖ Ÿàÿßÿ™ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠","error");
  if (contactMethod==="telegram" && !telegram) return showNotification("ŸÖÿπÿ±ŸëŸÅ ÿ™ŸÑŸÉÿ±ÿßŸÖ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠","error");
  createPostBusy = true; 
  const btn = document.getElementById("post-submit-btn"); btn.disabled = true;
  const newPost = { 
    userId:currentUser.uid, userName:currentUser.name, userEmail:currentUser.email||"", 
    stage, material, price: Number(price) || 0, description, contactMethod, 
    whatsapp: contactMethod==="whatsapp"?whatsapp:"", telegram: contactMethod==="telegram"?telegram:"", 
    status:"active", isPinned:false, createdAt:firebase.firestore.FieldValue.serverTimestamp() 
  };
  try{ 
    await db.collection("posts").add(newPost); 
    closeCreatePostModal(); 
    await loadPostsFromFirestore(); 
    showNotification("ÿ™ŸÖ ŸÜÿ¥ÿ± ÿßŸÑŸÖŸÜÿ¥Ÿàÿ± ÿ®ŸÜÿ¨ÿßÿ≠","success");
  } catch(err){ showNotification("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÜÿ¥ÿ±: "+(err.message||err),"error"); } 
  finally{ createPostBusy = false; btn.disabled = false; }
}
function openEditPostModal(postId) {
  const post = posts.find(p => p.id === postId); 
  if (!post) return showNotification("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±", "error");
  document.getElementById('edit-post-id').value = postId; 
  document.getElementById('edit-post-stage').value = post.stage || 'sades-elmi';
  document.getElementById('edit-post-price').value = post.price || 0; 
  document.getElementById('edit-post-material').value = post.material || 'ÿßÿ≥ŸÑÿßŸÖŸäÿ©';
  document.getElementById('edit-post-description').value = post.description || ''; 
  document.getElementById('edit-contact-method').value = post.contactMethod || 'whatsapp';
  document.getElementById('edit-whatsapp-number').value = post.whatsapp || ''; 
  document.getElementById('edit-telegram-username').value = post.telegram || '';
  changeContactMethod('edit'); 
  document.getElementById('edit-post-modal').style.display = 'block';
}
function closeEditPostModal(){ document.getElementById('edit-post-modal').style.display = 'none'; }
async function savePostEdits() {
  const postId = document.getElementById('edit-post-id').value; if (!postId) return;
  const updatedData = {
    stage: document.getElementById('edit-post-stage').value.trim(), 
    price: Number(document.getElementById('edit-post-price').value.trim()) || 0,
    material: document.getElementById('edit-post-material').value, 
    description: document.getElementById('edit-post-description').value.trim(),
    contactMethod: document.getElementById('edit-contact-method').value, 
    whatsapp: formatWhatsApp(document.getElementById('edit-whatsapp-number').value),
    telegram: sanitizeTelegram(document.getElementById('edit-telegram-username').value),
  };
  if (!updatedData.description) return showNotification("ÿßŸÑŸàÿµŸÅ ŸÖÿ∑ŸÑŸàÿ®", "error");
  if (updatedData.contactMethod==="whatsapp" && updatedData.whatsapp.length !== 12) return showNotification("ÿ±ŸÇŸÖ Ÿàÿßÿ™ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠","error");
  if (updatedData.contactMethod==="telegram" && !updatedData.telegram) return showNotification("ŸÖÿπÿ±ŸëŸÅ ÿ™ŸÑŸÉÿ±ÿßŸÖ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠","error");
  const btn = document.getElementById('post-edit-submit-btn'); btn.disabled = true;
  try {
    await db.collection('posts').doc(postId).update(updatedData); 
    showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™', 'success');
    closeEditPostModal(); 
    await loadPostsFromFirestore();
    if (pages.userPosts.style.display === 'block') { showUserPosts(); }
  } catch (e) { showNotification('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™: ' + e.message, 'error'); } 
  finally { btn.disabled = false; }
}
// ÿ∫Ÿäÿ± ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ®Ÿáÿ∞Ÿá:
async function showUserPosts(){
  if(!currentUser) return showNotification("Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ","warning"); 
  showPage("userPosts");
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ŸÉŸÖÿ¥ÿßŸáÿØÿ©
  markPostsAsSeen();
  
  userPostsContainer.innerHTML="";
  // ... ÿ®ÿßŸÇŸä ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä
  const mine = posts.filter(p=>p.userId===currentUser.uid).sort((a,b)=> (b.createdAt?.getTime?.()||0)-(a.createdAt?.getTime?.()||0));
  if(mine.length===0){ userPostsContainer.innerHTML='<div class="post"><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ŸÑŸÉ</p></div>'; return; }
  for(const post of mine){
    const meta = await getUserMeta(post.userId); const div=document.createElement("div");
    div.className=`post ${post.status==='sold'?'sold':''} ${post.status==='deleted'?'deleted':''} ${post.isPinned?'pinned':''}`;
    div.innerHTML = generatePostHTML(post, meta, 'user-posts'); userPostsContainer.appendChild(div);
  }
}
function updatePostCountInProfile(){ if(!currentUser) return; const count = posts.filter(p=>p.userId===currentUser?.uid && p.status!=='deleted').length; const el=document.getElementById("profile-count"); if(el) el.textContent = `ÿπÿØÿØ ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ŸÉ: ${count}`; }
async function repost(postId){ const doc = await db.collection("posts").doc(postId).get(); if(!doc.exists || doc.data().userId !== currentUser.uid) return; await db.collection("posts").doc(postId).update({ createdAt:firebase.firestore.FieldValue.serverTimestamp(), status:'active' }); showNotification("ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÜÿ¥ÿ± Ÿàÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ","success"); await loadPostsFromFirestore(); showUserPosts(); }
async function markSold(postId,isSold){ const doc = await db.collection("posts").doc(postId).get(); if(!doc.exists || doc.data().userId !== currentUser.uid) return; await db.collection("posts").doc(postId).update({ status: isSold? 'active':'sold' }); showNotification(isSold?"ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿßŸÑÿ© ÿßŸÑÿ®Ÿäÿπ":"ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ: ÿ™ŸÖ ÿ®ŸäÿπŸá","success"); await loadPostsFromFirestore(); showUserPosts(); }
async function deletePost(postId){
  if(!currentUser || !confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿü")) return;
  try {
    const doc = await db.collection("posts").doc(postId).get();
    if(!doc.exists || doc.data().userId !== currentUser.uid) return showNotification("ÿ∫Ÿäÿ± ŸÖÿ≥ŸÖŸàÿ≠","error");
    try {
      await db.collection("posts").doc(postId).delete();
    } catch (delErr) {
      await db.collection("posts").doc(postId).update({ status:'deleted' });
    }
    showNotification("ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ","success");
    await loadPostsFromFirestore();
    await showUserPosts();
  } catch(err){ showNotification("ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≠ÿ∞ŸÅ: "+(err.message||err),"error"); }
}
function openDetailsPage(postId){ currentDetailsPostId = postId; showPage("details"); renderDetails(postId); }
async function renderDetails(postId){
  detailsContainer.innerHTML = "<div class='post'><p>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p></div>";
  const post = posts.find(p=>p.id===postId); if(!post){ detailsContainer.innerHTML="<div class='post'><p>ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</p></div>"; return; }
  const meta = await getUserMeta(post.userId); const card = document.createElement("div");
  card.className = `post ${post.isPinned?'pinned':''}`; card.innerHTML = generatePostHTML(post, meta, 'details');
  detailsContainer.innerHTML = ''; detailsContainer.appendChild(card);
}

/* ÿ•ÿ®ŸÑÿßÿ∫ + ÿ™ÿπŸÑŸäŸÇÿßÿ™ */
async function reportPost(postId){
  if(!currentUser) return showNotification('ŸäŸÑÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ','warning');
  const reason = prompt('ÿ≥ÿ®ÿ® ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫:');
  if(!reason) return;
  
  try{
    const post = posts.find(p => p.id === postId);
    
    const ownerQuery = await db.collection('users')
      .where('shortUid', '==', '82JDU7')
      .limit(1)
      .get();
    
    if (ownerQuery.empty) {
      console.log('‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿßŸÑŸÉ ÿ®ŸÄ shortUid: 82JDU7');
      return;
    }
    
    const ownerDoc = ownerQuery.docs[0];
    const ownerUid = ownerDoc.id;
    const ownerData = ownerDoc.data();
    
    console.log('‚úÖ Ÿàÿ¨ÿØŸÜÿß ÿßŸÑŸÖÿßŸÑŸÉ:', ownerData.name, 'ÿ®ŸÄ UID:', ownerUid);

    await db.collection('inbox').add({
      userId: ownerUid,
      type: 'admin_report',
      postId: postId,
      reporterUid: currentUser.uid,
      reporterName: currentUser.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
      reporterShortUid: currentUser.shortUid || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ',
      title: 'üö® ÿ®ŸÑÿßÿ∫ ÿ¨ÿØŸäÿØ',
      message: `üë§ ÿßŸÑŸÖÿ®ŸÑÿ∫: ${currentUser.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'}\nüìù ÿßŸÑÿ≥ÿ®ÿ®: ${reason}\nüÜî ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ®ŸÑÿ∫: ${currentUser.shortUid || currentUser.uid.substring(0, 8)}`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸÑÿßÿ∫ ŸÑŸÑŸÖÿßŸÑŸÉ ÿ®ŸÜÿ¨ÿßÿ≠');

    try {
      const msg = `üì© <b>ÿ®ŸÑÿßÿ∫ ÿ¨ÿØŸäÿØ</b>\n\nüìù ÿßŸÑÿ≥ÿ®ÿ®: ${reason}\nüë§ ÿßŸÑŸÖÿ®ŸÑŸëÿ∫: ${currentUser.name||'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'}\nüÜî ${currentUser.shortUid || currentUser.uid.substring(0, 8)}`;
      await sendTelegramNotification(msg);
    } catch(tgError) {
      console.log('‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ');
    }
    
    const reportedPosts = JSON.parse(localStorage.getItem('reportedPosts') || '[]');
    if(!reportedPosts.includes(postId)){ 
      reportedPosts.push(postId); 
      localStorage.setItem('reportedPosts', JSON.stringify(reportedPosts)); 
    }
    
    showNotification('ÿ™ŸÖ ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫ ÿπŸÜ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ± Ÿàÿ≥Ÿäÿ™ŸÖ ŸÖÿ±ÿßÿ¨ÿπÿ™Ÿá','success');
    
  }catch(e){ 
    console.error('‚ùå Report error:', e);
    showNotification('ÿ™ÿπÿ∞Ÿëÿ± ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸÑÿßÿ∫','error'); 
  }
}
async function openCommentsPage(postId) { if (!currentUser) return; currentCommentsPostId = postId; showPage("comments"); await renderComments(postId); }
async function renderComments(postId) {
  const container = document.getElementById("comments-list-page");
  container.innerHTML = '<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™...</p></div>';
  try {
    const snap = await db.collection("posts").doc(postId).collection("comments").orderBy("createdAt", "asc").get();
    if (snap.empty) { container.innerHTML = '<div class="post"><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿ®ÿπÿØ.</p></div>'; return; }
    container.innerHTML = snap.docs.map(doc => { const c = doc.data(); const d = c.createdAt?.toDate?c.createdAt.toDate().toLocaleString('ar-IQ'):''; return `<div class="post" style="margin-bottom:8px; padding:10px;"><div style="font-weight:bold;">${escapeHTML(c.userName||'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}</div><p style="margin-top:5px;">${escapeHTML(c.text||'')}</p><small style="color:#777;">${d}</small></div>`; }).join('');
  } catch (e) { container.innerHTML = '<div class="post"><p>ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™.</p></div>'; }
}
async function addCommentFromPage() {
  if (!currentUser || !currentCommentsPostId) return;
  const textInput = document.getElementById("comment-text-page"); const text = textInput.value.trim(); if (!text) return;
  const btn = document.getElementById('send-comment-btn'); btn.disabled = true;
  try {
    await db.collection("posts").doc(currentCommentsPostId).collection("comments").add({ text, userId: currentUser.uid, userName: currentUser.name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    textInput.value = ''; await renderComments(currentCommentsPostId);
  } catch (e) { showNotification('ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇ', 'error'); } finally { btn.disabled = false; }
}
/* Owner actions */
async function ownerTogglePin(postId, isPinned){
  if(!isOwner()) return;
  try{
    await db.collection('posts').doc(postId).update({ isPinned: !isPinned });
    showNotification(isPinned?'ÿ£ŸèŸÑÿ∫Ÿä ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™':'ÿ™ŸÖ ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™','success');
    await loadPostsFromFirestore();
  }catch(e){ showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©','error'); }
}
async function ownerToggleVerify(uid){
  if(!isOwner()) return;
  try{
    const uref = db.collection('users').doc(uid);
    const snap = await uref.get();
    const cur = !!snap.data()?.isVerified;
    await uref.update({ isVerified: !cur });
    userMetaCache[uid] = { ...(userMetaCache[uid]||{}), isVerified: !cur };
    showNotification(!cur?'ÿ™ŸÖ ÿ™Ÿàÿ´ŸäŸÇ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ':'ÿ£ŸèŸÑÿ∫Ÿä ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ','success');
    await renderPosts();
  }catch(e){ showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©','error'); }
}
async function ownerToggleUserBanById(uid){
  if(!isOwner()) return;
  try{
    const uref = db.collection('users').doc(uid);
    const snap = await uref.get();
    const cur = !!snap.data()?.blockedFromPosting;
    await uref.update({ blockedFromPosting: !cur });
    userMetaCache[uid] = { ...(userMetaCache[uid]||{}), blockedFromPosting: !cur };
    showNotification(!cur?'ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ ÿßŸÑŸÜÿ¥ÿ±':'ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ∏ÿ±','success');
  }catch(e){ showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©','error'); }
}
async function ownerDeletePost(postId){
  if(!isOwner()) return;
  if(!confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ± ŸÜŸáÿßÿ¶ŸäŸãÿßÿü')) return;
  try{ await db.collection('posts').doc(postId).delete(); showNotification('ÿ≠Ÿèÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±','success'); await loadPostsFromFirestore(); }
  catch(e){ showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ','error'); }
}

/* =========================
   Companies
========================= */
const GOVERNORATES = ["ÿ®ÿ∫ÿØÿßÿØ","ŸÜŸäŸÜŸàŸâ","ÿßŸÑÿ®ÿµÿ±ÿ©","ÿ£ÿ±ÿ®ŸäŸÑ","ÿßŸÑŸÜÿ¨ŸÅ","ŸÉÿ±ÿ®ŸÑÿßÿ°","ÿ∞Ÿä ŸÇÿßÿ±","ÿßŸÑÿ≥ŸÑŸäŸÖÿßŸÜŸäÿ©","ÿØŸäÿßŸÑŸâ","ÿßŸÑÿ£ŸÜÿ®ÿßÿ±","ÿ®ÿßÿ®ŸÑ","ŸÉÿ±ŸÉŸàŸÉ","Ÿàÿßÿ≥ÿ∑","ÿßŸÑŸÖÿ´ŸÜŸâ","ÿßŸÑŸÇÿßÿØÿ≥Ÿäÿ©","ŸÖŸäÿ≥ÿßŸÜ","ÿµŸÑÿßÿ≠ ÿßŸÑÿØŸäŸÜ","ÿØŸáŸàŸÉ","ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿßÿ™"];
function populateGovernorateSelects(selectId) { 
  const select = document.getElementById(selectId); 
  if (!select?.dataset?.populated) { 
    select.innerHTML = GOVERNORATES.map(g => `<option value="${g}">${g}</option>`).join(''); 
    if (select) select.dataset.populated = "true"; 
  } 
}
function openCreateCompanyModal(){ 
  if (!isOwner()) return showNotification('ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑','error'); 
  populateGovernorateSelects('company-from'); 
  populateGovernorateSelects('company-to'); 
  document.getElementById('create-company-modal').style.display = 'block'; 
}
function closeCreateCompanyModal(){ document.getElementById('create-company-modal').style.display='none'; }
async function createCompany(){
  if (!isOwner()) return; 
  const data = { 
    name: document.getElementById('company-name').value.trim(), 
    from: document.getElementById('company-from').value, 
    to: document.getElementById('company-to').value, 
    phone: document.getElementById('company-phone').value.trim(), 
    desc: document.getElementById('company-desc').value.trim(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  if (!data.name || !data.phone || !data.from || !data.to) { 
    return showNotification("Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©", "error"); 
  }
  const btn = document.getElementById('company-submit-btn'); btn.disabled = true;
  try { 
    await db.collection('companies').add(data); 
    showNotification("ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¥ÿ±ŸÉÿ©","success"); 
    closeCreateCompanyModal(); 
    await loadCompanies(); 
  } catch (e) { showNotification("ŸÅÿ¥ŸÑ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¥ÿ±ŸÉÿ©: " + e.message, "error"); } 
  finally { btn.disabled = false; }
}
async function loadCompanies(){
  try{
    const snap = await db.collection('companies').orderBy('createdAt','desc').get();
    companies = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    renderCompanies();
  }catch(e){ companiesContainer.innerHTML='<div class="post"><p>ÿÆÿ∑ÿ£ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™</p></div>'; }
}
function renderCompanies(){
  if(!companies || companies.length===0){ companiesContainer.innerHTML='<div class="post"><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ¥ÿ±ŸÉÿßÿ™ ÿ®ÿπÿØ</p></div>'; return; }
  companiesContainer.innerHTML = companies.map(c => `
    <div class="company">
      <div class="name"><i class="fa-solid fa-truck"></i> ${escapeHTML(c.name||'ÿ¥ÿ±ŸÉÿ©')}</div>
      <div class="route">ŸÖŸÜ: ${escapeHTML(c.from||'-')} ‚Üí ÿ•ŸÑŸâ: ${escapeHTML(c.to||'-')}</div>
      <div class="phone"><i class="fa-solid fa-phone"></i> ${escapeHTML(c.phone||'')}</div>
      ${c.desc?`<div class="desc">${escapeHTML(c.desc)}</div>`:''}
      ${isOwner()?`<div class="post-actions" style="margin-top:8px">
        <button class="btn btn-danger btn-xs" onclick="deleteCompany('${c.id}')"><i class="fa-solid fa-trash"></i> ÿ≠ÿ∞ŸÅ</button>
      </div>`:''}
    </div>
  `).join('');
}
async function deleteCompany(id){
  if(!isOwner()) return;
  if(!confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑÿ¥ÿ±ŸÉÿ©ÿü')) return;
  try{ await db.collection('companies').doc(id).delete(); showNotification('ÿ≠Ÿèÿ∞ŸÅÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©','success'); await loadCompanies(); }
  catch(e){ showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ','error'); }
}

/* =========================
   Profile small actions
========================= */
function openAvatarModal(){ document.getElementById('avatar-modal').style.display='block'; }
function closeAvatarModal(){ document.getElementById('avatar-modal').style.display='none'; }
async function setAvatar(kind){
  if(!currentUser) return;
  try{
    await db.collection('users').doc(currentUser.uid).update({ avatar:kind });
    currentUser.avatar = kind; renderAvatar(kind);
    showNotification('ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´','success'); closeAvatarModal();
  }catch{ showNotification('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸàÿ±ÿ©','error'); }
}
async function editProfileName(){
  if(!currentUser) return;
  const newName = prompt('ÿßŸÉÿ™ÿ® ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØ:', currentUser.name||'');
  if(!newName) return;
  try{ await db.collection('users').doc(currentUser.uid).update({ name:newName }); currentUser.name=newName; document.getElementById('profile-name').textContent=newName; showNotification('ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ','success'); }
  catch{ showNotification('ŸÅÿ¥ŸÑ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ','error'); }
}

/* =========================
   Inbox
========================= */
async function showInbox(){
  if(!currentUser) return showNotification('ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ','warning');
  showPage('inbox');
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÉŸÖŸÇÿ±Ÿàÿ°ÿ© ÿπŸÜÿØ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑÿ®ÿ±ŸäÿØ
  await markAllNotificationsAsRead();
  
  inboxContainer.innerHTML = '<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ...</p></div>';
  
  try {
    const snapshot = await db.collection('inbox').get();
    
    if (snapshot.empty) {
      inboxContainer.innerHTML = '<div class="post"><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ≠ÿßŸÑŸäÿßŸã.</p></div>';
      return;
    }
    
    let filteredDocs = snapshot.docs;
    
    if (isOwner()) {
      filteredDocs = snapshot.docs.filter(doc => {
        const data = doc.data();
        return data.type === 'admin_report' || data.type === 'purchase_notice';
      });
    } else {
      filteredDocs = snapshot.docs.filter(doc => doc.data().userId === currentUser.uid);
    }
    
    if (filteredDocs.length === 0) {
      inboxContainer.innerHTML = '<div class="post"><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ≠ÿßŸÑŸäÿßŸã.</p></div>';
      return;
    }
    
    const sortedDocs = filteredDocs.sort((a,b) => {
      const aTime = a.data().createdAt?.toDate?.()?.getTime() || 0;
      const bTime = b.data().createdAt?.toDate?.()?.getTime() || 0;
      return bTime - aTime;
    });
    
    inboxContainer.innerHTML = sortedDocs.map(doc => {
      const msg = doc.data();
      const created = msg.createdAt?.toDate ? msg.createdAt.toDate().toLocaleString('ar-IQ') : '';
      
      if(isOwner() && msg.type === 'admin_report'){
        if(msg.status === 'resolved'){
          return `
            <div class="post" style="opacity:0.7; background:#f8f9fa;">
              <div style="font-weight:bold;color:#0f235f">üì© ÿ®ŸÑÿßÿ∫ - ${msg.actionMessage || 'ÿ™ŸÖ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©'}</div>
              <p style="margin-top:8px">${escapeHTML(msg.message || '')}</p>
              <div style="color:#28a745; font-weight:bold; margin-top:8px;">
                ‚úÖ ${msg.actionMessage || 'ÿ™ŸÖÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©'}
              </div>
              <small style="color:#777">${created}</small>
            </div>`;
        }
        
        return `
          <div class="post">
            <div style="font-weight:bold;color:#0f235f">üì© ÿ®ŸÑÿßÿ∫ ÿ¨ÿØŸäÿØ - ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ©</div>
            <p style="margin-top:8px">${escapeHTML(msg.message || '')}</p>
            <div class="post-actions">
              <button class="btn btn-danger btn-xs" onclick="adminReportAction('${doc.id}','${escapeHTML(msg.reportId||'')}','ban_poster','${escapeHTML(msg.posterUid||'')}','${escapeHTML(msg.reporterUid||'')}')">
                <i class="fa-solid fa-ban"></i> ÿ≠ÿ∏ÿ± ŸÜÿßÿ¥ÿ± ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±
              </button>
              <button class="btn btn-warning btn-xs" onclick="adminReportAction('${doc.id}','${escapeHTML(msg.reportId||'')}','ban_reporter','${escapeHTML(msg.reporterUid||'')}','${escapeHTML(msg.reporterUid||'')}')">
                <i class="fa-solid fa-user-slash"></i> ÿ≠ÿ∏ÿ± ÿßŸÑŸÖŸèÿ®ŸÑŸëÿ∫
              </button>
              <button class="btn btn-secondary btn-xs" onclick="adminReportAction('${doc.id}','${escapeHTML(msg.reportId||'')}','delete_post','${escapeHTML(msg.postId||'')}','${escapeHTML(msg.reporterUid||'')}')">
                <i class="fa-solid fa-trash"></i> ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±
              </button>
              <button class="btn btn-xs" onclick="adminReportAction('${doc.id}','${escapeHTML(msg.reportId||'')}','reject','','${escapeHTML(msg.reporterUid||'')}')">
                <i class="fa-solid fa-x"></i> ÿ±ŸÅÿ∂ ÿßŸÑÿ®ŸÑÿßÿ∫
              </button>
            </div>
            <small style="color:#777">${created}</small>
          </div>`;
      }
      
      if(isOwner() && msg.type === 'purchase_notice'){
        return `
          <div class="post">
            <div style="font-weight:bold;color:#0f235f">üõí ÿπŸÖŸÑŸäÿ© ÿ¥ÿ±ÿßÿ° ŸÖÿ±ÿ¥ÿ≠ÿßÿ™</div>
            <p><strong>ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:</strong> ${escapeHTML(msg.buyerName||'-')} (${escapeHTML(msg.buyerShortUid||'-')})</p>
            <p><strong>ÿßŸÑÿµŸÜŸÅ:</strong> ${escapeHTML(msg.item||'-')}</p>
            <p><strong>ÿßŸÑÿ≥ÿπÿ±:</strong> ${msg.price||0} ŸÜŸÇÿ∑ÿ©</p>
            <p><strong>ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ©:</strong> ${escapeHTML(msg.operationId||'-')}</p>
            <div class="post-actions">
              <button class="btn btn-success" onclick="openTelegram('MSLM_ALMYALY')"><i class="fab fa-telegram"></i> ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä</button>
            </div>
            <small style="color:#777">${created}</small>
          </div>`;
      }

      return `
        <div class="post">
          <div style="font-weight:bold;color:#0f235f">${escapeHTML(msg.title || 'ÿ•ÿ¥ÿπÿßÿ±')}</div>
          <p style="margin-top:8px">${escapeHTML(msg.message || '')}</p>
          <small style="color:#777">${created}</small>
        </div>`;
    }).join('');
    
  } catch (error) {
    console.error('Error loading inbox:', error);
    inboxContainer.innerHTML = '<div class="post"><p>ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ: ' + error.message + '</p></div>';
  }
}
async function adminReportAction(inboxDocId, reportId, action, targetId, reporterUid){
  if(!isOwner()) return;
  
  try {
    let actionMessage = '';
    let userNotification = '';

    if(action === 'ban_poster' && targetId){
      await db.collection('users').doc(targetId).update({ 
        blockedFromPosting: true 
      });
      actionMessage = 'ÿ™ŸÖ ÿ≠ÿ∏ÿ± ŸÜÿßÿ¥ÿ± ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±';
      userNotification = 'ÿ™ŸÖ ÿ≠ÿ∏ÿ±ŸÉ ŸÖŸÜ ÿßŸÑŸÜÿ¥ÿ±';
      
    } else if(action === 'ban_reporter' && targetId){
      await db.collection('users').doc(targetId).update({ 
        blockedFromPosting: true 
      });
      actionMessage = 'ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿßŸÑŸÖŸèÿ®ŸÑŸëÿ∫';
      userNotification = 'ÿ™ŸÖ ÿ≠ÿ∏ÿ±ŸÉ ŸÖŸÜ ÿßŸÑŸÜÿ¥ÿ±';
      
    } else if(action === 'delete_post' && targetId){
      try {
        await db.collection('posts').doc(targetId).delete();
      } catch(deleteError) {
        await db.collection('posts').doc(targetId).update({ 
          status: 'deleted' 
        });
      }
      actionMessage = 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±';
      userNotification = 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ± ÿßŸÑÿ∞Ÿä ÿ£ÿ®ŸÑÿ∫ÿ™ ÿπŸÜŸá';
      
    } else if(action === 'reject'){
      actionMessage = 'ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ®ŸÑÿßÿ∫';
      userNotification = 'ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿ•ÿ®ŸÑÿßÿ∫ŸÉ';
    }

    if(reportId){
      await db.collection('reports').doc(reportId).update({ 
        status: action === 'reject' ? 'ŸÖÿ±ŸÅŸàÿ∂' : 'ŸÖÿ∫ŸÑŸÇ',
        resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
        resolvedBy: currentUser.uid,
        actionTaken: actionMessage
      });
    }

    if(reporterUid && userNotification){
      await db.collection('inbox').add({
        userId: reporterUid,
        type: 'report_result',
        title: 'ŸÜÿ™Ÿäÿ¨ÿ© ÿ•ÿ®ŸÑÿßÿ∫ŸÉ',
        message: userNotification,
        status: 'unread',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    await db.collection('inbox').doc(inboxDocId).update({ 
      status: 'resolved',
      resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
      resolvedBy: currentUser.uid,
      actionMessage: actionMessage
    });

    showNotification('ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');

    setTimeout(() => {
      showInbox();
    }, 2000);

  } catch(e) {
    console.error('ŸÅÿ¥ŸÑ ÿ•ÿ¨ÿ±ÿßÿ° ÿßŸÑÿ•ÿØÿßÿ±ÿ©:', e);
    showNotification('ŸÅÿ¥ŸÑ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°: ' + e.message, 'error');
  }
}

/* =========================
   Modals helpers
========================= */
function closeModal(){
  document.querySelectorAll('.modal').forEach(m => { if (m.style.display==='block') m.style.display='none'; });
}
document.addEventListener('click', function(e){
  document.querySelectorAll('.modal').forEach(modal => {
    if (e.target === modal) modal.style.display = 'none';
  });
});

/* =========================
   Broadcast & Owner tools
========================= */
function openBroadcastModal(){
  if(!isOwner()) return showNotification('ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑','error');
  document.getElementById('broadcast-modal').style.display='block';
}
async function sendBroadcast(){
  if(!isOwner()) return;
  const title = document.getElementById('bcast-title').value.trim();
  const text  = document.getElementById('bcast-text').value.trim();
  if(!title || !text) return showNotification('ÿßŸÉŸÖŸÑ ÿßŸÑÿ≠ŸÇŸàŸÑ','error');
  try{
    await db.collection('broadcasts').add({
      title, text, createdAt: firebase.firestore.FieldValue.serverTimestamp(), by: currentUser.uid
    });
    
    const broadcastMessage = `üì¢ <b>${escapeHTML(title)}</b>\n\n${escapeHTML(text)}`;
    const sent = await sendBroadcastToAllUsers(broadcastMessage);
    
    if (sent) {
      showNotification('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ','success'); 
    } else {
      showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸàŸÑŸÉŸÜ ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ','warning');
    }
    closeModal();
  }catch(e){ showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ','error'); }
}

async function fetchLatestBroadcast(){
  if (isFirstLoginSession) return;
  try {
    const seenBroadcasts = JSON.parse(localStorage.getItem('seenBroadcasts') || '[]');
    const userSignupTime = localStorage.getItem('userSignupTime');
    const snap = await db.collection('broadcasts').orderBy('createdAt','desc').limit(1).get();
    if (snap.empty) return;
    const broadcast = snap.docs[0];
    const id = broadcast.id;
    const data = broadcast.data();
    const time = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();
    if (!seenBroadcasts.includes(id) && (!userSignupTime || new Date(userSignupTime) < time)) {
      document.getElementById('broadcast-title-display').textContent = data.title || 'ÿ•ÿ¥ÿπÿßÿ± ÿπÿßŸÖ';
      document.getElementById('broadcast-text-display').textContent  = data.text || '';
      document.getElementById('broadcast-banner').classList.add('show');
      document.getElementById('broadcast-overlay').classList.add('show');
      lastBroadcast = id;
    }
  } catch (e) { console.error("fetchLatestBroadcast", e); }
}

function dismissBroadcast(){
  document.getElementById('broadcast-banner').classList.remove('show');
  document.getElementById('broadcast-overlay').classList.remove('show');
  if (lastBroadcast) {
    const seen = JSON.parse(localStorage.getItem('seenBroadcasts') || '[]');
    if (!seen.includes(lastBroadcast)) { seen.push(lastBroadcast); localStorage.setItem('seenBroadcasts', JSON.stringify(seen)); }
  }
}

/* =========================
   Owner: Add points dialog
========================= */
function openAddPointsModal(){
  if (!isOwner()) return showNotification('ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑','error');
  document.getElementById('add-points-modal').style.display='block';
}
async function addPointsDirectly(userIdOrShort, points){
  if (!isOwner()) return;
  try {
    let targetUid = null;
    let userData = null;

    const token = (userIdOrShort || '').trim();
    if (token.length <= 8) {
      const q = await db.collection('users').where('shortUid', '==', token.toUpperCase()).limit(1).get();
      if (!q.empty) {
        const doc = q.docs[0];
        targetUid = doc.id;
        userData = doc.data();
      }
    }

    if (!targetUid) {
      const userDoc = await db.collection('users').doc(token).get();
      if (!userDoc.exists) throw new Error('ÿßŸÑŸÖÿπÿ±ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
      targetUid = userDoc.id;
      userData = userDoc.data();
    }
    
    await db.collection('study').doc(targetUid).set({
      currentPoints: firebase.firestore.FieldValue.increment(points),
      totalPoints: firebase.firestore.FieldValue.increment(points),
      name: userData.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
    
    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÅŸä ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜŸÇÿßÿ∑
    await logPointsTransaction(targetUid, points, 'admin_add', `ÿ•ÿ∂ÿßŸÅÿ© ŸäÿØŸàŸäÿ© ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑŸÖÿßŸÑŸÉ`);
    
    showNotification(`ÿ£Ÿèÿ∂ŸäŸÅ ${points} ŸÜŸÇÿ∑ÿ©`, 'success');
    await sendTelegramNotification(
      `‚ûï <b>ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÇÿßÿ∑</b>\nüë§ ${escapeHTML(userData.name||'-')}\nüìß ${escapeHTML(userData.email||'-')}\nüÜî ${escapeHTML(userData.shortUid || targetUid)}\nüéØ ${points}`
    );
  } catch (e) { showNotification(`ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©: ${e.message}`, 'error'); }
}

/* =========================
   App explanation
========================= */
async function openAppExplanation(){
  showPage('appExplainPage');
  const list = document.getElementById('app-explanation-list');
  list.innerHTML = '<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p></div>';
  try{
    const snapshot = await db.collection('app_explanations').orderBy('order','asc').get();
    if (snapshot.empty){
      list.innerHTML = `<div class="post"><p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ¥ÿ±ÿ≠ ÿ≠ÿßŸÑŸäÿßŸã.</p>${isOwner()?'<button class="btn" onclick="addExplanation()">ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ÿ±ÿ≠</button>':''}</div>`;
      return;
    }
    list.innerHTML = snapshot.docs.map(doc=>{
      const ex = doc.data();
      return `<div class="square-card">
        <h3>${escapeHTML(ex.title)}</h3>
        <div class="post-description" style="white-space:pre-wrap">${escapeHTML(ex.content||'')}</div>
        ${isOwner()?`<div class="post-actions" style="margin-top:8px">
          <button class="btn btn-xs btn-secondary" onclick="editExplanation('${doc.id}')">ÿ™ÿπÿØŸäŸÑ</button>
          <button class="btn btn-xs btn-danger" onclick="deleteExplanation('${doc.id}')">ÿ≠ÿ∞ŸÅ</button>
        </div>`:''}
      </div>`;
    }).join('');
    if (isOwner()){
      list.innerHTML += `<div class="post" style="margin-top:10px"><button class="btn btn-block" onclick="addExplanation()">ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ÿ±ÿ≠ ÿ¨ÿØŸäÿØ</button></div>`;
    }
  }catch(e){ list.innerHTML = '<div class="post"><p>ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ</p></div>'; }
}
async function addExplanation(){
  if(!isOwner()) return;
  const title = prompt('ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¥ÿ±ÿ≠:'); if(!title) return;
  const content = prompt('ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ:'); if(!content) return;
  try{
    const last = await db.collection('app_explanations').orderBy('order','desc').limit(1).get();
    const order = last.empty ? 1 : (Number(last.docs[0].data().order)||0) + 1;
    await db.collection('app_explanations').add({ title, content, order, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    showNotification('ÿ£Ÿèÿ∂ŸäŸÅ ÿßŸÑÿ¥ÿ±ÿ≠','success'); openAppExplanation();
  }catch(e){ showNotification('ÿ™ÿπÿ∞Ÿëÿ± ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©','error'); }
}
async function editExplanation(id){
  if(!isOwner()) return;
  const doc = await db.collection('app_explanations').doc(id).get();
  if(!doc.exists) return;
  const ex = doc.data();
  const title = prompt('ÿπÿØŸëŸÑ ÿßŸÑÿπŸÜŸàÿßŸÜ:', ex.title); if(!title) return;
  const content = prompt('ÿπÿØŸëŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ:', ex.content); if(content===null) return;
  try{ await db.collection('app_explanations').doc(id).update({ title, content, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); showNotification('ÿ™ŸÖ ÿßŸÑÿ™ÿπÿØŸäŸÑ','success'); openAppExplanation(); }
  catch(e){ showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ','error'); }
}
async function deleteExplanation(id){
  if(!isOwner()) return;
  if(!confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑÿ¥ÿ±ÿ≠ÿü')) return;
  try{ await db.collection('app_explanations').doc(id).delete(); showNotification('ÿ≠Ÿèÿ∞ŸÅ','success'); openAppExplanation(); }
  catch(e){ showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ','error'); }
}

/* =========================
   Journey
========================= */
// ŸÅŸä ÿØÿßŸÑÿ© switchChallengeTab - ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ™ÿ®ÿØŸäŸÑ
function switchChallengeTab(btn){
  const tabName = btn.dataset.tab;
  document.querySelectorAll('.challenge-tab-pill, .challenge-tab-content').forEach(el => el.classList.remove('active'));
  btn.classList.add('active'); 
  document.getElementById(`challenge-tab-${tabName}`).classList.add('active');
  
  // ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿ≥ÿ∑ÿ± ÿßŸÑŸÖŸÅŸÇŸàÿØÿ© - ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠ ŸáŸÜÿß
  if (tabName === 'leaderboard' && !window._leaderboardInit) { 
    window._leaderboardInit = true; 
    startLeaderboardListener(); 
    startLeaderboardCountdown(); 
  }
  if (tabName === 'journey' && !window._journeyInit) { 
    window._journeyInit = true; 
    startJourneyListener(); 
  }
}

/* =========================
   ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
========================= */
async function openUserStats(){
  showPage('userStats');
  const container = document.getElementById('user-stats-container');
  container.innerHTML = '<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™...</p></div>';
  
  try {
    let totalUsers='ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠';
    try {
      const usersSnapshot = await db.collection('users').get();
      totalUsers = usersSnapshot.size;
    } catch (e) {}
    const postsSnapshot = await db.collection('posts').get();
    const totalPosts = postsSnapshot.size;
    
    let activeToday='ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠', activeNow='ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠';
    try {
      const usersSnapshot = await db.collection('users').get();
      activeToday = usersSnapshot.docs.filter(doc => {
        const userData = doc.data();
        const lastSeen = userData.lastSeen?.toDate ? userData.lastSeen.toDate() : null;
        return lastSeen && (Date.now() - lastSeen.getTime()) < (24 * 60 * 60 * 1000);
      }).length;
      activeNow = usersSnapshot.docs.filter(doc => {
        const userData = doc.data();
        const lastSeen = userData.lastSeen?.toDate ? userData.lastSeen.toDate() : null;
        return lastSeen && (Date.now() - lastSeen.getTime()) < (5 * 60 * 1000);
      }).length;
    } catch(e){}
    
    container.innerHTML = `
      <div class="post">
        <h3>ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">${totalUsers}</div>
            <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${totalPosts}</div>
            <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${activeToday}</div>
            <div class="stat-label">ŸÜÿ¥ÿ∑ŸäŸÜ ÿßŸÑŸäŸàŸÖ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${activeNow}</div>
            <div class="stat-label">ŸÜÿ¥ÿ∑ŸäŸÜ ÿ≠ÿßŸÑŸäÿßŸã</div>
          </div>
        </div>
      </div>
    `;
  } catch (error) {
    console.error('Error loading user stats:', error);
    container.innerHTML = '<div class="post"><p>ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</p></div>';
  }
}

/* =========================
   ÿµŸÅÿ≠ÿ© ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
========================= */

function openMoreActionsPage() {
    if (!currentUser) return showNotification('Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã', 'warning');
    if (!isOwner()) return showNotification('ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑', 'error');
    
    console.log('ŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±...');
    showPage('moreActions');
}

/* ===========================================================
   üè¶ ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ ŸàÿßŸÑŸÖŸàÿ´ŸàŸÇ
=========================================================== */

// üîÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿ∏ÿßŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÜŸÇÿßÿ∑
async function updateWalletPoints(userId, pointsChange, reason) {
    try {
        const userRef = db.collection('study').doc(userId);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            // ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿ¨ÿØŸäÿØ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
            await userRef.set({
                walletPoints: Math.max(0, pointsChange),
                currentPoints: Math.max(0, pointsChange),
                totalPoints: Math.max(0, pointsChange),
                name: currentUser.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            return;
        }

        const currentData = userDoc.data();
        const currentWallet = Number(currentData.walletPoints) || 0;
        const newWalletPoints = Math.max(0, currentWallet + pointsChange);

        // üîí ÿ™ÿ≠ÿØŸäÿ´ ÿ¢ŸÖŸÜ ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        await userRef.update({
            walletPoints: newWalletPoints,
            currentPoints: firebase.firestore.FieldValue.increment(pointsChange),
            totalPoints: firebase.firestore.FieldValue.increment(pointsChange),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            lastTransaction: {
                type: pointsChange > 0 ? 'ÿßŸäÿØÿßÿπ' : 'ÿ≥ÿ≠ÿ®',
                amount: Math.abs(pointsChange),
                reason: reason,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                before: currentWallet,
                after: newWalletPoints
            }
        });

        // üìù ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ© ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑ
        await logPointsTransaction(userId, pointsChange, 'wallet_update', reason);

        console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©: ${currentWallet} ‚Üí ${newWalletPoints} (${pointsChange})`);

    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©:', error);
        throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜŸÇÿßÿ∑');
    }
}

// üéÅ ÿ™ÿ≠ÿØŸäÿ´ ÿØÿßŸÑÿ© ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©
async function claimDailyReward() {
    if (!currentUser) return;
    
    const btn = document.getElementById('daily-claim-btn');
    if (btn) btn.disabled = true;
    
    try {
        // üîç ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ŸÑÿßÿπÿ® ÿ£ŸàŸÑÿßŸã
        const isManipulation = await detectTimeManipulation();
        if (isManipulation) {
            await handleTimeManipulationDetected();
            return;
        }
        
        const userRef = db.collection('study').doc(currentUser.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            showNotification("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™", "error");
            return;
        }

        const userData = userDoc.data();
        const now = new Date();
        const serverTime = userData.lastUpdated?.toDate?.() || now;
        
        // üïí ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸàŸÇÿ™ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
        const lastClaim = userData.lastDailyClaimAt ? 
            userData.lastDailyClaimAt.toDate().getTime() : 0;
        
        const timeSinceLastClaim = serverTime.getTime() - lastClaim;
        
        if (timeSinceLastClaim < (23 * 60 * 60 * 1000)) { // 23 ÿ≥ÿßÿπÿ© ŸÑŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑
            const remaining = (24 * 60 * 60 * 1000) - timeSinceLastClaim;
            showNotification(`ŸÑŸÖ Ÿäÿ≠ŸÜ ŸàŸÇÿ™ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿ®ÿπÿØ. ŸÖÿ™ÿ®ŸÇŸä: ${msToHMS(remaining)}`, "error");
            return;
        }

        // üí∞ ŸÖŸÜÿ≠ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©
        await updateWalletPoints(currentUser.uid, 20, 'ŸÖŸÉÿßŸÅÿ£ÿ© ŸäŸàŸÖŸäÿ©');

        // üìù ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑÿ£ÿÆŸäÿ±
        await userRef.update({
            lastDailyClaimAt: firebase.firestore.Timestamp.fromDate(serverTime),
            lastDailyClaimServerTime: firebase.firestore.FieldValue.serverTimestamp(),
            lastClientTime: firebase.firestore.Timestamp.fromDate(new Date())
        });

        // üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
        studyState.currentPoints += 20;
        studyState.walletPoints = (studyState.walletPoints || 0) + 20;
        studyState.lastDailyClaimAt = serverTime;
        
        showNotification('ŸÖÿ®ÿ±ŸàŸÉ! ÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ 20 ŸÜŸÇÿ∑ÿ© ŸÅŸä ŸÖÿ≠ŸÅÿ∏ÿ™ŸÉ üéÅ', 'success');
        renderTimerUI();
        updateDailyRewardUI();
        
    } catch (error) {
        console.error("Error claiming daily reward:", error);
        showNotification('ÿ™ÿπÿ∞Ÿëÿ± ŸÖŸÜÿ≠ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©', 'error');
    } finally {
        if (btn) btn.disabled = false;
    }
}

// üîÑ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸëŸÜÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©
async function updateDailyRewardUI() {
    const btn = document.getElementById('daily-claim-btn'); 
    const rem = document.getElementById('daily-remaining');
    
    if(!btn || !rem || !currentUser) return;
  
    try {
        const userRef = db.collection('study').doc(currentUser.uid);
        const userDoc = await userRef.get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            const lastClaim = userData.lastDailyClaimAt ? 
                userData.lastDailyClaimAt.toDate().getTime() : 0;
            
            const serverTime = userData.lastUpdated?.toDate?.() || new Date();
            const left = (24 * 60 * 60 * 1000) - (serverTime.getTime() - lastClaim);
            
            if(left > 0){
                btn.disabled = true; 
                btn.innerHTML = '<i class="fas fa-clock"></i> ÿßŸÜÿ™ÿ∏ÿ±';
                rem.textContent = 'ŸÖÿ™ÿßÿ≠ ÿ®ÿπÿØ: ' + msToHMS(left);
                
                if(!dailyRewardInterval){ 
                    dailyRewardInterval = setInterval(updateDailyRewardUI, 30000); // ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ© ŸÅŸÇÿ∑
                }
            } else {
                btn.disabled = false; 
                btn.innerHTML = '<i class="fas fa-gift"></i> ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ 20 ŸÜŸÇÿ∑ÿ©';
                rem.textContent = 'ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ 20 ŸÜŸÇÿ∑ÿ© ŸÖÿ±ÿ© ŸÉŸÑ 24 ÿ≥ÿßÿπÿ©.';
                
                if(dailyRewardInterval){ 
                    clearInterval(dailyRewardInterval); 
                    dailyRewardInterval = null; 
                }
            }
        }
    } catch (error) {
        console.error("Error updating daily reward UI:", error);
    }
}

/* ===========================================================
   üõ°Ô∏è ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ§ŸÇÿ™ ÿßŸÑÿ¢ŸÖŸÜ ÿ∂ÿØ ÿßŸÑÿ™ŸÑÿßÿπÿ® - ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸÖÿµÿ≠ÿ≠
=========================================================== */

let studyInterval = null, boostInterval = null, heartbeatInterval = null, lastHeartbeatSentAt = 0;
let studyState = { 
  running: false, 
  totalSeconds: 0, 
  startAtMs: null, 
  totalPoints: 0, 
  currentPoints: 0, 
  multiplierActive: false,
  multiplierUntil: null,
  multiplierFactor: 1,
  lastDailyClaimAt: null,
  walletPoints: 0,
  boostUntil: null
};
let dailyRewardInterval = null;
let isClaiming = false;

// üïí ÿØÿßŸÑÿ© ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸàŸÇÿ™ - ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸÖÿµÿ≠ÿ≠
function msToHMS(ms) {
    let seconds = Math.floor(ms / 1000);
    let hours = Math.floor(seconds / 3600);
    seconds = seconds % 3600;
    let minutes = Math.floor(seconds / 60);
    seconds = seconds % 60;
    
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}


/* ===== ŸÜÿ∏ÿßŸÖ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ© ===== */
let boostTracker = {
    active: false,
    startTime: null,
    endTime: null,
    totalBoostedTime: 0,
    segments: []
};

// ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ©
function startBoostTracking() {
    if (studyState.boostUntil && studyState.boostUntil > new Date()) {
        boostTracker = {
            active: true,
            startTime: new Date(),
            endTime: studyState.boostUntil,
            totalBoostedTime: 0,
            segments: []
        };
        console.log('‚ö° ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ©');
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ©
function updateBoostTracking() {
    if (boostTracker.active && boostTracker.startTime) {
        const now = new Date();
        const boostEnd = boostTracker.endTime;
        
        if (now <= boostEnd) {
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ∂ÿßÿπŸÅ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑÿ¨ŸÑÿ≥ÿ©
            const sessionBoostedTime = now.getTime() - boostTracker.startTime.getTime();
            boostTracker.totalBoostedTime = sessionBoostedTime;
        } else {
            // ÿßŸÜÿ™Ÿáÿ™ ŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ©
            boostTracker.active = false;
            if (boostTracker.startTime && boostTracker.endTime) {
                const totalBoosted = boostTracker.endTime.getTime() - boostTracker.startTime.getTime();
                boostTracker.totalBoostedTime = totalBoosted;
                boostTracker.segments.push({
                    start: boostTracker.startTime,
                    end: boostTracker.endTime,
                    duration: totalBoosted
                });
            }
        }
    }
}

// ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ∂ÿßÿπŸÅ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
function calculateBoostedTime() {
    let totalBoosted = 0;
    
    // ÿßŸÑŸàŸÇÿ™ ŸÖŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
    if (boostTracker.active && boostTracker.startTime) {
        const now = new Date();
        const boostEnd = Math.min(now.getTime(), boostTracker.endTime.getTime());
        totalBoosted += boostEnd - boostTracker.startTime.getTime();
    }
    
    // ÿßŸÑŸàŸÇÿ™ ŸÖŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
    boostTracker.segments.forEach(segment => {
        totalBoosted += segment.duration;
    });
    
    return totalBoosted;
}

// ŸÜÿ≥ÿÆÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÖŸÜ ÿØÿßŸÑÿ© ÿ®ÿØÿ° ÿßŸÑŸÖÿ§ÿπÿ™ ŸÖÿπ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ©
async function startStudyTimer() {
    if (!currentUser) return showNotification("Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã", "error");
    
    if (studyState.running) return;

    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
    if (!navigator.onLine) {
        showNotification("‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™", "warning");
        return;
    }

    try {
        const startTime = new Date();
        const studyRef = db.collection('study').doc(currentUser.uid);
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ∏ÿ±
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists && userDoc.data().isPermanentlyBanned) {
            return showNotification("ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÖÿ≠ÿ∏Ÿàÿ±", "error");
        }

        // ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÅÿπÿßŸÑÿ©
        if (studyState.boostUntil && studyState.boostUntil > startTime) {
            startBoostTracking();
        }

        await studyRef.set({
            running: true,
            startAt: firebase.firestore.Timestamp.fromDate(startTime),
            lastVerifiedAt: firebase.firestore.Timestamp.fromDate(startTime),
            name: currentUser.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
            lastPingAt: firebase.firestore.FieldValue.serverTimestamp(),
            clientStartTime: firebase.firestore.Timestamp.fromDate(startTime),
            networkStatus: 'online',
            boostActive: studyState.boostUntil && studyState.boostUntil > startTime,
            boostUntil: studyState.boostUntil ? firebase.firestore.Timestamp.fromDate(studyState.boostUntil) : null
        }, { merge: true });

        studyState.running = true;
        studyState.startAtMs = startTime.getTime();
        
        startStudyInterval();
        startHeartbeatInterval();
        startNetworkMonitoring();
        renderTimerUI();
        
        let startMessage = "‚è∞ ÿ®ÿØÿ£ ÿßŸÑŸÖÿ§ŸÇÿ™";
        if (studyState.boostUntil && studyState.boostUntil > startTime) {
            const boostLeft = Math.floor((studyState.boostUntil.getTime() - startTime.getTime()) / 60000);
            startMessage += ` - ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ© ŸÅÿπÿßŸÑÿ© (${boostLeft} ÿØŸÇŸäŸÇÿ© ŸÖÿ™ÿ®ŸÇŸäÿ© ‚ö°)`;
        }
        
        showNotification(startMessage, "success");

    } catch (error) {
        console.error("Error starting timer:", error);
        showNotification("ŸÅÿ¥ŸÑ ÿ®ÿØÿ° ÿßŸÑŸÖÿ§ŸÇÿ™", "error");
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿØÿßŸÑÿ© ÿßŸÑÿØÿ±ÿßÿ≥ÿ© ŸÑÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ©
function startStudyInterval() { 
    stopStudyInterval(); 
    studyInterval = setInterval(() => {
        renderTimerUI();
        updateBoostTracking(); // ‚úÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ©
    }, 1000); 
}

function stopStudyInterval(){ 
    if(studyInterval){ 
        clearInterval(studyInterval); 
        studyInterval = null; 
    } 
}

function stopHeartbeatInterval(){ 
    if(heartbeatInterval){ 
        clearInterval(heartbeatInterval); 
        heartbeatInterval = null; 
    } 
}

function resetTimerState() {
    studyState.running = false;
    studyState.startAtMs = null;
    studyState.totalSeconds = 0;
    stopStudyInterval();
    stopHeartbeatInterval();
    renderTimerUI();
}

// üìä ÿπÿ±ÿ∂ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ§ŸÇÿ™ - ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸÖÿµÿ≠ÿ≠
function renderTimerUI(){
  const disp = document.getElementById('timer-display');
  const startBtn = document.getElementById('timer-start-btn');
  const stopBtn = document.getElementById('timer-stop-btn');
  const pointsDisp = document.getElementById('current-points-display');
  const boostInfo = document.getElementById('boost-status');
  
  // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠
  const isBoostActive = studyState.boostUntil && studyState.boostUntil > new Date();
  let seconds = 0;
  
  if(studyState.running && studyState.startAtMs){
    const elapsed = Date.now() - studyState.startAtMs;
    // üî• ÿßŸÑÿ™ÿ∫ŸäŸäÿ±: ÿπÿ±ÿ∂ ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸä (ÿ®ÿØŸàŸÜ ÿ™ÿ∂ÿßÿπŸÅ ŸÅŸä ÿßŸÑÿπÿ±ÿ∂)
    seconds = Math.floor(elapsed / 1000);
  }
  
  if(disp) {
    disp.innerHTML = msToHMS(seconds * 1000) + (isBoostActive ? ' <span style="color:#ff8c00;font-size:16px">(‚ö° ÿßŸÑŸàŸÇÿ™ ŸÖÿ∂ÿßÿπŸÅ)</span>' : '');
  }
  
  if(pointsDisp) pointsDisp.textContent = (studyState.currentPoints || 0).toLocaleString('ar-IQ');
  if(startBtn) startBtn.disabled = !!studyState.running;
  if(stopBtn) stopBtn.disabled = !studyState.running;
  
  // ÿπÿ±ÿ∂/ÿ•ÿÆŸÅÿßÿ° ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ
  if(boostInfo) {
    if (isBoostActive) {
      const left = studyState.boostUntil.getTime() - Date.now();
      boostInfo.textContent = `‚ö° ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ŸÖŸÅÿπŸÑ - ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${msToHMS(left)} (ÿßŸÑŸàŸÇÿ™ ŸÖÿ∂ÿßÿπŸÅ)`;
      boostInfo.style.display = 'block';
    } else {
      boostInfo.textContent = '';
      boostInfo.style.display = 'none';
    }
  }
}

// ‚ö° ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ - ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸÖÿµÿ≠ÿ≠ (ÿ™ÿ≥ÿ±Ÿäÿπ ÿßŸÑŸàŸÇÿ™)
function startBoostInterval(){ 
    stopBoostInterval(); 
    updateBoostStatus(); 
    boostInterval = setInterval(updateBoostStatus, 1000); 
}

function stopBoostInterval(){ 
    if(boostInterval){ 
        clearInterval(boostInterval); 
        boostInterval = null; 
    } 
}

function updateBoostStatus(){
  const st = studyState; 
  const el = document.getElementById('boost-status');
  
  if(!st.boostUntil){ 
    if(el) {
      el.textContent = ''; 
      el.style.display = 'none';
    }
    stopBoostInterval(); 
    renderTimerUI();
    return; 
  }
  
  const left = st.boostUntil.getTime() - Date.now();
  if(left <= 0){ 
    st.boostUntil = null; 
    if(el) {
      el.textContent = ''; 
      el.style.display = 'none';
    }
    stopBoostInterval(); 
    renderTimerUI(); 
    showNotification("ÿßŸÜÿ™Ÿáÿ™ ŸÅÿ™ÿ±ÿ© ÿ™ÿ≥ÿ±Ÿäÿπ ÿßŸÑŸàŸÇÿ™ ‚è∞", "info");
    return; 
  }
  
  if(el) {
    el.textContent = `‚ö° ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ŸÖŸÅÿπŸÑ - ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${msToHMS(left)} (ÿßŸÑŸàŸÇÿ™ ŸÖÿ∂ÿßÿπŸÅ)`;
    el.style.display = 'block';
  }
  
  renderTimerUI();
}

// üõí ÿ¥ÿ±ÿßÿ° ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ - ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸÖÿµÿ≠ÿ≠ (ÿ™ÿ≥ÿ±Ÿäÿπ ÿßŸÑŸàŸÇÿ™)
async function buyBoost(hours){
  if(!currentUser) return;
  const cost = (hours===1?25:hours===2?50:hours===3?75:hours===5?100:hours*25);
  
  if(studyState.currentPoints < cost){
    return showNotification('ŸÜŸÇÿßÿ∑ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸäÿ©','error');
  }
  
  try{
    // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ÿ≠ÿ≥ÿßÿ® ŸàŸÇÿ™ ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠ (ÿ™ÿ±ÿßŸÉŸÖŸä)
    const base = (studyState.boostUntil && studyState.boostUntil > new Date()) ? 
                 studyState.boostUntil.getTime() : Date.now();
    const until = new Date(base + hours * 3600 * 1000);
    
    await db.collection('study').doc(currentUser.uid).set({
      currentPoints: firebase.firestore.FieldValue.increment(-cost),
      boostUntil: firebase.firestore.Timestamp.fromDate(until),
      name: currentUser.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
      lastBoostPurchase: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
    
    await logPointsTransaction(currentUser.uid, -cost, 'boost_purchase', `ÿ¥ÿ±ÿßÿ° ÿ™ÿ≥ÿ±Ÿäÿπ ŸàŸÇÿ™ ${hours} ÿ≥ÿßÿπÿ©`);
    
    studyState.currentPoints -= cost;
    studyState.boostUntil = until;
    startBoostInterval();
    renderTimerUI();
    showNotification(`ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿ™ÿ≥ÿ±Ÿäÿπ ÿßŸÑŸàŸÇÿ™ ŸÑŸÖÿØÿ© ${hours} ÿ≥ÿßÿπÿ© ‚ö° (ÿßŸÑŸàŸÇÿ™ ŸÖÿ∂ÿßÿπŸÅ)`,'success');
    
  } catch(e){
    console.error('buyBoost error', e);
    showNotification('ŸÅÿ¥ŸÑ ÿ¥ÿ±ÿßÿ° ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ','error');
  }
}

// üì• ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≠ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± - ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸÖÿµÿ≠ÿ≠
async function loadStudyState() {
    if (!currentUser) return;
    
    const ref = db.collection('study').doc(currentUser.uid);
    try {
        const doc = await ref.get();
        if (doc.exists) {
            const data = doc.data();
            
            // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ÿ™ÿ≠ŸÖŸäŸÑ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠
            if (data.boostUntil && data.boostUntil.toDate) {
                studyState.boostUntil = data.boostUntil.toDate();
                if (studyState.boostUntil > new Date()) {
                    startBoostInterval();
                } else {
                    studyState.boostUntil = null;
                }
            }
            
            if (data.running && data.startAt) {
                const serverStartTime = data.startAt.toDate().getTime();
                const now = Date.now();
                const elapsed = now - serverStartTime;
                
                if (elapsed > (24 * 60 * 60 * 1000)) {
                    await handleSuspiciousActivity("ÿ¨ŸÑÿ≥ÿ© ÿ∑ŸàŸäŸÑÿ© ÿ®ÿ¥ŸÉŸÑ ÿ∫Ÿäÿ± ÿ∑ÿ®ŸäÿπŸä");
                    await ref.update({ running: false, startAt: null });
                    return;
                }
                
                studyState.running = true;
                studyState.startAtMs = serverStartTime;
                startStudyInterval();
                startHeartbeatInterval();
            }
            
            studyState.totalPoints = Number(data.totalPoints || 0);
            studyState.currentPoints = Number(data.currentPoints || 0);
            studyState.lastDailyClaimAt = data.lastDailyClaimAt?.toDate ? data.lastDailyClaimAt.toDate() : null;
            studyState.walletPoints = Number(data.walletPoints || 0);
            
            renderTimerUI();
            updateDailyRewardUI();
        }
    } catch (error) {
        console.error("Error loading study state:", error);
    }
}

// ŸÜÿ∏ÿßŸÖ Heartbeat ŸÖÿ≠ÿ≥ŸÜ ŸÖÿπ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
function startHeartbeatInterval() {
    stopHeartbeatInterval();
    lastHeartbeatSentAt = Date.now();
    
    heartbeatInterval = setInterval(async () => {
        if (!studyState.running || !currentUser) return;
        
        const now = Date.now();
        const timeSinceLastHeartbeat = now - lastHeartbeatSentAt;
        
        // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÅÿ¨Ÿàÿ© ŸÉÿ®Ÿäÿ±ÿ© ÿ¨ÿØÿßŸã (ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 5 ÿØŸÇÿßÿ¶ŸÇ)
        if (timeSinceLastHeartbeat > 300000) {
            console.warn("‚è∞ ŸÅÿ¨Ÿàÿ© ÿ≤ŸÖŸÜŸäÿ© ŸÉÿ®Ÿäÿ±ÿ© ŸÅŸä ÿßŸÑŸÄ Heartbeat:", timeSinceLastHeartbeat);
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿ£ŸàŸÑÿßŸã
            if (navigator.onLine) {
                // ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÖÿ™ÿµŸÑ ŸÑŸÉŸÜ ÿßŸÑŸÄ Heartbeat ŸÖÿ™ŸàŸÇŸÅ - ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                await handleAppCrash();
            } else {
                // ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÖŸÇÿ∑Ÿàÿπ - ŸÜÿ™ÿ±ŸÉ ŸÜÿ∏ÿßŸÖ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ Ÿäÿ™ÿπÿßŸÖŸÑ ŸÖÿπŸáÿß
                console.log('üåê ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÖŸÇÿ∑Ÿàÿπ - ÿ™ÿÆÿ∑Ÿä ÿßŸÑŸÄ Heartbeat');
            }
            return;
        }

        try {
            // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÄ Heartbeat ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÖÿ™ÿµŸÑ
            if (navigator.onLine) {
                await db.collection('study').doc(currentUser.uid).update({
                    lastPingAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastClientTime: firebase.firestore.Timestamp.fromDate(new Date(now)),
                    totalHeartbeats: firebase.firestore.FieldValue.increment(1),
                    networkStatus: 'online',
                    lastOnlineCheck: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                lastHeartbeatSentAt = now;
                consecutiveOfflineCount = 0;
            } else {
                console.log('üåê ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÖŸÇÿ∑Ÿàÿπ - ÿ™ÿÆÿ∑Ÿä ÿßŸÑŸÄ Heartbeat');
                consecutiveOfflineCount++;
            }
        } catch (error) {
            console.error("Heartbeat error:", error);
            
            // ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿßŸÑŸÄ Heartbeat ÿπÿØÿ© ŸÖÿ±ÿßÿ™ ŸÖÿ™ÿ™ÿßŸÑŸäÿ©
            if (consecutiveOfflineCount > 5) {
                console.warn('üö´ ŸÅÿ¥ŸÑ ŸÖÿ™ŸÉÿ±ÿ± ŸÅŸä ÿßŸÑŸÄ Heartbeat - ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
            }
        }
    }, 45000); // ŸÉŸÑ 45 ÿ´ÿßŸÜŸäÿ© (ÿ®ÿØŸÑ 30)
}

// ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿ™ÿ≠ÿ∑ŸÖ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
async function handleAppCrash() {
    console.log('üöë ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ™ÿ≠ÿ∑ŸÖ ŸÖÿ≠ÿ™ŸÖŸÑ ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ');
    
    try {
        // ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶
        await db.collection('study').doc(currentUser.uid).update({
            running: false,
            startAt: null,
            lastCrashDetected: firebase.firestore.FieldValue.serverTimestamp(),
            crashReason: 'heartbeat_gap_detected'
        });
        
        // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿπÿØÿßÿØ ŸÖÿ≠ŸÑŸäÿßŸã
        studyState.running = false;
        studyState.startAtMs = null;
        stopStudyInterval();
        stopHeartbeatInterval();
        
        renderTimerUI();
        
        showNotification("‚ö†Ô∏è ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ - ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿπÿØÿßÿØ", "warning");
        
    } catch (error) {
        console.error("Error handling app crash:", error);
    }
}

/* ===========================================================
   ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ŸàÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ÿßŸÑÿ¨ÿØŸäÿØ
=========================================================== */

/* ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅ */
async function loadLeaderboardSettings(){
  try{
    const doc = await db.collection('settings').doc('leaderboard').get();
    if(doc.exists){
      const data = doc.data();
      leaderboardSettings.nextReset = data.nextReset?.toDate ? data.nextReset.toDate() : null;
      leaderboardSettings.scheduleDay = data.scheduleDay || 0;
      leaderboardSettings.scheduleTime = data.scheduleTime || "00:00";
      
      const now = new Date();
      
      // ÿ™ÿ≠ŸÇŸÇ ŸÇŸàŸä ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿÆÿ≤ŸÜ
      if(!leaderboardSettings.nextReset || 
         leaderboardSettings.nextReset <= now ||
         isNaN(leaderboardSettings.nextReset.getTime())) {
        
        console.log('üîÑ ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸàÿπÿØ (ŸÖŸÜÿ™ŸáŸä ÿ£Ÿà ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ÿ™ÿßŸÑŸÅ)');
        await calculateNextReset();
      } else {
        console.log('‚úÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÖÿÆÿ≤ŸÜ:', leaderboardSettings.nextReset.toLocaleString('ar-IQ'));
        console.log('üìÖ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™:', {
          day: leaderboardSettings.scheduleDay,
          time: leaderboardSettings.scheduleTime
        });
      }
    } else {
      // ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸâ
      console.log('üÜï ÿ•ŸÜÿ¥ÿßÿ° ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ™ÿµŸÜŸäŸÅ');
      leaderboardSettings.scheduleDay = 0;
      leaderboardSettings.scheduleTime = "00:00";
      await calculateNextReset();
    }
    
  }catch(e){
    console.error('Error loading leaderboard settings:', e);
    leaderboardSettings.scheduleDay = 0;
    leaderboardSettings.scheduleTime = "00:00";
    await calculateNextReset();
  }
}

/* ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÇÿßÿØŸÖ ŸÑÿ•ÿπÿßÿØÿ© ÿßŸÑÿ∂ÿ®ÿ∑ */
async function calculateNextReset(){
  try {
    const now = new Date();
    const targetDay = leaderboardSettings.scheduleDay || 0;
    const [targetHours, targetMinutes] = (leaderboardSettings.scheduleTime || "00:00").split(':').map(Number);
    
    console.log('üïí ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑÿ¨ÿØŸäÿØ:', { 
      targetDay, 
      targetHours, 
      targetMinutes,
      now: now.toLocaleString('ar-IQ')
    });
    
    let nextReset = new Date(now);
    let daysDifference = targetDay - now.getDay();
    
    if (daysDifference < 0) {
      daysDifference += 7;
    }
    else if (daysDifference === 0) {
      const currentTime = now.getHours() * 60 + now.getMinutes();
      const targetTime = targetHours * 60 + targetMinutes;
      
      if (currentTime >= targetTime) {
        daysDifference = 7;
      }
    }
    
    nextReset.setDate(now.getDate() + daysDifference);
    nextReset.setHours(targetHours, targetMinutes, 0, 0);
    
    // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸàŸÇÿ™ ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ
    if (nextReset <= now) {
      console.log('‚ö†Ô∏è ÿßŸÑŸÖŸàÿπÿØ ŸÅŸä ÿßŸÑŸÖÿßÿ∂Ÿäÿå ÿ•ÿ∂ÿßŸÅÿ© ÿ£ÿ≥ÿ®Ÿàÿπ ÿ¢ÿÆÿ±');
      nextReset.setDate(nextReset.getDate() + 7);
    }
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
    if (isNaN(nextReset.getTime())) {
      console.error('‚ùå ÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿå ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä');
      nextReset = new Date();
      nextReset.setDate(nextReset.getDate() + 7);
      nextReset.setHours(0, 0, 0, 0);
    }
    
    console.log(`‚úÖ ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÇÿßÿØŸÖ: ${nextReset.toLocaleString('ar-IQ')}`);
    
    leaderboardSettings.nextReset = nextReset;
    
    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÅŸä Firebase
    await db.collection('settings').doc('leaderboard').set({
      nextReset: firebase.firestore.Timestamp.fromDate(nextReset),
      scheduleDay: targetDay,
      scheduleTime: leaderboardSettings.scheduleTime || "00:00",
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastCalculated: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
    
    startLeaderboardCountdown();
    return nextReset;
    
  } catch(e) {
    console.error('Error calculating next reset:', e);
    // ŸàŸÇÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®
    const defaultReset = new Date();
    defaultReset.setDate(defaultReset.getDate() + 7);
    defaultReset.setHours(0, 0, 0, 0);
    return defaultReset;
  }
}

/* ŸÅÿ™ÿ≠ ŸÖŸàÿπÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿµŸÜŸäŸÅ */
function openLbScheduleModal(){
  if(!isOwner()) return showNotification('ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑','error');
  
  document.getElementById('lb-schedule-day').value = leaderboardSettings.scheduleDay;
  document.getElementById('lb-schedule-time').value = leaderboardSettings.scheduleTime;
  
  document.getElementById('lb-schedule-modal').style.display = 'block';
}

function closeLbScheduleModal(){
  document.getElementById('lb-schedule-modal').style.display = 'none';
}

/* ÿ≠ŸÅÿ∏ ŸÖŸàÿπÿØ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ */
async function ownerSetLbSchedule(){
  if(!isOwner()) return;
  
  const day = parseInt(document.getElementById('lb-schedule-day').value);
  const time = document.getElementById('lb-schedule-time').value;
  
  if(isNaN(day) || day < 0 || day > 6) {
    return showNotification('ÿßŸÑŸäŸàŸÖ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠','error');
  }
  
  if(!time) {
    return showNotification('ÿßŸÑŸàŸÇÿ™ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠','error');
  }
  
  try {
    leaderboardSettings.scheduleDay = day;
    leaderboardSettings.scheduleTime = time;
    
    await calculateNextReset();
    
    showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖŸàÿπÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿµŸÜŸäŸÅ','success');
    closeLbScheduleModal();
    
    startLeaderboardCountdown();
    
  } catch(e) {
    console.error('Error setting leaderboard schedule:', e);
    showNotification('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàÿπÿØ','error');
  }
}

// ÿ£ÿ∂ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿØŸàÿßŸÑ ÿßŸÑŸÖŸÅŸÇŸàÿØÿ©
function stopLeaderboardListener() { 
    if(leaderboardUnsub){
        try{leaderboardUnsub();}catch{} 
        leaderboardUnsub=null;
    }
}

function stopJourneyListener() { 
    if(journeyUnsub){
        try{journeyUnsub();}catch{} 
        journeyUnsub=null;
    }
}

/* =========================
   üèÜ ŸÜÿ∏ÿßŸÖ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä ÿßŸÑÿµÿßÿ±ŸÖ
========================= */

let distributionInProgress = false;

// ŸÜÿ∏ÿßŸÖ ÿ™Ÿàÿ≤Ÿäÿπ ŸÖÿ≠ÿ≥ŸÜ ŸÖÿπ ÿ™ÿ£ŸÉŸäÿØÿßÿ™
async function distributeWeeklyRewards(){
    if(!isOwner()) return;
    
    if (distributionInProgress) {
        showNotification('‚ö†Ô∏è ÿπŸÖŸÑŸäÿ© ÿ™Ÿàÿ≤Ÿäÿπ ÿ≥ÿßÿ®ŸÇÿ© ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞', 'warning');
        return;
    }
    
    distributionInProgress = true;
    
    try {
        console.log('üöÄ ÿ®ÿØÿ° ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä...');
        
        // 1. üîí ŸÇŸÅŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ
        await db.collection('settings').doc('leaderboard').update({
            distributionStatus: 'in_progress',
            distributionStartedAt: firebase.firestore.FieldValue.serverTimestamp(),
            distributedBy: currentUser.uid
        });
        
        // 2. üìä ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅ
        const leaderboardSnapshot = await db.collection('study')
            .orderBy('totalPoints', 'desc')
            .limit(50)
            .get();
        
        if(leaderboardSnapshot.empty) {
            console.log('üì≠ ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÅŸä ÿßŸÑÿ™ÿµŸÜŸäŸÅ');
            await sendTelegramNotification('üìä ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÅŸä ÿßŸÑÿ™ÿµŸÜŸäŸÅ ŸÑŸáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ');
            
            await db.collection('settings').doc('leaderboard').update({
                distributionStatus: 'completed',
                distributionMessage: 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ'
            });
            
            distributionInProgress = false;
            return;
        }
        
        const topUsers = leaderboardSnapshot.docs.map(doc => ({
            uid: doc.id,
            name: doc.data().name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
            shortUid: doc.data().shortUid || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ',
            totalPoints: Number(doc.data().totalPoints) || 0,
            currentPoints: Number(doc.data().currentPoints) || 0,
            walletPoints: Number(doc.data().walletPoints) || 0
        }));

        const rewards = {
            0: 2000, // ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ£ŸàŸÑ
            1: 1500, // ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ´ÿßŸÜŸä  
            2: 1000, // ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ´ÿßŸÑÿ´
            3: 500,  // ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ±ÿßÿ®ÿπ
            4: 300   // ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿÆÿßŸÖÿ≥
        };
        
        const winners = [];
        const batch = db.batch();
        
        // 3. üéÅ ŸÖŸÜÿ≠ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ŸÑŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑÿ£ŸàŸÑŸâ
        for(let i = 0; i < Math.min(5, topUsers.length); i++){
            const user = topUsers[i];
            
            if(user.totalPoints >= 200){ // ÿ¥ÿ±ÿ∑ 200 ŸÜŸÇÿ∑ÿ© ŸÉÿ≠ÿØ ÿ£ÿØŸÜŸâ
                const reward = rewards[i];
                
                winners.push({
                    rank: i + 1,
                    name: user.name,
                    uid: user.uid,
                    shortUid: user.shortUid,
                    oldPoints: user.walletPoints || user.currentPoints || 0,
                    reward: reward,
                    newPoints: (user.walletPoints || user.currentPoints || 0) + reward,
                    totalPoints: user.totalPoints
                });
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜŸÇÿßÿ∑ ŸÅŸä ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©
                const userRef = db.collection('study').doc(user.uid);
                batch.update(userRef, {
                    walletPoints: firebase.firestore.FieldValue.increment(reward),
                    currentPoints: firebase.firestore.FieldValue.increment(reward),
                    totalPoints: firebase.firestore.FieldValue.increment(reward),
                    lastWeeklyReward: firebase.firestore.FieldValue.serverTimestamp(),
                    lastRewardAmount: reward,
                    lastRewardRank: i + 1
                });

                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©
                await logPointsTransaction(user.uid, reward, 'weekly_reward', 
                    `ŸÖŸÉÿßŸÅÿ£ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ© - ÿßŸÑŸÖÿ±ŸÉÿ≤ ${i + 1}`);

                // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÅÿßÿ¶ÿ≤
                await db.collection('inbox').add({
                    userId: user.uid,
                    type: 'weekly_reward',
                    title: `üéâ ŸÖÿ®ÿ±ŸàŸÉ! ŸÅŸàÿ≤ ÿ£ÿ≥ÿ®ŸàÿπŸä - ÿßŸÑŸÖÿ±ŸÉÿ≤ ${i + 1}`,
                    message: `
üèÜ ŸÖÿ®ÿßÿ±ŸÉ ŸÑŸÉ! ŸÑŸÇÿØ ŸÅÿ≤ÿ™ ŸÅŸä ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä

‚Ä¢ ÿßŸÑŸÖÿ±ŸÉÿ≤: ${i + 1}
‚Ä¢ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©: ${reward} ŸÜŸÇÿ∑ÿ© üéÅ
‚Ä¢ ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ¨ÿØŸäÿØ: ${(user.walletPoints || user.currentPoints || 0) + reward} ŸÜŸÇÿ∑ÿ©
‚Ä¢ ŸÜŸÇÿßÿ∑ŸÉ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©: ${user.totalPoints} ŸÜŸÇÿ∑ÿ©

ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑÿ™ŸÅŸàŸÇ Ÿàÿ≠ŸÇŸÇ ŸÖÿ±ÿßŸÉÿ≤ ÿ£ÿπŸÑŸâ! üí™
                    `.trim(),
                    status: 'unread',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    rewardPoints: reward,
                    rank: i + 1
                });

                console.log(`‚úÖ ÿ™ŸÖ ŸÖŸÜÿ≠ ${reward} ŸÜŸÇÿ∑ÿ© ŸÑŸÑŸÖÿ±ŸÉÿ≤ ${i + 1}: ${user.name}`);
            }
        }
        
        // 4. üíæ ÿ™ŸÜŸÅŸäÿ∞ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿØŸÅÿπÿ© Ÿàÿßÿ≠ÿØÿ©
        await batch.commit();
        console.log('‚úÖ ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿ¨ŸÖŸäÿπ ÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÜŸÇÿßÿ∑');
        
        // 5. üîÑ ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ŸÑŸÑÿ¨ŸÖŸäÿπ
        await resetLeaderboardPoints(leaderboardSnapshot);
        
        // 6. üìù ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ
        const distributionRecord = {
            winners: winners,
            distributedAt: firebase.firestore.FieldValue.serverTimestamp(),
            totalWinners: winners.length,
            totalPointsDistributed: winners.reduce((sum, winner) => sum + winner.reward, 0),
            totalParticipants: leaderboardSnapshot.size,
            distributedBy: currentUser.uid,
            distributedByName: currentUser.name
        };
        
        await db.collection('weekly_distributions').add(distributionRecord);
        
        // 7. üóìÔ∏è ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÇÿßÿØŸÖ
        await calculateNextReset();
        
        // 8. üì¢ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± ŸÑŸÑŸÖÿßŸÑŸÉ
        await sendDistributionReport(winners, distributionRecord);
        
        console.log('‚úÖ ÿ™ŸÖ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
        showNotification('‚úÖ ÿ™ŸÖ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ Ÿàÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿ®ŸÜÿ¨ÿßÿ≠','success');
        
    } catch(e) {
        console.error('‚ùå ŸÅÿ¥ŸÑ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤:', e);
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿ¥ŸÑ
        await db.collection('settings').doc('leaderboard').update({
            distributionStatus: 'failed',
            distributionError: e.message,
            lastFailedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await sendTelegramNotification(
            `‚ùå <b>ŸÅÿ¥ŸÑ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤</b>\n\nüìù ${e.message}\n‚è∞ ${new Date().toLocaleString('ar-IQ')}`
        );
        
        showNotification('‚ùå ŸÅÿ¥ŸÑ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤','error');
    } finally {
        distributionInProgress = false;
    }
}

// ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ŸÑŸÑÿ¨ŸÖŸäÿπ
async function resetLeaderboardPoints(leaderboardSnapshot) {
    try {
        console.log('üîÑ ÿ®ÿØÿ° ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ÿßŸÑÿ™ÿµŸÜŸäŸÅ...');
        
        const batch = db.batch();
        let resetCount = 0;
        
        leaderboardSnapshot.docs.forEach(doc => {
            batch.update(doc.ref, {
                totalPoints: 0, // ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ŸÅŸÇÿ∑
                lastResetAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            resetCount++;
        });
        
        await batch.commit();
        console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ${resetCount} ŸÖÿ≥ÿ™ÿÆÿØŸÖ`);
        
    } catch (error) {
        console.error('‚ùå ŸÅÿ¥ŸÑ ÿ™ÿµŸÅŸäÿ± ÿßŸÑŸÜŸÇÿßÿ∑:', error);
        throw error;
    }
}

// ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ
async function sendDistributionReport(winners, distributionRecord) {
    try {
        let reportMessage = `üèÜ <b>ÿ™ŸÇÿ±Ÿäÿ± ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</b>\n\n`;
        
        reportMessage += `üìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™:\n`;
        reportMessage += `‚Ä¢ ÿπÿØÿØ ÿßŸÑŸÅÿßÿ¶ÿ≤ŸäŸÜ: ${distributionRecord.totalWinners}\n`;
        reportMessage += `‚Ä¢ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸÇÿßÿ∑: ${distributionRecord.totalPointsDistributed}\n`;
        reportMessage += `‚Ä¢ ÿπÿØÿØ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉŸäŸÜ: ${distributionRecord.totalParticipants}\n\n`;
        
        if (winners.length > 0) {
            reportMessage += `üéñÔ∏è ÿßŸÑŸÅÿßÿ¶ÿ≤ŸàŸÜ:\n`;
            winners.forEach(winner => {
                reportMessage += `${winner.rank}. ${winner.name} (${winner.shortUid}) - ${winner.reward} ŸÜŸÇÿ∑ÿ©\n`;
            });
        } else {
            reportMessage += `‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ ŸÅÿßÿ¶ÿ≤ŸàŸÜ ŸÖÿ§ŸáŸÑŸàŸÜ Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ\n`;
            reportMessage += `(ÿßŸÑŸÜŸÇÿßÿ∑ ÿ£ŸÇŸÑ ŸÖŸÜ 200 ŸÜŸÇÿ∑ÿ©)`; 
        }
        
        reportMessage += `\n‚è∞ ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÇÿßÿØŸÖ: ${leaderboardSettings.nextReset.toLocaleString('ar-IQ')}`;
        
        await sendTelegramNotification(reportMessage);
        
    } catch (error) {
        console.error('Error sending distribution report:', error);
    }
}
/* ===========================================================
   ÿßŸÑÿ™ÿµŸÜŸäŸÅ (Top 50)
========================= */
function startLeaderboardListener(){
  stopLeaderboardListener();
  const lb=document.getElementById('challenge-leaderboard');
  if(lb) lb.innerHTML='<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿµŸÜŸäŸÅ...</p></div>';
  
  try {
    leaderboardUnsub = db.collection('study')
      .orderBy('totalPoints','desc')
      .limit(50)
      .onSnapshot(
        snap => {
          const items = snap.docs.map(d=>({uid:d.id,...d.data()}));
          renderLeaderboard(items);
        },
        async error => { 
          console.error("Leaderboard error:", error);
          try{
            const one = await db.collection('study').orderBy('totalPoints','desc').limit(50).get();
            const items = one.docs.map(d=>({uid:d.id,...d.data()}));
            renderLeaderboard(items);
          }catch(e){
            if(lb) lb.innerHTML='<div class="post"><p>ÿ™ÿπÿ∞Ÿëÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ</p></div>'; 
          }
        }
      );
  } catch (e) {
    console.error('leaderboard listener init error', e);
    if(lb) lb.innerHTML='<div class="post"><p>ÿ™ÿπÿ∞Ÿëÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ</p></div>'; 
  }
}
function stopLeaderboardListener(){ 
  if(leaderboardUnsub){
    try{leaderboardUnsub();}catch{} 
    leaderboardUnsub=null;
  }
}
function renderLeaderboard(items){
  const lb=document.getElementById('challenge-leaderboard'); 
  if(!lb) return;
  
  if(!items||!items.length){ 
    lb.innerHTML='<div class="post"><p>ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ™ŸÜÿßŸÅÿ≥ŸàŸÜ ÿ®ÿπÿØ</p></div>'; 
    return; 
  }
  
  lb.innerHTML = items.map((it,idx)=>{
    const points = it.totalPoints||0;
    const cls = idx===0?'rank-1':(idx===1?'rank-2':(idx===2?'rank-3':(idx===3?'rank-4':(idx===4?'rank-5':'rank'))));
    
    const delBtn = isOwner()? `
      <button class="btn btn-xs btn-danger" style="margin-right:auto" onclick="ownerRemoveFromLeaderboard('${it.uid}','${escapeHTML(it.name||'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}')">
        <i class="fa-solid fa-trash"></i>
      </button>` : '';
    
    return `
      <div class="rank-card ${cls}">
        <div class="rank-left">
          <div class="rank-badge">${idx+1}</div>
          <div class="rank-name">${escapeHTML(it.name||'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}</div>
        </div>
        ${delBtn}
        <div class="rank-points">${points.toLocaleString('ar-IQ')} ŸÜŸÇÿ∑ÿ©</div>
      </div>`;
  }).join('');
}

// ÿ≤ÿ± ŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅ
function openLbRewardsModal(){ document.getElementById('lb-rewards-modal').style.display='block'; }
function closeLbRewardsModal(){ document.getElementById('lb-rewards-modal').style.display='none'; }

/* ÿπÿØŸë ÿ™ŸÜÿßÿ≤ŸÑŸä ÿ£ÿ≥ÿ®ŸàÿπŸä */
let lbCountdownInterval=null;
// ŸÜÿ∏ÿßŸÖ ÿπÿØ ÿ™ŸÜÿßÿ≤ŸÑŸä ŸÖÿ≠ÿ≥ŸÜ ŸÖÿπ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ
function startLeaderboardCountdown(){
    const daysEl = document.getElementById('cd-days');
    const hrsEl  = document.getElementById('cd-hours');
    const minEl  = document.getElementById('cd-mins');
    const secEl  = document.getElementById('cd-secs');
    
    if(!daysEl || !hrsEl || !minEl || !secEl) return;
    
    if (lbCountdownInterval) clearInterval(lbCountdownInterval);
    
    const tick = async () => {
        const now = new Date();
        let target = leaderboardSettings.nextReset;
        
        if(!target){
            await calculateNextReset();
            target = leaderboardSettings.nextReset;
        }
        
        let diff = target - now;
        
        // ÿ•ÿ∞ÿß ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™ - ÿ™Ÿàÿ≤Ÿäÿπ ŸÅŸàÿ±Ÿä
        if (diff <= 0) {
            console.log('‚è∞ ÿßŸÜÿ™ŸáŸâ ŸàŸÇÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅ - ÿ®ÿØÿ° ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ...');
            
            daysEl.textContent = '00';
            hrsEl.textContent  = '00';
            minEl.textContent  = '00';
            secEl.textContent  = '00';
            
            // ÿ™Ÿàÿ≤Ÿäÿπ ŸÅŸàÿ±Ÿä
            if (isOwner()) {
                await distributeWeeklyRewards();
            }
            
            return;
        }
        
        const totalSeconds = Math.floor(diff/1000);
        const days = Math.floor(totalSeconds / (24*3600));
        const hours = Math.floor((totalSeconds % (24*3600)) / 3600);
        const mins = Math.floor((totalSeconds % 3600) / 60);
        const secs = totalSeconds % 60;
        
        daysEl.textContent = String(days).padStart(2,'0');
        hrsEl.textContent  = String(hours).padStart(2,'0');
        minEl.textContent  = String(mins).padStart(2,'0');
        secEl.textContent  = String(secs).padStart(2,'0');
    };
    
    tick();
    lbCountdownInterval = setInterval(tick, 1000);
}

/* ŸÖÿßŸÑŸÉ: ÿ≠ÿ∞ŸÅ ŸÖŸÜ ÿßŸÑÿ™ÿµŸÜŸäŸÅ */
async function ownerRemoveFromLeaderboard(uid, name){
  if(!isOwner()) return;
  if(!confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ${name} ŸÖŸÜ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿü`)) return;
  try{
    await db.collection('study').doc(uid).set({ totalPoints: 0 }, { merge: true });
    showNotification('ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ','success');
  }catch(e){
    console.error('ownerRemoveFromLeaderboard', e);
    showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿµŸÅŸäÿ±','error');
  }
}

/* ===========================================================
   ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥
========================= */
function startJourneyListener(){
  stopJourneyListener();
  const box=document.getElementById('journey-container');
  if(box) box.innerHTML='<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿ≠ÿ™ŸàŸâ ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥...</p></div>';
  
  journeyUnsub = db.collection('journey_content')
    .orderBy('order','asc')
    .onSnapshot(
      snap=>{
        if(!snap.size){ 
          box.innerHTML='<div class="post"><p>ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≠ÿ™ŸàŸâ ÿ≠ÿßŸÑŸäÿßŸã.</p></div>'; 
          return; 
        }
        
        box.innerHTML = snap.docs.map(d=>{
          const it={id:d.id,...d.data()};
          return `
            <div class="journey-button" onclick="openJourneyItem('${it.id}')">
              <h3 style="margin:0">${escapeHTML(it.title||'ŸÖÿ≠ÿ™ŸàŸâ')}</h3>
            </div>`;
        }).join('');
      },
      error=>{ 
        console.error("Journey error:", error);
        box.innerHTML='<div class="post"><p>ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ</p></div>'; 
      }
    );
}
function stopJourneyListener(){ 
  if(journeyUnsub){
    try{journeyUnsub();}catch{} 
    journeyUnsub=null;
  }
}
// üìñ ŸÅÿ™ÿ≠ ŸÖÿ≠ÿ™ŸàŸâ ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥ - ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑŸÖÿµÿ≠ÿ≠
async function openJourneyItem(id) {
    try {
        showPage('journeyItem');
        
        const container = document.getElementById('journey-item-container');
        container.innerHTML = '<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ...</p></div>';
        
        const doc = await db.collection('journey_content').doc(id).get();
        
        if (!doc.exists) {
            container.innerHTML = '<div class="post"><p>ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ</p></div>';
            return;
        }
        
        const item = doc.data();
        
        let contentHTML = `
            <div class="post">
                <h2>${escapeHTML(item.title || 'ŸÖÿ≠ÿ™ŸàŸâ')}</h2>
                <div class="post-description" style="white-space: pre-wrap; line-height: 1.8;">
                    ${escapeHTML(item.content || 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≠ÿ™ŸàŸâ')}
                </div>
        `;
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÑŸÑŸÖÿßŸÑŸÉ
        if (isOwner()) {
            contentHTML += `
                <div class="post-actions" style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="editJourneyItem('${id}')">
                        <i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ
                    </button>
                    <button class="btn btn-danger" onclick="deleteJourneyItem('${id}')">
                        <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ
                    </button>
                </div>
            `;
        }
        
        contentHTML += `</div>`;
        container.innerHTML = contentHTML;
        
    } catch (error) {
        console.error("Error opening journey item:", error);
        showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ', 'error');
        
        const container = document.getElementById('journey-item-container');
        container.innerHTML = `
            <div class="post">
                <p>‚ùå ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ</p>
                <button class="btn" onclick="showChallengePage()">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ™ÿ≠ÿØŸä</button>
            </div>
        `;
    }
}

/* ===========================================================
   ÿßŸÑŸáÿØÿßŸäÿß ŸàÿßŸÑÿ¥ÿ±ÿßÿ°
========================= */
function openGiftsModal(){
  document.getElementById('gifts-modal').style.display='block';
  loadGifts();
}
function closeGiftsModal(){
  document.getElementById('gifts-modal').style.display='none';
}
function closePurchasedGiftsModal(){
  document.getElementById('purchased-gifts-modal').style.display='none';
}
async function loadGifts(){
  const giftsList = document.getElementById('gifts-list');
  giftsList.innerHTML = '<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸáÿØÿßŸäÿß...</p></div>';
  try {
    const snapshot = await db.collection('gifts').orderBy('price', 'asc').get();
    if (snapshot.empty) {
      giftsList.innerHTML = `
        <div class="post">
          <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸáÿØÿßŸäÿß ÿ≠ÿßŸÑŸäÿßŸã.</p>
          ${isOwner() ? '<button class="btn" onclick="addGift()">ÿ•ÿ∂ÿßŸÅÿ© ŸáÿØŸäÿ©</button>' : ''}
        </div>`;
      return;
    }
    giftsList.innerHTML = snapshot.docs.map(doc => {
      const gift = { id: doc.id, ...doc.data() };
      return `
        <div class="gift-item">
          <h4>${escapeHTML(gift.name)}</h4>
          <p>${escapeHTML(gift.description)}</p>
          <p class="muted">ÿßŸÑÿ≥ÿπÿ±: ${gift.price} ŸÜŸÇÿ∑ÿ©</p>
          <div class="gift-actions">
            <button class="btn btn-success" onclick="openBuyGiftModal('${gift.id}', '${escapeHTML(gift.name)}', '${escapeHTML(gift.description)}', ${gift.price})">
              ÿ¥ÿ±ÿßÿ°
            </button>
            ${isOwner() ? `
              <button class="btn btn-secondary" onclick="editGift('${gift.id}')">ÿ™ÿπÿØŸäŸÑ</button>
              <button class="btn btn-danger" onclick="deleteGift('${gift.id}')">ÿ≠ÿ∞ŸÅ</button>
            ` : ''}
          </div>
        </div>`;
    }).join('');
    if (isOwner()) {
      giftsList.innerHTML += `
        <div class="post" style="margin-top: 15px;">
          <button class="btn btn-block" onclick="addGift()">ÿ•ÿ∂ÿßŸÅÿ© ŸáÿØŸäÿ© ÿ¨ÿØŸäÿØÿ©</button>
        </div>`;
    }
    await loadPurchasedGifts();
  } catch (error) {
    console.error('Error loading gifts:', error);
    giftsList.innerHTML = '<div class="post"><p>ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸáÿØÿßŸäÿß</p></div>';
  }
}
async function showPurchasedGifts(){
  document.getElementById('purchased-gifts-modal').style.display = 'block';
  const list = document.getElementById('purchased-gifts-list');
  list.innerHTML = '<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™...</p></div>';
  try {
    const snapshot = await db.collection('purchases')
      .where('userId', '==', currentUser.uid)
      .get();
    if (snapshot.empty) {
      list.innerHTML = '<div class="post"><p>ŸÑŸÖ ÿ™ÿ¥ÿ™ÿ±Ÿä ÿ£Ÿä ŸÖÿ±ÿ¥ÿ≠ÿßÿ™ ÿ®ÿπÿØ.</p></div>';
      return;
    }
    list.innerHTML = snapshot.docs.map(doc => {
      const purchase = doc.data();
      return `
        <div class="gift-item">
          <h4>${escapeHTML(purchase.item)}</h4>
          <p>ÿ™ŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ° ÿ®ÿ™ÿßÿ±ŸäÿÆ: ${purchase.createdAt?.toDate ? purchase.createdAt.toDate().toLocaleString('ar-IQ') : ''}</p>
          <p class="muted">ÿßŸÑÿ≥ÿπÿ±: ${purchase.price} ŸÜŸÇÿ∑ÿ©</p>
          <button class="btn" onclick="openTelegram('MSLM_ALMYALY')">
            <i class="fab fa-telegram"></i> ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑŸÖÿßŸÑŸÉ
          </button>
        </div>`;
    }).join('');
  } catch (error) {
    console.error('Error loading purchased gifts:', error);
    list.innerHTML = '<div class="post"><p>ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ</p></div>';
  }
}
async function loadPurchasedGifts() {
  if (!currentUser) return;
  try {
    const purchasedSnapshot = await db.collection('purchases')
      .where('userId', '==', currentUser.uid)
      .get();
    const purchasedBtn = document.getElementById('purchased-gifts-btn');
    if (purchasedBtn && !purchasedSnapshot.empty) {
      purchasedBtn.style.display = 'block';
    }
  } catch (error) {
    console.error('Error loading purchased gifts:', error);
  }
}
function openBuyGiftModal(id, name, description, price){
  document.getElementById('buy-gift-title').textContent = `ÿ¥ÿ±ÿßÿ° ${name}`;
  document.getElementById('buy-gift-description').textContent = description;
  document.getElementById('buy-gift-price').textContent = price;
  document.getElementById('buy-gift-modal').style.display = 'block';
  window.currentGift = {id, name, description, price};
}
function closeBuyGiftModal(){
  document.getElementById('buy-gift-modal').style.display = 'none';
  window.currentGift = null;
}
async function purchaseGift(){
  if (!currentUser || !window.currentGift) return;
  const gift = window.currentGift;
  if (studyState.currentPoints < gift.price) {
    return showNotification('ŸÜŸÇÿßÿ∑ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸäÿ©','error');
  }
  try {
    const opId = Math.random().toString(36).substring(2,10).toUpperCase();
    await db.collection('study').doc(currentUser.uid).set({
      currentPoints: firebase.firestore.FieldValue.increment(-gift.price),
      name: currentUser.name||'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'
    }, {merge: true });
    
    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ¥ÿ±ÿßÿ° ÿßŸÑŸáÿØŸäÿ© ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑ
    await logPointsTransaction(currentUser.uid, -gift.price, 'gift_purchase', `ÿ¥ÿ±ÿßÿ° ŸáÿØŸäÿ©: ${gift.name}`);
    
    studyState.currentPoints -= gift.price;
    renderTimerUI();
    await db.collection('purchases').add({
      userId: currentUser.uid,
      userName: currentUser.name,
      userShortUid: currentUser.shortUid || generateShortUid(currentUser.uid),
      item: gift.name,
      price: gift.price,
      operationId: opId,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    await db.collection('inbox').add({
      userId: currentUser.uid,
      type: 'purchase',
      title: 'ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™',
      message: `ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ${gift.name} ÿ®ŸÜÿ¨ÿßÿ≠. ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑŸÖÿßŸÑŸÉ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™. (ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ©: ${opId})`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    const ownerUid = await getOwnerUid();
    if(ownerUid){
      await db.collection('inbox').add({
        userId: ownerUid,
        type: 'purchase_notice',
        item: gift.name,
        price: gift.price,
        operationId: opId,
        buyerUid: currentUser.uid,
        buyerName: currentUser.name,
        buyerShortUid: currentUser.shortUid || generateShortUid(currentUser.uid),
        status: 'unread',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    await sendTelegramNotification(
      `üõí <b>ÿ¥ÿ±ÿßÿ° ÿ¨ÿØŸäÿØ</b>\n\nüë§ ${escapeHTML(currentUser.name)}\nüÜî ${escapeHTML(currentUser.shortUid || generateShortUid(currentUser.uid))}\nüéÅ ${escapeHTML(gift.name)}\nüí∞ ${gift.price} ŸÜŸÇÿ∑ÿ©\n#${opId}`
    );

    showNotification(`ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ${gift.name} ÿ®ŸÜÿ¨ÿßÿ≠`,'success');
    closeBuyGiftModal();
    await loadPurchasedGifts();
  } catch (error) {
    console.error('Error purchasing gift:', error);
    showNotification('ŸÅÿ¥ŸÑ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ¥ÿ±ÿßÿ°','error');
  }
}
async function addGift() {
  if (!isOwner()) return;
  const name = prompt('ÿßÿ≥ŸÖ ÿßŸÑŸáÿØŸäÿ©:'); if (!name) return;
  const description = prompt('ŸàÿµŸÅ ÿßŸÑŸáÿØŸäÿ©:'); if (!description) return;
  const price = parseInt(prompt('ÿ≥ÿπÿ± ÿßŸÑŸáÿØŸäÿ© (ŸÜŸÇÿßÿ∑):')); if (isNaN(price) || price <= 0) return;
  try {
    await db.collection('gifts').add({
      name,
      description,
      price,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    showNotification('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸáÿØŸäÿ©','success');
    loadGifts();
  } catch (error) {
    console.error('Error adding gift:', error);
    showNotification('ŸÅÿ¥ŸÑ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸáÿØŸäÿ©','error');
  }
}
async function editGift(id) {
  if (!isOwner()) return;
  const doc = await db.collection('gifts').doc(id).get();
  if (!doc.exists) return;
  const gift = doc.data();
  const name = prompt('ÿßÿ≥ŸÖ ÿßŸÑŸáÿØŸäÿ©:', gift.name); if (!name) return;
  const description = prompt('ŸàÿµŸÅ ÿßŸÑŸáÿØŸäÿ©:', gift.description); if (!description) return;
  const price = parseInt(prompt('ÿ≥ÿπÿ± ÿßŸÑŸáÿØŸäÿ© (ŸÜŸÇÿßÿ∑):', gift.price)); if (isNaN(price) || price <= 0) return;
  try {
    await db.collection('gifts').doc(id).update({
      name,
      description,
      price,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    showNotification('ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸáÿØŸäÿ©','success');
    loadGifts();
  } catch (error) {
    console.error('Error editing gift:', error);
    showNotification('ŸÅÿ¥ŸÑ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸáÿØŸäÿ©','error');
  }
}
async function deleteGift(id) {
  if (!isOwner()) return;
  if (!confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑŸáÿØŸäÿ©ÿü')) return;
  try {
    await db.collection('gifts').doc(id).delete();
    showNotification('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸáÿØŸäÿ©','success');
    loadGifts();
  } catch (error) {
    console.error('Error deleting gift:', error);
    showNotification('ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸáÿØŸäÿ©','error');
  }
}

/* =========================
   ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÅŸÇÿßÿπÿßÿ™ ŸàÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ
========================= */

function updateNavBadges() {
    console.log('üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅŸÇÿßÿπÿßÿ™ - ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿ¨ÿØŸäÿØÿ©:', unreadPostsCount, 'ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™:', unreadNotifications.inbox);
    
    // ŸÅŸÇÿßÿπÿ© ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ (ÿßŸÑÿ™ŸÜŸÇŸÑ ÿßŸÑÿ≥ŸÅŸÑŸä)
    const postsBadge = document.getElementById('posts-badge');
    if (postsBadge) {
        if (unreadPostsCount > 0) {
            postsBadge.style.display = 'flex';
            postsBadge.textContent = unreadPostsCount > 9 ? '9+' : unreadPostsCount.toString();
            console.log('‚úÖ ÿπÿ±ÿ∂ ŸÅŸÇÿßÿπÿ© ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™:', unreadPostsCount);
        } else {
            postsBadge.style.display = 'none';
        }
    }
    
    // ŸÅŸÇÿßÿπÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ (ŸÅŸä ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®)
    const inboxBadge = document.getElementById('inbox-badge');
    if (inboxBadge) {
        if (unreadNotifications.inbox > 0) {
            inboxBadge.style.display = 'flex';
            inboxBadge.textContent = unreadNotifications.inbox > 9 ? '9+' : unreadNotifications.inbox.toString();
        } else {
            inboxBadge.style.display = 'none';
        }
    }
    
    // ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ™ŸÜŸÇŸÑ ÿßŸÑÿ≥ŸÅŸÑŸä ŸÑŸÑÿ≠ÿ≥ÿßÿ®
    const profileNavBadge = document.querySelector('.nav-item[data-page="profile"] .nav-badge');
    if (profileNavBadge) {
        if (unreadNotifications.inbox > 0) {
            profileNavBadge.style.display = 'flex';
            profileNavBadge.textContent = unreadNotifications.inbox > 9 ? '9+' : unreadNotifications.inbox.toString();
        } else {
            profileNavBadge.style.display = 'none';
        }
    }
}

/* ===== ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ ===== */
function startInboxBadgeListener() {
    if (!currentUser) return;
    
    // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÇÿØŸäŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
    if (window.inboxBadgeUnsubscribe) {
        window.inboxBadgeUnsubscribe();
    }
    
    // ŸÖÿ≥ÿ™ŸÖÿπ ÿ¨ÿØŸäÿØ ŸÑŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ
    window.inboxBadgeUnsubscribe = db.collection('inbox')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'unread')
        .onSnapshot((snapshot) => {
            unreadNotifications.inbox = snapshot.size;
            updateNavBadges(); // ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸÇÿßÿπÿßÿ™
        }, (error) => {
            console.error('Inbox badge listener error:', error);
        });
}

/* =========================
   ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑŸÅŸàÿ±Ÿä
========================= */

// ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÅÿπŸÑŸä ŸÑŸÑŸÜŸÇÿßÿ∑
function startPointsListener() {
  if (!currentUser) return;
  
  // ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÇÿØŸäŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
  if (window.pointsUnsubscribe) {
    window.pointsUnsubscribe();
  }
  
  // ŸÖÿ≥ÿ™ŸÖÿπ ÿ¨ÿØŸäÿØ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÅÿπŸÑŸä
  window.pointsUnsubscribe = db.collection('study')
    .doc(currentUser.uid)
    .onSnapshot((doc) => {
      if (doc.exists) {
        const data = doc.data();
        studyState.currentPoints = Number(data.currentPoints) || 0;
        studyState.totalPoints = Number(data.totalPoints) || 0;
        renderTimerUI();
      }
    }, (error) => {
      console.error('Points listener error:', error);
    });
}

/* =========================
   Ÿàÿ∏ÿßÿ¶ŸÅ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑŸÖÿßŸÑŸÉ
========================= */
async function manualDistributeRewards(){
  if(!isOwner()) return;
  if(!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ŸäÿØŸàŸäÿßŸãÿü')) return;
  await distributeWeeklyRewards();
}

async function ownerQuickResetLeaderboard(){
  if(!isOwner()) return;
  try {
    const snapshot = await db.collection('study').get();
    const batch = db.batch();
    snapshot.docs.forEach(doc => {
      batch.update(doc.ref, { totalPoints: 0 });
    });
    await batch.commit();
    showNotification('ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ ŸäÿØŸàŸäÿßŸã','success');
  } catch(e) {
    console.error('Error in quick reset:', e);
    showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿµŸÅŸäÿ±','error');
  }
}

// ÿ≤ÿ± ÿ™Ÿàÿ≤Ÿäÿπ ŸäÿØŸàŸä ŸÖÿπ ÿ™ÿ£ŸÉŸäÿØ
function addManualDistributionButton() {
    if(isOwner()){
        const lbTools = document.querySelector('.lb-tools');
        if(lbTools && !document.getElementById('manual-distribute-btn')){
            const manualBtn = document.createElement('button');
            manualBtn.id = 'manual-distribute-btn';
            manualBtn.className = 'btn btn-danger';
            manualBtn.innerHTML = '<i class="fas fa-bolt"></i> ÿ™Ÿàÿ≤Ÿäÿπ ŸäÿØŸàŸä';
            manualBtn.onclick = confirmManualDistribution;
            lbTools.appendChild(manualBtn);
        }
    }
}

// ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸäÿØŸàŸä
function confirmManualDistribution() {
    if(!isOwner()) return;
    
    const confirmation = confirm(`‚ö†Ô∏è ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸäÿØŸàŸä

ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿ¢ŸÜÿü
‚Ä¢ ÿ≥Ÿäÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ™ÿµŸÜŸäŸÅ
‚Ä¢ ÿ≥Ÿäÿ™ŸÖ ŸÖŸÜÿ≠ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ŸÑŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑÿ£ŸàŸÑŸâ
‚Ä¢ ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ©

ÿßÿ∂ÿ∫ÿ∑ "ŸÖŸàÿßŸÅŸÇ" ŸÑŸÑŸÖÿ™ÿßÿ®ÿπÿ©.`);
    
    if (confirmation) {
        distributeWeeklyRewards();
    }
}

// ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≤ÿ±
setTimeout(addManualDistributionButton, 3000);

/* =========================
   ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
========================= */
// ÿ•ÿÆŸÅÿßÿ° ÿ≤ÿ± ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
setTimeout(() => {
  const testBtn = document.querySelector('button[onclick="testWeeklyReward()"]');
  if (testBtn) {
    testBtn.style.display = 'none';
  }
}, 5000);

// ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™ ÿßŸÑŸÇÿµŸäÿ±ÿ©
async function updateAllUserShortUids() {
  if (!isOwner()) return;
  try {
    const usersSnapshot = await db.collection('users').get();
    const batch = db.batch();
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      if (!userData.shortUid) {
        const shortUid = generateShortUid(doc.id);
        batch.update(doc.ref, { shortUid });
      }
    });
    await batch.commit();
    showNotification('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™','success');
  } catch (error) {
    console.error('Error updating short UIDs:', error);
    showNotification('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™','error');
  }
}


console.log('‚úÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ≥ŸàŸÇ ÿßŸÑÿ∑ŸÑÿßÿ® ŸÖÿ≠ŸÖŸÑ Ÿàÿ¨ÿßŸáÿ≤ ŸÑŸÑÿπŸÖŸÑ!');
/* =========================
   ŸÜÿ∏ÿßŸÖ ŸÉÿ¥ŸÅ ÿßŸÑŸÜŸÇÿßÿ∑ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
========================= */

// ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ŸÉÿ¥ŸÅ ÿßŸÑŸÜŸÇÿßÿ∑
function openPointsReport() {
  if (!isOwner()) return showNotification('ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑', 'error');
  document.getElementById('points-report-modal').style.display = 'block';
  // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ
  document.getElementById('points-search-input').value = '';
  document.getElementById('points-user-info').style.display = 'none';
  document.getElementById('points-stats').style.display = 'none';
  document.getElementById('points-report-container').innerHTML = '<div class="post"><p>ÿßŸÉÿ™ÿ® ÿ®ÿ±ŸäÿØ ÿ£Ÿà ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ´ŸÖ ÿßÿ∂ÿ∫ÿ∑ ÿ®ÿ≠ÿ´</p></div>';
}

// ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
function closePointsReportModal() {
  document.getElementById('points-report-modal').style.display = 'none';
}

// ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿàÿπÿ±ÿ∂ ŸÜŸÇÿßÿ∑Ÿá
async function searchUserPoints() {
  if (!isOwner()) return;
  
  const searchTerm = document.getElementById('points-search-input').value.trim();
  if (!searchTerm) {
    return showNotification('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ®ÿ±ŸäÿØ ÿ£Ÿà ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'error');
  }

  try {
    let userDoc = null;
    let userData = null;
    let userId = null;

    // ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
    const emailQuery = await db.collection('users')
      .where('email', '==', searchTerm.toLowerCase())
      .limit(1)
      .get();

    if (!emailQuery.empty) {
      userDoc = emailQuery.docs[0];
      userData = userDoc.data();
      userId = userDoc.id;
    } else {
      // ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿÆÿ™ÿµÿ±
      const shortUidQuery = await db.collection('users')
        .where('shortUid', '==', searchTerm.toUpperCase())
        .limit(1)
        .get();

      if (!shortUidQuery.empty) {
        userDoc = shortUidQuery.docs[0];
        userData = userDoc.data();
        userId = userDoc.id;
      } else {
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÄ UID
        try {
          const uidDoc = await db.collection('users').doc(searchTerm).get();
          if (uidDoc.exists) {
            userDoc = uidDoc;
            userData = uidDoc.data();
            userId = searchTerm;
          }
        } catch (e) {}
      }
    }

    if (!userDoc) {
      return showNotification('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'error');
    }

    // ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    document.getElementById('points-user-name').textContent = `ÿßŸÑÿßÿ≥ŸÖ: ${userData.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}`;
    document.getElementById('points-user-email').textContent = `ÿßŸÑÿ®ÿ±ŸäÿØ: ${userData.email || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}`;
    document.getElementById('points-user-shortuid').textContent = `ÿßŸÑŸÖÿπÿ±ŸÅ: ${userData.shortUid || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}`;
    document.getElementById('points-user-info').style.display = 'block';

    // ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜŸÇÿßÿ∑
    const studyDoc = await db.collection('study').doc(userId).get();
    let pointsData = {};

    if (studyDoc.exists) {
      pointsData = studyDoc.data();
    }

    // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
    document.getElementById('total-points').textContent = pointsData.totalPoints || 0;
    document.getElementById('current-points').textContent = pointsData.currentPoints || 0;
    document.getElementById('wallet-points').textContent = pointsData.walletPoints || 0;
    document.getElementById('points-stats').style.display = 'block';

    // ÿ¨ŸÑÿ® ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜŸÇÿßÿ∑ ŸÖŸÜ Firestore
    await loadUserPointsHistory(userId, userData);

  } catch (error) {
    console.error('Error searching user points:', error);
    showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ®ÿ≠ÿ´', 'error');
  }
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜŸÇÿßÿ∑ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
async function loadUserPointsHistory(userId, userData) {
  const container = document.getElementById('points-report-container');
  container.innerHTML = '<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜŸÇÿßÿ∑...</p></div>';

  try {
    // ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ study ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    const studyDoc = await db.collection('study').doc(userId).get();
    const studyData = studyDoc.exists ? studyDoc.data() : {};

    // ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
    const pointsHistory = [];

    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑŸäŸàŸÖŸäÿ©
    if (studyData.lastDailyClaimAt) {
      pointsHistory.push({
        type: 'ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©',
        points: 20,
        description: 'ŸÖŸÉÿßŸÅÿ£ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ŸäŸàŸÖŸä',
        timestamp: studyData.lastDailyClaimAt
      });
    }

    // ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ§ŸÇÿ™
    if (studyData.totalPoints && studyData.totalPoints > 0) {
      pointsHistory.push({
        type: 'ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ§ŸÇÿ™',
        points: studyData.totalPoints,
        description: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ§ŸÇÿ™',
        timestamp: studyData.lastUpdated || studyData.startAt
      });
    }

    // ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©
    if (studyData.walletPoints && studyData.walletPoints > 0) {
      pointsHistory.push({
        type: 'ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©',
        points: studyData.walletPoints,
        description: 'ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ÿßŸÑŸÖÿ™ÿ±ÿßŸÉŸÖÿ©',
        timestamp: studyData.lastUpdated
      });
    }

    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©
    if (studyData.lastWeeklyReward) {
      pointsHistory.push({
        type: 'ŸÖŸÉÿßŸÅÿ£ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©',
        points: studyData.lastWeeklyRewardAmount || 0,
        description: 'ŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä',
        timestamp: studyData.lastWeeklyReward
      });
    }

    // ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ¨ŸÑ
    if (pointsHistory.length === 0) {
      container.innerHTML = '<div class="post"><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ŸÜŸÇÿßÿ∑ ŸÑŸáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</p></div>';
      return;
    }

    // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ≥ÿ¨ŸÑ ŸÖŸÜ ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ•ŸÑŸâ ÿßŸÑÿ£ŸÇÿØŸÖ
    pointsHistory.sort((a, b) => {
      const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0;
      const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0;
      return timeB - timeA;
    });

    container.innerHTML = pointsHistory.map(item => {
      const time = item.timestamp?.toDate ? item.timestamp.toDate().toLocaleString('ar-IQ') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
      
      return `
        <div class="post" style="margin-bottom: 10px; border-left: 4px solid ${getPointsHistoryColor(item.type)}">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <strong>${escapeHTML(item.type)}</strong>
            <span style="color: ${item.points > 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">
              ${item.points > 0 ? '+' : ''}${item.points} ŸÜŸÇÿ∑ÿ©
            </span>
          </div>
          <div style="color: #666; font-size: 14px; margin: 5px 0;">
            ${escapeHTML(item.description)}
          </div>
          <div style="font-size: 12px; color: #888;">
            ${time}
          </div>
        </div>
      `;
    }).join('');

  } catch (error) {
    console.error('Error loading points history:', error);
    container.innerHTML = '<div class="post"><p>ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜŸÇÿßÿ∑</p></div>';
  }
}

// ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑŸÑÿ£ŸÑŸàÿßŸÜ ŸÅŸä ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜŸÇÿßÿ∑
function getPointsHistoryColor(type) {
  const colors = {
    'ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©': '#28a745',
    'ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ§ŸÇÿ™': '#17a2b8',
    'ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©': '#ffc107',
    'ŸÖŸÉÿßŸÅÿ£ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©': '#6610f2',
    'ÿ¥ÿ±ÿßÿ° ÿ™ÿ≥ÿ±Ÿäÿπ': '#fd7e14',
    'ÿ¥ÿ±ÿßÿ° ŸáÿØŸäÿ©': '#e83e8c'
  };
  return colors[type] || '#6c757d';
}

/* ===== ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ÿ∏ÿ± ÿßŸÑÿØÿßÿ¶ŸÖ ŸàÿßŸÑŸÖŸÜÿπ ===== */
async function permanentBanAndPrevent(userId, reason) {
    try {
        const userRef = db.collection('users').doc(userId);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) return;

        const userData = userDoc.data();
        const userEmail = userData.email;
        
        // 1. üîí Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ÿ≠ÿ∏ÿ± ÿØÿßÿ¶ŸÖÿ©
        await userRef.update({
            isPermanentlyBanned: true,
            banReason: reason,
            bannedAt: firebase.firestore.FieldValue.serverTimestamp(),
            originalEmail: userEmail, // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ£ÿµŸÑŸä
            bannedBy: 'SYSTEM_AUTO',
            banType: 'PERMANENT'
        });

        // 2. üóÇ ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ± ÿπÿßŸÑŸÖŸäÿßŸã
        await db.collection('banned_emails').doc(userEmail.toLowerCase()).set({
            email: userEmail.toLowerCase(),
            originalUserId: userId,
            banReason: reason,
            bannedAt: firebase.firestore.FieldValue.serverTimestamp(),
            bannedBy: 'SYSTEM_AUTO',
            preventRegistration: true
        });

        // 3. üì¢ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿßŸÑŸÉ
        await sendTelegramNotification(
            `üö´ <b>ÿ≠ÿ∏ÿ± ÿØÿßÿ¶ŸÖ</b>\n\n` +
            `üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${escapeHTML(userData.name || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ')}\n` +
            `üìß ÿßŸÑÿ®ÿ±ŸäÿØ: ${escapeHTML(userEmail)}\n` +
            `üÜî ÿßŸÑŸÖÿπÿ±ŸÅ: ${escapeHTML(userData.shortUid || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ')}\n` +
            `üìù ÿßŸÑÿ≥ÿ®ÿ®: ${escapeHTML(reason)}\n` +
            `‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleString('ar-IQ')}\n` +
            `üö® ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°: ÿ≠ÿ∏ÿ± ÿØÿßÿ¶ŸÖ + ŸÖŸÜÿπ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ`
        );

        console.log(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∏ÿ± ${userEmail} ÿ®ÿ¥ŸÉŸÑ ÿØÿßÿ¶ŸÖ`);

    } catch (error) {
        console.error('Error in permanent ban:', error);
    }
}

// üö™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿßŸÑŸÇÿ≥ÿ±Ÿä ŸÖÿπ ÿ±ÿ≥ÿßŸÑÿ© Ÿàÿßÿ∂ÿ≠ÿ©
function forceLogoutWithMessage(message) {
    showNotification(`üö´ ${message}`, 'error');
    
    setTimeout(() => {
        // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
        localStorage.removeItem('seenBroadcasts');
        localStorage.removeItem('userSignupTime');
        localStorage.removeItem('lastSeenTime');
        localStorage.removeItem('reportedPosts');
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
        auth.signOut().then(() => {
            // ÿ•ÿπÿßÿØÿ© ÿ™Ÿàÿ¨ŸäŸá ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
            window.location.reload();
        });
    }, 4000);
}

/* ===== ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ± ÿπŸÜÿØ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ===== */
async function checkIfEmailBanned(email) {
    try {
        const bannedEmailDoc = await db.collection('banned_emails')
            .doc(email.toLowerCase())
            .get();
        
        return bannedEmailDoc.exists;
    } catch (error) {
        console.error('Error checking banned email:', error);
        return false;
    }
}

/* ===== ŸÉÿ¥ŸÅ ÿßŸÑÿ™ŸÑÿßÿπÿ® ÿ®ÿßŸÑŸàŸÇÿ™ ŸÖÿπ ÿßŸÑÿ≠ÿ∏ÿ± ÿßŸÑÿØÿßÿ¶ŸÖ ===== */
// üîç ŸÉÿ¥ŸÅ ÿßŸÑÿ™ŸÑÿßÿπÿ® ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ (ÿßŸÑÿ≠ÿ∏ÿ± ŸÅŸÇÿ∑ ŸÑŸÑŸÅÿ±ŸÇ ÿßŸÑŸÉÿ®Ÿäÿ±)
async function detectTimeManipulation() {
    if (!currentUser) return false;
    
    try {
        const userRef = db.collection('study').doc(currentUser.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) return false;
        
        const userData = userDoc.data();
        const now = new Date();
        const clientTime = now.getTime();
        
        // üïí ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸàŸÇÿ™ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿßŸÑŸÖŸàÿ´ŸàŸÇ
        const serverTimeDoc = await db.collection('server_time').doc('current').get();
        let serverTime = now;
        
        if (serverTimeDoc.exists) {
            serverTime = serverTimeDoc.data().timestamp.toDate();
        }

        // üìä ÿßŸÑŸÅÿ±ŸàŸÇ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ© (ŸÖÿ±ŸÜÿ© ŸàÿπÿßÿØŸÑÿ©)
        const MAX_TIME_DIFF = 2 * 24 * 60 * 60 * 1000; // üî• ŸäŸàŸÖŸäŸÜ ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ ŸÑŸÑŸÅÿ±ŸÇ (ÿ®ÿØŸÑ 5 ÿØŸÇÿßŸäŸÇ)
        const MIN_CLAIM_INTERVAL = 23 * 60 * 60 * 1000; // 23 ÿ≥ÿßÿπÿ© ŸÉÿ≠ÿØ ÿ£ÿØŸÜŸâ ÿ®ŸäŸÜ ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™

        // üîç ÿßŸÑÿ™ÿ≠ŸÇŸÇ 1: ÿßŸÑŸÅÿ±ŸÇ ÿßŸÑŸÉÿ®Ÿäÿ± ÿ®ŸäŸÜ ŸàŸÇÿ™ ÿßŸÑÿπŸÖŸäŸÑ ŸàÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± (ŸäŸàŸÖŸäŸÜ+)
        const timeDiff = Math.abs(serverTime.getTime() - clientTime);
        if (timeDiff > MAX_TIME_DIFF) {
            console.warn(`üö® ŸÅÿ±ŸÇ ÿ≤ŸÖŸÜŸä ŸÉÿ®Ÿäÿ±: ${Math.floor(timeDiff/(24*60*60*1000))} ÿ£ŸäÿßŸÖ`);
            
            // üî• ŸáŸÜÿß ŸÅŸÇÿ∑ ŸÜÿ≠ÿ∏ÿ± - ÿ•ÿ∞ÿß ÿßŸÑŸÅÿ±ŸÇ ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ŸäŸàŸÖŸäŸÜ
            await handleSevereTimeManipulation();
            return true;
        }

        // üîç ÿßŸÑÿ™ÿ≠ŸÇŸÇ 2: ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±ÿ© ÿ®ÿ≥ÿ±ÿπÿ© (ÿ®ÿØŸàŸÜ ÿ≠ÿ∏ÿ± - ŸÅŸÇÿ∑ ŸÖŸÜÿπ)
        if (userData.lastDailyClaimAt) {
            const lastClaimTime = userData.lastDailyClaimAt.toDate().getTime();
            const timeSinceLastClaim = clientTime - lastClaimTime;
            
            if (timeSinceLastClaim < MIN_CLAIM_INTERVAL) {
                console.warn(`‚ö†Ô∏è ŸÖÿ≠ÿßŸàŸÑÿ© ÿ£ÿÆÿ∞ ŸÖŸÉÿßŸÅÿ£ÿ© ŸÖÿ®ŸÉÿ±ÿßŸã: ${msToHMS(timeSinceLastClaim)} ŸÅŸÇÿ∑`);
                // ‚ùå ŸÜŸÖŸÜÿπ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ŸÑŸÉŸÜ ŸÖÿß ŸÜÿ≠ÿ∏ÿ±
                showNotification('ŸÑŸÖ Ÿäÿ≠ŸÜ ŸàŸÇÿ™ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿ®ÿπÿØ', 'error');
                return true;
            }
        }

        // ‚úÖ ŸÉŸÑ ÿ¥Ÿäÿ° ÿ∑ÿ®ŸäÿπŸä
        return false;
        
    } catch (error) {
        console.error('Error in time manipulation detection:', error);
        return false; // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£ÿå ŸÑÿß ŸÜÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    }
}

// üõ°Ô∏è ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ™ŸÑÿßÿπÿ® ÿßŸÑŸÖŸÉÿ™ÿ¥ŸÅ (ŸÖÿ±ŸÜÿ© - ÿ®ÿØŸàŸÜ ÿ≠ÿ∏ÿ±)
async function handleTimeManipulationDetected() {
    try {
        // üìù ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ™ŸÑÿßÿπÿ® ŸÅŸÇÿ∑
        await db.collection('suspicious_activities').add({
            userId: currentUser.uid,
            userName: currentUser.name,
            userEmail: currentUser.email,
            type: 'time_manipulation_daily_reward',
            clientTime: new Date(),
            serverTime: firebase.firestore.FieldValue.serverTimestamp(),
            severity: 'low',
            action_taken: 'prevent_reward_only'
        });

        // üö´ ŸÖŸÜÿπ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ŸÖÿπ ÿ±ÿ≥ÿßŸÑÿ© ÿ™Ÿàÿ∂Ÿäÿ≠Ÿäÿ©
        showNotification('‚ùå ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© - Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸàŸÇÿ™ ÿßŸÑÿ¨Ÿáÿßÿ≤', 'error');
        
        // üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        updateDailyRewardUI();

    } catch (error) {
        console.error('Error handling time manipulation:', error);
    }
}

console.log('‚úÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ≥ŸàŸÇ ÿßŸÑÿ∑ŸÑÿßÿ® ŸÖÿ≠ŸÖŸÑ Ÿàÿ¨ÿßŸáÿ≤ ŸÑŸÑÿπŸÖŸÑ!');

/* ===== ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ŸÖÿ≠ÿ™ŸàŸâ ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥ ===== */

// ‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ŸÖÿ≠ÿ™ŸàŸâ ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥
async function editJourneyItem(id) {
    if(!isOwner()) return;
    
    try {
        const doc = await db.collection('journey_content').doc(id).get();
        if(!doc.exists) return;
        
        const item = doc.data();
        const newTitle = prompt('ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¨ÿØŸäÿØ:', item.title);
        if(!newTitle) return;
        
        const newContent = prompt('ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ¨ÿØŸäÿØ:', item.content);
        if(newContent === null) return;
        
        await db.collection('journey_content').doc(id).update({
            title: newTitle,
            content: newContent,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
        openJourneyItem(id);
        
    } catch(error) {
        console.error('Error editing journey item:', error);
        showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ', 'error');
    }
}

// üóëÔ∏è ÿ≠ÿ∞ŸÅ ŸÖÿ≠ÿ™ŸàŸâ ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥
async function deleteJourneyItem(id) {
    if(!isOwner()) return;
    
    if(!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≠ÿ™ŸàŸâÿü')) return;
    
    try {
        await db.collection('journey_content').doc(id).delete();
        showNotification('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        // ÿßŸÑÿπŸàÿØÿ© ŸÑÿµŸÅÿ≠ÿ© ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        showChallengePage();
        
    } catch(error) {
        console.error('Error deleting journey item:', error);
        showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ', 'error');
    }
}

// ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ÿ™ŸàŸâ ÿ¨ÿØŸäÿØ ŸÑÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥
async function addJourneyContent() {
    if(!isOwner()) return;
    
    const title = prompt('ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ¨ÿØŸäÿØ:');
    if(!title) return;
    
    const content = prompt('ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÜÿµŸä:');
    if(!content) return;
    
    try {
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
        const lastItem = await db.collection('journey_content')
            .orderBy('order', 'desc')
            .limit(1)
            .get();
            
        const newOrder = lastItem.empty ? 1 : (lastItem.docs[0].data().order + 1);
        
        await db.collection('journey_content').add({
            title: title,
            content: content,
            order: newOrder,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser.uid
        });
        
        showNotification('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ¨ÿØŸäÿØ', 'success');
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿØÿ≥
        startJourneyListener();
        
    } catch(error) {
        console.error('Error adding journey content:', error);
        showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©', 'error');
    }
}

// ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ
function updateBoostStatus(){
  const st = studyState; 
  const el = document.getElementById('boost-status');
  const boostInfo = document.getElementById('boost-info');
  
  if(!st.boostUntil){ 
    if(el) el.textContent = ''; 
    if(boostInfo) boostInfo.style.display = 'none';
    stopBoostInterval(); 
    renderTimerUI();
    return; 
  }
  
  const left = st.boostUntil.getTime() - Date.now();
  if(left <= 0){ 
    st.boostUntil = null; 
    if(el) el.textContent = ''; 
    if(boostInfo) boostInfo.style.display = 'none';
    stopBoostInterval(); 
    renderTimerUI(); 
    showNotification("ÿßŸÜÿ™Ÿáÿ™ ŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ‚è∞", "info");
    return; 
  }
  
  const hours = Math.floor(left / (1000 * 60 * 60));
  const minutes = Math.floor((left % (1000 * 60 * 60)) / (1000 * 60));
  
  if(el) el.textContent = `‚ö° ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ ŸÖŸÅÿπŸÑ - ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${hours} ÿ≥ÿßÿπÿ© ${minutes} ÿØŸÇŸäŸÇÿ©`;
  if(boostInfo) boostInfo.style.display = 'block';
  
  renderTimerUI();
}

/* =========================
   üî• ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ
========================= */

// ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
async function openUserManagement() {
    if (!isOwner()) return showNotification('ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑', 'error');
    document.getElementById('user-management-modal').style.display = 'block';
    await loadUsersStats();
}

async function openPointsReport() {
  if (!isOwner()) return showNotification('ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑', 'error');
  document.getElementById('points-report-modal').style.display = 'block';
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
async function loadUsersStats() {
    try {
        const usersSnapshot = await db.collection('users').get();
        const totalUsers = usersSnapshot.size;
        
        let bannedCount = 0;
        let verifiedCount = 0;
        
        usersSnapshot.forEach(doc => {
            const userData = doc.data();
            if (userData.isPermanentlyBanned) bannedCount++;
            if (userData.isVerified) verifiedCount++;
        });
        
        document.getElementById('total-users-count').textContent = totalUsers;
        document.getElementById('banned-users-count').textContent = bannedCount;
        document.getElementById('verified-users-count').textContent = verifiedCount;
        
    } catch (error) {
        console.error('Error loading users stats:', error);
    }
}

// ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
async function searchUsers() {
    const searchTerm = document.getElementById('user-search-input').value.trim();
    const container = document.getElementById('users-list-container');
    
    container.innerHTML = '<div class="post"><p>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´...</p></div>';
    
    try {
        let usersQuery;
        
        if (!searchTerm) {
            // ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (ÿ¢ÿÆÿ± 50 ŸÖÿ≥ÿ™ÿÆÿØŸÖ)
            usersQuery = await db.collection('users')
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
        } else {
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿ®ÿ±ŸäÿØ
            usersQuery = await db.collection('users')
                .where('email', '>=', searchTerm)
                .where('email', '<=', searchTerm + '\uf8ff')
                .get();
            
            if (usersQuery.empty) {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ
                usersQuery = await db.collection('users')
                    .where('name', '>=', searchTerm)
                    .where('name', '<=', searchTerm + '\uf8ff')
                    .get();
            }
            
            if (usersQuery.empty) {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿÆÿ™ÿµÿ±
                usersQuery = await db.collection('users')
                    .where('shortUid', '==', searchTerm.toUpperCase())
                    .get();
            }
        }
        
        if (usersQuery.empty) {
            container.innerHTML = '<div class="post"><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸÑÿ®ÿ≠ÿ´</p></div>';
            return;
        }
        
        await renderUsersList(usersQuery.docs);
        
    } catch (error) {
        console.error('Error searching users:', error);
        container.innerHTML = '<div class="post"><p>ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´</p></div>';
    }
}

// ÿπÿ±ÿ∂ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
async function renderUsersList(userDocs) {
    const container = document.getElementById('users-list-container');
    
    const usersWithStats = await Promise.all(
        userDocs.map(async (doc) => {
            const userData = doc.data();
            const userId = doc.id;
            
            // ÿ¨ŸÑÿ® ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            const studyDoc = await db.collection('study').doc(userId).get();
            const studyData = studyDoc.exists ? studyDoc.data() : {};
            
            // ÿ¨ŸÑÿ® ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™
            const postsQuery = await db.collection('posts')
                .where('userId', '==', userId)
                .get();
            
            return {
                id: userId,
                ...userData,
                totalPoints: studyData.totalPoints || 0,
                currentPoints: studyData.currentPoints || 0,
                walletPoints: studyData.walletPoints || 0,
                postsCount: postsQuery.size,
                lastSeen: userData.lastSeen || null
            };
        })
    );
    
    container.innerHTML = usersWithStats.map(user => `
        <div class="post" style="border-left: 4px solid ${user.isPermanentlyBanned ? '#dc3545' : user.isVerified ? '#28a745' : '#6c757d'}; margin-bottom: 10px;">
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: start;">
                <div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <strong>${escapeHTML(user.name || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ')}</strong>
                        ${user.isVerified ? '<span class="badge-verified"><i class="fa-solid fa-crown"></i> ŸÖŸàÿ´ŸëŸÇ</span>' : ''}
                        ${user.isPermanentlyBanned ? '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">ŸÖÿ≠ÿ∏Ÿàÿ±</span>' : ''}
                    </div>
                    
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                        üìß ${escapeHTML(user.email || 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ®ÿ±ŸäÿØ')}
                    </div>
                    
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                        üÜî ${escapeHTML(user.shortUid || 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿπÿ±ŸÅ')}
                    </div>
                    
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                        üìä ÿßŸÑŸÜŸÇÿßÿ∑: ${user.currentPoints} | ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©: ${user.walletPoints} | ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™: ${user.postsCount}
                    </div>
                    
                    ${user.lastSeen ? `
                    <div style="font-size: 12px; color: #888;">
                        ÿ¢ÿÆÿ± ŸÜÿ¥ÿßÿ∑: ${user.lastSeen.toDate ? user.lastSeen.toDate().toLocaleString('ar-IQ') : 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'}
                    </div>
                    ` : ''}
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    ${!user.isPermanentlyBanned ? `
                        <button class="btn btn-danger btn-xs" onclick="banUser('${user.id}', '${escapeHTML(user.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}')">
                            <i class="fas fa-ban"></i> ÿ≠ÿ∏ÿ±
                        </button>
                        <button class="btn btn-warning btn-xs" onclick="resetUserPoints('${user.id}', '${escapeHTML(user.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}')">
                            <i class="fas fa-undo"></i> ÿ™ÿµŸÅŸäÿ± ÿßŸÑŸÜŸÇÿßÿ∑
                        </button>
                    ` : `
                        <button class="btn btn-success btn-xs" onclick="unbanUser('${user.id}', '${escapeHTML(user.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}')">
                            <i class="fas fa-check"></i> ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ±
                        </button>
                    `}
                    
                    <button class="btn btn-secondary btn-xs" onclick="viewUserDetails('${user.id}')">
                        <i class="fas fa-info-circle"></i> ÿ™ŸÅÿßÿµŸäŸÑ
                    </button>
                    
                    ${!user.isVerified ? `
                        <button class="btn btn-xs" onclick="verifyUser('${user.id}')">
                            <i class="fas fa-crown"></i> ÿ™Ÿàÿ´ŸäŸÇ
                        </button>
                    ` : `
                        <button class="btn btn-warning btn-xs" onclick="unverifyUser('${user.id}')">
                            <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ
                        </button>
                    `}
                </div>
            </div>
        </div>
    `).join('');
}

// üîí ÿ≠ÿ∏ÿ± ŸÖÿ≥ÿ™ÿÆÿØŸÖ
async function banUser(userId, userName) {
    if (!isOwner()) return;
    
    const reason = prompt(`ÿ≥ÿ®ÿ® ÿ≠ÿ∏ÿ± ${userName}:`);
    if (!reason) return;
    
    try {
        // 1. ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        await db.collection('users').doc(userId).update({
            isPermanentlyBanned: true,
            banReason: reason,
            bannedAt: firebase.firestore.FieldValue.serverTimestamp(),
            bannedBy: currentUser.uid
        });
        
        // 2. ÿ™ÿµŸÅŸäÿ± ÿßŸÑŸÜŸÇÿßÿ∑
        await db.collection('study').doc(userId).set({
            currentPoints: 0,
            totalPoints: 0,
            walletPoints: 0,
            running: false,
            startAt: null
        }, { merge: true });
        
        // 3. ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±
        const userDoc = await db.collection('users').doc(userId).get();
        const userEmail = userDoc.data().email;
        
        await db.collection('banned_emails').doc(userEmail.toLowerCase()).set({
            email: userEmail.toLowerCase(),
            originalUserId: userId,
            banReason: reason,
            bannedAt: firebase.firestore.FieldValue.serverTimestamp(),
            bannedBy: currentUser.uid,
            preventRegistration: true
        });
        
        // 4. ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±
        await sendTelegramNotification(
            `üö´ <b>ÿ≠ÿ∏ÿ± ŸÖÿ≥ÿ™ÿÆÿØŸÖ</b>\n\nüë§ ${escapeHTML(userName)}\nüìß ${escapeHTML(userEmail)}\nüìù ${escapeHTML(reason)}`
        );
        
        showNotification(`ÿ™ŸÖ ÿ≠ÿ∏ÿ± ${userName} Ÿàÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑Ÿá`, 'success');
        await searchUsers(); // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
        
    } catch (error) {
        console.error('Error banning user:', error);
        showNotification('ŸÅÿ¥ŸÑ ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'error');
    }
}

// üîì ÿØÿßŸÑÿ© ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ± ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸÖÿπ ÿ•ÿ±ÿ¨ÿßÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
async function unbanUser(userId, userName) {
    if (!isOwner()) return;
    
    if (!confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÅŸÉ ÿ≠ÿ∏ÿ± ${userName}ÿü\n\n‚úÖ ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ¨ÿßÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™:\n‚Ä¢ ÿßŸÑŸÜÿ¥ÿ± ŸàÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™\n‚Ä¢ ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫ ŸàÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™\n‚Ä¢ ÿ¨ŸÖÿπ ÿßŸÑŸÜŸÇÿßÿ∑ ŸàÿßŸÑŸÖÿ§ŸÇÿ™\n‚Ä¢ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©\n‚Ä¢ ÿ¥ÿ±ÿßÿ° ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™ ŸàÿßŸÑŸáÿØÿßŸäÿß\n‚Ä¢ ÿ¥ÿ±ÿßÿ° ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ\n‚Ä¢ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ŸàÿßŸÑŸÖŸÜÿßŸÅÿ≥ÿ©`)) return;
    
    try {
        const userRef = db.collection('users').doc(userId);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            showNotification('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ', 'error');
            return;
        }

        const userData = userDoc.data();
        const userEmail = userData.email;
        
        // 1. üîì ÿ•ŸÑÿ∫ÿßÿ° ÿ¨ŸÖŸäÿπ ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ≠ÿ∏ÿ± ŸàÿßŸÑŸÇŸäŸàÿØ
        await userRef.update({
            // ÿßŸÑÿ≠ÿ∏ÿ± ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä
            isPermanentlyBanned: false,
            blockedFromPosting: false,
            
            // ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
            canReport: true,
            canComment: true,
            canEarnPoints: true,
            canClaimDaily: true,
            canBuyGifts: true,
            canBuyBoost: true,
            canCompete: true,
            
            // ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ±
            banReason: null,
            unbannedAt: firebase.firestore.FieldValue.serverTimestamp(),
            unbannedBy: currentUser.uid,
            unbannedByName: currentUser.name,
            fullAccessRestored: true
        });

        // 2. üóëÔ∏è ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±
        await db.collection('banned_emails').doc(userEmail.toLowerCase()).delete();

        // 3. üîÑ ÿ™ŸÅÿπŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸäÿ≤ÿßÿ™ ŸÅŸä collection study
        await db.collection('study').doc(userId).set({
            canEarnPoints: true,
            canUseTimer: true,
            canClaimRewards: true,
            canCompeteInLeaderboard: true,
            accessRestoredAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // 4. üìù ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ±
        await db.collection('admin_actions').add({
            type: 'full_unban_user',
            targetUserId: userId,
            targetUserName: userName,
            targetUserEmail: userEmail,
            adminId: currentUser.uid,
            adminName: currentUser.name,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            permissions_restored: [
                'ÿßŸÑŸÜÿ¥ÿ±',
                'ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫', 
                'ÿßŸÑÿ™ÿπŸÑŸäŸÇ',
                'ÿ¨ŸÖÿπ ÿßŸÑŸÜŸÇÿßÿ∑',
                'ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©',
                'ÿ¥ÿ±ÿßÿ° ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™',
                'ÿ¥ÿ±ÿßÿ° ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ',
                'ÿßŸÑÿ™ÿµŸÜŸäŸÅ'
            ],
            notes: 'ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ± ÿßŸÑŸÉÿßŸÖŸÑ Ÿàÿ•ÿ±ÿ¨ÿßÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™'
        });

        // 5. üì¢ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿßŸÑŸÉ
        await sendTelegramNotification(
            `üîì <b>ŸÅŸÉ ÿ≠ÿ∏ÿ± ŸÉÿßŸÖŸÑ</b>\n\n` +
            `üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${escapeHTML(userName)}\n` +
            `üìß ÿßŸÑÿ®ÿ±ŸäÿØ: ${escapeHTML(userEmail)}\n` +
            `üÜî ÿßŸÑŸÖÿπÿ±ŸÅ: ${escapeHTML(userData.shortUid || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ')}\n` +
            `üë®‚Äçüíº ÿ™ŸÖ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: ${escapeHTML(currentUser.name)}\n` +
            `‚úÖ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™: ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÖŸèÿ±ÿ¨ÿπÿ©\n` +
            `‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleString('ar-IQ')}`
        );

        showNotification(`‚úÖ ÿ™ŸÖ ŸÅŸÉ ÿ≠ÿ∏ÿ± ${userName} Ÿàÿ•ÿ±ÿ¨ÿßÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™`, 'success');
        
        // 6. üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        await searchUsers();
        
    } catch (error) {
        console.error('Error unbanning user:', error);
        showNotification('‚ùå ŸÅÿ¥ŸÑ ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ±', 'error');
    }
}

// üö´ ÿØÿßŸÑÿ© ÿßŸÑÿ≠ÿ∏ÿ± ÿßŸÑŸÉÿßŸÖŸÑ ŸÖŸÜ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
async function banUser(userId, userName) {
    if (!isOwner()) return;
    
    const reason = prompt(`ÿ≥ÿ®ÿ® ÿ≠ÿ∏ÿ± ${userName} (ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™):`);
    if (!reason) return;
    
    try {
        const userRef = db.collection('users').doc(userId);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) return;

        const userData = userDoc.data();
        const userEmail = userData.email;
        
        // 1. üö´ ÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
        await userRef.update({
            // ÿßŸÑÿ≠ÿ∏ÿ± ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä
            isPermanentlyBanned: true,
            blockedFromPosting: true,
            
            // ÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
            canReport: false,
            canComment: false, 
            canEarnPoints: false,
            canClaimDaily: false,
            canBuyGifts: false,
            canBuyBoost: false,
            canCompete: false,
            
            // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ∏ÿ±
            banReason: reason,
            bannedAt: firebase.firestore.FieldValue.serverTimestamp(),
            bannedBy: currentUser.uid,
            bannedByName: currentUser.name,
            fullAccessRevoked: true
        });

        // 2. üîí ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸäÿ≤ÿßÿ™ ŸÅŸä collection study
        await db.collection('study').doc(userId).set({
            canEarnPoints: false,
            canUseTimer: false,
            canClaimRewards: false,
            canCompeteInLeaderboard: false,
            accessRevokedAt: firebase.firestore.FieldValue.serverTimestamp(),
            accessRevokedReason: reason
        }, { merge: true });

        // 3. üóÇ ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±
        await db.collection('banned_emails').doc(userEmail.toLowerCase()).set({
            email: userEmail.toLowerCase(),
            originalUserId: userId,
            banReason: reason,
            bannedAt: firebase.firestore.FieldValue.serverTimestamp(),
            bannedBy: currentUser.uid,
            preventRegistration: true,
            fullBan: true
        });

        // 4. üìù ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ≠ÿ∏ÿ±
        await db.collection('admin_actions').add({
            type: 'full_ban_user',
            targetUserId: userId,
            targetUserName: userName,
            targetUserEmail: userEmail,
            adminId: currentUser.uid,
            adminName: currentUser.name,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            permissions_revoked: [
                'ÿßŸÑŸÜÿ¥ÿ±',
                'ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫',
                'ÿßŸÑÿ™ÿπŸÑŸäŸÇ', 
                'ÿ¨ŸÖÿπ ÿßŸÑŸÜŸÇÿßÿ∑',
                'ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©',
                'ÿ¥ÿ±ÿßÿ° ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™',
                'ÿ¥ÿ±ÿßÿ° ÿßŸÑÿ™ÿ≥ÿ±Ÿäÿπ',
                'ÿßŸÑÿ™ÿµŸÜŸäŸÅ'
            ],
            ban_reason: reason,
            notes: 'ÿ≠ÿ∏ÿ± ŸÉÿßŸÖŸÑ ŸÖÿπ ÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™'
        });

        // 5. üì¢ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿßŸÑŸÉ
        await sendTelegramNotification(
            `üö´ <b>ÿ≠ÿ∏ÿ± ŸÉÿßŸÖŸÑ</b>\n\n` +
            `üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${escapeHTML(userName)}\n` +
            `üìß ÿßŸÑÿ®ÿ±ŸäÿØ: ${escapeHTML(userEmail)}\n` +
            `üÜî ÿßŸÑŸÖÿπÿ±ŸÅ: ${escapeHTML(userData.shortUid || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ')}\n` +
            `üìù ÿßŸÑÿ≥ÿ®ÿ®: ${escapeHTML(reason)}\n` +
            `üë®‚Äçüíº ÿ™ŸÖ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: ${escapeHTML(currentUser.name)}\n` +
            `‚ùå ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™: ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÖÿ∫ŸÑŸÇÿ©\n` +
            `‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleString('ar-IQ')}`
        );

        showNotification(`üö´ ÿ™ŸÖ ÿ≠ÿ∏ÿ± ${userName} Ÿàÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™`, 'success');
        await searchUsers();
        
    } catch (error) {
        console.error('Error banning user:', error);
        showNotification('‚ùå ŸÅÿ¥ŸÑ ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'error');
    }
}

// üîç ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÅŸä ÿ¨ŸÖŸäÿπ ÿ£ŸÜÿ≠ÿßÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
function canUserPost() {
    if (!currentUser) return false;
    return !currentUser.blockedFromPosting && currentUser.canReport !== false;
}

function canUserReport() {
    if (!currentUser) return false;
    return currentUser.canReport !== false;
}

function canUserComment() {
    if (!currentUser) return false;
    return currentUser.canComment !== false;
}

function canUserEarnPoints() {
    if (!currentUser) return false;
    return currentUser.canEarnPoints !== false;
}

function canUserClaimDaily() {
    if (!currentUser) return false;
    return currentUser.canClaimDaily !== false;
}

function canUserBuyGifts() {
    if (!currentUser) return false;
    return currentUser.canBuyGifts !== false;
}

function canUserBuyBoost() {
    if (!currentUser) return false;
    return currentUser.canBuyBoost !== false;
}

function canUserCompete() {
    if (!currentUser) return false;
    return currentUser.canCompete !== false;
}

// üí∞ ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ
async function resetUserPoints(userId, userName) {
    if (!isOwner()) return;
    
    if (!confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ${userName}ÿü`)) return;
    
    try {
        await db.collection('study').doc(userId).set({
            currentPoints: 0,
            totalPoints: 0,
            walletPoints: 0,
            pointsResetAt: firebase.firestore.FieldValue.serverTimestamp(),
            pointsResetBy: currentUser.uid
        }, { merge: true });
        
        showNotification(`ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ${userName}`, 'success');
        await searchUsers(); // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
        
    } catch (error) {
        console.error('Error resetting points:', error);
        showNotification('ŸÅÿ¥ŸÑ ÿ™ÿµŸÅŸäÿ± ÿßŸÑŸÜŸÇÿßÿ∑', 'error');
    }
}

// üëë ÿ™Ÿàÿ´ŸäŸÇ ŸÖÿ≥ÿ™ÿÆÿØŸÖ
async function verifyUser(userId) {
    if (!isOwner()) return;
    
    try {
        await db.collection('users').doc(userId).update({
            isVerified: true,
            verifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
            verifiedBy: currentUser.uid
        });
        
        showNotification('ÿ™ŸÖ ÿ™Ÿàÿ´ŸäŸÇ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'success');
        await searchUsers();
        
    } catch (error) {
        console.error('Error verifying user:', error);
        showNotification('ŸÅÿ¥ŸÑ ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ', 'error');
    }
}

// ‚ùå ÿ•ŸÑÿ∫ÿßÿ° ÿ™Ÿàÿ´ŸäŸÇ ŸÖÿ≥ÿ™ÿÆÿØŸÖ
async function unverifyUser(userId) {
    if (!isOwner()) return;
    
    try {
        await db.collection('users').doc(userId).update({
            isVerified: false,
            unverifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
            unverifiedBy: currentUser.uid
        });
        
        showNotification('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ™Ÿàÿ´ŸäŸÇ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'success');
        await searchUsers();
        
    } catch (error) {
        console.error('Error unverifying user:', error);
        showNotification('ŸÅÿ¥ŸÑ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ', 'error');
    }
}

// ‚ÑπÔ∏è ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
async function viewUserDetails(userId) {
    const userDoc = await db.collection('users').doc(userId).get();
    const userData = userDoc.data();
    
    const details = `
ÿßŸÑÿßÿ≥ŸÖ: ${userData.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
ÿßŸÑÿ®ÿ±ŸäÿØ: ${userData.email || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
ÿßŸÑŸÖÿπÿ±ŸÅ: ${userData.shortUid || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
ÿßŸÑÿ≠ÿßŸÑÿ©: ${userData.isPermanentlyBanned ? 'ŸÖÿ≠ÿ∏Ÿàÿ±' : 'ŸÜÿ¥ÿ∑'}
ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ: ${userData.isVerified ? 'ŸÖŸàÿ´ŸëŸÇ' : 'ÿ∫Ÿäÿ± ŸÖŸàÿ´ŸëŸÇ'}
ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ: ${userData.createdAt?.toDate?.().toLocaleString('ar-IQ') || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'}
    `.trim();
    
    alert(details);
}

console.log('‚úÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ≥ŸàŸÇ ÿßŸÑÿ∑ŸÑÿßÿ® ŸÖÿ≠ŸÖŸÑ Ÿàÿ¨ÿßŸáÿ≤ ŸÑŸÑÿπŸÖŸÑ!');

/* =========================
   ŸÜÿ∏ÿßŸÖ ÿ≤ÿ± ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
========================= */

// ÿØÿßŸÑÿ© ÿπÿ±ÿ∂/ÿ•ÿÆŸÅÿßÿ° ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
function toggleMoreActions() {
  const grid = document.getElementById('moreActionsGrid');
  const btn = document.querySelector('.more-actions-btn');
  
  if (grid && btn) {
    grid.classList.toggle('show');
    btn.classList.toggle('active');
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ£ÿ´Ÿäÿ± ŸÑŸÑÿ≤ÿ± ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ±
    if (grid.classList.contains('show')) {
      btn.style.background = 'linear-gradient(135deg, #6a11cb, #4a6bff)';
    } else {
      btn.style.background = 'linear-gradient(135deg, #4a6bff, #6a11cb)';
    }
  }
}

// ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
document.addEventListener('click', function(e) {
  const moreActionsContainer = document.querySelector('.more-actions-container');
  const moreActionsBtn = document.querySelector('.more-actions-btn');
  
  if (moreActionsContainer && 
      !moreActionsContainer.contains(e.target) && 
      e.target !== moreActionsBtn) {
    const grid = document.getElementById('moreActionsGrid');
    const btn = document.querySelector('.more-actions-btn');
    
    if (grid && btn) {
      grid.classList.remove('show');
      btn.classList.remove('active');
      btn.style.background = 'linear-gradient(135deg, #4a6bff, #6a11cb)';
    }
  }
});

// ÿØÿßŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿ±ÿ∂ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑
function checkOwnerButtons() {
  if (currentUser && isOwner()) {
    const moreActionsContainer = document.querySelector('.more-actions-container.owner-only');
    if (moreActionsContainer) {
      moreActionsContainer.style.display = 'block';
    }
  }
}

// ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ≠ÿßŸÑÿ©
function updateMoreActionsUI() {
  checkOwnerButtons();
}

// ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸÅÿ≠ÿ© ÿ£Ÿà ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
setTimeout(updateMoreActionsUI, 1000);

function openMoreActionsPage() {
    if (!currentUser) {
        showNotification('Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã', 'warning');
        return;
    }
    
    if (!isOwner()) {
        showNotification('ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑', 'error');
        return;
    }
    
    console.log('‚úÖ ŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±');
    showPage('moreActions');
}

// ŸÖÿ≥ÿ™ŸÖÿπ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ŸÑŸÉŸÑ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ (ÿ®ÿØŸàŸÜ ŸÅŸÑÿ™ÿ±ÿ© ŸàŸÇÿ™)
function startBackupPostsListener() {
    console.log('üõ°Ô∏è ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä...');
    
    // ŸÖÿ≥ÿ™ŸÖÿπ ŸÑŸÉŸÑ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ®ÿØŸàŸÜ ÿ¥ÿ±ÿ∑ ÿßŸÑŸàŸÇÿ™
    db.collection('posts')
        .orderBy('createdAt', 'desc')
        .limit(10)
        .onSnapshot((snapshot) => {
            const lastSeenTime = getLastSeenPostsTime();
            let newCount = 0;
            
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'added') {
                    const post = change.doc.data();
                    const postTime = post.createdAt?.toDate?.();
                    
                    if (postTime && postTime > lastSeenTime && 
                        (post.status === 'active' || post.status === 'sold')) {
                        newCount++;
                        console.log('üî• ŸÖŸÜÿ¥Ÿàÿ± ÿ¨ÿØŸäÿØ ŸÖÿ®ÿßÿ¥ÿ±:', {
                            ŸÖÿßÿØÿ©: post.material,
                            ŸÖÿ≥ÿ™ÿÆÿØŸÖ: post.userName,
                            ÿßŸÑŸàŸÇÿ™: postTime.toLocaleTimeString('ar-IQ')
                        });
                    }
                }
            });
            
            if (newCount > 0) {
                unreadPostsCount = newCount;
                updateNavBadges();
                console.log('‚úÖ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÉÿ™ÿ¥ŸÅ', newCount, 'ŸÖŸÜÿ¥Ÿàÿ± ÿ¨ÿØŸäÿØ');
            }
        });
}

// ÿ¥ÿ∫ŸëŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä
setTimeout(startBackupPostsListener, 5000);

/* ===== ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸàÿ± ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ¨ÿØŸäÿØ ===== */

// ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©
function openImageUploadModal() {
    document.getElementById('image-upload-modal').style.display = 'block';
    document.getElementById('avatar-upload-input').value = '';
    document.getElementById('avatar-preview').style.display = 'none';
    document.getElementById('upload-avatar-btn').disabled = true;
}

// ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©
function closeImageUploadModal() {
    document.getElementById('image-upload-modal').style.display = 'none';
}

// ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿµŸàÿ±ÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ±ŸÅÿπ
document.getElementById('avatar-upload-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('avatar-preview');
    const previewImg = document.getElementById('avatar-preview-img');
    const uploadBtn = document.getElementById('upload-avatar-btn');
    
    if (file) {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÜŸàÿπ Ÿàÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        const maxSize = 2 * 1024 * 1024; // 2MB
        
        if (!validTypes.includes(file.type)) {
            showNotification('ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ. Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸàÿ±ÿ© (JPG, PNG, GIF)', 'error');
            return;
        }
        
        if (file.size > maxSize) {
            showNotification('ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã. ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 2MB', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
            uploadBtn.disabled = false;
        }
        reader.readAsDataURL(file);
    }
});

// ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ© ŸÖÿπ ÿ∂ÿ∫ÿ∑
async function uploadAvatar() {
    const fileInput = document.getElementById('avatar-upload-input');
    const file = fileInput.files[0];
    
    if (!file || !currentUser) return;
    
    const uploadBtn = document.getElementById('upload-avatar-btn');
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ∂ÿ∫ÿ∑ ŸàÿßŸÑÿ≠ŸÅÿ∏...';
    
    try {
        // ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©
        const compressedImage = await compressImage(file);
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä Firestore
        await db.collection('users').doc(currentUser.uid).update({
            avatarBase64: compressedImage,
            avatarUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        currentUser.avatarBase64 = compressedImage;
        updateAvatarDisplay();
        
        showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠! üéâ', 'success');
        closeImageUploadModal();
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ±ŸÅÿπ:', error);
        showNotification('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ©: ' + error.message, 'error');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©';
    }
}

// ÿØÿßŸÑÿ© ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©
function compressImage(file, maxWidth = 200, quality = 0.7) {
    return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ®ÿπÿßÿØ ÿßŸÑÿ¨ÿØŸäÿØÿ©
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // ÿ±ÿ≥ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑ÿ©
            ctx.drawImage(img, 0, 0, width, height);
            
            // ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ base64 ŸÖÿπ ÿ¨ŸàÿØÿ© ŸÖÿ≠ÿØÿØÿ©
            const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
            resolve(compressedBase64);
        };
        
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
    });
}

// ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπ ÿ≠ÿØÿ´ ŸäÿØŸàŸä ŸÑŸÑÿ≤ÿ±
document.addEventListener('DOMContentLoaded', function() {
    const uploadBtn = document.getElementById('upload-avatar-btn');
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
            const fileInput = document.getElementById('avatar-upload-input');
            if (fileInput.files.length > 0) {
                uploadAvatar();
            } else {
                showNotification('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸàÿ±ÿ© ÿ£ŸàŸÑÿßŸã', 'error');
            }
        });
    }
});

// ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ©
function updateAvatarDisplay() {
    const avatarElement = document.getElementById('avatar');
    if (!avatarElement) return;
    
    if (currentUser.avatarBase64) {
        avatarElement.innerHTML = `<img src="${currentUser.avatarBase64}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
    } else {
        const emoji = currentUser.avatar === 'female' ? 'üë©üèª‚Äçüíº' : 'üë®üèª‚Äçüíº';
        avatarElement.innerHTML = `<div style="width:100%;height:100%;font-size:40px;line-height:72px">${emoji}</div>`;
    }
}

// ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸàÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÅŸä ÿßŸÑÿ™ÿµŸÜŸäŸÅ
async function getUserAvatarUrl(uid) {
    try {
        const userDoc = await db.collection('users').doc(uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            return userData.avatarBase64 || userData.avatarUrl || null;
        }
    } catch (error) {
        console.error('Error getting user avatar:', error);
    }
    return null;
}

/* ===== ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑŸÖÿπÿØŸÑÿ© ===== */
async function renderLeaderboardNew(items) {
    const lb = document.getElementById('challenge-leaderboard'); 
    if (!lb) return;
    
    if (!items || !items.length) { 
        lb.innerHTML = '<div class="post"><p>ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ™ŸÜÿßŸÅÿ≥ŸàŸÜ ÿ®ÿπÿØ</p></div>'; 
        return; 
    }
    
    // ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ
    const usersWithVerification = await Promise.all(
        items.map(async (user, idx) => {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                const isVerified = userData?.isVerified || false;
                const avatarUrl = userData?.avatarBase64 || null;
                const userAvatarType = userData?.avatar || 'male';
                
                return {
                    ...user,
                    avatarUrl,
                    isVerified,
                    avatar: userAvatarType,
                    rank: idx + 1
                };
            } catch (error) {
                console.error('Error fetching user data:', error);
                return {
                    ...user,
                    avatarUrl: null,
                    isVerified: false,
                    avatar: 'male',
                    rank: idx + 1
                };
            }
        })
    );
    
    lb.innerHTML = usersWithVerification.map(user => {
        const points = user.totalPoints || 0;
        const rankClass = user.rank === 1 ? 'rank-1-new' : 
                         user.rank === 2 ? 'rank-2-new' : 
                         user.rank === 3 ? 'rank-3-new' : 
                         user.rank === 4 ? 'rank-4-new' : 
                         user.rank === 5 ? 'rank-5-new' : 'rank-normal-new';
        
        // ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ ÿ™ÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ŸÑŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖŸàÿ´ŸÇÿ©
        const verifiedBadge = user.isVerified ? 
            `<span class="verified-badge-new"><i class="fa-solid fa-check"></i> ŸÖŸàÿ´ŸëŸÇ</span>` : '';
        
        const deleteBtn = isOwner() ? `
            <button class="btn btn-xs btn-danger" onclick="ownerRemoveFromLeaderboard('${user.uid}','${escapeHTML(user.name||'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}')">
                <i class="fa-solid fa-trash"></i>
            </button>` : '';
        
        // ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿ£Ÿà ÿßŸÑÿ•ŸäŸÖŸàÿ¨Ÿä ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
        const avatarDisplay = user.avatarUrl ? 
            `<img src="${user.avatarUrl}" class="rank-avatar" alt="${escapeHTML(user.name||'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}">` :
            `<div class="rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:20px;background:${user.avatar === 'female' ? '#ffd7ea' : '#d7e4ff'};">
                ${user.avatar === 'female' ? 'üë©üèª‚Äçüíº' : 'üë®üèª‚Äçüíº'}
             </div>`;
        
        return `
            <div class="rank-card-new ${rankClass}">
                <!-- ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿØÿßÿ¶ÿ±ÿ© ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© .rank-number-new -->
                
                <div class="rank-avatar-container">
                    ${avatarDisplay}
                    <div class="rank-number-overlay">${user.rank}</div> <!-- ÿßŸÑÿØÿßÿ¶ÿ±ÿ© ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© ÿ™ÿπŸÖŸÑ -->
                </div>
                
                <div class="rank-user-info">
                    <div class="rank-user-name">
                        ${escapeHTML(user.name||'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}
                        ${verifiedBadge}
                    </div>
                    <div class="rank-user-points">${points.toLocaleString('ar-IQ')} ŸÜŸÇÿ∑ÿ©</div>
                </div>
                
                ${deleteBtn}
            </div>`;
    }).join('');
}

// ÿ™ÿ£ŸÉÿØ ÿ•ŸÜ Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ŸÖŸàÿ¨ŸàÿØ
function renderLeaderboard(items) {
    renderLeaderboardNew(items);
}

/* =========================
   üé° ŸÜÿ∏ÿßŸÖ ÿπÿ¨ŸÑÿ© ÿßŸÑÿ≠ÿ∏ ÿßŸÑÿ¨ÿØŸäÿØ - ÿßŸÑÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ¨ÿØŸäÿØ
========================= */

let wheelPrizes = [10, 25, 50, 75, 100, 150, 200, 250];
let wheelProbabilities = [35, 25, 15, 10, 8, 4, 2, 1];
let wheelSpinning = false;
let wheelCanvas, wheelCtx;

// ŸÅÿ™ÿ≠ ÿπÿ¨ŸÑÿ© ÿßŸÑÿ≠ÿ∏
function openWheelModal() {
    if (!currentUser) return showNotification('Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã', 'error');
    
    checkTimeManipulationStrict().then(isManipulated => {
        if (isManipulated) {
            showNotification('üö´ ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ™ŸÑÿßÿπÿ® ŸÅŸä ÿßŸÑŸàŸÇÿ™ - ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿ≠ÿ∏Ÿàÿ±', 'error');
            return;
        }
        
        document.getElementById('wheel-modal').style.display = 'block';
        initWheel();
        updateWheelUI();
    });
}

// ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿπÿ¨ŸÑÿ©
function closeWheelModal() {
    document.getElementById('wheel-modal').style.display = 'none';
    wheelSpinning = false;
}

// ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿπÿ¨ŸÑÿ©
function initWheel() {
    wheelCanvas = document.getElementById('wheel-canvas');
    wheelCtx = wheelCanvas.getContext('2d');
    drawWheel();
}

// ÿ±ÿ≥ŸÖ ÿßŸÑÿπÿ¨ŸÑÿ© (ÿ®ÿØŸàŸÜ ŸÜÿ≥ÿ®)
function drawWheel() {
    const centerX = wheelCanvas.width / 2;
    const centerY = wheelCanvas.height / 2;
    const radius = wheelCanvas.width / 2 - 10;
    
    wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
    
    const segmentAngle = (2 * Math.PI) / wheelPrizes.length;
    
    // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ŸÜÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≥ŸÖ ŸÖŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ≥ŸáŸÖ ŸÖÿ®ÿßÿ¥ÿ±ÿ©
    // ÿπŸÑÿ¥ÿßŸÜ ÿ£ŸàŸÑ ÿ¨ÿßÿ¶ÿ≤ÿ© ÿ™ŸÉŸàŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ≥ŸáŸÖ ÿπŸÜÿØŸÖÿß ÿ™ŸÉŸàŸÜ ÿßŸÑÿπÿ¨ŸÑÿ© ŸÅŸä ÿßŸÑÿ®ÿØÿßŸäÿ©
    const startOffset = -Math.PI / 2 - (segmentAngle / 2);
    
    for (let i = 0; i < wheelPrizes.length; i++) {
        const startAngle = startOffset + (i * segmentAngle);
        const endAngle = startOffset + ((i + 1) * segmentAngle);
        const prize = wheelPrizes[i];
        
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
        wheelCtx.fillStyle = colors[i % colors.length];
        wheelCtx.strokeStyle = '#fff';
        wheelCtx.lineWidth = 3;
        
        wheelCtx.beginPath();
        wheelCtx.moveTo(centerX, centerY);
        wheelCtx.arc(centerX, centerY, radius, startAngle, endAngle);
        wheelCtx.closePath();
        wheelCtx.fill();
        wheelCtx.stroke();
        
        // ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÜÿµ ŸÅŸä ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÇÿ∑ÿßÿπ
        wheelCtx.save();
        wheelCtx.translate(centerX, centerY);
        const textAngle = startAngle + (segmentAngle / 2);
        wheelCtx.rotate(textAngle);
        wheelCtx.textAlign = 'right';
        wheelCtx.fillStyle = '#fff';
        wheelCtx.font = 'bold 16px Tajawal';
        wheelCtx.fillText(prize + ' ŸÜŸÇÿ∑ÿ©', radius - 20, 5);
        wheelCtx.restore();
    }
    
    // ÿ±ÿ≥ŸÖ ÿßŸÑŸÖÿ±ŸÉÿ≤
    wheelCtx.fillStyle = '#fff';
    wheelCtx.beginPath();
    wheelCtx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
    wheelCtx.fill();
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ£ÿ´Ÿäÿ± ÿ∏ŸÑ ŸÑŸÑÿπÿ¨ŸÑÿ©
    wheelCtx.shadowColor = 'rgba(0, 0, 0, 0.3)';
    wheelCtx.shadowBlur = 10;
    wheelCtx.shadowOffsetX = 2;
    wheelCtx.shadowOffsetY = 2;
}

// ÿ™ÿØŸàŸäÿ± ÿßŸÑÿπÿ¨ŸÑÿ©
async function spinWheel() {
    if (wheelSpinning) return;
    
    const spinBtn = document.getElementById('spin-button');
    const resultDiv = document.getElementById('wheel-result');
    
    const userRef = db.collection('study').doc(currentUser.uid);
    const userDoc = await userRef.get();
    
    if (userDoc.exists) {
        const userData = userDoc.data();
        const lastSpin = userData.lastWheelSpin ? userData.lastWheelSpin.toDate().getTime() : 0;
        const now = new Date().getTime();
        const timeSinceLastSpin = now - lastSpin;
        
        if (timeSinceLastSpin < (6 * 60 * 60 * 1000)) {
            const remaining = (6 * 60 * 60 * 1000) - timeSinceLastSpin;
            showNotification(`‚è∞ ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ≥ÿ≠ÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ÿπÿØ: ${msToHMS(remaining)}`, 'error');
            return;
        }
    }
    
    wheelSpinning = true;
    spinBtn.disabled = true;
    spinBtn.innerHTML = 'üîÑ';
    resultDiv.style.display = 'none';
    
    // ÿ£ŸàŸÑÿßŸã: ŸÜÿ≠ÿØÿØ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ© ÿπÿ¥Ÿàÿßÿ¶ŸäÿßŸã
    const winningIndex = getRandomPrizeIndex();
    const prize = wheelPrizes[winningIndex];
    
    console.log(`üéØ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©: ${prize} ŸÜŸÇÿ∑ÿ© (ÿßŸÑŸÖÿ§ÿ¥ÿ±: ${winningIndex})`);
    
    // ÿ´ÿßŸÜŸäÿßŸã: ŸÜÿ≠ÿ≥ÿ® ÿßŸÑÿ≤ÿßŸàŸäÿ© ÿ®ÿØŸÇÿ© - ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿµÿ≠Ÿäÿ≠
    const segmentAngle = (2 * Math.PI) / wheelPrizes.length;
    
    // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿµÿ≠Ÿäÿ≠: ŸÜŸàŸÇŸÅ ŸÅŸä ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ© ÿ™ŸÖÿßŸÖÿßŸã
    // ÿßŸÑÿ≥ŸáŸÖ ŸÅŸä ÿßŸÑÿ£ÿπŸÑŸâ (ÿ≤ÿßŸàŸäÿ© -90 ÿØÿ±ÿ¨ÿ© ÿ£Ÿà -œÄ/2 ÿ±ÿßÿØŸäÿßŸÜ)
    // ŸÜÿ±ŸäÿØ ÿ£ŸÜ ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ© ŸäŸÉŸàŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ≥ŸáŸÖ ŸÖÿ®ÿßÿ¥ÿ±ÿ©
    const targetAngleForPrize = (winningIndex * segmentAngle) + (segmentAngle / 2);
    
    // ÿπÿØÿØ ÿßŸÑÿØŸàÿ±ÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ© + ÿßŸÑÿ≤ÿßŸàŸäÿ© ŸÑŸÑŸÇÿ∑ÿßÿπ ÿßŸÑŸÅÿßÿ¶ÿ≤
    const fullRotations = 5; // 5 ÿØŸàÿ±ÿßÿ™ ŸÉÿßŸÖŸÑÿ©
    const targetAngle = (fullRotations * 2 * Math.PI) + targetAngleForPrize;
    
    console.log(`üìê ÿßŸÑÿ≤ÿßŸàŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅÿ©: ${targetAngle} ÿ±ÿßÿØŸäÿßŸÜ`);
    console.log(`üé™ ÿ≥Ÿäÿ™ŸàŸÇŸÅ ŸÅŸä ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ©: ${prize} ŸÜŸÇÿ∑ÿ©`);
    
    let currentRotation = 0;
    const duration = 4000;
    const startTime = Date.now();
    
    function animateWheel() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // ÿ™ÿ£ÿ´Ÿäÿ± ÿ™ÿØÿ±Ÿäÿ¨Ÿä ŸàÿßŸÇÿπŸä: ÿ≥ÿ±Ÿäÿπ ŸÅŸä ÿßŸÑÿ®ÿØÿßŸäÿ©ÿå ÿ®ÿ∑Ÿäÿ° ŸÅŸä ÿßŸÑŸÜŸáÿßŸäÿ©
        const easeOut = 1 - Math.pow(1 - progress, 4);
        
        currentRotation = targetAngle * easeOut;
        
        wheelCanvas.style.transform = `rotate(${currentRotation}rad)`;
        wheelCanvas.style.transition = 'none';
        
        if (progress < 1) {
            requestAnimationFrame(animateWheel);
        } else {
            setTimeout(() => {
                console.log(`‚úÖ ÿßŸÑÿ™ŸàŸÇŸÅÿ™ ŸÅŸä ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ©: ${prize} ŸÜŸÇÿ∑ÿ©`);
                showWheelResult(prize);
                wheelSpinning = false;
                spinBtn.disabled = false;
                spinBtn.innerHTML = 'ÿßÿ®ÿØÿ°';
                
            }, 500);
        }
    }
    
    requestAnimationFrame(animateWheel);
}

// ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿ±ÿ≥ŸÖ ÿßŸÑÿπÿ¨ŸÑÿ© Ÿäÿ®ÿØÿ£ ŸÖŸÜ ÿßŸÑÿ£ÿπŸÑŸâ (ÿ≠Ÿäÿ´ ÿßŸÑÿ≥ŸáŸÖ)
function drawWheel() {
    const centerX = wheelCanvas.width / 2;
    const centerY = wheelCanvas.height / 2;
    const radius = wheelCanvas.width / 2 - 10;
    
    wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
    
    const segmentAngle = (2 * Math.PI) / wheelPrizes.length;
    
    // ŸÜÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≥ŸÖ ŸÖŸÜ ÿßŸÑÿ£ÿπŸÑŸâ (ÿ≤ÿßŸàŸäÿ© -œÄ/2)
    const startOffset = -Math.PI / 2;
    
    for (let i = 0; i < wheelPrizes.length; i++) {
        const startAngle = startOffset + (i * segmentAngle);
        const endAngle = startOffset + ((i + 1) * segmentAngle);
        const prize = wheelPrizes[i];
        
        const colors = ['#4a6bff', '#6a11cb', '#28a745', '#17a2b8', '#ffc107', '#fd7e14', '#e83e8c', '#dc3545'];
        wheelCtx.fillStyle = colors[i % colors.length];
        wheelCtx.strokeStyle = '#fff';
        wheelCtx.lineWidth = 2;
        
        wheelCtx.beginPath();
        wheelCtx.moveTo(centerX, centerY);
        wheelCtx.arc(centerX, centerY, radius, startAngle, endAngle);
        wheelCtx.closePath();
        wheelCtx.fill();
        wheelCtx.stroke();
        
        // ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÜÿµ ŸÅŸä ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÇÿ∑ÿßÿπ
        wheelCtx.save();
        wheelCtx.translate(centerX, centerY);
        const textAngle = startAngle + (segmentAngle / 2);
        wheelCtx.rotate(textAngle);
        wheelCtx.textAlign = 'right';
        wheelCtx.fillStyle = '#fff';
        wheelCtx.font = 'bold 14px Tajawal';
        wheelCtx.fillText(prize + ' ŸÜŸÇÿ∑ÿ©', radius - 15, 5);
        wheelCtx.restore();
    }
    
    wheelCtx.fillStyle = '#fff';
    wheelCtx.beginPath();
    wheelCtx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
    wheelCtx.fill();
}

// ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿßÿ≠ÿ™ŸÖÿßŸÑÿßÿ™
function getRandomPrizeIndex() {
    const total = wheelProbabilities.reduce((sum, prob) => sum + prob, 0);
    let random = Math.random() * total;
    
    console.log('üé≤ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ≥ÿ≠ÿ® ÿßŸÑÿπÿ¥Ÿàÿßÿ¶Ÿä:');
    
    for (let i = 0; i < wheelProbabilities.length; i++) {
        random -= wheelProbabilities[i];
        if (random <= 0) {
            console.log(`‚úÖ ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ©: ${wheelPrizes[i]} ŸÜŸÇÿ∑ÿ© (ÿßŸÑÿßÿ≠ÿ™ŸÖÿßŸÑ: ${wheelProbabilities[i]}%)`);
            return i;
        }
    }
    
    console.log(`‚úÖ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©: ${wheelPrizes[wheelPrizes.length - 1]} ŸÜŸÇÿ∑ÿ©`);
    return wheelProbabilities.length - 1;
}

// ÿπÿ±ÿ∂ ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ≥ÿ≠ÿ®
async function showWheelResult(prize) {
    const resultDiv = document.getElementById('wheel-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div style="color:#28a745; background:#e9f7ef; padding:20px; border-radius:15px; border:3px solid #28a745; text-align:center">
            <div style="font-size:28px; margin-bottom:15px; font-weight:900">üéâ ŸÖÿ®ÿ±ŸàŸÉ!</div>
            <div style="font-size:24px; font-weight:800">ŸÅÿ≤ÿ™ ÿ®ŸÄ <span style="color:#dc3545">${prize} ŸÜŸÇÿ∑ÿ©</span>! üéÅ</div>
            <div style="margin-top:10px; font-size:14px; color:#666">ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÜŸÇÿßÿ∑ ÿ•ŸÑŸâ ÿ±ÿµŸäÿØŸÉ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</div>
        </div>
    `;
    
    try {
        // ŸÖŸÜÿ≠ ÿßŸÑŸÜŸÇÿßÿ∑
        await db.collection('study').doc(currentUser.uid).set({
            currentPoints: firebase.firestore.FieldValue.increment(prize),
            totalPoints: firebase.firestore.FieldValue.increment(prize),
            walletPoints: firebase.firestore.FieldValue.increment(prize),
            lastWheelSpin: firebase.firestore.FieldValue.serverTimestamp(),
            lastWheelPrize: prize,
            name: currentUser.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'
        }, { merge: true });
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©
        await logPointsTransaction(currentUser.uid, prize, 'wheel_spin', `ÿ≥ÿ≠ÿ® ÿπÿ¨ŸÑÿ© ÿßŸÑÿ≠ÿ∏ - ${prize} ŸÜŸÇÿ∑ÿ©`);
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
        studyState.currentPoints += prize;
        studyState.totalPoints += prize;
        studyState.walletPoints = (studyState.walletPoints || 0) + prize;
        
        renderTimerUI();
        updateWheelUI();
        
        // ÿ•ÿ¥ÿπÿßÿ± ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ ŸÑŸÑŸÖÿßŸÑŸÉ
        if (isOwner()) {
            await sendTelegramNotification(
                `üé° <b>ÿ≥ÿ≠ÿ® ÿπÿ¨ŸÑÿ© ÿ≠ÿ∏</b>\n\nüë§ ${currentUser.name}\nüÜî ${currentUser.shortUid}\nüéÅ ${prize} ŸÜŸÇÿ∑ÿ©`
            );
        }
        
    } catch (error) {
        console.error('Error awarding wheel prize:', error);
        showNotification('ŸÅÿ¥ŸÑ ŸÖŸÜÿ≠ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ©', 'error');
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿπÿ¨ŸÑÿ©
async function updateWheelUI() {
    const spinBtn = document.getElementById('wheel-spin-btn');
    const remainingDiv = document.getElementById('wheel-remaining');
    
    if (!spinBtn || !remainingDiv || !currentUser) return;
    
    try {
        const userRef = db.collection('study').doc(currentUser.uid);
        const userDoc = await userRef.get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            const lastSpin = userData.lastWheelSpin ? userData.lastWheelSpin.toDate().getTime() : 0;
            const now = new Date().getTime();
            const timeSinceLastSpin = now - lastSpin;
            const remaining = (6 * 60 * 60 * 1000) - timeSinceLastSpin;
            
            if (remaining > 0) {
                spinBtn.disabled = true;
                spinBtn.innerHTML = '<i class="fas fa-clock"></i> ÿßŸÜÿ™ÿ∏ÿ±';
                spinBtn.style.background = '#6c757d';
                remainingDiv.textContent = `ÿßŸÑÿ≥ÿ≠ÿ® ŸÖÿ™ÿßÿ≠ ÿ®ÿπÿØ: ${msToHMS(remaining)}`;
            } else {
                spinBtn.disabled = false;
                spinBtn.innerHTML = '<i class="fas fa-play"></i> ÿßÿ®ÿØÿ°';
                spinBtn.style.background = '#dc3545';
                remainingDiv.textContent = 'üéÅ ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ≥ÿ≠ÿ®! ÿßÿ∂ÿ∫ÿ∑ "ÿßÿ®ÿØÿ°"';
            }
        }
    } catch (error) {
        console.error('Error updating wheel UI:', error);
    }
}

/* =========================
   üîí ŸÜÿ∏ÿßŸÖ ŸÉÿ¥ŸÅ ÿßŸÑÿ™ŸÑÿßÿπÿ® ÿßŸÑÿµÿßÿ±ŸÖ
========================= */

async function checkTimeManipulationStrict() {
    if (!currentUser) return false;
    
    try {
        const userRef = db.collection('study').doc(currentUser.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) return false;
        
        const userData = userDoc.data();
        const now = new Date();
        const clientTime = now.getTime();
        
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸàŸÇÿ™ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
        const serverTimeDoc = await db.collection('server_time').doc('current').get();
        let serverTime = now;
        
        if (serverTimeDoc.exists) {
            serverTime = serverTimeDoc.data().timestamp.toDate();
        }
        
        // üî• ÿßŸÑŸÅÿ±ŸÇ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠: ŸäŸàŸÖŸäŸÜ ŸÅŸÇÿ∑ (ÿ®ÿØŸÑ 6 ÿ≥ÿßÿπÿßÿ™)
        const MAX_TIME_DIFF = 2 * 24 * 60 * 60 * 1000; // ŸäŸàŸÖŸäŸÜ
        
        const timeDiff = Math.abs(serverTime.getTime() - clientTime);
        
        if (timeDiff > MAX_TIME_DIFF) {
            console.warn(`üö® ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ™ŸÑÿßÿπÿ® ÿµÿßÿ±ŸÖ: ${Math.floor(timeDiff/(24*60*60*1000))} ÿ£ŸäÿßŸÖ ŸÅÿ±ŸÇ`);
            
            // üî• ÿ≠ÿ∏ÿ± ŸÅŸàÿ±Ÿä ŸàŸÉÿßŸÖŸÑ
            await permanentBanAndPrevent(currentUser.uid, `ÿ™ŸÑÿßÿπÿ® ŸÅŸä ÿßŸÑŸàŸÇÿ™ - ŸÅÿ±ŸÇ ${Math.floor(timeDiff/(24*60*60*1000))} ÿ£ŸäÿßŸÖ`);
            
            // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≠ÿßÿØÿ´
            await db.collection('suspicious_activities').add({
                userId: currentUser.uid,
                userName: currentUser.name,
                userEmail: currentUser.email,
                type: 'strict_time_manipulation_wheel',
                clientTime: new Date(),
                serverTime: firebase.firestore.FieldValue.serverTimestamp(),
                timeDifference: timeDiff,
                severity: 'CRITICAL',
                action_taken: 'PERMANENT_BAN'
            });
            
            return true;
        }
        
        return false;
        
    } catch (error) {
        console.error('Error in strict time manipulation detection:', error);
        return false;
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ±Ÿä ŸÑŸÑÿπÿ¨ŸÑÿ©
setInterval(updateWheelUI, 30000);

/* =========================
   üéØ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿßŸÑÿ¨ÿØŸäÿØ
========================= */

// ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
function showReferralSystem() {
    if (!currentUser) {
        showNotification('Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã', 'warning');
        return;
    }
    showPage('referral');
    loadReferralData();
    startReferralListener();
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
async function loadReferralData() {
    if (!currentUser) return;
    
    try {
        // ÿπÿ±ÿ∂ ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© (ŸÜŸÅÿ≥ ÿßŸÑŸÄ UID)
        const referralCode = currentUser.shortUid || generateShortUid(currentUser.uid);
        document.getElementById('referral-code-input').value = referralCode;
        document.getElementById('referral-share-code').textContent = referralCode;
        
        // ÿ¨ŸÑÿ® ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
        const referralStats = await getReferralStats(currentUser.uid);
        
        document.getElementById('referral-count').textContent = referralStats.referralCount;
        document.getElementById('referral-points').textContent = referralStats.earnedPoints;
        
    } catch (error) {
        console.error('Error loading referral data:', error);
    }
}

// ŸÜÿ≥ÿÆ ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
function copyReferralCode() {
    const codeInput = document.getElementById('referral-code-input');
    codeInput.select();
    document.execCommand('copy');
    showNotification('ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠! üéâ', 'success');
}

// ÿ¨ŸÑÿ® ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
async function getReferralStats(userId) {
    try {
        const referralsSnapshot = await db.collection('referrals')
            .where('referrerId', '==', userId)
            .get();
        
        const referralCount = referralsSnapshot.size;
        let earnedPoints = 0;
        
        referralsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.rewardClaimed) {
                earnedPoints += 150; // 150 ŸÜŸÇÿ∑ÿ© ŸÑŸÉŸÑ ÿ•ÿ≠ÿßŸÑÿ© ŸÜÿßÿ¨ÿ≠ÿ©
            }
        });
        
        return { referralCount, earnedPoints };
        
    } catch (error) {
        console.error('Error getting referral stats:', error);
        return { referralCount: 0, earnedPoints: 0 };
    }
}

// ŸÖÿ≥ÿ™ŸÖÿπ ŸÑŸÑÿ•ÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
function startReferralListener() {
    if (!currentUser || referralListener) return;
    
    referralListener = db.collection('referrals')
        .where('referrerId', '==', currentUser.uid)
        .onSnapshot((snapshot) => {
            loadReferralData(); // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÜÿØ Ÿàÿ¨ŸàÿØ ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
        }, (error) => {
            console.error('Referral listener error:', error);
        });
}

// ÿ•ŸäŸÇÿßŸÅ ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™
function stopReferralListener() {
    if (referralListener) {
        referralListener();
        referralListener = null;
    }
}

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿπŸÜÿØ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
async function validateReferralCode(referralCode) {
    try {
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿµÿßÿ≠ÿ® ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
        const userQuery = await db.collection('users')
            .where('shortUid', '==', referralCode.toUpperCase())
            .limit(1)
            .get();
        
        if (userQuery.empty) {
            return { valid: false, error: 'ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠' };
        }
        
        const referrerDoc = userQuery.docs[0];
        const referrerData = referrerDoc.data();
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑÿß Ÿäÿ≠ŸäŸÑ ŸÜŸÅÿ≥Ÿá
        if (referrerDoc.id === currentUser.uid) {
            return { valid: false, error: 'ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ' };
        }
        
        return { 
            valid: true, 
            referrerId: referrerDoc.id,
            referrerName: referrerData.name,
            referrerShortUid: referrerData.shortUid
        };
        
    } catch (error) {
        console.error('Error validating referral code:', error);
        return { valid: false, error: 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©' };
    }
}

// ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿßÿ¨ÿ≠ÿ©
async function processSuccessfulReferral(referredUserId, referredUserName, referralCode) {
    try {
        const validation = await validateReferralCode(referralCode);
        
        if (!validation.valid) {
            return { success: false, error: validation.error };
        }
        
        const { referrerId, referrerName, referrerShortUid } = validation;
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
        await db.collection('referrals').add({
            referrerId: referrerId,
            referrerName: referrerName,
            referrerShortUid: referrerShortUid,
            referredUserId: referredUserId,
            referredUserName: referredUserName,
            referralCode: referralCode.toUpperCase(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            rewardClaimed: true
        });
        
        // ŸÖŸÜÿ≠ ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™
        await grantReferralRewards(referrerId, referredUserId);
        
        return { success: true };
        
    } catch (error) {
        console.error('Error processing referral:', error);
        return { success: false, error: 'ŸÅÿ¥ŸÑ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©' };
    }
}

// ŸÖŸÜÿ≠ ŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
async function grantReferralRewards(referrerId, referredUserId) {
    try {
        // ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ŸÑŸÑŸÖŸèÿ≠ŸäŸÑ (150 ŸÜŸÇÿ∑ÿ©)
        await db.collection('study').doc(referrerId).set({
            currentPoints: firebase.firestore.FieldValue.increment(150),
            totalPoints: firebase.firestore.FieldValue.increment(150),
            walletPoints: firebase.firestore.FieldValue.increment(150),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÑŸÑŸÖŸèÿ≠ŸäŸÑ
        await logPointsTransaction(referrerId, 150, 'referral_reward', 
            `ŸÖŸÉÿßŸÅÿ£ÿ© ÿ•ÿ≠ÿßŸÑÿ© - 150 ŸÜŸÇÿ∑ÿ©`);
        
        // ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ŸÑŸÑŸÖŸèÿ≠ÿßŸÑ (75 ŸÜŸÇÿ∑ÿ©)
        await db.collection('study').doc(referredUserId).set({
            currentPoints: firebase.firestore.FieldValue.increment(75),
            totalPoints: firebase.firestore.FieldValue.increment(75),
            walletPoints: firebase.firestore.FieldValue.increment(75),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÑŸÑŸÖŸèÿ≠ÿßŸÑ
        await logPointsTransaction(referredUserId, 75, 'referral_bonus', 
            `ŸÖŸÉÿßŸÅÿ£ÿ© ÿØÿÆŸàŸÑ ÿ®ÿ±ŸÖÿ≤ ÿ•ÿ≠ÿßŸÑÿ© - 75 ŸÜŸÇÿ∑ÿ©`);
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ
        await sendReferralNotifications(referrerId, referredUserId);
        
        console.log('‚úÖ ÿ™ŸÖ ŸÖŸÜÿ≠ ŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
        
    } catch (error) {
        console.error('Error granting referral rewards:', error);
        throw error;
    }
}

// ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ
async function sendReferralNotifications(referrerId, referredUserId) {
    try {
        const referredUserDoc = await db.collection('users').doc(referredUserId).get();
        const referredUserName = referredUserDoc.data().name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ';
        
        // ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖŸèÿ≠ŸäŸÑ
        await db.collection('inbox').add({
            userId: referrerId,
            type: 'referral_success',
            title: 'üéâ ŸÖÿ®ÿ±ŸàŸÉ! ÿ•ÿ≠ÿßŸÑÿ© ŸÜÿßÿ¨ÿ≠ÿ©',
            message: `ŸÑŸÇÿØ ÿ±ÿ®ÿ≠ÿ™ 150 ŸÜŸÇÿ∑ÿ©! ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${referredUserName} ŸÇÿßŸÖ ÿ®ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ.`,
            status: 'unread',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            points: 150
        });
        
        // ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖŸèÿ≠ÿßŸÑ
        await db.collection('inbox').add({
            userId: referredUserId,
            type: 'referral_welcome',
            title: 'üéÅ ŸÖÿ®ÿ±ŸàŸÉ! ŸÖŸÉÿßŸÅÿ£ÿ© ÿ™ÿ±ÿ≠Ÿäÿ®',
            message: `ŸÑŸÇÿØ ÿ±ÿ®ÿ≠ÿ™ 75 ŸÜŸÇÿ∑ÿ© ŸÖÿ¨ÿßŸÜŸäÿ© ÿ®ÿ≥ÿ®ÿ® ÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸÉ ÿ±ŸÖÿ≤ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©. ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑÿ™ŸÅŸàŸÇ!`,
            status: 'unread',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            points: 75
        });
        
    } catch (error) {
        console.error('Error sending referral notifications:', error);
    }
}

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖŸÜÿπ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸàŸáŸÖŸäÿ©
async function checkForFakeAccounts(userId, userEmail) {
    try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿ£ÿÆÿ±Ÿâ ÿ®ŸÜŸÅÿ≥ ÿßŸÑÿ®ÿ±ŸäÿØ ÿ£Ÿà ÿßŸÑÿ¨Ÿáÿßÿ≤
        const suspiciousQuery = await db.collection('suspicious_activities')
            .where('type', '==', 'multiple_accounts')
            .where('userEmail', '==', userEmail)
            .limit(1)
            .get();
        
        if (!suspiciousQuery.empty) {
            // ÿ≠ÿ∏ÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©
            await banMultipleAccounts(userEmail);
            return true;
        }
        
        return false;
        
    } catch (error) {
        console.error('Error checking for fake accounts:', error);
        return false;
    }
}

// ÿ≠ÿ∏ÿ± ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©
async function banMultipleAccounts(email) {
    try {
        const usersQuery = await db.collection('users')
            .where('email', '==', email)
            .get();
        
        const batch = db.batch();
        
        usersQuery.forEach(doc => {
            batch.update(doc.ref, {
                isPermanentlyBanned: true,
                banReason: 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ© ŸÑŸÑÿ∫ÿ¥ ŸÅŸä ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©',
                bannedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        
        await batch.commit();
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿßŸÑŸÉ
        await sendTelegramNotification(
            `üö´ <b>ÿ≠ÿ∏ÿ± ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©</b>\n\nüìß ${email}\nüìù ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ŸàŸáŸÖŸäÿ© ŸÑŸÑÿ∫ÿ¥ ŸÅŸä ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©`
        );
        
    } catch (error) {
        console.error('Error banning multiple accounts:', error);
    }
}
// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
async function checkPendingReferrals(userId) {
    try {
        const pendingRef = await db.collection('pending_referrals')
            .where('referredUserId', '==', userId)
            .where('processed', '==', false)
            .limit(1)
            .get();
        
        if (!pendingRef.empty) {
            const pendingDoc = pendingRef.docs[0];
            const pendingData = pendingDoc.data();
            
            // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿπŸÑŸÇÿ©
            await processSuccessfulReferral(userId, pendingData.referredUserName, pendingData.referralCode);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
            await pendingDoc.ref.update({ processed: true });
        }
    } catch (error) {
        console.error('Error checking pending referrals:', error);
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿµÿßÿØŸÇÿ© ŸÑÿØÿπŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
auth.onAuthStateChanged(async (user) => {
  if(!user){
    updateUIForLoggedOutUser();
    stopAllListeners();
    return;
  }
  try{
    let doc = await db.collection("users").doc(user.uid).get();
    if(!doc.exists){
      isFirstLoginSession = true;
      const shortUid = generateShortUid(user.uid);
      await db.collection("users").doc(user.uid).set({
        name: user.displayName || user.email.split("@")[0], 
        email: user.email, 
        avatar: pendingChosenAvatar || "male",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
        isVerified:false, isOwner:false, blockedFromPosting:false, 
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(), 
        lastPromoAt: null,
        shortUid: shortUid
      },{merge:true});
      doc = await db.collection("users").doc(user.uid).get();
    }else{
      isFirstLoginSession = false;
      if (!doc.data().shortUid) {
        const shortUid = generateShortUid(user.uid);
        await db.collection("users").doc(user.uid).update({
          shortUid: shortUid,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await db.collection("users").doc(user.uid).update({ 
          lastSeen: firebase.firestore.FieldValue.serverTimestamp() 
        });
      }
    }
    currentUser = { uid:user.uid, ...doc.data() };
    
    // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸÖŸÜ ÿßŸÑŸÅÿßŸäÿ±ÿ®Ÿäÿ≤
    if (doc.data().avatarBase64) {
      currentUser.avatarBase64 = doc.data().avatarBase64;
    }
    
  }catch(e){
    console.error("user load error:", e);
    currentUser = { uid:user.uid, name:user.email.split("@")[0], email:user.email, avatar: pendingChosenAvatar || "male", isVerified:false, blockedFromPosting:false, isOwner:false };
  }
  
  updateUIForLoggedInUser();
  await Promise.all([loadPostsFromFirestore(), loadCompanies(), fetchLatestBroadcast()]);
  await loadStudyState();
  await loadLeaderboardSettings();
  
  // ÿ®ÿØÿ° ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™
  startReferralListener();
  // ÿ®ÿßŸÇŸä ÿßŸÑŸÉŸàÿØ...
});

/* =========================
   üö´ ŸÜÿ∏ÿßŸÖ ŸÖŸÜÿπ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ© (ÿ≠ÿ≥ÿßÿ® Ÿàÿßÿ≠ÿØ ŸÑŸÉŸÑ IP ŸÑŸÑÿ£ÿ®ÿØ)
========================= */

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ≠ÿ≥ÿßÿ® ÿ≥ÿßÿ®ŸÇ ÿ®ŸÜŸÅÿ≥ ÿßŸÑŸÄ IP
async function checkExistingAccountByIP(userIP) {
    try {
        console.log('üîç ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿ®ŸÜŸÅÿ≥ ÿßŸÑŸÄ IP:', userIP);
        
        if (!userIP) {
            console.log('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÄ IP');
            return { hasExisting: false };
        }
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£Ÿä ÿ≠ÿ≥ÿßÿ® ÿ≥ÿßÿ®ŸÇ ÿ®ŸÜŸÅÿ≥ ÿßŸÑŸÄ IP
        const existingAccounts = await db.collection('users')
            .where('registrationIP', '==', userIP)
            .limit(1)
            .get();
        
        if (!existingAccounts.empty) {
            const existingAccount = existingAccounts.docs[0].data();
            const accountId = existingAccounts.docs[0].id;
            console.log('üö´ Ÿàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ŸÖŸàÿ¨ŸàÿØ ÿ®ŸÜŸÅÿ≥ ÿßŸÑŸÄ IP:', existingAccount.email);
            
            return { 
                hasExisting: true, 
                existingEmail: existingAccount.email,
                existingName: existingAccount.name,
                accountId: accountId,
                createdAt: existingAccount.createdAt
            };
        }
        
        return { hasExisting: false };
        
    } catch (error) {
        console.error('Error checking existing account by IP:', error);
        return { hasExisting: false };
    }
}

// ŸÖŸÜÿπ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ≠ÿ≥ÿßÿ® ÿ≥ÿßÿ®ŸÇ ÿ®ŸÜŸÅÿ≥ ÿßŸÑŸÄ IP
async function preventMultipleAccounts(userIP, userEmail) {
    try {
        const existingCheck = await checkExistingAccountByIP(userIP);
        
        if (existingCheck.hasExisting) {
            console.log('üö´ ŸÖŸÜÿπ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ - ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ÿ≥ÿßÿ®ŸÇ ÿ®ŸÜŸÅÿ≥ ÿßŸÑŸÄ IP');
            
            // ÿ±ÿ≥ÿßŸÑÿ© ÿ™Ÿàÿ∂Ÿäÿ≠Ÿäÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            const message = `
‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ

ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ® ŸÖÿ≥ÿ¨ŸÑ ŸÖÿ≥ÿ®ŸÇÿßŸã ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ:
‚Ä¢ ÿßŸÑÿ®ÿ±ŸäÿØ: ${existingCheck.existingEmail}
‚Ä¢ ÿßŸÑÿßÿ≥ŸÖ: ${existingCheck.existingName}

ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ÿµÿßÿ≠ÿ® Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ.

ŸÑŸÑÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ±ÿßÿ™: @MSLM_ALMYALY
            `.trim();
            
            return { 
                allowed: false, 
                message: message,
                existingAccount: existingCheck 
            };
        }
        
        return { allowed: true };
        
    } catch (error) {
        console.error('Error in preventMultipleAccounts:', error);
        return { allowed: true }; // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£ÿå ŸÜÿ≥ŸÖÿ≠ ÿ®ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
    }
}

// ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÄ IP ÿπŸÜÿØ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÜÿßÿ¨ÿ≠
async function registerUserIP(userId, userIP) {
    try {
        if (!userIP) return;
        
        await db.collection('users').doc(userId).update({
            registrationIP: userIP,
            ipRegisteredAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÄ IP ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', userIP);
        
    } catch (error) {
        console.error('Error registering user IP:', error);
    }
}

// ŸÜÿ∏ÿßŸÖ ŸÖÿ≠ÿ≥ŸÜ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÄ IP
async function getUserIP() {
    try {
        // ŸÖÿ≠ÿßŸàŸÑÿ© ŸÖŸÜ ŸÖÿµÿßÿØÿ± ŸÖÿ™ÿπÿØÿØÿ©
        const sources = [
            'https://api.ipify.org?format=json',
            'https://api64.ipify.org?format=json',
            'https://ipinfo.io/json'
        ];
        
        for (const source of sources) {
            try {
                const response = await fetch(source, { timeout: 5000 });
                if (response.ok) {
                    const data = await response.json();
                    const ip = data.ip || data.ipAddress;
                    if (ip && isValidIP(ip)) {
                        console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÄ IP ŸÖŸÜ:', source, ip);
                        return ip;
                    }
                }
            } catch (sourceError) {
                console.log('‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÄ IP ŸÖŸÜ:', source);
                continue;
            }
        }
        
        // ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑÿ™ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿµÿßÿØÿ±ÿå ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ IP ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
        console.log('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÄ IPÿå ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä');
        return 'unknown-ip';
        
    } catch (error) {
        console.error('Error in getUserIP:', error);
        return 'unknown-ip';
    }
}

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸÄ IP
function isValidIP(ip) {
    if (!ip || ip === 'unknown-ip') return false;
    
    // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ŸÜÿ≥ŸäŸÇ IPv4 ÿ£Ÿà IPv6
    const ipv4Pattern = /^(\d{1,3}\.){3}\d{1,3}$/;
    const ipv6Pattern = /^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/;
    
    return ipv4Pattern.test(ip) || ipv6Pattern.test(ip);
}

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸÄ IPs ÿßŸÑŸÖÿÆÿ≤ŸÜÿ© (ŸÑŸÑŸÖÿßŸÑŸÉ)
async function validateStoredIPs() {
    if (!isOwner()) return;
    
    try {
        const allUsers = await db.collection('users').get();
        const ipCounts = {};
        
        allUsers.forEach(doc => {
            const userData = doc.data();
            const ip = userData.registrationIP;
            
            if (ip && ip !== 'unknown-ip') {
                ipCounts[ip] = (ipCounts[ip] || 0) + 1;
            }
        });
        
        // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
        console.log('üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÄ IPs:', ipCounts);
        
        const multipleIPs = Object.entries(ipCounts).filter(([ip, count]) => count > 1);
        if (multipleIPs.length > 0) {
            console.log('üö´ IPs ÿ®Ÿáÿß ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ÿ≠ÿ≥ÿßÿ®:', multipleIPs);
        }
        
    } catch (error) {
        console.error('Error validating stored IPs:', error);
    }
}

// ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ (ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑)
if (isOwner()) {
    setTimeout(validateStoredIPs, 10000);
}
// ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÄ IPs ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ© (ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸàÿßŸÑÿ™ÿ∑ŸàŸäÿ±)
const ALLOWED_MULTIPLE_IPS = [
    '127.0.0.1',
    'localhost',
    '::1',
    'unknown-ip'
];

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÄ IP ŸÖÿ≥ŸÖŸàÿ≠ÿßŸã ÿ®Ÿá ŸÑŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©
function isIPAllowedForMultiple(ip) {
    return ALLOWED_MULTIPLE_IPS.includes(ip);
}

// ŸÜÿ≥ÿÆÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÖŸÜ preventMultipleAccounts
async function preventMultipleAccounts(userIP, userEmail) {
    try {
        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÄ IP ŸÖÿ≥ŸÖŸàÿ≠ÿßŸã ÿ®Ÿáÿå ŸÜÿ≥ŸÖÿ≠ ÿ®ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
        if (isIPAllowedForMultiple(userIP)) {
            console.log('‚úÖ IP ŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿá ŸÑŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©:', userIP);
            return { allowed: true };
        }
        
        const existingCheck = await checkExistingAccountByIP(userIP);
        
        if (existingCheck.hasExisting) {
            console.log('üö´ ŸÖŸÜÿπ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ - ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ÿ≥ÿßÿ®ŸÇ ÿ®ŸÜŸÅÿ≥ ÿßŸÑŸÄ IP');
            
            const message = `
‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ

ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ® ŸÖÿ≥ÿ¨ŸÑ ŸÖÿ≥ÿ®ŸÇÿßŸã ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÖŸÜ ŸÜŸÅÿ≥ ÿ¥ÿ®ŸÉÿ© ÿßŸÑÿßŸÜÿ™ÿ±ŸÜÿ™:
‚Ä¢ ÿßŸÑÿ®ÿ±ŸäÿØ: ${existingCheck.existingEmail}
‚Ä¢ ÿßŸÑÿßÿ≥ŸÖ: ${existingCheck.existingName}

üìã ÿßŸÑŸÇŸàÿßÿπÿØ:
- ŸÖÿ≥ŸÖŸàÿ≠ ÿ≠ÿ≥ÿßÿ® Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑ ŸÑŸÉŸÑ ÿ¥ÿ®ŸÉÿ© ÿßŸÜÿ™ÿ±ŸÜÿ™
- ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ÿµÿßÿ≠ÿ® Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿå ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®Ÿá
- ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ŸÅŸä ŸÖŸÉÿßŸÜ ÿπÿßŸÖÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ¥ÿ®ŸÉÿ© ŸÖÿÆÿ™ŸÑŸÅÿ©

ŸÑŸÑÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ±ÿßÿ™: @MSLM_ALMYALY
            `.trim();
            
            return { 
                allowed: false, 
                message: message,
                existingAccount: existingCheck 
            };
        }
        
        return { allowed: true };
        
    } catch (error) {
        console.error('Error in preventMultipleAccounts:', error);
        return { allowed: true };
    }
}

/* =========================
   üåê ŸÜÿ∏ÿßŸÖ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ ŸÑŸÑÿπÿØÿßÿØ
========================= */

let networkMonitorInterval = null;
let lastNetworkCheck = Date.now();
let networkStatus = 'online';
let consecutiveOfflineCount = 0;
const MAX_OFFLINE_DURATION = 3 * 60 * 60 * 1000; // 3 ÿ≥ÿßÿπÿßÿ™

// ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
function startNetworkMonitoring() {
    stopNetworkMonitoring();
    
    console.log('üåê ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™...');
    
    networkMonitorInterval = setInterval(() => {
        checkNetworkStatus();
    }, 30000); // ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ©
    
    // ÿ£Ÿäÿ∂Ÿãÿß ŸÜÿ≥ÿ™ŸÖÿπ ŸÑÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
    window.addEventListener('online', handleOnlineStatus);
    window.addEventListener('offline', handleOfflineStatus);
}

// ÿ•ŸäŸÇÿßŸÅ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
function stopNetworkMonitoring() {
    if (networkMonitorInterval) {
        clearInterval(networkMonitorInterval);
        networkMonitorInterval = null;
    }
    
    window.removeEventListener('online', handleOnlineStatus);
    window.removeEventListener('offline', handleOfflineStatus);
}

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
async function checkNetworkStatus() {
    const now = Date.now();
    
    try {
        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
        const response = await fetch('https://www.google.com/favicon.ico', { 
            method: 'HEAD',
            cache: 'no-cache',
            timeout: 10000 
        });
        
        if (response.ok) {
            handleOnlineStatus();
        } else {
            handleOfflineStatus();
        }
    } catch (error) {
        handleOfflineStatus();
    }
    
    lastNetworkCheck = now;
}

// ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
function handleOnlineStatus() {
    if (networkStatus === 'online') return;
    
    console.log('‚úÖ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿπÿßÿØ ŸÑŸÑÿπŸÖŸÑ');
    networkStatus = 'online';
    consecutiveOfflineCount = 0;
    
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿπÿØÿßÿØ ÿ¥ÿ∫ÿßŸÑÿå ŸÜÿ≥ÿ™ÿ£ŸÜŸÅ ÿßŸÑÿπŸÖŸÑ
    if (studyState.running) {
        showNotification('‚úÖ ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿπÿßÿØ - ÿßŸÑÿπÿØÿßÿØ ŸäÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿ∑ÿ®ŸäÿπŸä', 'success');
    }
}

// ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿ≠ÿßŸÑÿ© ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
function handleOfflineStatus() {
    if (networkStatus === 'offline') {
        consecutiveOfflineCount++;
    } else {
        console.log('‚ùå ÿßŸÜŸÇÿ∑ÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
        networkStatus = 'offline';
        consecutiveOfflineCount = 1;
    }
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿßŸÜŸÇÿ∑ÿßÿπ 3 ÿ≥ÿßÿπÿßÿ™
    checkOfflineDuration();
}

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖÿØÿ© ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
async function checkOfflineDuration() {
    if (!studyState.running) return;
    
    const offlineDuration = Date.now() - lastNetworkCheck;
    const offlineHours = Math.floor(offlineDuration / (60 * 60 * 1000));
    
    console.log(`‚è∞ ŸÖÿØÿ© ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™: ${offlineHours} ÿ≥ÿßÿπÿßÿ™`);
    
    // ÿ•ÿ∞ÿß ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿßŸÜŸÇÿ∑ÿßÿπ 3 ÿ≥ÿßÿπÿßÿ™
    if (offlineDuration >= MAX_OFFLINE_DURATION) {
        console.log('üö´ ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿ™ÿ¨ÿßŸàÿ≤ 3 ÿ≥ÿßÿπÿßÿ™ - ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿπÿØÿßÿØ');
        await stopTimerDueToNetworkIssue();
    }
}

// ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿπÿØÿßÿØ ÿ®ÿ≥ÿ®ÿ® ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
async function stopTimerDueToNetworkIssue() {
    if (!studyState.running) return;
    
    try {
        const endTime = new Date();
        const elapsedMs = endTime.getTime() - studyState.startAtMs;
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑŸÖŸÉÿ™ÿ≥ÿ®ÿ© ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ
        const pointsEarned = Math.floor(elapsedMs / (2 * 60 * 1000));
        
        if (pointsEarned > 0) {
            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑŸÖŸÉÿ™ÿ≥ÿ®ÿ©
            await db.collection('study').doc(currentUser.uid).set({
                currentPoints: firebase.firestore.FieldValue.increment(pointsEarned),
                totalPoints: firebase.firestore.FieldValue.increment(pointsEarned),
                running: false,
                startAt: null,
                lastStoppedAt: firebase.firestore.FieldValue.serverTimestamp(),
                name: currentUser.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                lastSessionPoints: pointsEarned,
                lastSessionDuration: elapsedMs,
                stopReason: 'network_disconnection'
            }, { merge: true });
            
            // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©
            await logPointsTransaction(currentUser.uid, pointsEarned, 'timer_earned', 
                `ŸÜŸÇÿßÿ∑ ŸÖÿ§ŸÇÿ™ - ÿ™ŸàŸÇŸÅ ÿ®ÿ≥ÿ®ÿ® ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ (${Math.floor(elapsedMs/60000)} ÿØŸÇŸäŸÇÿ©)`);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
            studyState.currentPoints += pointsEarned;
            studyState.totalPoints += pointsEarned;
        }
        
        // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿπÿØÿßÿØ
        studyState.running = false;
        studyState.startAtMs = null;
        stopStudyInterval();
        stopHeartbeatInterval();
        stopNetworkMonitoring();
        
        renderTimerUI();
        
        // ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        showNotification(`‚è∞ ÿ™ŸàŸÇŸÅ ÿßŸÑÿπÿØÿßÿØ - ÿßŸÜŸÇÿ∑ÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÑŸÖÿØÿ© 3 ÿ≥ÿßÿπÿßÿ™. ÿ™ŸÖ ÿ≠ŸÅÿ∏ ${pointsEarned} ŸÜŸÇÿ∑ÿ©.`, "warning");
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ
        await sendNetworkStopNotification(pointsEarned, elapsedMs);
        
    } catch (error) {
        console.error("Error stopping timer due to network issue:", error);
        showNotification("ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿπÿØÿßÿØ", "error");
    }
}

// ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÑŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ
async function sendNetworkStopNotification(pointsEarned, durationMs) {
    try {
        const durationMinutes = Math.floor(durationMs / 60000);
        const durationHours = Math.floor(durationMinutes / 60);
        const remainingMinutes = durationMinutes % 60;
        
        await db.collection('inbox').add({
            userId: currentUser.uid,
            type: 'timer_auto_stop',
            title: '‚è∞ ÿ™ŸàŸÇŸÅ ÿßŸÑÿπÿØÿßÿØ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã',
            message: `
ÿßŸÜŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÑŸÖÿØÿ© 3 ÿ≥ÿßÿπÿßÿ™ ŸÖÿ™ŸàÿßÿµŸÑÿ©.

üìä ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ:
‚Ä¢ ÿßŸÑŸÖÿØÿ©: ${durationHours} ÿ≥ÿßÿπÿ© Ÿà ${remainingMinutes} ÿØŸÇŸäŸÇÿ©
‚Ä¢ ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©: ${pointsEarned} ŸÜŸÇÿ∑ÿ©
‚Ä¢ ÿßŸÑÿ≥ÿ®ÿ®: ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™

üí° ŸÜÿµÿßÿ¶ÿ≠:
- ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ŸÇÿ±ÿßÿ± ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
- ÿ£ÿ∫ŸÑŸÇ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿ≥ÿ™ŸáŸÑŸÉ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
- ÿ≠ÿßŸàŸÑ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ¥ÿ®ŸÉÿ© Wi-Fi ŸÖÿ≥ÿ™ŸÇÿ±ÿ©

ŸÑŸÑÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ±ÿßÿ™: @MSLM_ALMYALY
            `.trim(),
            status: 'unread',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            points: pointsEarned,
            duration: durationMs
        });
        
    } catch (error) {
        console.error('Error sending network stop notification:', error);
    }
}

// ÿßÿ≥ÿ™ÿ±ÿØÿßÿØ ÿßŸÑÿπÿØÿßÿØ ÿ®ÿπÿØ ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿßŸÑŸÇÿµŸäÿ±
async function recoverTimerAfterShortDisconnection() {
    if (!currentUser || !studyState.running) return;
    
    try {
        const studyDoc = await db.collection('study').doc(currentUser.uid).get();
        
        if (studyDoc.exists) {
            const data = studyDoc.data();
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿπÿØÿßÿØ ÿ¥ÿ∫ÿßŸÑ ŸÅŸä ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÑŸÉŸÜ ŸÖÿ™ŸàŸÇŸÅ ŸÖÿ≠ŸÑŸäÿßŸã
            if (data.running && !studyState.running) {
                console.log('üîÑ ÿßÿ≥ÿ™ÿ±ÿØÿßÿØ ÿßŸÑÿπÿØÿßÿØ ÿ®ÿπÿØ ÿßŸÜŸÇÿ∑ÿßÿπ ŸÇÿµŸäÿ±');
                
                const serverStartTime = data.startAt.toDate().getTime();
                const now = Date.now();
                const elapsed = now - serverStartTime;
                
                // ÿ•ÿ∞ÿß ÿßŸÑÿßŸÜŸÇÿ∑ÿßÿπ ŸÉÿßŸÜ ÿ£ŸÇŸÑ ŸÖŸÜ 10 ÿØŸÇÿßÿ¶ŸÇÿå ŸÜÿ≥ÿ™ÿ±ÿØ ÿßŸÑÿπÿØÿßÿØ
                if (elapsed < (10 * 60 * 1000)) {
                    studyState.running = true;
                    studyState.startAtMs = serverStartTime;
                    startStudyInterval();
                    startHeartbeatInterval();
                    startNetworkMonitoring();
                    
                    renderTimerUI();
                    showNotification("‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿØÿßÿØ ÿßŸÑÿπÿØÿßÿØ ÿ®ÿπÿØ ÿßŸÜŸÇÿ∑ÿßÿπ ÿ®ÿ≥Ÿäÿ∑", "success");
                }
            }
        }
    } catch (error) {
        console.error("Error recovering timer:", error);
    }
}

// ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿßÿ≥ÿ™ÿ±ÿØÿßÿØ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
setTimeout(recoverTimerAfterShortDisconnection, 5000);

async function stopStudyTimer() {
    if (!currentUser || !studyState.running) return;

    try {
        const endTime = new Date();
        const elapsedMs = endTime.getTime() - studyState.startAtMs;
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© (ÿ®ÿØŸàŸÜ ŸÖÿ∂ÿßÿπŸÅÿ©)
        const basePoints = Math.floor(elapsedMs / (2 * 60 * 1000));
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜŸÇÿßÿ∑ ŸÖÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÅÿπÿßŸÑÿ©
        let totalPoints = basePoints;
        let boostedMessage = '';
        
        if (studyState.boostUntil && studyState.boostUntil > studyState.startAtMs) {
            const boostStart = new Date(Math.max(studyState.startAtMs, studyState.boostUntil.getTime() - (studyState.boostUntil.getTime() - studyState.startAtMs)));
            const boostEnd = new Date(Math.min(endTime.getTime(), studyState.boostUntil.getTime()));
            const boostedMs = Math.max(0, boostEnd.getTime() - boostStart.getTime());
            
            if (boostedMs > 0) {
                const boostedPoints = Math.floor(boostedMs / (60 * 1000)); // ŸÜŸÇÿ∑ÿ© ŸÑŸÉŸÑ ÿØŸÇŸäŸÇÿ© ŸÖÿ∂ÿßÿπŸÅÿ©
                totalPoints = basePoints + boostedPoints;
                boostedMessage = ` (${Math.floor(boostedMs/60000)} ÿØŸÇŸäŸÇÿ© ŸÖÿ∂ÿßÿπŸÅÿ© ‚ö°)`;
            }
        }

        console.log('üí∞ ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜŸÇÿßÿ∑:', {
            'ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©': basePoints,
            'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä': totalPoints,
            'ÿßŸÑŸÖÿØÿ©': Math.floor(elapsedMs/60000) + ' ÿØŸÇŸäŸÇÿ©'
        });

        if (totalPoints > 0) {
            await db.collection('study').doc(currentUser.uid).set({
                currentPoints: firebase.firestore.FieldValue.increment(totalPoints),
                totalPoints: firebase.firestore.FieldValue.increment(totalPoints),
                running: false,
                startAt: null,
                lastStoppedAt: firebase.firestore.FieldValue.serverTimestamp(),
                name: currentUser.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            await logPointsTransaction(currentUser.uid, totalPoints, 'timer_earned', 
                `ŸÜŸÇÿßÿ∑ ŸÖÿ§ŸÇÿ™ - ${Math.floor(elapsedMs/60000)} ÿØŸÇŸäŸÇÿ©`);

            studyState.currentPoints += totalPoints;
            studyState.totalPoints += totalPoints;
        }

        // ÿ•ŸäŸÇÿßŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÜÿ∏ŸÖÿ©
        studyState.running = false;
        studyState.startAtMs = null;
        stopStudyInterval();
        stopHeartbeatInterval();
        stopNetworkMonitoring();
        
        renderTimerUI();
        
        if (totalPoints > 0) {
            showNotification(`‚è∞ ÿ™ŸÖ ÿßŸÑÿ•ŸäŸÇÿßŸÅ - ÿ±ÿ®ÿ≠ÿ™ ${totalPoints} ŸÜŸÇÿ∑ÿ©${boostedMessage}`, "success");
        } else {
            showNotification("ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿ§ŸÇÿ™ - ÿßŸÑŸàŸÇÿ™ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä ŸÑŸÑŸÜŸÇÿßÿ∑", "info");
        }

    } catch (error) {
        console.error("Error stopping timer:", error);
        showNotification("ŸÅÿ¥ŸÑ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿ§ŸÇÿ™ - ÿ¨ÿ±ÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ", "error");
    }
}

// ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿ©
function resetBoostTracking() {
    boostTracker = {
        active: false,
        startTime: null,
        endTime: null,
        totalBoostedTime: 0,
        segments: []
    };
}

// ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ŸÅŸä Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅ
function addDistributionInfo() {
    const leaderboardContainer = document.getElementById('challenge-leaderboard');
    if (!leaderboardContainer) return;
    
    const infoDiv = document.createElement('div');
    infoDiv.className = 'post';
    infoDiv.style.background = '#fff3cd';
    infoDiv.style.border = '1px solid #ffeaa7';
    infoDiv.innerHTML = `
        <div style="text-align: center;">
            <h4>üèÜ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</h4>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 10px 0;">
                <div style="text-align: center;">
                    <div style="background: #d4af37; color: white; padding: 5px; border-radius: 5px; font-weight: bold;">1</div>
                    <div style="font-size: 12px; margin-top: 5px;">2000 ŸÜŸÇÿ∑ÿ©</div>
                </div>
                <div style="text-align: center;">
                    <div style="background: #c0c0c0; color: white; padding: 5px; border-radius: 5px; font-weight: bold;">2</div>
                    <div style="font-size: 12px; margin-top: 5px;">1500 ŸÜŸÇÿ∑ÿ©</div>
                </div>
                <div style="text-align: center;">
                    <div style="background: #cd7f32; color: white; padding: 5px; border-radius: 5px; font-weight: bold;">3</div>
                    <div style="font-size: 12px; margin-top: 5px;">1000 ŸÜŸÇÿ∑ÿ©</div>
                </div>
                <div style="text-align: center;">
                    <div style="background: #7aa2ff; color: white; padding: 5px; border-radius: 5px; font-weight: bold;">4</div>
                    <div style="font-size: 12px; margin-top: 5px;">500 ŸÜŸÇÿ∑ÿ©</div>
                </div>
                <div style="text-align: center;">
                    <div style="background: #a17aff; color: white; padding: 5px; border-radius: 5px; font-weight: bold;">5</div>
                    <div style="font-size: 12px; margin-top: 5px;">300 ŸÜŸÇÿ∑ÿ©</div>
                </div>
            </div>
            <p style="font-size: 12px; color: #856404; margin: 5px 0;">
                ‚ö†Ô∏è Ÿäÿ¥ÿ™ÿ±ÿ∑ 200 ŸÜŸÇÿ∑ÿ© ŸÉÿ≠ÿØ ÿ£ÿØŸÜŸâ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ©
            </p>
            <p style="font-size: 12px; color: #856404; margin: 0;">
                ‚è∞ ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÇÿßÿØŸÖ: <span id="next-distribution-time">${leaderboardSettings.nextReset ? leaderboardSettings.nextReset.toLocaleString('ar-IQ') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
            </p>
        </div>
    `;
    
    leaderboardContainer.prepend(infoDiv);
}

// ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
setTimeout(addDistributionInfo, 4000);

// ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ
function monitorDistributionStatus() {
    if (!isOwner()) return;
    
    db.collection('settings').doc('leaderboard')
        .onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                const status = data.distributionStatus;
                
                if (status === 'in_progress') {
                    showNotification('üîÑ ÿ¨ÿßÿ±Ÿä ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤...', 'info');
                } else if (status === 'completed') {
                    showNotification('‚úÖ ÿ™ŸÖ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                } else if (status === 'failed') {
                    showNotification('‚ùå ŸÅÿ¥ŸÑ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤', 'error');
                }
            }
        });
}

// ÿ®ÿØÿ° ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©
setTimeout(monitorDistributionStatus, 5000);

// ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿßŸÑÿµÿßÿ±ŸÖ
async function autoDistributeRewards() {
    if (!isOwner()) return;
    
    const now = new Date();
    const targetTime = leaderboardSettings.nextReset;
    
    if (!targetTime) {
        console.log('‚è∞ ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸàÿπÿØ ŸÖÿ≠ÿØÿØ ŸÑŸÑÿ™Ÿàÿ≤Ÿäÿπ');
        return;
    }
    
    // ÿ•ÿ∞ÿß ÿ≠ÿßŸÜ ŸàŸÇÿ™ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ
    if (now >= targetTime) {
        console.log('üîÑ ÿ®ÿØÿ° ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä...');
        
        try {
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ ÿ™Ÿàÿ≤Ÿäÿπ ÿ≥ÿßÿ®ŸÇ
            const settingsDoc = await db.collection('settings').doc('leaderboard').get();
            const settings = settingsDoc.data();
            
            if (settings.distributionStatus === 'in_progress') {
                console.log('‚ö†Ô∏è ÿ™Ÿàÿ≤Ÿäÿπ ÿ≥ÿßÿ®ŸÇ ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞');
                return;
            }
            
            // ÿ®ÿØÿ° ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ
            await distributeWeeklyRewards();
            
        } catch (error) {
            console.error('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä:', error);
        }
    }
}

// ÿ®ÿØÿ° ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©
function startAutoDistributionMonitor() {
    console.log('üîç ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä...');
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÉŸÑ ÿØŸÇŸäŸÇÿ©
    setInterval(() => {
        autoDistributeRewards();
    }, 60000); // ŸÉŸÑ ÿØŸÇŸäŸÇÿ©
    
    // ÿ£Ÿäÿ∂Ÿãÿß ÿ™ÿ≠ŸÇŸÇ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    setTimeout(autoDistributeRewards, 5000);
}

// ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©
startAutoDistributionMonitor();

</script>
</body>
</html>
