<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Ø³ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø§Ø¨</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary-color:#4a6bff;--secondary-color:#f8f9fa;--accent-color:#ff6b6b;
      --text-color:#222;--light-text:#6c757d;--border-color:#dee2e6;
      --success-color:#28a745;--warning-color:#ffc107;--danger-color:#dc3545;
      --sky:#e9f0ff;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal','Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    html,body{height:100%}
    body{background:#f5f5f5;color:var(--text-color);overscroll-behavior-y:contain;-webkit-text-size-adjust:100%;touch-action:manipulation}
    .container{max-width:100%;min-height:100vh;background:#fff;padding-bottom:70px}

    /* ===== Splash ===== */
    .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:
      radial-gradient(60% 90% at 20% 10%, rgba(16,209,255,.20), transparent 60%),
      radial-gradient(70% 80% at 90% 90%, rgba(106,17,203,.18), transparent 60%),
      linear-gradient(135deg,#0d0f1a 0%, #0f1330 100%);z-index:1200;overflow:hidden;transition:opacity .6s ease}
    .splash.fade-out{opacity:0;pointer-events:none}

    /* Ø§Ù„Ø­Ø±ÙˆÙ ØªØ¨Ù‚Ù‰ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© (ØªÙ†Ù‚Ù‘Ù„ Ù‚ØµÙŠØ± ÙÙ‚Ø·) */
    .runner{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      gap:.08em;filter:drop-shadow(0 10px 28px rgba(0,0,0,.45));
      pointer-events:none;
    }
    .runner span{
      font-weight:900;font-size:clamp(40px,9vw,74px);color:#e6ebff;display:inline-block;
      opacity:0; transform:translateX(6vw) scale(.96);
      animation:runCentered .8s cubic-bezier(.2,.8,.2,1) forwards;
      will-change:transform,opacity;
    }
    .runner span:nth-child(1){animation-delay:.00s}
    .runner span:nth-child(2){animation-delay:.05s}
    .runner span:nth-child(3){animation-delay:.10s}
    .runner span:nth-child(4){animation-delay:.15s}
    .runner span:nth-child(5){animation-delay:.20s}
    .runner span:nth-child(6){animation-delay:.25s}
    .runner span:nth-child(7){animation-delay:.30s}
    .runner span:nth-child(8){animation-delay:.35s}
    .runner span:nth-child(9){animation-delay:.40s}
    .runner span:nth-child(10){animation-delay:.45s}

    @keyframes runCentered{
      0%   {opacity:0; transform:translateX(6vw) scale(.96)}
      18%  {opacity:1}
      55%  {transform:translateX(-6vw) scale(1.02)}
      100% {opacity:0; transform:translateX(-6vw) scale(.98)}
    }

    .final-logo{
      position:relative;z-index:2;opacity:0;font-weight:900;
      font-size:clamp(42px,9.5vw,72px);color:#eef2ff;
      text-shadow:0 14px 40px rgba(16,209,255,.22),0 4px 10px rgba(0,0,0,.5);
      white-space:nowrap;line-height:1;direction:rtl;unicode-bidi:plaintext;
      animation:logoMerge .55s cubic-bezier(.2,.9,.1,1) var(--merge-delay,1.35s) forwards
    }
    @keyframes logoMerge{0%{opacity:0;transform:translateY(18px) scale(.94)}100%{opacity:1;transform:translateY(0) scale(1)}}

    /* Auth */
    .auth-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:20px;background:linear-gradient(135deg,#4a6bff,#6a11cb)}
    .auth-box{background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;width:100%;max-width:420px;text-align:center}
    .auth-tabs{display:flex;margin-bottom:20px;border-bottom:1px solid var(--border-color)}
    .auth-tab{flex:1;padding:10px;cursor:pointer;font-weight:500;color:var(--light-text);transition:.3s}
    .auth-tab.active{color:var(--primary-color);border-bottom:2px solid var(--primary-color)}
    .auth-form{display:none}.auth-form.active{display:block}
    .form-group{margin-bottom:15px;text-align:right}
    .form-group label{display:block;margin-bottom:5px;font-weight:500}
    .form-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;transition:.3s}
    .form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,107,255,.2)}
    .row{display:flex;gap:8px;align-items:center}

    /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„/Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    .choose-avatar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .choose-avatar label{display:flex;align-items:center;gap:8px;background:#f2f4ff;border:1px solid #dfe4ff;padding:8px 10px;border-radius:12px;cursor:pointer}
    .choose-avatar input{display:none}
    .choose-avatar input:checked + span{outline:3px solid #3a5bef;border-radius:10px}
    .choose-avatar .emo{font-size:22px;line-height:1}

    /* Buttons */
    .btn{display:inline-block;padding:10px 14px;background:var(--primary-color);color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;width:auto}
    .btn:hover{transform:translateY(-1px)}
    .btn[disabled]{opacity:.65;cursor:not-allowed;transform:none}
    .btn-block{width:100%}
    .btn-secondary{background:var(--secondary-color);color:var(--text-color)}
    .btn-danger{background:var(--danger-color)}
    .btn-success{background:var(--success-color)}
    .btn-warning{background:var(--warning-color);color:#111}
    .btn-xs{padding:6px 8px;font-size:12px;border-radius:8px}

    /* Header */
    .header{position:sticky;top:0;background:#fff;padding:12px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);z-index:100}
    .brand{display:flex;align-items:center;gap:8px}
    .section-switch{display:inline-flex;background:#f2f4ff;border:1px solid #dfe4ff;border-radius:999px;overflow:hidden;margin-inline-start:10px}
    .section-pill{padding:6px 10px;font-size:12px;font-weight:800;color:#3a5bef;cursor:pointer;border:none;background:transparent}
    .section-pill.active{background:#3a5bef;color:#fff}

    .icon-btn{position:relative;background:transparent;border:none;cursor:pointer;font-size:20px}
    .icon-btn .dot{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:#ff3b3b;border-radius:50%;display:none}
    .icon-btn.has-unseen .dot{display:block}

    .filter-container{padding:15px;background:#fff;border-bottom:1px solid var(--border-color)}
    .filter-select{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:5px}
    .posts-container{padding:15px 15px 90px}
    .pull-indicator{position:relative;height:0;overflow:visible}
    .pull-indicator .bubble{position:absolute;top:-28px;left:50%;transform:translateX(-50%);background:#e9f0ff;border:1px solid #d0dcff;border-radius:999px;padding:4px 10px;font-size:12px;color:#3a5bef;display:none}

    .post{background:#fff;border-radius:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);padding:15px;margin-bottom:15px;border:1px solid var(--border-color);position:relative}
    .post.pinned{box-shadow:0 4px 14px rgba(255,199,0,.25)}
    .post .pin-ribbon{position:absolute;top:-8px;right:-8px;background:#ffc107;color:#111;font-weight:800;padding:4px 8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:11px}
    .post.sold{opacity:.85;position:relative}
    .post.sold::after{content:"ØªÙ… Ø¨ÙŠØ¹Ù‡";position:absolute;top:10px;left:10px;background:var(--success-color);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
    .post-header{display:grid;grid-template-columns:1fr auto;grid-row-gap:6px;align-items:center;margin-bottom:10px}
    .post-username{display:flex;align-items:center;gap:10px;font-weight:900;color:#111;font-size:17px}
    .badge-verified{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:999px;background:linear-gradient(135deg,#f7d774,#e7b10a,#ffdf85,#e7b10a);color:#5a4600;font-size:12px;font-weight:900;border:1px solid rgba(128,96,0,.35);box-shadow:0 2px 10px rgba(231,177,10,.35), inset 0 0 10px rgba(255,255,255,.35)}
    .badge-verified i{font-size:14px;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15))}
    .post-title{font-weight:800;font-size:15px;color:var(--primary-color)}
    .post-price{justify-self:end;font-weight:900;color:var(--success-color)}
    .post-description{margin:10px 0 15px;line-height:1.8;color:#222;white-space:pre-wrap}
    .post-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .owner-tools{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;border-bottom:1px dashed #eee;padding-bottom:8px}

    /* Companies */
    .company{background:#fff;border-radius:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);padding:15px;margin-bottom:12px;border:1px solid var(--border-color)}
    .company .name{font-weight:900;color:#111;font-size:16px}
    .company .phone{color:#0c7a43;font-weight:800;margin-top:6px}
    .company .route{color:#555;margin-top:6px;font-size:13px}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;overflow-y:auto}
    .modal-content{background:#fff;margin:20px auto;padding:20px;border-radius:12px;width:90%;max-width:520px;animation:modalOpen .25s}
    @keyframes modalOpen{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}
    .modal-header h2{font-size:18px;margin:0}
    .close-modal{background:none;border:none;font-size:24px;cursor:pointer;color:var(--light-text)}
    .select-group{margin-bottom:15px}
    .select-group label{display:block;margin-bottom:5px;font-weight:500}
    .select-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;background:#fff}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}

    /* Profile */
    .profile-shell{padding:16px}
    .profile-card{background:var(--sky);border:1px solid #d0dcff;border-radius:16px;padding:16px;display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .avatar{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:#d7e4ff;color:#2740b9;font-size:28px;cursor:pointer;border:2px solid #c9d7ff;overflow:hidden}
    .profile-meta{display:flex;flex-direction:column;gap:4px}
    .profile-name-row{display:flex;align-items:center;gap:8px;font-weight:900;font-size:18px;color:#0f235f}
    .profile-count{font-size:13px;color:#2b3f8c;font-weight:700}
    .profile-email{font-size:12px;color:#3c4c7f;word-break:break-all}
    .profile-actions-card{margin-top:20px;background:#fff;border:1px solid var(--border-color);border-radius:14px;padding:10px}
    .profile-menu{padding:5px}
    .menu-item{display:flex;align-items:center;gap:10px;padding:14px;margin-bottom:10px;background:var(--secondary-color);border-radius:12px;cursor:pointer;transition:.2s}
    .menu-item:hover{transform:translateY(-2px)}
    .muted{color:#777;font-size:13px}

    /* ===== Broadcast popup (Ø·ÙˆÙ„ÙŠ) ===== */
    #broadcast-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:210}
    #broadcast-overlay.show{display:block}

    #broadcast-banner{
      display:none;
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%) scale(.98);
      width:min(92%, 380px);
      max-height:70vh;
      overflow:auto;
      z-index:220;
      background:#fff7d1;
      border:1px solid #f0d36a;
      border-radius:16px;
      padding:16px 46px 16px 16px;
      box-shadow:0 20px 40px rgba(0,0,0,.28);
      opacity:0;
    }
    /* Ø¥ØµÙ„Ø§Ø­: Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© .show */
    #broadcast-banner.show{
      display:block; /* Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ */
      animation:bannerIn .32s cubic-bezier(.2,.8,.2,1) forwards
    }
    @keyframes bannerIn{to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    #broadcast-banner .x{position:absolute;top:10px;right:12px;background:#0000;border:none;font-size:22px;cursor:pointer;color:#6b5a00}

    .bottom-nav{position:fixed;bottom:0;left:0;width:100%;background:#fff;display:flex;justify-content:space-around;padding:12px 0;border-top:1px solid var(--border-color);z-index:120}
    .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--light-text);font-size:12px;cursor:pointer}
    .nav-item.active{color:var(--primary-color)}

    .notification{position:fixed;top:20px;right:20px;background:var(--success-color);color:#fff;padding:15px 20px;border-radius:8px;box-shadow:0 3px 10px rgba(0,0,0,.2);z-index:300;display:none;font-size:12px}
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>

  <!-- Splash -->
  <div id="splash" class="splash" aria-label="Ø³ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø§Ø¨">
    <div class="runner" dir="rtl" aria-hidden="true">
      <span>Ø³</span><span>Ùˆ</span><span>Ù‚</span><span>&nbsp;</span><span>Ø§</span><span>Ù„</span><span>Ø·</span><span>Ù„</span><span>Ø§</span><span>Ø¨</span>
    </div>
    <div class="final-logo" id="final-logo" dir="rtl">Ø³ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
  </div>

  <!-- Auth -->
  <div id="auth-page" class="auth-container page" style="display:none">
    <div class="auth-box">
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <div class="auth-tab" onclick="switchAuthTab('register')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
      </div>

      <form id="login-form" class="auth-form active" onsubmit="event.preventDefault(); login();">
        <div class="form-group"><label for="login-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="login-email" class="form-control" required></div>
        <div class="form-group"><label for="login-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="login-password" class="form-control" required></div>
        <div class="form-group">
          <label>Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ±Ø©</label>
          <div class="choose-avatar">
            <label><input type="radio" name="login-avatar" value="male" checked><span class="emo">ğŸ‘¨ğŸ»â€ğŸ¦°</span> ÙˆÙ„Ø¯</label>
            <label><input type="radio" name="login-avatar" value="female"><span class="emo">ğŸ‘©ğŸ»â€ğŸ¦°</span> Ø¨Ù†Øª</label>
          </div>
        </div>
        <button type="submit" class="btn btn-block">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </form>

      <form id="register-form" class="auth-form" onsubmit="event.preventDefault(); register();">
        <div class="form-group"><label for="register-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="register-name" class="form-control" required></div>
        <div class="form-group"><label for="register-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="register-email" class="form-control" required></div>
        <div class="form-group"><label for="register-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="register-password" class="form-control" required></div>
        <div class="form-group">
          <label>Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ±Ø©</label>
          <div class="choose-avatar">
            <label><input type="radio" name="register-avatar" value="male" checked><span class="emo">ğŸ‘¨ğŸ»â€ğŸ¦°</span> ÙˆÙ„Ø¯</label>
            <label><input type="radio" name="register-avatar" value="female"><span class="emo">ğŸ‘©ğŸ»â€ğŸ¦°</span> Ø¨Ù†Øª</label>
          </div>
        </div>
        <button type="submit" class="btn btn-block">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      </form>
    </div>
  </div>

  <!-- Main -->
  <div id="main-page" class="container page" style="display:none">
    <div class="header">
      <div class="brand">
        <button id="create-btn" class="btn" onclick="onCreateButton()"><i class="fas fa-plus"></i> <span id="create-btn-label">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±</span></button>
        <div class="section-switch" role="tablist" aria-label="Ø§Ù„Ø£Ù‚Ø³Ø§Ù…">
          <button id="pill-posts" class="section-pill active" onclick="switchSection('posts')" role="tab" aria-selected="true">Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</button>
          <button id="pill-companies" class="section-pill" onclick="switchSection('companies')" role="tab" aria-selected="false">Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</button>
        </div>
      </div>
      <button class="icon-btn" id="notif-button" onclick="showNotificationsPage()" aria-label="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
        <i class="fa-regular fa-bell"></i>
        <span class="dot" id="notif-dot"></span>
      </button>
    </div>

    <div id="filter-container" class="filter-container">
      <select class="filter-select" onchange="filterPosts(this.value)">
        <option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option>
        <option value="Ø§Ø³Ù„Ø§Ù…ÙŠØ©">Ø§Ø³Ù„Ø§Ù…ÙŠØ©</option><option value="Ø¹Ø±Ø¨ÙŠ">Ø¹Ø±Ø¨ÙŠ</option><option value="Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ">Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ</option>
        <option value="Ø±ÙŠØ§Ø¶ÙŠØ§Øª">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option><option value="Ø§Ø­ÙŠØ§Ø¡">Ø§Ø­ÙŠØ§Ø¡</option><option value="ÙƒÙŠÙ…ÙŠØ§Ø¡">ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
        <option value="ÙÙŠØ²ÙŠØ§Ø¡">ÙÙŠØ²ÙŠØ§Ø¡</option><option value="Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª">Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª</option><option value="ØªØ§Ø±ÙŠØ®">ØªØ§Ø±ÙŠØ®</option>
        <option value="Ø¬ØºØ±Ø§ÙÙŠØ©">Ø¬ØºØ±Ø§ÙÙŠØ©</option><option value="Ø§Ù‚ØªØµØ§Ø¯">Ø§Ù‚ØªØµØ§Ø¯</option><option value="Ø¹Ù„ÙˆÙ…">Ø¹Ù„ÙˆÙ…</option>
      </select>
    </div>

    <!-- Ø·Ø¨Ù‚Ø© Ø§Ù„ØªØ¹ØªÙŠÙ… + Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø·ÙˆÙ„ÙŠØ© -->
    <div id="broadcast-overlay"></div>
    <div id="broadcast-banner">
      <button class="x" onclick="dismissBroadcast()">Ã—</button>
      <div style="font-weight:900;color:#6b5a00" id="broadcast-title-display"></div>
      <div id="broadcast-text-display" style="margin-top:4px;color:#4c3f00"></div>
    </div>

    <div class="pull-indicator"><div id="pull-bubble" class="bubble">Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø¯ÙŠØ«â€¦</div></div>
    <div class="posts-container" id="posts-container"></div>
    <div class="posts-container" id="companies-container" style="display:none"></div>
  </div>

  <!-- Profile -->
  <div id="profile-page" class="container page" style="display:none">
    <div class="profile-shell">
      <div class="profile-card">
        <div id="avatar" class="avatar" title="ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©" onclick="openAvatarModal"></div>
        <div class="profile-meta">
          <div class="profile-name-row">
            <span id="profile-name"></span>
            <span id="profile-verified"></span>
            <i class="fas fa-pencil-alt" style="color:var(--primary-color);cursor:pointer" onclick="editProfileName()"></i>
          </div>
          <div id="profile-count" class="profile-count"></div>
          <div id="profile-email" class="profile-email"></div>
        </div>
      </div>
      <div class="profile-actions-card">
        <div class="profile-menu">
          <div class="menu-item" onclick="showUserPosts()"><i class="fas fa-book"></i><span>Ù…Ù†Ø´ÙˆØ±Ø§ØªÙŠ</span></div>
          <div class="menu-item" onclick="showInbox()"><i class="fas fa-inbox"></i><span>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯</span></div>
          <div class="menu-item" onclick="openTelegram('MSLM_ALMYALY')"><i class="fas fa-thumbtack"></i><span>ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù€ 1$</span></div>
          <div class="menu-item" onclick="openTelegram('IbnalKufa')"><i class="fab fa-telegram"></i><span>Ù‚Ù†Ø§Ø© Ø§Ø¨Ù† Ø§Ù„ÙƒÙˆÙØ©</span></div>
          <div class="menu-item" onclick="openUserStats()"><i class="fas fa-chart-pie"></i><span>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span></div>
          <div class="menu-item owner-only" style="display:none" onclick="openBroadcastModal()"><i class="fas fa-bullhorn"></i><span>Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù…</span></div>
          <div class="menu-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Posts / Inbox / Notifications / Details / Comments -->
  <div id="user-posts-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">Ù…Ù†Ø´ÙˆØ±Ø§ØªÙŠ</span></div>
    <div class="posts-container" id="user-posts-container"></div>
  </div>

  <div id="inbox-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯</span></div>
    <div class="posts-container" id="inbox-container"></div>
  </div>

  <div id="notifications-page" class="container page" style="display:none;">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromNotifications()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span></div>
    <div class="posts-container" id="notifications-container"></div>
  </div>

  <div id="details-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromDetails()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</span></div>
    <div class="posts-container" id="details-container"></div>
  </div>

  <div id="comments-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromComments()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span></div>
    <div class="posts-container">
      <div id="comments-list-page"></div>
      <div class="row" style="margin-top:10px;">
        <input type="text" id="comment-text-page" class="form-control grow" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ù‹Ø§...">
        <button class="btn" onclick="addCommentFromPage()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div id="bottom-nav" class="bottom-nav">
    <div class="nav-item active" data-page="main" onclick="showMainPage()"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
    <div class="nav-item" data-page="profile" onclick="showProfilePage()"><i class="fas fa-user"></i><span>Ø­Ø³Ø§Ø¨ÙŠ</span></div>
  </div>

  <div id="notification" class="notification"></div>

  <!-- Create Post -->
  <div id="create-post-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h2><button class="close-modal" onclick="closeCreatePostModal()">&times;</button></div>
      <div class="form-group"><label for="post-subject">Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„ØµÙ</label><input type="text" id="post-subject" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª - Ø³Ø§Ø¯Ø³ Ø¹Ù„Ù…ÙŠ" required></div>
      <div class="form-group"><label for="post-price">Ø§Ù„Ø³Ø¹Ø± (Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ)</label><input type="number" id="post-price" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 5000" required></div>
      <div class="select-group">
        <label for="post-material">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
        <select id="post-material" class="select-control">
          <option value="Ø§Ø³Ù„Ø§Ù…ÙŠØ©">Ø§Ø³Ù„Ø§Ù…ÙŠØ©</option><option value="Ø¹Ø±Ø¨ÙŠ">Ø¹Ø±Ø¨ÙŠ</option><option value="Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ">Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ</option>
          <option value="Ø±ÙŠØ§Ø¶ÙŠØ§Øª">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option><option value="Ø§Ø­ÙŠØ§Ø¡">Ø§Ø­ÙŠØ§Ø¡</option><option value="ÙƒÙŠÙ…ÙŠØ§Ø¡">ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
          <option value="ÙÙŠØ²ÙŠØ§Ø¡">ÙÙŠØ²ÙŠØ§Ø¡</option><option value="Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª">Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª</option><option value="ØªØ§Ø±ÙŠØ®">ØªØ§Ø±ÙŠØ®</option>
          <option value="Ø¬ØºØ±Ø§ÙÙŠØ©">Ø¬ØºØ±Ø§ÙÙŠØ©</option><option value="Ø§Ù‚ØªØµØ§Ø¯">Ø§Ù‚ØªØµØ§Ø¯</option><option value="Ø¹Ù„ÙˆÙ…">Ø¹Ù„ÙˆÙ…</option>
        </select>
      </div>
      <div class="form-group"><label for="post-description">ÙˆØµÙ Ø§Ù„Ù…Ù„Ø²Ù…Ø©</label><textarea id="post-description" class="form-control" rows="4" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°ØŒ ÙˆØµÙ Ø§Ù„Ù…Ù„Ø²Ù…Ø©..." required></textarea></div>
      <div class="select-group">
        <label for="contact-method">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</label>
        <select id="contact-method" class="select-control" onchange="changeContactMethod()">
          <option value="whatsapp">ÙˆØ§ØªØ³Ø§Ø¨</option><option value="telegram">ØªÙ„ÙƒØ±Ø§Ù…</option><option value="comments">ØªØ¹Ù„ÙŠÙ‚Ø§Øª</option>
        </select>
      </div>
      <div class="form-group" id="whatsapp-field"><label for="whatsapp-number">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label><input type="text" id="whatsapp-number" class="form-control" placeholder="9641234567890"></div>
      <div class="form-group" id="telegram-field" style="display:none"><label for="telegram-username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ØªÙ„ÙƒØ±Ø§Ù…</label><input type="text" id="telegram-username" class="form-control" placeholder="@username"></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeCreatePostModal()">Ø¥Ù„ØºØ§Ø¡</button><button id="post-submit-btn" class="btn" onclick="createPost()">Ù†Ø´Ø±</button></div>
    </div>
  </div>

  <!-- Create Company (Owner) -->
  <div id="create-company-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© ØªÙˆØµÙŠÙ„</h2><button class="close-modal" onclick="closeCreateCompanyModal()">&times;</button></div>
      <div class="form-group"><label for="company-name">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label><input type="text" id="company-name" class="form-control" required></div>
      <div class="form-group"><label for="company-phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="company-phone" class="form-control" placeholder="07xxxxxxxxxx" required></div>
      <div class="select-group">
        <label for="company-from">Ù…Ù† Ù…Ø­Ø§ÙØ¸Ø©</label>
        <select id="company-from" class="select-control"></select>
        <div class="muted">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„ØªÙŠ <b>ØªØ³ØªÙ„Ù… Ù…Ù†Ù‡Ø§</b> Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø·Ù„Ø¨.</div>
      </div>
      <div class="select-group">
        <label for="company-to">Ø¥Ù„Ù‰ Ù…Ø­Ø§ÙØ¸Ø©</label>
        <select id="company-to" class="select-control"></select>
        <div class="muted">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„ØªÙŠ <b>ØªÙÙˆØµÙ„ Ø¥Ù„ÙŠÙ‡Ø§</b> Ø§Ù„Ø´Ø±ÙƒØ© (Ø§Ø®ØªØ± "ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª" Ø¥Ù† ÙƒØ§Ù†Øª Ø¹Ø§Ù…Ø©).</div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeCreateCompanyModal()">Ø¥Ù„ØºØ§Ø¡</button><button id="company-submit-btn" class="btn" onclick="createCompany()">Ø¥Ø¶Ø§ÙØ©</button></div>
    </div>
  </div>

  <!-- Avatar chooser modal -->
  <div id="avatar-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</h2><button class="close-modal" onclick="closeAvatarModal()">&times;</button></div>
      <div class="row" style="justify-content:center;margin-top:10px;">
        <div class="avatar" onclick="setAvatar('female')" title="Ø¨Ù†Øª" style="background:#ffd7ea;border-color:#ffc2e1"><div style="width:100%;height:100%;font-size:30px;line-height:56px">ğŸ‘©ğŸ»â€ğŸ¦°</div></div>
        <div class="avatar" onclick="setAvatar('male')" title="ÙˆÙ„Ø¯" style="background:#d7e4ff;border-color:#c9d7ff"><div style="width:100%;height:100%;font-size:30px;line-height:56px">ğŸ‘¨ğŸ»â€ğŸ¦°</div></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeAvatarModal()">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>

  <!-- Edit name -->
  <div id="edit-name-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</h2><button class="close-modal" onclick="closeEditNameModal()">&times;</button></div>
      <div class="form-group"><label for="new-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</label><input type="text" id="new-name" class="form-control" required></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeEditNameModal()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn" onclick="saveProfileName()">Ø­ÙØ¸</button></div>
    </div>
  </div>

  <!-- Broadcast (Owner) -->
  <div id="broadcast-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù…</h2><button class="close-modal" onclick="closeBroadcastModal()">&times;</button></div>
      <div class="form-group"><label for="broadcast-title-modal">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label><input id="broadcast-title-modal" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£Ø³Ø¹Ø§Ø±"></div>
      <div class="form-group"><label for="broadcast-text-modal">Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label><textarea id="broadcast-text-modal" class="form-control" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø³ØªØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹"></textarea></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeBroadcastModal()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn" onclick="sendBroadcast()">Ù†Ø´Ø±</button></div>
    </div>
  </div>

  <!-- Stats modal -->
  <div id="stats-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2><button class="close-modal" onclick="closeStatsModal()">&times;</button></div>
      <div id="stats-cards" class="row" style="gap:12px;flex-wrap:wrap">
        <div class="post" style="flex:1;min-width:140px"><div class="post-title">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ† (7 Ø£ÙŠØ§Ù…)</div><div id="stat-active" style="font-size:26px;font-weight:900;margin-top:6px">â€”</div></div>
        <div class="post" style="flex:1;min-width:140px"><div class="post-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div><div id="stat-users" style="font-size:26px;font-weight:900;margin-top:6px">â€”</div></div>
        <div class="post" style="flex:1;min-width:140px"><div class="post-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</div><div id="stat-posts" style="font-size:26px;font-weight:900;margin-top:6px">â€”</div></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeStatsModal()">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>

  <script>
    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey:"AIzaSyBkoSz3ZUy4qKBTeLx42Oo-TlTtvFtF2vY",
      authDomain:"we-kill-the-sixth.firebaseapp.com",
      databaseURL:"https://we-kill-the-sixth-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"we-kill-the-sixth",
      storageBucket:"we-kill-the-sixth.appspot.com",
      messagingSenderId:"862363949793",
      appId:"1:862363949793:web:e0dc01a4eb139da43f75a0",
      measurementId:"G-CT6WFGXRHH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const APP_OWNER_EMAIL = "mslmalmyaly223@gmail.com";
    let APP_OWNER_UID = null;
    let pendingChosenAvatar = null;           // ÙŠÙÙ…Ù„Ø£ Ù…Ù† ÙÙˆØ±Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    let lastBroadcast = null;

    // ===== Splash timings (Ø£Ø³Ø±Ø¹) =====
    (function(){
      const lastDelay = 0.45;   // Ø¢Ø®Ø± Ø­Ø±Ù ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ 0.45s
      const runDur   = 0.8;     // Ù…Ø¯Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø±Ù
      const mergeDelay = lastDelay + runDur + .10; // Ù…ØªÙ‰ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø´Ø¹Ø§Ø±
      document.getElementById('final-logo').style.setProperty('--merge-delay', mergeDelay+'s');
      setTimeout(()=>{ document.querySelector('.runner')?.remove(); }, (mergeDelay+0.4)*1000);
      const splash=document.getElementById('splash');
      function skip(){ splash.classList.add('fade-out'); setTimeout(()=>splash.remove(),600); }
      splash.addEventListener('click', skip);
      splash.addEventListener('touchstart', skip, {passive:true});
    })();

    // ===== Helpers =====
    function showNotification(msg,type="success"){
      const n=document.getElementById("notification");
      n.textContent=msg; n.style.display="block";
      const colors={error:'var(--danger-color)',warning:'var(--warning-color)',info:'var(--primary-color)',success:'var(--success-color)'};
      n.style.backgroundColor = colors[type]||colors.success;
      setTimeout(()=>{ n.style.display="none"; },5000);
    }
    function validateEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase()); }
    function sanitizeWhatsApp(v){ return (v||"").toString().replace(/[^\d]/g,""); }
    function sanitizeTelegram(v){ return (v||"").toString().replace(/^@+/,"").trim(); }
    function formatWhatsApp(msisdn){
      const d = sanitizeWhatsApp(msisdn);
      if (!d) return "";
      if (d.startsWith("964")) return d;
      if (d.startsWith("0")) return "964" + d.slice(1);
      return "964" + d;
    }
    function openTelegram(username){ username=sanitizeTelegram(username); if(!username) return; window.location.href = "https://t.me/" + username; }
    const GOVERNORATES = ["Ø¨ØºØ¯Ø§Ø¯","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø¨ØµØ±Ø©","Ø£Ø±Ø¨ÙŠÙ„","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±Ø¨Ù„Ø§Ø¡","Ø°ÙŠ Ù‚Ø§Ø±","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ø¯ÙŠØ§Ù„Ù‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±ÙƒÙˆÙƒ","ÙˆØ§Ø³Ø·","Ø§Ù„Ù…Ø«Ù†Ù‰","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","Ù…ÙŠØ³Ø§Ù†","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø¯Ù‡ÙˆÙƒ","ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª"];

    // ØªÙ‡Ø±ÙŠØ¨ HTML Ù„Ù…Ù†Ø¹ Ø­Ù‚Ù† Ø³ÙƒØ±Ø¨ØªØ§Øª
    function escapeHTML(s){
      s = (s==null) ? "" : String(s);
      return s
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function renderAvatar(kind){
      const el = document.getElementById("avatar");
      const bg = kind==="female" ? "#ffd7ea" : "#d7e4ff";
      const emoji = kind==="female" ? "ğŸ‘©ğŸ»â€ğŸ¦°" : "ğŸ‘¨ğŸ»â€ğŸ¦°";
      el.style.background = bg;
      el.innerHTML = `<div style="font-size:30px;line-height:56px">${emoji}</div>`;
    }

    // ===== Pages & UI =====
    const pages = {
      auth: document.getElementById("auth-page"),
      main: document.getElementById("main-page"),
      profile: document.getElementById("profile-page"),
      userPosts: document.getElementById("user-posts-page"),
      inbox: document.getElementById("inbox-page"),
      details: document.getElementById("details-page"),
      comments: document.getElementById("comments-page"),
      notifications: document.getElementById("notifications-page"),
    };
    const postsContainer = document.getElementById("posts-container");
    const companiesContainer = document.getElementById("companies-container");
    const userPostsContainer = document.getElementById("user-posts-container");
    const detailsContainer = document.getElementById("details-container");
    const commentsList = document.getElementById("comments-list-page");
    const inboxContainer = document.getElementById("inbox-container");
    const notificationsContainer = document.getElementById("notifications-container");
    const notifBtn = document.getElementById("notif-button");
    const createBtn = document.getElementById("create-btn");
    const createBtnLabel = document.getElementById("create-btn-label");
    const filterBox = document.getElementById("filter-container");
    const pillPosts = document.getElementById("pill-posts");
    const pillCompanies = document.getElementById("pill-companies");

    let currentUser = null;
    let posts = [];
    let companies = [];
    let currentDetailsPostId = null;
    let currentCommentsPostId = null;
    const userMetaCache = {}; // {uid: {isVerified, blockedFromPosting}}
    let activeSection = "posts";

    // ===== Auth =====
    auth.onAuthStateChanged(async (user) => {
      if(!user){
        updateUIForLoggedOutUser();
        setTimeout(()=>{ document.getElementById('splash')?.classList.add('fade-out'); setTimeout(()=>document.getElementById('splash')?.remove(),700); }, 900);
        return;
      }
      try{
        let doc = await db.collection("users").doc(user.uid).get();
        if(!doc.exists){
          await db.collection("users").doc(user.uid).set({
            name: user.email.split("@")[0],
            email: user.email,
            avatar: pendingChosenAvatar || "male",
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            isVerified:false,
            isOwner:false,
            blockedFromPosting:false,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          },{merge:true});
          doc = await db.collection("users").doc(user.uid).get();
        }else{
          db.collection("users").doc(user.uid).set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() },{merge:true});
          if(pendingChosenAvatar){
            await db.collection("users").doc(user.uid).set({ avatar: pendingChosenAvatar }, {merge:true});
          }
        }

        currentUser = { uid:user.uid, ...doc.data() };
        if (currentUser.email === APP_OWNER_EMAIL && currentUser.isOwner !== true){
          await db.collection("users").doc(currentUser.uid).set({ isOwner:true }, {merge:true});
          currentUser.isOwner = true;
        }
      }catch(e){
        console.error("user load error:", e);
        currentUser = { uid:user.uid, name:user.email.split("@")[0], email:user.email, avatar: pendingChosenAvatar || "male", isVerified:false, blockedFromPosting:false, isOwner:false };
        if (currentUser.email === APP_OWNER_EMAIL) currentUser.isOwner = true;
      }

      await resolveAppOwnerUid();
      updateUIForLoggedInUser();
      await Promise.all([loadPostsFromFirestore(), refreshNotifDot(), loadCompanies(), fetchLatestBroadcast()]);
      setTimeout(()=>{ document.getElementById('splash')?.classList.add('fade-out'); setTimeout(()=>document.getElementById('splash')?.remove(),700); }, 200);
      pendingChosenAvatar = null;
    });

    function isOwner(){ return currentUser && (currentUser.email===APP_OWNER_EMAIL || currentUser.isOwner===true); }

    function register(){
      const name=document.getElementById("register-name").value.trim();
      const email=document.getElementById("register-email").value.trim();
      const password=document.getElementById("register-password").value;
      const picked=(document.querySelector('input[name="register-avatar"]:checked')?.value)||"male";
      pendingChosenAvatar = picked;
      if(!name||!email||!password) return showNotification("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„","error");
      if(!validateEmail(email)) return showNotification("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­","error");
      auth.createUserWithEmailAndPassword(email,password)
        .then(cred=>{
          return db.collection("users").doc(cred.user.uid).set({
            name,email,avatar:picked,
            createdAt:firebase.firestore.FieldValue.serverTimestamp(),
            isVerified:false,isOwner:false,blockedFromPosting:false,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          },{merge:true});
        })
        .then(()=>{ showNotification("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.","success"); switchAuthTab('login'); })
        .catch(handleAuthError);
    }
    function login(){
      const email=document.getElementById("login-email").value.trim();
      const password=document.getElementById("login-password").value;
      const picked=(document.querySelector('input[name="login-avatar"]:checked')?.value)||null;
      pendingChosenAvatar = picked;
      if(!email||!password) return showNotification("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„","error");
      auth.signInWithEmailAndPassword(email,password)
        .then(cred=>{
          if(picked){ return db.collection("users").doc(cred.user.uid).set({ avatar:picked },{merge:true}); }
        })
        .catch(handleAuthError);
    }
    function logout(){ auth.signOut(); }

    // ===== Navigation =====
    function showPage(key){
      Object.values(pages).forEach(p=>p.style.display="none");
      pages[key].style.display = (key==="auth")?"flex":"block";
      updateBottomNav(key);
    }
    function updateBottomNav(activePageKey) {
      document.querySelectorAll("#bottom-nav .nav-item").forEach(item => {
        if (item.dataset.page === activePageKey) item.classList.add("active");
        else item.classList.remove("active");
      });
    }
    function showMainPage(){ showPage("main"); }
    function showProfilePage(){ showPage("profile"); }
    function backToProfile(){ showPage("profile"); }
    function backToMainFromDetails(){ showPage("main"); }
    function backToMainFromComments(){ showPage("main"); }
    function showNotificationsPage(){ showPage("notifications"); renderNotificationsPage(); }
    function backToMainFromNotifications(){ showPage("main"); }

    function updateUIForLoggedInUser(){
      showPage("main");
      document.getElementById("profile-name").textContent = currentUser.name || "";
      document.getElementById("profile-email").textContent = currentUser.email || "";
      renderAvatar(currentUser.avatar==="female"?"female":"male");
      const pv=document.getElementById("profile-verified");
      pv.innerHTML = currentUser.isVerified? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> Ù…ÙˆØ«Ù‘Ù‚</span>` : '';
      document.querySelectorAll(".owner-only").forEach(el=> el.style.display = isOwner()? "flex":"none");
      updateCreateButton();
      updatePostCountInProfile();
    }
    function updateUIForLoggedOutUser(){
      showPage("auth"); postsContainer.innerHTML=""; companiesContainer.innerHTML=""; posts=[]; companies=[]; currentUser=null;
      document.getElementById("profile-count").textContent="";
      document.getElementById("broadcast-banner").classList.remove('show');
      document.getElementById("broadcast-overlay").classList.remove('show');
    }

    function switchAuthTab(tab){
      document.querySelectorAll(".auth-tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".auth-form").forEach(f=>f.classList.remove("active"));
      if(tab==="login"){ document.querySelector(".auth-tab:nth-child(1)").classList.add("active"); document.getElementById("login-form").classList.add("active"); }
      else{ document.querySelector(".auth-tab:nth-child(2)").classList.add("active"); document.getElementById("register-form").classList.add("active"); }
    }

    // ===== Sections =====
    function switchSection(section){
      activeSection = section;
      if(section==="posts"){
        pillPosts.classList.add("active"); pillCompanies.classList.remove("active");
        postsContainer.style.display="block"; companiesContainer.style.display="none";
        filterBox.style.display="block";
      }else{
        pillCompanies.classList.add("active"); pillPosts.classList.remove("active");
        postsContainer.style.display="none"; companiesContainer.style.display="block";
        filterBox.style.display="none";
      }
      updateCreateButton();
    }
    function updateCreateButton(){
      if(activeSection==="posts"){
        createBtnLabel.textContent = "Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±";
        createBtn.style.display = currentUser? "inline-flex":"none";
      }else{
        createBtnLabel.textContent = "Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ©";
        createBtn.style.display = isOwner()? "inline-flex":"none";
      }
    }
    function onCreateButton(){ if(activeSection==="posts") openCreatePostModal(); else openCreateCompanyModal(); }

    // ===== Notifications Dot =====
    async function refreshNotifDot(){
      if(!currentUser) return;
      try{
        const q = await db.collection("notifications")
          .where("userId","==",currentUser.uid)
          .where("seen","==",false)
          .orderBy("createdAt","desc")
          .limit(1)
          .get();
        notifBtn.classList.toggle("has-unseen", !q.empty);
      }catch(err){ console.error("notif dot err:", err); }
    }
    async function renderNotificationsPage(){
      notificationsContainer.innerHTML = "<div class='post'><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>";
      if(!currentUser) return;
      try{
        const q = await db.collection("notifications")
          .where("userId","==",currentUser.uid)
          .orderBy("createdAt","desc").limit(50).get();
        const items = q.docs.map(d=>({id:d.id, ...d.data()}));
        if(items.length===0){ notificationsContainer.innerHTML = "<div class='post'><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p></div>"; return; }
        const out = items.map(n => {
          const dateTxt = n.createdAt?.toDate ? n.createdAt.toDate().toLocaleString('ar-IQ') : "";
          const typeTxt = n.type==='comment'?'ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯':(n.type==='report'?'Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯':'Ø¥Ø´Ø¹Ø§Ø±');
          const postIdSafe = escapeHTML(n.postId || '');
          return `<div class="post">
            <div class="post-header">
              <div class="post-username"><span>${typeTxt}</span></div>
              <div class="post-price" style="color:#888">${dateTxt}</div>
              <div class="post-title">${postIdSafe}</div>
            </div>
            <div class="post-actions">
              ${n.postId?`<button class="btn btn-secondary" onclick="openPostFromNotif('${n.postId}','${n.type}')">ÙØªØ­</button>`:""}
              ${n.seen===false?`<button class="btn" onclick="markNotifSeen('${n.id}')">ØªÙ…</button>`:""}
            </div>
          </div>`;
        });
        notificationsContainer.innerHTML = out.join("");
      }catch(err){ console.error(err); notificationsContainer.innerHTML = "<div class='post'><p>ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p></div>"; }
      await refreshNotifDot();
    }
    async function markNotifSeen(id){ await db.collection("notifications").doc(id).update({seen:true}); await renderNotificationsPage(); }
    function openPostFromNotif(postId,type){ if(type==='comment'){ openCommentsPage(postId); } else{ openDetailsPage(postId); } }

    // ===== Posts =====
    async function loadPostsFromFirestore(){
      try{
        const snap = await db.collection("posts").orderBy("createdAt","desc").get();
        posts = snap.docs.map(d=>{
          const data=d.data();
          const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : null; // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… new Date() Ø§ÙØªØ±Ø§Ø¶ÙŠ
          return { id:d.id, isPinned: !!data.isPinned, ...data, createdAt };
        });
        renderPosts();
        updatePostCountInProfile();
      }catch(e){ console.error(e); showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: "+(e.message||e),"error"); }
    }

    async function getUserMeta(uid){
      if(userMetaCache[uid]) return userMetaCache[uid];
      try{
        const u = await db.collection("users").doc(uid).get();
        const meta = { isVerified: !!u.data()?.isVerified, blockedFromPosting: !!u.data()?.blockedFromPosting };
        userMetaCache[uid]=meta; return meta;
      }catch{ return { isVerified:false, blockedFromPosting:false }; }
    }

    function filterPosts(material){ renderPosts(material); }

    // ØªØ±ØªÙŠØ¨ ØµØ­ÙŠØ­: Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨ Firestore ÙˆÙ†Ù‚Ø¯Ù‘Ù… Ø§Ù„Ù…Ø«Ø¨Ù‘ØªØ© Ø£Ø¹Ù„Ù‰
    async function renderPosts(filterMaterial=""){
      postsContainer.innerHTML="";
      const visible = posts.filter(p=>p.status!=='sold');
      const filtered = filterMaterial ? visible.filter(p=>p.material===filterMaterial) : visible;

      if(filtered.length===0){
        postsContainer.innerHTML='<div class="post"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…ØªØ§Ø­Ø©</p></div>';
        return;
      }

      const pinned = filtered.filter(p=>p.isPinned);
      const normal = filtered.filter(p=>!p.isPinned);
      const finalList = [...pinned, ...normal];

      const metas = await Promise.all(finalList.map(p => getUserMeta(p.userId)));
      const frag = document.createDocumentFragment();

      finalList.forEach((post, idx) => {
        const card = document.createElement("div");
        card.className = `post ${post.isPinned?'pinned':''}`;
        card.innerHTML = generatePostHTML(post, metas[idx], 'list');
        frag.appendChild(card);
      });

      postsContainer.appendChild(frag);
    }

    // ===== Post HTML Generator (Ù…Ø¹ ØªÙ‡Ø±ÙŠØ¨ HTML) =====
    function generatePostHTML(post, meta, context = 'list') {
      const userName = escapeHTML(post.userName || 'Ù…Ø³ØªØ®Ø¯Ù…');
      const subject  = escapeHTML(post.subject || '');
      const desc     = escapeHTML(post.description || '');
      const priceTxt = escapeHTML(String(post.price ?? 'â€”'));

      const badge = meta.isVerified
        ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> Ù…ÙˆØ«Ù‘Ù‚</span>`
        : '';

      const pinRibbon = post.isPinned
        ? '<div class="pin-ribbon"><i class="fa-solid fa-thumbtack"></i> Ù…Ø«Ø¨Øª</div>'
        : '';

      // Owner tools
      let ownerTools = '';
      if (isOwner()) {
        const pinTxt = post.isPinned ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª' : 'ØªØ«Ø¨ÙŠØª';
        const verTxt = meta.isVerified ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙˆØ«ÙŠÙ‚' : 'ØªÙˆØ«ÙŠÙ‚';
        const banTxt = meta.blockedFromPosting ? 'Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù†Ø´Ø±' : 'Ø­Ø¸Ø± Ø§Ù„Ù†Ø´Ø±';
        ownerTools = `
          <div class="owner-tools">
            <button class="btn btn-xs" onclick="ownerTogglePin('${post.id}', ${post.isPinned ? 'true' : 'false'})"><i class="fa-solid fa-thumbtack"></i> ${pinTxt}</button>
            <button class="btn btn-xs" onclick="ownerToggleVerify('${post.userId}')"><i class="fa-solid fa-crown"></i> ${verTxt}</button>
            <button class="btn btn-xs" onclick="ownerToggleUserBanById('${post.userId}')"><i class="fa-solid fa-ban"></i> ${banTxt}</button>
            <button class="btn btn-danger btn-xs" onclick="ownerDeletePost('${post.id}')"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù</button>
          </div>`;
      }

      // Contact
      let contactBtn = "";
      if (post.contactMethod === "whatsapp" && post.whatsapp) {
        const wa = formatWhatsApp(post.whatsapp);
        if (wa) contactBtn = `<a class="btn" href="https://wa.me/${wa}" target="_blank" rel="noopener">Ø§Ù„ØªÙˆØ§ØµÙ„ (ÙˆØ§ØªØ³Ø§Ø¨)</a>`;
      } else if (post.contactMethod === "telegram" && post.telegram) {
        contactBtn = `<button class="btn" onclick="openTelegram('${sanitizeTelegram(post.telegram)}')">Ø§Ù„ØªÙˆØ§ØµÙ„ (ØªÙ„ÙƒØ±Ø§Ù…)</button>`;
      } else if (post.contactMethod === "comments") {
        contactBtn = `<button class="btn" onclick="openCommentsPage('${post.id}')">Ø§Ù„ØªÙˆØ§ØµÙ„ (ØªØ¹Ù„ÙŠÙ‚Ø§Øª)</button>`;
      }

      let actionButtons = '';
      if (context === 'list') {
        actionButtons = `<button class="btn btn-secondary" onclick="openDetailsPage('${post.id}')">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>${contactBtn}`;
      } else if (context === 'details') {
        actionButtons = `<button class="btn btn-secondary" onclick="reportPost('${post.id}')"><i class="fas fa-flag"></i> Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>${contactBtn}`;
      } else if (context === 'user-posts') {
        const sold = post.status === 'sold';
        actionButtons = `
          <button class="btn btn-secondary" onclick="openDetailsPage('${post.id}')">ØªÙØ§ØµÙŠÙ„</button>
          ${contactBtn}
          <button class="btn" onclick="repost('${post.id}')"><i class="fas fa-rotate-right"></i> Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø±</button>
          <button class="btn btn-warning" onclick="markSold('${post.id}', ${sold ? 'true' : 'false'})">${sold ? 'Ø¥Ù„ØºØ§Ø¡ ØªÙ… Ø¨ÙŠØ¹Ù‡' : 'ØªÙ… Ø¨ÙŠØ¹Ù‡'}</button>
          <button class="btn btn-danger" onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>`;
      }

      return `
        ${pinRibbon}
        ${ownerTools}
        <div class="post-header">
          <div class="post-username"><span>${userName}</span> ${badge}</div>
          <div class="post-price">${priceTxt} Ø¯ÙŠÙ†Ø§Ø±</div>
          <div class="post-title">${subject}</div>
        </div>
        <div class="post-description">${desc}</div>
        <div class="post-actions">${actionButtons}</div>`;
    }

    // ===== Owner tools =====
    async function ownerTogglePin(postId, current){ if(!isOwner()) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning"); try{ await db.collection("posts").doc(postId).update({ isPinned: !current }); showNotification(!current? "ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª":"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª","success"); await loadPostsFromFirestore(); } catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: "+(e.message||e),"error"); } }
    async function ownerDeletePost(postId){ if(!isOwner()) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning"); if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ")) return; try{ await db.collection("posts").doc(postId).delete(); showNotification("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±","success"); await loadPostsFromFirestore(); } catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù: "+(e.message||e),"error"); } }
    async function ownerToggleVerify(userId){ if(!isOwner()) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning"); try{ const u = await db.collection("users").doc(userId).get(); const newVal = !u.data()?.isVerified; await db.collection("users").doc(userId).set({ isVerified:newVal }, {merge:true}); userMetaCache[userId] = { ...(userMetaCache[userId]||{}), isVerified:newVal, blockedFromPosting: !!u.data()?.blockedFromPosting }; showNotification(newVal? "ØªÙ… Ø§Ù„ØªÙˆØ«ÙŠÙ‚":"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙˆØ«ÙŠÙ‚","success"); await loadPostsFromFirestore(); }catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ù‘Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªÙˆØ«ÙŠÙ‚: "+(e.message||e),"error"); } }
    async function ownerToggleUserBanById(userId){ if(!isOwner()) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning"); try{ const u = await db.collection("users").doc(userId).get(); const newVal = !(u.data()?.blockedFromPosting); await db.collection("users").doc(userId).set({ blockedFromPosting:newVal },{merge:true}); userMetaCache[userId] = { ...(userMetaCache[userId]||{}), blockedFromPosting:newVal, isVerified: !!u.data()?.isVerified }; showNotification(newVal? "ØªÙ… Ø§Ù„Ø­Ø¸Ø±":"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±","success"); await loadPostsFromFirestore(); }catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ù‘Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¸Ø±: "+(e.message||e),"error"); } }

    // ===== Details =====
    function openDetailsPage(postId){ currentDetailsPostId = postId; showPage("details"); renderDetails(postId); }
    async function renderDetails(postId){
      detailsContainer.innerHTML = "<div class='post'><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>";
      let post = posts.find(p=>p.id===postId);
      if(!post){
        try{
          const doc = await db.collection("posts").doc(postId).get();
          if(doc.exists){
            const data = doc.data();
            post = {
              id: doc.id,
              ...data,
              createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : null
            };
          }
        }catch(e){
          console.error(e);
        }
      }
      if(!post){ detailsContainer.innerHTML="<div class='post'><p>ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p></div>"; return; }
      const meta = await getUserMeta(post.userId);
      const card = document.createElement("div");
      card.className = `post ${post.isPinned?'pinned':''}`;
      card.innerHTML = generatePostHTML(post, meta, 'details');
      detailsContainer.innerHTML = '';
      detailsContainer.appendChild(card);
    }

    // ===== Comments =====
    async function openCommentsPage(postId){ currentCommentsPostId = postId; showPage("comments"); await renderCommentsPage(postId); }
    async function isUserBannedFromPost(postId, userId){ try{ const doc = await db.collection("posts").doc(postId).collection("bans").doc(userId).get(); return doc.exists && doc.data()?.banned===true; } catch{ return false; } }
    async function addCommentFromPage(){
      if(!currentUser) return showNotification("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚","error");
      const postId = currentCommentsPostId;
      const input = document.getElementById("comment-text-page");
      const text = (input.value||"").trim();
      if(!text) return showNotification("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚","warning");
      if(await isUserBannedFromPost(postId, currentUser.uid)) return showNotification("Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±","error");

      const newComment = { userId: currentUser.uid, userName: currentUser.name, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
      try{
        await db.collection("posts").doc(postId).collection("comments").add(newComment);
        const pdoc = await db.collection("posts").doc(postId).get();
        const ownerId = pdoc.data()?.userId;
        if(ownerId && ownerId !== currentUser.uid){
          await db.collection("notifications").add({ userId: ownerId, type: "comment", postId, seen: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
        input.value = "";
        await renderCommentsPage(postId);
        await refreshNotifDot();
        showNotification("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚","success");
      }catch(e){ console.error("addComment error:", e); showNotification("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: "+(e.message||e),"error"); }
    }
    async function renderCommentsPage(postId){
      commentsList.innerHTML = "<div class='post'><p>Ø¬ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª...</p></div>";
      try{
        const postDoc = await db.collection("posts").doc(postId).get();
        const post = postDoc.exists ? { id: postDoc.id, ...postDoc.data() } : posts.find(p=>p.id===postId);
        const isOwnerOfPost = currentUser && post && post.userId===currentUser.uid;
        const cSnap = await db.collection("posts").doc(postId).collection("comments").orderBy("createdAt","desc").get();
        if(cSnap.empty){ commentsList.innerHTML = "<div class='post'><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯</p></div>"; return; }

        const frags = cSnap.docs.map(doc => {
          const c = doc.data();
          const dateTxt = c.createdAt?.toDate ? c.createdAt.toDate().toLocaleString('ar-IQ') : "";
          const name = escapeHTML(c.userName || 'Ù…Ø³ØªØ®Ø¯Ù…');
          const text = escapeHTML(c.text || '');
          const banBtn = (isOwnerOfPost && c.userId !== currentUser.uid)
            ? `<button class="btn btn-danger btn-xs" style="margin-top:8px" onclick="banUserFromPost('${postId}','${c.userId}')"><i class="fas fa-ban"></i> Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>` : ``;
          return `<div class="post">
            <div class="post-header">
              <div class="post-username"><span>${name}</span></div>
              <div class="post-price" style="color:#888">${dateTxt}</div>
            </div>
            <div class="post-description">${text}</div>
            ${banBtn}
          </div>`;
        });
        commentsList.innerHTML = frags.join("");
      }catch(e){ console.error(e); commentsList.innerHTML = "<div class='post'><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</p></div>"; }
    }
    async function banUserFromPost(postId, userId){
      if(!currentUser) return;
      try{
        const postDoc = await db.collection("posts").doc(postId).get();
        if(!postDoc.exists) return;
        if(postDoc.data().userId !== currentUser.uid) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning");
        await db.collection("posts").doc(postId).collection("bans").doc(userId).set({ banned:true, at: firebase.firestore.FieldValue.serverTimestamp() });
        showNotification("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±","success");
        await renderCommentsPage(postId);
      }catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­Ø¸Ø±: "+(e.message||e),"error"); }
    }

    // ===== Reports =====
    async function reportPost(postId){
      if(!currentUser) return showNotification("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„","warning");
      const pdoc = await db.collection("posts").doc(postId).get();
      if(!pdoc.exists) return showNotification("Ø§Ù„Ù…Ù†Ø´ÙˆØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","error");
      const reason = prompt("Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº (Ø¥Ù„Ø²Ø§Ù…ÙŠ):","");
      if(!reason || !reason.trim()) return showNotification("ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ ÙˆØ§Ø¶Ø­ Ù„Ù„Ø¥Ø¨Ù„Ø§Øº","warning");
      const payload = { postId, ownerId: pdoc.data().userId || null, reporterId: currentUser.uid, reporterName: currentUser.name, reason: reason.trim(), status: "open", createdAt: firebase.firestore.FieldValue.serverTimestamp() };
      try{
        await db.collection("reports").add(payload);
        if(payload.ownerId){ await db.collection("notifications").add({ userId: payload.ownerId, type: "report", postId, seen: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); }
        const ownerUid = await resolveAppOwnerUid();
        if(ownerUid){ await db.collection("notifications").add({ userId: ownerUid, type: "report", postId, seen: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); }
        showNotification("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº","success");
        await refreshNotifDot();
      }catch(e){ console.error("report error:", e); showNotification("ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº: "+(e.message||e),"error"); }
    }

    // ===== Inbox =====
    function showInbox(){ if(!currentUser) return showNotification("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„","warning"); showPage("inbox"); renderInbox(); }
    async function renderInbox(){
      inboxContainer.innerHTML = "<div class='post'><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>";
      try{
        let snap;
        if(isOwner()){
          snap = await db.collection("reports").orderBy("createdAt","desc").get();
        }else{
          snap = await db.collection("reports").where("reporterId","==",currentUser.uid).orderBy("createdAt","desc").get();
        }
        if(snap.empty){ inboxContainer.innerHTML = "<div class='post'><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</p></div>"; return; }
        const rows = snap.docs.map(d => ({id:d.id, ...d.data()}))
          .sort((a,b)=> (b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0))
          .map(r => {
            const timeTxt = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString('ar-IQ') : "";
            const statusColor = r.status==="action_taken" ? "var(--success-color)" : (r.status==="rejected" ? "var(--danger-color)" : "#999");
            const reason = escapeHTML(r.reason || "â€”");
            const notes  = r.reviewerNotes ? (' â€” Ù…Ù„Ø§Ø­Ø¸Ø©: ' + escapeHTML(r.reviewerNotes)) : '';
            const controls = isOwner() ? `
              <div class="row" style="margin-top:10px;">
                <input id="note-${r.id}" class="form-control" style="flex:1" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©..." value="${(r.reviewerNotes||"").replace(/"/g,'&quot;')}">
                <button class="btn btn-danger btn-xs" onclick="ownerBanPostOwner('${r.id}')">Ø­Ø¸Ø± ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
                <button class="btn btn-warning btn-xs" onclick="ownerBanReporter('${r.id}')">Ø­Ø¸Ø± Ø§Ù„Ù…ÙØ¨Ù„Ù‘Øº</button>
                <button class="btn btn-secondary btn-xs" onclick="ownerRejectReport('${r.id}')">Ø±ÙØ¶ Ø§Ù„Ø¨Ù„Ø§Øº</button>
              </div>` :
              `<div class="muted">Ø§Ù„Ø­Ø§Ù„Ø©: <b style="color:${statusColor}">${reportStatusLabel(r.status)}</b>${notes}</div>`;
            return `
              <div class="post">
                <div class="post-header">
                  <div class="post-username"><span>Ø¨Ù„Ø§Øº Ø¹Ù„Ù‰ Ù…Ù†Ø´ÙˆØ±: ${escapeHTML(r.postId || '')}</span></div>
                  <div class="post-price" style="color:#888">${timeTxt}</div>
                  <div class="post-title">Ø­Ø§Ù„ØªÙ‡: <b style="color:${statusColor}">${reportStatusLabel(r.status)}</b></div>
                </div>
                <div class="post-description">Ø§Ù„Ø³Ø¨Ø¨: ${reason}</div>
                ${controls}
                <div class="post-actions" style="margin-top:10px;">
                  <button class="btn btn-secondary" onclick="openDetailsPage('${r.postId}')">Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
                </div>
              </div>`;
          });
        inboxContainer.innerHTML = rows.join("");
      }catch(e){ console.error(e); inboxContainer.innerHTML = "<div class='post'><p>Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„: "+(e.message||e)+"</p></div>"; }
    }
    function reportStatusLabel(s){ if(s==="action_taken") return "ØªÙ… Ø§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡"; if(s==="rejected") return "Ù…Ø±ÙÙˆØ¶"; return "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"; }
    async function ownerBanPostOwner(reportId){
      if(!isOwner()) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning");
      try{
        const rdoc = await db.collection("reports").doc(reportId).get(); if(!rdoc.exists) return; const r = rdoc.data();
        if(!r.ownerId) return showNotification("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµØ§Ø­Ø¨ Ù…Ù†Ø´ÙˆØ± Ù…Ø­Ø¯Ø¯","warning");
        const note = document.getElementById(`note-${reportId}`)?.value || "";
        await db.collection("users").doc(r.ownerId).set({ blockedFromPosting:true },{merge:true});
        await db.collection("reports").doc(reportId).update({ status:"action_taken", reviewerNotes: note, reviewedBy: currentUser.uid });
        showNotification("ØªÙ… Ø­Ø¸Ø± ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº","success"); renderInbox();
      }catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ù‘Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: "+(e.message||e),"error"); }
    }
    async function ownerBanReporter(reportId){
      if(!isOwner()) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning");
      try{
        const rdoc = await db.collection("reports").doc(reportId).get(); if(!rdoc.exists) return; const r = rdoc.data();
        if(!r.reporterId) return showNotification("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØ¨Ù„Øº Ù…Ø­Ø¯Ø¯","warning");
        const note = document.getElementById(`note-${reportId}`)?.value || "";
        await db.collection("users").doc(r.reporterId).set({ blockedFromPosting:true },{merge:true});
        await db.collection("reports").doc(reportId).update({ status:"action_taken", reviewerNotes: note||"ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…ÙØ¨Ù„Øº", reviewedBy: currentUser.uid });
        showNotification("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…ÙØ¨Ù„Øº","success"); renderInbox();
      }catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ù‘Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: "+(e.message||e),"error"); }
    }
    async function ownerRejectReport(reportId){
      if(!isOwner()) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning");
      try{
        const note = document.getElementById(`note-${reportId}`)?.value || "";
        await db.collection("reports").doc(reportId).update({ status:"rejected", reviewerNotes: note, reviewedBy: currentUser.uid });
        showNotification("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¨Ù„Ø§Øº","success"); renderInbox();
      }catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ù‘Ø± Ø±ÙØ¶ Ø§Ù„Ø¨Ù„Ø§Øº: "+(e.message||e),"error"); }
    }

    // ===== My Posts =====
    async function showUserPosts(){
      if(!currentUser) return showNotification("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„","warning");
      showPage("userPosts");
      userPostsContainer.innerHTML="";
      const mine = posts.filter(p=>p.userId===currentUser.uid);
      if(mine.length===0){ userPostsContainer.innerHTML='<div class="post"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù„Ùƒ</p></div>'; return; }
      for(const post of mine){
        const meta = await getUserMeta(post.userId);
        const div=document.createElement("div");
        div.className=`post ${post.status==='sold'?'sold':''} ${post.isPinned?'pinned':''}`;
        div.innerHTML = generatePostHTML(post, meta, 'user-posts');
        userPostsContainer.appendChild(div);
      }
    }
    async function updatePostCountInProfile(){
      if(!currentUser) return;
      const count = posts.filter(p=>p.userId===currentUser.uid).length;
      document.getElementById("profile-count").textContent = `Ø¹Ø¯Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§ØªÙƒ: ${count}`;
    }
    async function repost(postId){ const doc = await db.collection("posts").doc(postId).get(); if(!doc.exists) return; if(doc.data().userId !== currentUser.uid) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning"); await db.collection("posts").doc(postId).update({ createdAt: firebase.firestore.FieldValue.serverTimestamp(), status:'active' }); showNotification("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®","success"); await loadPostsFromFirestore(); showUserPosts(); }
    async function markSold(postId,isSold){ const doc = await db.collection("posts").doc(postId).get(); if(!doc.exists) return; if(doc.data().userId !== currentUser.uid) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning"); await db.collection("posts").doc(postId).update({ status: isSold? 'active':'sold' }); showNotification(isSold?"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹":"ØªÙ… ØªØ­Ø¯ÙŠØ¯: ØªÙ… Ø¨ÙŠØ¹Ù‡","success"); await loadPostsFromFirestore(); showUserPosts(); }
    function deletePost(postId){ if(!currentUser) return; if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ")) return; db.collection("posts").doc(postId).get().then(doc=>{ if(!doc.exists) return showNotification("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","error"); if(doc.data().userId !== currentUser.uid) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning"); return db.collection("posts").doc(postId).delete(); }).then(()=>{ showNotification("ØªÙ… Ø§Ù„Ø­Ø°Ù","success"); loadPostsFromFirestore(); showUserPosts(); }).catch(err=> showNotification("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: "+(err.message||err),"error")); }

    // ===== Create Post =====
    let createPostBusy = false;
    function openCreatePostModal(){ document.getElementById("create-post-modal").style.display="block"; }
    function closeCreatePostModal(){ document.getElementById("create-post-modal").style.display="none"; }
    function changeContactMethod(){ const method=document.getElementById("contact-method").value; document.getElementById("whatsapp-field").style.display = method==="whatsapp"?"block":"none"; document.getElementById("telegram-field").style.display = method==="telegram"?"block":"none"; }

    async function createPost(){
      if(createPostBusy) return;
      if(!currentUser) return showNotification("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹","error");
      try{
        const udoc = await db.collection("users").doc(currentUser.uid).get();
        if(udoc.exists && udoc.data()?.blockedFromPosting){ return showNotification("ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ Ù…Ù† Ø§Ù„Ù†Ø´Ø±","error"); }
      }catch(e){ console.warn("check block failed", e); }

      const subject=document.getElementById("post-subject").value.trim();
      const price=document.getElementById("post-price").value.trim();
      const material=document.getElementById("post-material").value;
      const description=document.getElementById("post-description").value.trim();
      const contactMethod=document.getElementById("contact-method").value;
      const whatsapp=sanitizeWhatsApp(document.getElementById("whatsapp-number").value);
      const telegram=sanitizeTelegram(document.getElementById("telegram-username").value);
      if(!subject||!price||!description) return showNotification("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©","error");

      createPostBusy = true;
      const btn = document.getElementById("post-submit-btn"); btn.disabled = true;
      const newPost={ userId:currentUser.uid,userName:currentUser.name,userEmail:currentUser.email||"", subject,material,price,description,contactMethod, whatsapp:contactMethod==="whatsapp"?whatsapp:"", telegram:contactMethod==="telegram"?telegram:"", status:"active", isPinned:false, createdAt:firebase.firestore.FieldValue.serverTimestamp() };
      try{
        await db.collection("posts").add(newPost);
        closeCreatePostModal();
        await loadPostsFromFirestore();
        showNotification("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­","success");
      }catch(err){
        console.error("createPost error:", err);
        showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±: "+(err.message||err),"error");
      }finally{
        createPostBusy = false; btn.disabled = false;
      }
    }

    // ===== Companies =====
    function openCreateCompanyModal(){ document.getElementById("create-company-modal").style.display="block"; fillGovOptions(); }
    function closeCreateCompanyModal(){ document.getElementById("create-company-modal").style.display="none"; }
    let createCompanyBusy=false;
    function fillGovOptions(){
      const fromSel=document.getElementById("company-from");
      const toSel=document.getElementById("company-to");
      if(fromSel.options.length > 1) return; // Avoid re-filling
      fromSel.innerHTML = GOVERNORATES.map(g=>`<option value="${g}">${g}</option>`).join("");
      toSel.innerHTML = GOVERNORATES.map(g=>`<option value="${g}">${g}</option>`).join("");
      fromSel.value="Ø¨ØºØ¯Ø§Ø¯"; toSel.value="ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª";
    }
    async function loadCompanies(){
      companiesContainer.innerHTML = "<div class='post'><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª...</p></div>";
      try{
        const snap = await db.collection("companies").orderBy("createdAt","desc").get();
        companies = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderCompanies();
      }catch(e){
        console.warn("companies load err:", e);
        companiesContainer.innerHTML = "<div class='post'><p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø¢Ù†.</p></div>";
      }
    }
    function renderCompanies(){
      if(!companies || companies.length===0){
        companiesContainer.innerHTML = "<div class='post'><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª ØªÙˆØµÙŠÙ„ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯</p></div>"; return;
      }
      const html = companies.map(c=>`
        <div class="company">
          <div class="name">${escapeHTML(c.name||'Ø´Ø±ÙƒØ©')}</div>
          <div class="phone"><i class="fa-solid fa-phone"></i> ${c.phone?('0'+String(c.phone).replace(/^0+/,'')):'â€”'}</div>
          <div class="route">Ø§Ù„Ù†Ø·Ø§Ù‚: Ù…Ù† <b>${escapeHTML(c.fromGov||'â€”')}</b> Ø¥Ù„Ù‰ <b>${escapeHTML(c.toGov||'â€”')}</b></div>
        </div>`).join("");
      companiesContainer.innerHTML = html;
    }
    async function createCompany(){
      if(createCompanyBusy) return;
      if(!isOwner()) return showNotification("Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·","warning");
      const name=(document.getElementById("company-name").value||"").trim();
      const phone=(document.getElementById("company-phone").value||"").trim();
      const fromGov=document.getElementById("company-from").value;
      const toGov=document.getElementById("company-to").value;
      if(!name||!phone) return showNotification("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ø´Ø±ÙƒØ©","error");
      createCompanyBusy=true; const btn=document.getElementById("company-submit-btn"); btn.disabled=true;
      try{
        await db.collection("companies").add({ name, phone, fromGov, toGov, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        closeCreateCompanyModal();
        await loadCompanies();
        showNotification("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©","success");
      }catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©: "+(e.message||e),"error"); }
      finally{ createCompanyBusy=false; btn.disabled=false; }
    }

    // ===== Profile: Avatar & Name =====
    function openAvatarModal(){ if(!currentUser) return; document.getElementById("avatar-modal").style.display="block"; }
    function closeAvatarModal(){ document.getElementById("avatar-modal").style.display="none"; }
    async function setAvatar(kind){
      if(!currentUser) return;
      try{
        await db.collection("users").doc(currentUser.uid).set({ avatar: kind }, {merge:true});
        currentUser.avatar = kind; renderAvatar(kind);
        closeAvatarModal();
      }catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©","error"); }
    }
    function editProfileName(){ if(!currentUser) return; document.getElementById("new-name").value=currentUser.name||""; document.getElementById("edit-name-modal").style.display="block"; }
    function closeEditNameModal(){ document.getElementById("edit-name-modal").style.display="none"; }
    async function saveProfileName(){
      try{
        const newName = (document.getElementById("new-name").value||"").trim();
        if(!currentUser) return showNotification("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„","warning");
        if(!newName) return showNotification("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­","error");
        await db.collection("users").doc(currentUser.uid).update({ name:newName });
        currentUser.name = newName;
        document.getElementById("profile-name").textContent = newName;
        showNotification("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­","success");
      }catch(e){ console.error(e); showNotification("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…: "+(e.message||e),"error"); }
    }

    // ===== Stats (modal) =====
    async function openUserStats(){
      document.getElementById("stats-modal").style.display="block";
      try{
        const qAll = await db.collection("users").get();
        const all = qAll.size || qAll.docs.length;
        const since = new Date(); since.setDate(since.getDate()-7);
        let active = 0;
        try{
          const qActive = await db.collection("users").where("lastSeen",">=",firebase.firestore.Timestamp.fromDate(since)).get();
          active = qActive.size || qActive.docs.length;
        }catch(e){
          active = qAll.docs.filter(d=>{ const t=d.data().lastSeen; const ts=t?.toDate? t.toDate(): null; return ts && ts >= since; }).length;
        }
        const qPosts = await db.collection("posts").get();
        document.getElementById("stat-active").textContent = active;
        document.getElementById("stat-users").textContent  = all;
        document.getElementById("stat-posts").textContent = qPosts.size || qPosts.docs.length;
      }catch(e){ console.error(e); showNotification("ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª","error"); }
    }
    function closeStatsModal(){ document.getElementById("stats-modal").style.display="none"; }

    // ===== Broadcast (owner) + Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… =====
    function openBroadcastModal(){ if(!isOwner()) return showNotification("Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·","warning"); document.getElementById("broadcast-modal").style.display="block"; }
    function closeBroadcastModal(){ document.getElementById("broadcast-modal").style.display="none"; }

    async function sendBroadcast(){
      if(!currentUser || !isOwner()) return showNotification("ØºÙŠØ± Ù…ØµØ±Ø­","warning");
      const title = (document.getElementById("broadcast-title-modal").value||"").trim();
      const text  = (document.getElementById("broadcast-text-modal").value||"").trim();
      if(!title || !text) return showNotification("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¹Ù†ÙˆØ§Ù† ÙˆÙ†Øµ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±","warning");
      const payload = { title, text, createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdBy: { uid: currentUser.uid, email: currentUser.email } };
      try{
        if (auth.currentUser) await auth.currentUser.getIdToken(true);
        await db.collection("broadcasts").add(payload);
        showNotification("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±","success");
        document.getElementById("broadcast-title-modal").value="";
        document.getElementById("broadcast-text-modal").value="";
        closeBroadcastModal();
        await fetchLatestBroadcast(true);
      }catch(e){
        console.error("broadcast error:", e);
        showNotification("Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: " + (e.message||e), "error");
      }
    }

    // ÙŠØ¸Ù‡Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙƒÙ„ Ø¥Ø´Ø¹Ø§Ø±
    async function fetchLatestBroadcast(forceShow=false){
      try{
        const q = await db.collection("broadcasts").orderBy("createdAt","desc").limit(1).get();
        const overlay = document.getElementById("broadcast-overlay");
        const banner  = document.getElementById("broadcast-banner");
        if(q.empty){ banner.classList.remove('show'); overlay.classList.remove('show'); return; }
        lastBroadcast = { id:q.docs[0].id, ...q.docs[0].data() };
        const seenKey = `broadcast_seen_${lastBroadcast.id}_${currentUser ? currentUser.uid : "guest"}`;
        if(forceShow || !localStorage.getItem(seenKey)){
          document.getElementById("broadcast-title-display").textContent = lastBroadcast.title || "Ø¥Ø´Ø¹Ø§Ø±";
          document.getElementById("broadcast-text-display").textContent  = lastBroadcast.text  || "";
          banner.classList.add('show'); overlay.classList.add('show');
        }
      }catch(e){ console.warn("broadcast fetch failed", e); }
    }
    function dismissBroadcast(){
      const overlay = document.getElementById("broadcast-overlay");
      const banner  = document.getElementById("broadcast-banner");
      if(lastBroadcast){
        const seenKey = `broadcast_seen_${lastBroadcast.id}_${currentUser ? currentUser.uid : "guest"}`;
        localStorage.setItem(seenKey,"1");
      }
      banner.classList.remove('show'); overlay.classList.remove('show');
    }

    // ===== Owner resolve =====
    async function resolveAppOwnerUid(){
      if(APP_OWNER_UID) return APP_OWNER_UID;
      try{
        const q = await db.collection("users").where("email","==",APP_OWNER_EMAIL).limit(1).get();
        if(!q.empty){ APP_OWNER_UID = q.docs[0].id; }
      }catch(e){ console.error("resolve owner uid err:", e); }
      return APP_OWNER_UID;
    }

    function handleAuthError(error){ const code=error?.code||""; showNotification("Ø®Ø·Ø£ Ù…ØµØ§Ø¯Ù‚Ø©: "+code+" "+(error.message||""),"error"); console.error("Auth error:", error); }

    // ===== Pull to refresh =====
    ;(function initPullToRefresh(){
      const bubble = document.getElementById("pull-bubble");
      let startY = 0, pulling = false, threshold = 80;
      window.addEventListener("touchstart", (e)=>{
        if(pages.main.style.display!=="block" || window.pageYOffset > 0) return;
        startY = e.touches[0].clientY;
        pulling = true;
      }, {passive:true});
      window.addEventListener("touchmove", (e)=>{
        if(!pulling) return;
        const dy = e.touches[0].clientY - startY;
        if(dy > 6 && window.pageYOffset <= 0){
          e.preventDefault();
          bubble.style.display = "inline-block";
          bubble.textContent = dy > threshold ? "Ø£ÙÙ„Øª Ù„Ù„ØªØ­Ø¯ÙŠØ«â€¦" : "Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø¯ÙŠØ«â€¦";
        }else{
          bubble.style.display = "none";
        }
      }, {passive:false});
      window.addEventListener("touchend", async ()=>{
        if(!pulling) return; pulling = false;
        if(bubble.style.display === "inline-block" && bubble.textContent.includes("Ø£ÙÙ„Øª")){
          bubble.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦";
          try{ await Promise.all([loadPostsFromFirestore(), loadCompanies(), fetchLatestBroadcast()]); } finally{ setTimeout(()=> bubble.style.display="none", 500); }
        }else{
          bubble.style.display = "none";
        }
      });
    })();

    // ===== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ù… Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø£Ùˆ Ø²Ø± ESC =====
    document.getElementById('broadcast-overlay').addEventListener('click', dismissBroadcast);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') dismissBroadcast(); });

  </script>
</body>
</html>